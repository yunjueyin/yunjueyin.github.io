<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, minimum-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>ä¸‰æ ¼è®°å½•æœ¬</title>
    <!-- å¼•å…¥html2canvasåº“ç”¨äºå°†è®°å½•çº¸å¯¼å‡ºä¸ºå›¾ç‰‡ (å·²æ”¹ä¸ºåœ¨JSä¸­åŠ¨æ€ä»CDNåŠ è½½) -->
    <!-- <script src="html2canvas.min.js"></script> -->
    <!-- äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ -->
    <!-- <script src="qrcode.min.js"></script> -->
    <!-- <script src="jsQR.min.js"></script> -->
    <script>
        // å¤‡é€‰CDN URLé…ç½®ï¼ˆä½¿ç”¨æµ‹è¯•æˆåŠŸçš„cdnjs CDNï¼‰
        const CDN_CONFIG = {
            html2canvas: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨
            // qrcode: 'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js',
            // jsQR: 'https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js'
        };
        
        // æ£€æŸ¥æ‰€æœ‰æœ¬åœ°åº“æ˜¯å¦åŠ è½½æˆåŠŸï¼Œå¹¶åœ¨å¤±è´¥æ—¶æä¾›å¤‡é€‰CDNåŠ è½½
        
        // ç›´æ¥ä»CDNåŠ è½½html2canvasåº“ï¼ˆç§»é™¤æœ¬åœ°åŠ è½½ï¼‰
        console.log('æ­£åœ¨ä»CDNåŠ è½½html2canvasåº“...');
        window.html2canvasLoaded = false;
        loadScriptFromCDN(CDN_CONFIG.html2canvas, 'html2canvasLoaded', function() {
            console.log('âœ… html2canvasåº“å·²æˆåŠŸä»CDNåŠ è½½');
            window.html2canvasLoaded = true;
        });
        
        // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨
        // window.qrcodeLoaded = false;
        // window.qrcodeFailed = true;
        
        // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨
        // window.jsQRLoaded = false;
        // window.jsQRFailed = true;
        
        // ä»CDNåŠ¨æ€åŠ è½½è„šæœ¬çš„å‡½æ•°
        function loadScriptFromCDN(url, loadedFlag, onLoadCallback) {
            const script = document.createElement('script');
            script.src = url;
            script.async = true;
            
            // è®¾ç½®è¶…æ—¶å¤„ç†
            const timeout = setTimeout(function() {
                console.error(`âŒ CDNåŠ è½½è¶…æ—¶: ${url}`);
                window[loadedFlag] = false;
            }, 10000); // 10ç§’è¶…æ—¶
            
            script.onload = function() {
                clearTimeout(timeout);
                if (onLoadCallback) {
                    onLoadCallback();
                }
            };
            
            script.onerror = function() {
                clearTimeout(timeout);
                console.error(`âŒ CDNåŠ è½½å¤±è´¥: ${url}`);
                window[loadedFlag] = false;
            };
            
            document.head.appendChild(script);
        }
        
        // åº“åŠŸèƒ½å¯ç”¨æ€§æ£€æŸ¥å‡½æ•°
        window.checkLibraryAvailability = function() {
            return {
                html2canvas: typeof html2canvas !== 'undefined'
                // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨
                // qrcode: typeof qrcode !== 'undefined',
                // jsQR: typeof jsQR !== 'undefined'
            };
        }
        

    </script>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ä¸»é¢˜å˜é‡ */
        :root {
            --primary-color: #667eea;
            --primary-color-dark: #5a67d8;
            --secondary-color: #764ba2;
            --accent-color: #ff6b6b;
            --accent-hover: #ee5a5a;
            --success-color: #4ecdc4;
            --warning-color: #ffe66d;
            --bg-gradient-1: #667eea;
            --bg-gradient-2: #764ba2;
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #999;
            --border-light: #e0e0e0;
            --border-medium: #ddd;
            --bg-light: #f8f9fa;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.2);
            --radius-small: 8px;
            --radius-medium: 12px;
            --radius-large: 16px;
            --radius-full: 50%;
        }

        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            line-height: 1.6;
            margin: 0;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            background: white;
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-heavy);
            padding: 30px;
            width: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 20px);
        }

        /* å±å¹•æ—‹è½¬æç¤ºè¦†ç›–å±‚ */
        .orientation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            text-align: center;
            padding: 20px;
        }

        .orientation-overlay.visible {
            display: flex;
        }

        /* å½“ç«–å±å…¨å±æç¤ºæ˜¾ç¤ºæ—¶ï¼Œç¦æ­¢èƒŒæ™¯å†…å®¹æ»šåŠ¨ */
        body.portrait-fullscreen-modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }

        .orientation-icon {
            font-size: 6rem;
            margin-bottom: 20px;
            animation: rotate 2s ease-in-out infinite;
        }

        .orientation-message {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .orientation-submessage {
            font-size: 1rem;
        }
        
        .orientation-options {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 250px;
        }
        
        .orientation-option-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .orientation-option-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        #orientation-skip-forever {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        #orientation-skip-forever:hover {
            background: rgba(102, 126, 234, 0.4);
            border-color: rgba(102, 126, 234, 0.6);
        }

        @keyframes rotate {
            0%, 100% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(90deg);
            }
        }

        /* æ¨ªå±ä¼˜åŒ–æ ·å¼ */
        @media (orientation: landscape) and (max-width: 1024px) {
            .container {
                min-height: 100vh;
                padding: 20px;
            }

            .header {
                padding: 10px 0;
                margin-bottom: 15px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .controls {
                max-width: 100%;
                margin-bottom: 15px;
            }

            .grid-container {
                grid-template-rows: auto 1fr;
            }
        }

        /* è£…é¥°å…ƒç´  */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .header h1 {
            color: var(--text-primary);
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.1);
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* æ§åˆ¶æ  - ä¼˜åŒ–å */
        .controls {
            display: flex;
            justify-content: flex-start;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: linear-gradient(135deg, var(--bg-light), #ffffff);
            padding: 16px 20px;
            border-radius: var(--radius-large);
            box-shadow: var(--shadow-medium);
            border: 1px solid rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            max-width: calc(100% - 320px); /* ä¸ºå³ä¾§å›æ”¶ç«™ç•™å‡ºç©ºé—´ */
            transition: all 0.3s ease;
        }

        .controls:hover {
            box-shadow: var(--shadow-heavy);
        }

        /* ç¡®ä¿æŒ‰é’®åˆ†æˆä¸¤è¡Œæ˜¾ç¤º */
        .controls .btn {
            flex: 0 0 calc(33.333% - 8px); /* æ¯è¡Œæ˜¾ç¤º3ä¸ªæŒ‰é’® */
            min-width: 150px;
            box-sizing: border-box;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }



        /* æŒ‰é’®æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .btn {
            padding: 12px 20px;
            font-size: 0.95rem;
            border: none;
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            will-change: transform, box-shadow;
            min-height: 40px;
            height: 40px;
            line-height: 1;
        }

        /* SVGå›¾æ ‡æ ·å¼ */
        .btn svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }

        /* ç¡®ä¿æ‰€æœ‰æŒ‰é’®æ–‡å­—åœ¨æŒ‰é’®ä¸­é—´ä½ç½® */
        .btn span,
        .btn i,
        .btn svg {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }

        /* æŒ‰é’®æ‚¬åœæ•ˆæœ - æ‰€æœ‰æŒ‰é’®ç»Ÿä¸€ä½¿ç”¨ */
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†å†…æŒ‰é’®ä½¿ç”¨ä¸æ§åˆ¶æ æŒ‰é’®ç›¸åŒçš„è¿‡æ¸¡åŠ¨ç”»è®¾ç½® */
        .modal-content .btn {
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            will-change: transform, box-shadow;
        }
        
        /* ç¡®ä¿æ¨¡æ€æ¡†æ“ä½œåŒºåŸŸçš„æŒ‰é’®æ–‡å­—å±…ä¸­ */
        .modal-actions .btn {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 40px;
            height: 40px;
            line-height: 1 !important;
            text-align: center !important;
        }
        
        /* ä¸“é—¨é’ˆå¯¹è®¾ç½®æ¨¡æ€æ¡†æŒ‰é’®çš„å±…ä¸­ä¿®å¤ */
        #confirm-settings-btn,
        #cancel-settings-btn {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            height: 40px !important;
            line-height: 1 !important;
            text-align: center !important;
        }

        /* ä¸»æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background: #ee5a5a;
        }

        /* æ¬¡æŒ‰é’®æ ·å¼ */
        .btn-secondary {
            background: var(--success-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #45b7aa;
        }

        /* ç¬¬ä¸‰æŒ‰é’®æ ·å¼ */
        .btn-tertiary {
            background: linear-gradient(135deg, var(--warning-color), #ffd166);
            color: var(--text-primary);
        }

        .btn-tertiary:hover {
            background: linear-gradient(135deg, #ffd166, var(--warning-color));
        }

        /* ä¿¡æ¯æŒ‰é’®æ ·å¼ */
        .btn-info {
            background: var(--primary-color);
            color: white;
        }

        .btn-info:hover {
            background: var(--primary-color-dark);
        }
        }

        /* è®°å½•æœ¬åˆ—è¡¨ */
        .notebook-list {
            background: white;
            border-radius: var(--radius-medium);
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            position: relative;
            border: 1px solid var(--border-light);
        }

        .notebook-list h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.4rem;
            font-weight: 700;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-light);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼æŒ‰é’®æ ·å¼ */
        .view-toggle-btn, .sort-toggle-btn {
            background: var(--bg-light);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-small);
            padding: 6px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: all 0.15s ease;
            margin-left: 8px;
        }

        .view-toggle-btn:hover, .sort-toggle-btn:hover {
            background: white;
            border-color: var(--primary-color);
        }

        /* åˆ—è¡¨æ˜¾ç¤ºæ¨¡å¼ */
        .notebook-list.list-view .notebook-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* å›¾æ ‡æ˜¾ç¤ºæ¨¡å¼ - ä¸ºäº†å‘åå…¼å®¹ä¿ç•™ */
        .notebook-list.icon-view .notebook-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 20px;
            margin: 10px;
            flex: 0 0 calc(33.333% - 20px);
        }

        .notebook-list.icon-view #notebooks-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        /* å¹³é“ºæ˜¾ç¤ºæ¨¡å¼ - ä¼˜åŒ–åçš„å¹³é“ºè§†å›¾ */
        .notebook-list.tile-view .notebook-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 24px;
            margin: 12px;
            flex: 0 0 calc(33.333% - 24px);
            background: white;
            border-radius: var(--radius-medium);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-light);
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .notebook-list.tile-view .notebook-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transition: all 0.15s ease;
        }

        .notebook-list.tile-view .notebook-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-color);
        }

        .notebook-list.tile-view .notebook-item.active {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: var(--secondary-color);
        }

        .notebook-list.tile-view .notebook-item.active::before {
            background: var(--secondary-color);
            width: 6px;
        }

        .notebook-list.tile-view #notebooks-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 12px;
        }

        /* ä¼˜åŒ–ç§»åŠ¨ç«¯å“åº”å¼ */
        /* å¹³æ¿è®¾å¤‡ */
        @media (max-width: 768px) {
            /* å¹³æ¿ç«–å± - 2åˆ— */
            @media (orientation: portrait) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(50% - 5px); /* å‡å»gapçš„ä¸€åŠä½œä¸ºé—´è· */
                    padding: 20px 16px;
                    margin: 0;
                }
            }
            
            /* å¹³æ¿æ¨ªå± - 3åˆ— */
            @media (orientation: landscape) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(33.0% - 4px); /* è°ƒæ•´ä¸ºæ›´ç²¾ç¡®çš„å€¼ä»¥ç¡®ä¿ä¸‰åˆ—æ˜¾ç¤º */
                    padding: 20px 16px;
                    margin: 0;
                }
            }
            
            .notebook-list.tile-view #notebooks-container {
                display: flex !important;
                flex-wrap: wrap !important;
                justify-content: flex-start !important;
                gap: 6px;
            }
        }

        /* æ‰‹æœºè®¾å¤‡ */
        @media (max-width: 480px) {
            /* æ‰‹æœºç«–å± - 2åˆ— */
            @media (orientation: portrait) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(50% - 4px); /* å‡å»gapçš„ä¸€åŠä½œä¸ºé—´è· */
                    padding: 16px 12px;
                    margin: 0;
                    font-size: 0.85rem;
                }
            }
            
            /* æ‰‹æœºæ¨ªå± - 3åˆ— */
            @media (orientation: landscape) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(33.0% - 3.333px); /* è°ƒæ•´ä¸ºæ›´ç²¾ç¡®çš„å€¼ä»¥ç¡®ä¿ä¸‰åˆ—æ˜¾ç¤º */
                    padding: 16px 12px;
                    margin: 0;
                    font-size: 0.85rem;
                }
            }
            
            .notebook-list.tile-view #notebooks-container {
                display: flex !important;
                flex-wrap: wrap !important;
                justify-content: flex-start !important;
                gap: 5px;
            }
        }

        /* å°å±å¹•æ‰‹æœºè®¾å¤‡ */
        @media (max-width: 360px) {
            /* å°å±å¹•æ‰‹æœºç«–å± - 2åˆ— */
            @media (orientation: portrait) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(50% - 3px); /* å‡å»gapçš„ä¸€åŠä½œä¸ºé—´è· */
                    padding: 12px 10px;
                    margin: 0;
                    font-size: 0.8rem;
                }
            }
            
            /* å°å±å¹•æ‰‹æœºæ¨ªå± - 3åˆ— */
            @media (orientation: landscape) {
                .notebook-list.tile-view .notebook-item {
                    flex: 0 0 calc(33.0% - 2.666px); /* è°ƒæ•´ä¸ºæ›´ç²¾ç¡®çš„å€¼ä»¥ç¡®ä¿ä¸‰åˆ—æ˜¾ç¤º */
                    padding: 12px 10px;
                    margin: 0;
                    font-size: 0.8rem;
                }
            }
            
            .notebook-list.tile-view #notebooks-container {
                display: flex !important;
                flex-wrap: wrap !important;
                justify-content: flex-start !important;
                gap: 4px;
            }
        }

        .notebook-list h3::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: var(--primary-color);
        }

        .notebook-item {
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.15s ease;
            background: var(--bg-light);
            border-left: 4px solid var(--primary-color);
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notebook-item:hover {
            background: #e9ecef;
            transform: translateX(8px);
            box-shadow: var(--shadow-medium);
        }

        .notebook-item.active {
            background: #e6e9ff;
            border-left: 4px solid var(--secondary-color);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        /* è®°å½•æœ¬åˆ é™¤æŒ‰é’® */
        .notebook-delete-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            margin-left: 8px;
        }

        .notebook-delete-btn:hover {
            background: rgba(220, 53, 69, 0.1);
            transform: scale(1.1);
        }

        .notebook-delete-btn:active {
            transform: scale(0.95);
        }

        /* è®°å½•æœ¬ */
        .notebook {
            background: #f9f7f1;
            border-radius: var(--radius-medium);
            padding: 25px;
            position: relative;
            margin-bottom: 30px;
            box-shadow: var(--shadow-medium);
            border: 1px solid #e6d9b8;
        }

        .notebook::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50px;
            height: 100%;
            width: 3px;
            background: linear-gradient(to bottom, #e6d9b8, transparent 80%);
        }

        /* è®°å½•çº¸ */
        .paper {
            background: white;
            border-radius: var(--radius-small);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .paper:hover {
            box-shadow: var(--shadow-heavy);
            transform: translateY(-2px);
        }
        
        .paper.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(124, 157, 250, 0.2);
        }
        
        /* ç½‘æ ¼çº¸èƒŒæ™¯çš„é€‰ä¸­è®°å½•çº¸ - ç§»é™¤è¡Œçº¿æ¡ä¿ç•™ç«–çº¿æ¡ */
        .paper.selected.bg-image-grid {
            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
        }
        
        /* å››æ ¼è®°å½•çº¸ä¸­ç½‘æ ¼çº¸èƒŒæ™¯çš„é€‰ä¸­è®°å½•çº¸ */
        .paper.selected.bg-image-grid .grid-container.four-column {
            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
        }
        
        /* ç¡®ä¿è¾“å…¥åŒºä¸‹è¾¹ç•Œä¸ç½‘æ ¼çº¸æ–¹æ ¼ä¸‹è¾¹çº¿å¹³é½ */
        .paper.bg-image-grid .grid-line {
            height: calc(2.8125rem - 1px);
            border-bottom: none;
        }
        
        .paper.bg-image-grid .grid-container.four-column .grid-line {
            height: calc(2.8125rem - 1px);
            border-bottom: none;
        }

        .paper-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px dashed var(--border-light);
            position: relative;
        }
        
        .print-btn {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-light);
            color: var(--text-primary);
            border: none;
            border-radius: var(--radius-full);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
        }
        
        .print-btn:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: var(--shadow-medium);
        }
        
        .print-btn:active {
            transform: translateY(-50%) scale(0.95);
        }
        
        .paper-date {
            position: absolute;
            right: 40px; /* ä¸ºåˆ é™¤æŒ‰é’®ç•™å‡ºç©ºé—´ */
            top: 50%;
            transform: translateY(-50%);
        }
        
        .delete-btn {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(calc(-50% - 5px)); /* å‘ä¸Šç§»åŠ¨5px */
            background: linear-gradient(135deg, var(--accent-color), #ff5252);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            width: 30px;
            height: 30px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-weight: 500;
            line-height: 1;
        }
        
        .delete-btn:hover {
            background: linear-gradient(135deg, var(--accent-color), #ff5252);
            box-shadow: var(--shadow-light);
        }
        
        .delete-btn:active {
            background: #cc0000;
            box-shadow: 0 0 8px rgba(255, 82, 82, 0.6);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }

        .paper-title {
            font-size: 1.4rem;
            color: var(--text-primary);
            font-weight: 700;
            letter-spacing: -0.3px;
            flex: 1;
            text-align: center;
            outline: none;
            transition: background-color 0.2s ease;
        }
        
        .paper-title[contenteditable="true"] {
            background-color: rgba(102, 126, 234, 0.05);
        }

        .paper-date {
            color: var(--text-light);
            font-size: 0.9rem;
            background: var(--bg-light);
            padding: 4px 10px;
            border-radius: var(--radius-full);
        }

        /* ä¸‰æ ¼å¸ƒå±€ */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 40px;
            position: relative;
        }
        
        /* å››æ ¼å¸ƒå±€ */
        .grid-container.four-column {
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 30px;
        }

        .column {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* åŸºæœ¬ç«–çº¿æ¡æ ·å¼ */
        .column:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 0;
            right: -20px;
            height: 100%;
            width: 1px;
            background-color: var(--column-border-color, #a0d4e6);
        }
        
        /* è™šçº¿æ ·å¼ */
        .column:not(:last-child)[style*="--column-border-style: dashed"]::after {
            background-image: repeating-linear-gradient(
                to bottom,
                transparent 0px, 
                transparent 19px,
                var(--column-border-color, #a0d4e6) 19px,
                var(--column-border-color, #a0d4e6) 20px
            );
            background-color: transparent;
        }
        
        /* ç‚¹çº¿æ ·å¼ */
        .column:not(:last-child)[style*="--column-border-style: dotted"]::after {
            background-image: repeating-linear-gradient(
                to bottom,
                transparent 0px, 
                transparent 5px,
                var(--column-border-color, #a0d4e6) 5px,
                var(--column-border-color, #a0d4e6) 6px
            );
            background-color: transparent;
        }
        
        /* å®çº¿æ ·å¼ï¼ˆé»˜è®¤æ ·å¼ï¼‰ä¸éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½¿ç”¨ä¸Šé¢çš„åŸºæœ¬æ ·å¼ */

        /* ç½‘æ ¼çº¿ */
        .grid-line {
            height: 2.8125rem; /* ä¸èƒŒæ™¯å›¾ç‰‡ç½‘æ ¼å¤§å°(2rem)æˆæ¯”ä¾‹ï¼Œä¿æŒè§†è§‰åè°ƒ */
            border-bottom: 1px dashed #a0d4e6;
            transition: all 0.3s ease;
            position: relative;
            background-color: transparent;
        }
        
        /* åŒçº¿æ ·å¼ */
        .grid-line.double-line {
            border-bottom-width: 4px;
            border-bottom-style: double;
            border-bottom-color: var(--grid-line-color, #a0d4e6);
        }
        

        
        .grid-line:hover {
            background-color: rgba(249, 249, 249, 0.8);
            border-bottom-color: #7cbad9;
        }

        /* è¾“å…¥æ¡†æ ·å¼ - åŒæ—¶æ”¯æŒinputå’Œtextarea */
        .grid-line input,
        .grid-line textarea {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background: transparent;
            font-size: 0.95rem;
            position: relative;
            z-index: 2;
            padding: 10px 12px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            /* ç¡®ä¿textareaçš„è‡ªåŠ¨æ¢è¡ŒåŠŸèƒ½æ­£å¸¸å·¥ä½œ */
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            resize: none;
            /* ç»Ÿä¸€è¡Œé«˜å’Œå­—ä½“ */
            line-height: 1.4;
            font-family: inherit;
        }

        .grid-line input:focus,
        .grid-line textarea:focus {
            background-color: rgba(255, 230, 109, 0.2);
            transform: scale(1.02);
        }

        /* æ¨¡æ€æ¡† - åŒ…å«å±…ä¸­æ˜¾ç¤ºå’ŒèƒŒæ™¯æ¨¡ç³Š */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.15s ease;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-medium);
            padding: 35px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-heavy);
            animation: slideIn 0.15s ease;
            border: 1px solid var(--border-light);
            position: relative;
            max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„80% */
            overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
        }
        
        /* ä¸ºè®¾ç½®æ¨¡æ€æ¡†çš„å†…å®¹åŒºåŸŸæ·»åŠ ç‰¹æ®Šå¤„ç†ï¼Œç¡®ä¿æŒ‰é’®å§‹ç»ˆåœ¨åº•éƒ¨ */
        #settings-modal .modal-content {
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 85vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„85% */
            overflow-y: visible; /* æ”¹ä¸ºvisibleï¼Œç¡®ä¿æ ‡é¢˜è¡Œå®Œå…¨æ˜¾ç¤º */
            padding-top: 15px;
            padding-bottom: 5px;
        }
        
        /* ä¸ºæ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†ä¼˜åŒ–é—´è·å’Œå¸ƒå±€ */
        #template-modal .modal-content {
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„80% */
            overflow-y: hidden; /* ç¦ç”¨å†…å®¹ç›´æ¥æ»šåŠ¨ */
            padding-top: 15px;
            padding-bottom: 5px;
        }
        
        /* ä¸ºåŒæ­¥ä¸å¤‡ä»½æ¨¡æ€æ¡†ä¼˜åŒ–é—´è·å’Œå¸ƒå±€ */
        #sync-modal .modal-content {
            display: flex;
            flex-direction: column;
            position: relative;
            max-height: 80vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„80% */
            overflow-y: auto; /* å¯ç”¨å‚ç›´æ»šåŠ¨ */
            padding-top: 15px;
            padding-bottom: 5px; /* å‡å°‘åº•éƒ¨å†…è¾¹è·ï¼Œä½¿æŒ‰é’®æ›´é è¿‘åº•éƒ¨ */
        }
        
        /* æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸå®¹å™¨ */
        #template-modal .modal-content > *:not(.modal-actions) {
            overflow-y: auto; /* å¯ç”¨å†…å®¹åŒºåŸŸçš„æ»šåŠ¨åŠŸèƒ½ */
            flex: 1;
            padding-right: 5px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
        }
        
        /* æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†æ ‡é¢˜æ ·å¼ */
        #template-modal .modal-content h3 {
            overflow: visible !important;
            white-space: nowrap;
            margin-top: 0;
            margin-bottom: 12px; /* å‡å°æ ‡é¢˜åº•éƒ¨é—´è· */
        }
        
        /* æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†æ“ä½œæŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ */
        #template-modal .modal-actions {
            margin-top: auto; /* ç¡®ä¿æ“ä½œæŒ‰é’®åŒºåŸŸå§‹ç»ˆåœ¨åº•éƒ¨ */
            padding-top: 10px; /* å‡å°æŒ‰é’®åŒºåŸŸé¡¶éƒ¨å†…è¾¹è· */
            padding-bottom: 2px; /* å‡å°åº•éƒ¨å†…è¾¹è· */
            border-top: 1px solid var(--border-light);
            background-color: white; /* ç¡®ä¿èƒŒæ™¯è‰²ä¸å†…å®¹ä¸€è‡´ */
            position: sticky;
            bottom: 0;
            z-index: 10; /* ç¡®ä¿åœ¨å†…å®¹ä¹‹ä¸Š */
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†æ ‡é¢˜å’Œæ ‡ç­¾è¡Œå®¹å™¨ - ç¡®ä¿å§‹ç»ˆå¯è§ */
        #settings-modal .modal-header {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 5;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†å†…å®¹åŒºåŸŸå®¹å™¨ - åªè®©å†…å®¹åŒºåŸŸæ»šåŠ¨ */
        #settings-modal .tab-content-container {
            overflow-y: auto; /* åªè®©å†…å®¹åŒºåŸŸæ»šåŠ¨ */
            flex: 1;
            padding-right: 5px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
        }
        
        /* åªé’ˆå¯¹è®¾ç½®è¡Œå’Œæ ‡ç­¾è¡Œç§»é™¤æ»šåŠ¨æ¡ */
        .settings-tabs {
            overflow-x: hidden !important; /* ä»…ç§»é™¤æ ‡ç­¾è¡Œçš„æ°´å¹³æ»šåŠ¨æ¡ */
            overflow-y: hidden !important; /* ä»…ç§»é™¤æ ‡ç­¾è¡Œçš„å‚ç›´æ»šåŠ¨æ¡ */
            margin-bottom: 8px;
        }
        
        /* ç¡®ä¿è®¾ç½®æ ‡é¢˜åŒºåŸŸæ²¡æœ‰æ»šåŠ¨æ¡ */
        #settings-modal .modal-content h3 {
            overflow: visible !important;
            white-space: nowrap;
            margin-top: 0;
            margin-bottom: 8px;
        }
        
        /* è®¾ç½®æ¨¡æ€æ¡†æ“ä½œæŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ */
        #settings-modal .modal-actions {
            margin-top: auto; /* ç¡®ä¿æ“ä½œæŒ‰é’®åŒºåŸŸå§‹ç»ˆåœ¨åº•éƒ¨ */
            padding-top: 15px;
            padding-bottom: 2px; /* å‡å°‘åº•éƒ¨å†…è¾¹è· */
            border-top: 1px solid var(--border-light);
        }
        
        /* åŒæ­¥ä¸å¤‡ä»½æ¨¡æ€æ¡†æ“ä½œæŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨ */
        #sync-modal .modal-actions {
            margin-top: auto; /* ç¡®ä¿æ“ä½œæŒ‰é’®åŒºåŸŸå§‹ç»ˆåœ¨åº•éƒ¨ */
            padding-top: 15px;
            padding-bottom: 5px; /* å‡å°åº•éƒ¨å†…è¾¹è·ï¼Œç¼©å‡ç©ºç™½åŒºåŸŸ */
            border-top: 1px solid var(--border-light);
            background-color: white; /* ç¡®ä¿èƒŒæ™¯è‰²ä¸å†…å®¹ä¸€è‡´ */
            position: sticky;
            bottom: 0;
            z-index: 10; /* ç¡®ä¿åœ¨å†…å®¹ä¹‹ä¸Š */
        }
        
        /* ä¼˜åŒ–æ»šåŠ¨æ¡æ ·å¼ */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 3px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--border-color);
        }

        /* åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† - ç®€åŒ–æ ·å¼ */
        .delete-confirm-content {
            background: white;
            border-radius: 8px;
            padding: 24px 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e0e0e0;
        }
        
        /* åˆ é™¤å›¾æ ‡æ ·å¼ */
        .delete-confirm-icon {
            margin: 0 auto 20px;
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        .delete-confirm-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin: 0 0 12px;
        }
        
        /* æ¶ˆæ¯æ ·å¼ */
        .delete-confirm-message {
            font-size: 14px;
            color: #666;
            margin: 0 0 24px;
        }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .delete-confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        /* å–æ¶ˆæŒ‰é’®æ ·å¼ */
        .delete-confirm-cancel {
            padding: 8px 20px;
            border-radius: 4px;
            border: 1px solid #d0d0d0;
            background: white;
            color: #666;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* ç¡®è®¤åˆ é™¤æŒ‰é’®æ ·å¼ */
        .delete-confirm-submit {
            padding: 8px 20px;
            border-radius: 4px;
            border: none;
            background: #f44336;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        

        


        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 1.3rem; /* å¢å¤§è®¾ç½®æ ‡é¢˜æ–‡å­— */
            font-weight: 700;
        }

        .modal-content input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 20px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-small);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-content input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 25px;
        }
        
        /* è®¾ç½®é€‰é¡¹å¡æ ·å¼ - å®Œå…¨ä¼˜åŒ– */
        .settings-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border-medium);
            white-space: nowrap; /* ç¡®ä¿æ ‡ç­¾åœ¨åŒä¸€è¡Œ */
            overflow-x: hidden !important; /* å¼ºåˆ¶ç§»é™¤æ°´å¹³æ»šåŠ¨æ¡ */
            overflow-y: hidden !important; /* å¼ºåˆ¶ç§»é™¤å‚ç›´æ»šåŠ¨æ¡ */
        }
        
        .tab-btn {
            padding: 8px 12px; /* ç¨å¾®å¢åŠ å†…è¾¹è· */
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem !important; /* å¢å¤§æ ‡ç­¾æ–‡å­— */
            color: var(--text-secondary);
            position: relative;
            margin-bottom: -2px;
            flex-shrink: 0; /* é˜²æ­¢æ ‡ç­¾è¢«å‹ç¼© */
            white-space: nowrap;
        }
        
        /* è®¾ç½®å†…å®¹åŒºåŸŸçš„æ ‡é¢˜æ–‡å­— - ç»Ÿä¸€ç¼©å° */
        .tab-content h4,
        .tab-content > div > h4 {
            font-size: 0.9rem !important;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        
        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }
        
        /* é€‰é¡¹å¡å†…å®¹æ ·å¼ */
        .tab-content {
            
        }
        
        /* ä¸»é¢˜é€‰é¡¹æ ·å¼ */
        .theme-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-small);
            cursor: pointer;
            margin: 5px;
            flex: 1;
            min-width: 80px;
        }
        
        .theme-option:hover {
            border-color: var(--primary-color);
        }
        
        .theme-option.selected {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }
        
        .theme-option span {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* å¯¹é½é€‰é¡¹æ ·å¼ */
        .alignment-option {
            display: flex;
            flex-direction: column;
            padding: 8px 12px;
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-small);
            cursor: pointer;
            margin: 5px;
            flex: 1;
            min-width: 80px;
            font-size: 14px;
        }

        .alignment-option > div {
            width: 100%;
            text-align: inherit;
        }

        .alignment-option[data-alignment="left"] > div {
            text-align: left !important;
        }

        .alignment-option[data-alignment="center"] > div {
            text-align: center !important;
        }

        .alignment-option[data-alignment="right"] > div {
            text-align: right !important;
        }

        .alignment-option > span {
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            width: 100%;
        }

        .alignment-option[data-alignment="left"] > span {
            text-align: left;
        }

        .alignment-option[data-alignment="center"] > span {
            text-align: center;
        }

        .alignment-option[data-alignment="right"] > span {
            text-align: right;
        }

        .alignment-option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .alignment-option.selected {
            border-color: var(--primary-color);
            background: var(--bg-light);
        }

        .alignment-option > div {
            width: 100%;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .alignment-option span {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }



        /* æ¨¡æ¿é¡¹ */
        .template-item {
            border: 2px solid var(--border-medium);
            border-radius: var(--radius-small);
            padding: 12px;
            cursor: pointer;
            transition: border-color 0.1s ease, background 0.1s ease, transform 0.1s ease, box-shadow 0.1s ease;
            background: var(--bg-light);
            box-shadow: var(--shadow-light);
            text-align: center;
            will-change: border-color, background, transform, box-shadow;
            height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.2;
        }

        .template-item:hover {
            border-color: var(--primary-color);
            background: white;
            transform: translateY(-3px);
            box-shadow: var(--shadow-medium);
        }

        .template-item.selected {
            border-color: var(--primary-color);
            background: #e6e9ff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        /* æš—é»‘æ¨¡å¼ä¸‹é€‰ä¸­æ¨¡æ¿çš„æ ·å¼ */
        .theme-dark .template-item.selected {
            background: #2d3748;
            border-color: #4a5568;
        }
        
        .theme-dark .template-item.selected > div:first-child {
            color: #ffffff !important;
        }
        
        /* æ¨¡æ¿é¡¹é”å®šçŠ¶æ€ */
        .template-item.locked {
            border-color: var(--border-light);
            background: var(--bg-ultra-light);
            cursor: not-allowed;
            position: relative;
            opacity: 0.7;
        }
        
        .template-item.locked:hover {
            border-color: var(--border-light);
            background: var(--bg-ultra-light);
            transform: none;
            box-shadow: var(--shadow-light);
        }
        
        .template-item.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
        }

        /* æ ‡ç­¾ */
        .tag {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: all 0.15s ease;
            box-shadow: var(--shadow-light);
        }

        .tag:hover {
            background: var(--primary-color-dark);
            transform: scale(1.05);
        }

        /* è®°å½•çº¸æ“ä½œ */
        .paper-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .paper:hover .paper-actions {
            opacity: 1;
        }

        .delete-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: var(--shadow-light);
        }

        .delete-btn:hover {
            background: #ff5252;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
        }
        
        .delete-btn:active {
            background: #cc0000;
            box-shadow: 0 2px 5px rgba(255, 107, 107, 0.3);
        }

        .style-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            padding: 6px 12px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: var(--shadow-light);
        }

        .style-btn:hover {
            background: #45b7aa;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
        }

        /* å›æ”¶ç«™ - PCç«¯åŸºç¡€æ ·å¼ */
        .recycle-bin {
            position: absolute; /* æ”¹ä¸ºabsoluteå®šä½ï¼Œç›¸å¯¹äºcontainerå®¹å™¨ */
            top: 15px; /* å‘ä¸Šç§»åŠ¨15px */
            right: 30px; /* ä¸.containerçš„padding-rightå¯¹é½ */
            width: 320px; /* ä¿æŒå®½åº¦ä¸å˜ */
            max-height: 350px; /* ä¿æŒæœ€å¤§é«˜åº¦ä¸å˜ */
            background: white;
            border-radius: var(--radius-medium);
            box-shadow: var(--shadow-heavy);
            padding: 20px;
            z-index: 90; /* ä¿æŒz-indexä¸å˜ */
            border: 1px solid var(--border-light);
            animation: fadeIn 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 350px; /* å›ºå®šé«˜åº¦ï¼Œç¡®ä¿å¸ƒå±€ç¨³å®š */
        }

        .recycle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-light);
            flex-shrink: 0; /* é˜²æ­¢å¤´éƒ¨è¢«å‹ç¼© */
        }

        .recycle-header h3 {
            font-size: 1.2rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .recycle-count {
            background: var(--accent-color);
            color: white;
            border-radius: var(--radius-full);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .recycle-items {
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* ä»…å†…å®¹åŒºåŸŸæ»šåŠ¨ */
            margin-bottom: 10px;
            min-height: 0; /* é‡è¦ï¼šå…è®¸flexå­å…ƒç´ åœ¨flexå®¹å™¨ä¸­æ­£ç¡®æ”¶ç¼© */
        }

        .recycle-item {
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-light);
            border-radius: var(--radius-small);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: flex-start;
            line-height: 1.4;
        }

        /* å›æ”¶ç«™é¡¹ç›®å†…éƒ¨å…ƒç´ æ ·å¼ */
        .recycle-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            word-break: break-word;
            width: 100%;
        }

        .recycle-item-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        /* PCç«¯å›æ”¶ç«™æ ·å¼ - ä»recycle-fix.cssæ•´åˆ - æ–°å¢recycle-footeræ ·å¼ */
        .recycle-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border-light);
        }

        .recycle-item-date {            font-size: 0.75rem;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .recycle-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
            transition: all 0.15s ease;
        }

        /* å±•å¼€å›æ”¶ç«™æŒ‰é’® */
        .expand-recycle-btn {
            width: 100%;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            padding: 8px 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-light);
            margin-top: 8px;
            font-weight: 500;
        }

        .expand-recycle-btn:hover {
            background: var(--primary-color-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }

        .expand-recycle-btn:active {
            transform: translateY(0);
        }

        /* ç§»é™¤æ— ç”¨çš„recycle-item-infoç±» */

        .restore-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            padding: 4px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.15s ease;
        }

        .restore-btn:hover {
            background: #45b7aa;
            transform: scale(1.05);
        }

        .empty-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-small);
            padding: 4px 10px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .empty-btn:hover {
            background: #ff5252;
            transform: scale(1.05);
        }

        /* è®°å½•çº¸æ ·å¼é€‰æ‹© */
        .paper-styles {
            display: none;
            position: absolute;
            top: 50px;
            right: 15px;
            background: white;
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-heavy);
            padding: 20px;
            min-width: 220px;
            z-index: 200;
            border: 1px solid var(--border-light);
            animation: slideIn 0.3s ease;
        }

        .paper-styles.visible {
            display: block;
        }

        .style-group {
            margin-bottom: 20px;
        }

        .style-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .style-options {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .line-style-option {
            width: 45px;
            height: 22px;
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-small);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .line-style-option:hover::after {
            content: attr(data-label);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 1001;
            margin-bottom: 5px;
        }

        .line-style-option:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid rgba(0, 0, 0, 0.8);
            margin-bottom: -1px;
            z-index: 1001;
        }

        /* åŸºç¡€çº¿æ¡æ ·å¼ - ä¸ä½¿ç”¨::afterä¼ªå…ƒç´  */
        .line-style-option.dashed {
            border-bottom: 2px dashed var(--text-primary);
        }

        .line-style-option.solid {
            border-bottom: 2px solid var(--text-primary);
        }

        .line-style-option.dotted {
            border-bottom: 2px dotted var(--text-primary);
        }

        .line-style-option.double {
            border-bottom: 4px double var(--text-primary);
        }



        /* æ³¢æµªçº¿çš„åŸå§‹æ ·å¼é€šè¿‡é¢å¤–å…ƒç´ å®ç°ï¼Œè€Œä¸æ˜¯::afterä¼ªå…ƒç´  */

        .line-style-option.selected {
            background: #e6e9ff;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .color-option {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: var(--shadow-light);
        }

        .color-option.selected {
            border-color: var(--text-primary);
        }

        /* å­—ä½“é€‰é¡¹æ ·å¼ */
        .font-option {
            padding: 8px 12px;
            border-radius: var(--radius-small);
            cursor: pointer;
            border: 2px solid transparent;
            background: var(--bg-light);
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            min-width: 80px;
            text-align: center;
        }

        .font-option:hover {
            border-color: var(--primary-color);
            background: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow-light);
        }

        .font-option.selected {
            border-color: var(--primary-color);
            background: #e6e9ff;
            font-weight: 600;
        }

        .bg-option {
            width: 65px;
            height: 32px;
            border-radius: var(--radius-small);
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: var(--shadow-light);
            transition: border-color 0.05s linear, background-color 0.05s linear;
            will-change: border-color, background-color;
        }

        .bg-option.selected {
            border-color: var(--text-primary);
            transition: border-color 0.05s linear, background-color 0.05s linear;
        }

        /* æ“ä½œæŒ‰é’® */
        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: var(--radius-full);
            background: var(--bg-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-light);
        }

        .action-btn:hover {
            background: white;
        }

        /* å›¾ç‰‡é¢„è§ˆ */
        .image-preview {
            max-width: 100%;
            max-height: 180px;
            border-radius: var(--radius-small);
            margin: 8px 0;
            box-shadow: var(--shadow-medium);
        }

        .image-preview:hover {
            
        }

        /* å°æŒ‰é’® */
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            background: var(--bg-light);
            box-shadow: var(--shadow-light);
        }

        .btn-sm:hover {
            background: white;
        }
        
        /* è¶…å°æŒ‰é’® */
        .btn-xs {
            padding: 3px 8px;
            font-size: 11px;
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            background: var(--bg-light);
            box-shadow: var(--shadow-light);
        }
        
        .btn-xs:hover {
            background: white;
        }

        /* å¯Œæ–‡æœ¬æŒ‰é’® */
        #format-bold {
            font-weight: bold;
        }

        #format-italic {
            font-style: italic;
        }

        #format-underline {
            text-decoration: underline;
        }



        /* å“åº”å¼è®¾è®¡ */
        /* å¹³æ¿è®¾å¤‡é€‚é… */
        @media (max-width: 1024px) {
            .grid-container {
                gap: 35px;
            }
        }
        
        /* ç§»åŠ¨è®¾å¤‡é€‚é… */
        @media (max-width: 768px) {
            /* è°ƒæ•´åŸºç¡€å­—ä½“å¤§å°ä»¥å®ç°æ•´ä½“ç¼©æ”¾æ•ˆæœ */
            body {
                font-size: 0.75rem;
            }
            
            /* åŸºæœ¬å¸ƒå±€è°ƒæ•´ - ä¸‰åˆ—æ˜¾ç¤º */
            .grid-container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 8px;
                width: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* å››åˆ—è®°å½•çº¸åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä¹Ÿä¿æŒå››åˆ—æ˜¾ç¤º */
            .grid-container.four-column {
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 6px;
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            .column:not(:last-child)::after {
                display: block;
                right: -3px; /* è°ƒæ•´ç«–çº¿ä½ç½® */
            }
            
            /* ç¡®ä¿è®°å½•çº¸é“ºæ»¡å·¦å³ç©ºé—´ */
            .paper {
                width: 100%;
                margin: 0;
                padding: 3px 8px;
                max-width: none;
                font-size: 0.75rem;
                box-sizing: border-box;
            }
            
            /* ä¼˜åŒ–è®°å½•çº¸è¾“å…¥æ¡†å®½åº¦ */
            .grid-line input {
                width: 100%;
                padding: 0 6px;
                box-sizing: border-box;
                max-width: none;
                font-size: 0.75rem;
            }
            
            /* è°ƒæ•´æ‰€æœ‰æ–‡æœ¬è¾“å…¥å…ƒç´ çš„å­—å· */
            input, textarea, select {
                font-size: 0.75rem;
            }
            
            /* è°ƒæ•´ä¾§è¾¹æ æŒ‰é’®çš„é—´è·å’Œå¤§å° */
            .sidebar-nav .btn {
                padding: 8px 10px;
                font-size: 0.75rem;
                gap: 4px;
            }
            
            /* è°ƒæ•´æ¨¡æ€æ¡†å†…å…ƒç´ çš„é—´è·å’Œå¤§å° */
            .modal-content {
                padding: 20px;
            }
            
            .modal h3 {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            /* è°ƒæ•´æ‰€æœ‰æŒ‰é’®çš„å¤§å°å’Œé—´è· */
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
                height: auto;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .btn-xs {
                padding: 2px 6px;
                font-size: 10px;
            }
            
            /* è°ƒæ•´æ ‡ç­¾å¤§å° */
            .tag {
                padding: 2px 6px;
                font-size: 0.7rem;
            }
            
            /* ç¡®ä¿å›¾ç‰‡ä¹Ÿèƒ½å……åˆ†åˆ©ç”¨ç©ºé—´ */
            .image-preview {
                width: 100%;
                height: auto;
                max-height: none;
            }
            
            /* å‡å°å¤´éƒ¨æ ‡é¢˜å­—ä½“å¤§å° */
            .header h1 {
                font-size: 1.5rem;
                margin: 5px 0;
            }
            
            .header p {
                font-size: 0.8rem;
                margin: 5px 0;
            }
            
            .container {
                padding: 0;
                padding-top: 60px; /* å‡å°‘é¡¶éƒ¨ç©ºé—´ */
                width: 100%;
                box-sizing: border-box;
                margin: 0;
                max-width: none;
            }
            
            /* ç¡®ä¿è®°å½•çº¸çˆ¶å®¹å™¨ä¹Ÿå æ»¡å®½åº¦ */
            .notebook-content {
                width: 100%;
                margin: 0;
                padding: 0;
                max-width: none;
            }
            
            /* ç¡®ä¿åˆ—ä¹Ÿå æ»¡å®½åº¦ */
            .column {
                width: 100%;
                margin: 0;
                padding: 0;
            }
            
            /* ç¡®ä¿ç½‘æ ¼çº¿ä¹Ÿå æ»¡å®½åº¦ */
            .grid-line {
                width: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* æ˜¾ç¤ºæ±‰å ¡èœå•æŒ‰é’® */
            .menu-btn {
                display: flex;
            }
            
            /* éšè—åŸæ§åˆ¶æ  */
            .controls {
                display: none;
            }
            
            /* ç§»åŠ¨ç«¯ç‰¹å®šå›æ”¶ç«™æ ·å¼æ•´åˆ */
            
            /* PCç«¯æ¨ªå±æ ·å¼ - ä¿æŒåŸæœ‰PCç«¯å›æ”¶ç«™æ ·å¼ */
            @media (orientation: landscape) {
                /* ç©ºè§„åˆ™ï¼Œä¿æŒPCç«¯åŸæœ‰æ ·å¼ä¸å˜ */
            }
            
            /* ç§»åŠ¨ç«¯æ¨ªå±ä¸“ç”¨å›æ”¶ç«™æ ·å¼ - ç®€çº¦ã€æ˜“çœ‹ã€è´´è¾¹ã€ç¾è§‚è®¾è®¡ */
            @media (orientation: landscape) and (max-width: 768px) {
                .recycle-bin {
                    position: fixed;
                    display: flex;
                    flex-direction: column;
                    width: 180px; /* æ›´ç´§å‡‘çš„å®½åº¦ */
                    right: 0; /* è´´å³è¾¹æ¡† */
                    top: 0; /* è´´é¡¶è¾¹æ¡† */
                    z-index: 1000;
                    max-height: 100vh; /* å æ»¡æ•´ä¸ªå‚ç›´ç©ºé—´ */
                    height: 100vh;
                    padding: 10px;
                    background: rgba(255, 255, 255, 0.95); /* åŠé€æ˜èƒŒæ™¯å¢åŠ ç°ä»£æ„Ÿ */
                    border-radius: 0; /* æ— è¾¹è§’ï¼Œå®Œå…¨è´´è¾¹ */
                    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1); /* å•ä¾§é˜´å½±ï¼Œå¢å¼ºå±‚æ¬¡æ„Ÿ */
                    border: none; /* æ— è¾¹æ¡† */
                    animation: slideInRight 0.3s ease; /* å³ä¾§æ»‘å…¥åŠ¨ç”» */
                }
                
                /* å³ä¾§æ»‘å…¥åŠ¨ç”» */
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                    }
                    to {
                        transform: translateX(0);
                    }
                }
                
                .recycle-header {
                    margin-bottom: 8px;
                    padding-bottom: 6px;
                    border-bottom: 1px solid var(--border-light);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .recycle-header h3 {
                    font-size: 0.9rem;
                    color: var(--text-primary);
                    font-weight: 600;
                    margin: 0;
                    text-align: center;
                    width: 100%;
                }
                
                .recycle-items {
                    flex: 1;
                    overflow-y: auto;
                    margin-bottom: 8px;
                    min-height: 0;
                }
                
                /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
                .recycle-items::-webkit-scrollbar {
                    width: 4px;
                }
                
                .recycle-items::-webkit-scrollbar-track {
                    background: transparent;
                }
                
                .recycle-items::-webkit-scrollbar-thumb {
                    background: var(--border-light);
                    border-radius: 2px;
                }
                
                .recycle-items::-webkit-scrollbar-thumb:hover {
                    background: var(--text-secondary);
                }
                
                .recycle-item {
                    padding: 8px;
                    margin-bottom: 4px;
                    background: white;
                    border-radius: 6px;
                    display: flex;
                    flex-direction: column;
                    justify-content: space-between;
                    align-items: flex-start;
                    line-height: 1.3;
                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                    transition: all 0.2s ease;
                }
                
                .recycle-item:hover {
                    transform: translateX(-2px);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
                }
                
                .recycle-item-title {
                    font-size: 0.8rem;
                    font-weight: 600;
                    color: var(--text-primary);
                    margin-bottom: 2px;
                    display: flex;
                    align-items: center;
                    word-break: break-word;
                    width: 100%;
                }
                
                .recycle-item-meta,
                .recycle-item-date {
                    font-size: 0.7rem;
                    color: var(--text-secondary);
                    margin-bottom: 2px;
                }
                
                .recycle-footer {
                    display: flex;
                    flex-direction: column;
                    gap: 4px;
                    padding-top: 6px;
                    border-top: 1px solid var(--border-light);
                }
                
                .recycle-footer button {
                    font-size: 0.75rem;
                    padding: 6px 8px;
                    background: var(--accent-color);
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-align: center;
                    width: 100%;
                }
                
                .recycle-footer button:hover {
                    background: var(--accent-hover);
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }
                
                /* åˆ é™¤æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
                .recycle-footer button.delete {
                    background: #ff4d4f;
                }
                
                .recycle-footer button.delete:hover {
                    background: #ff7875;
                }
            }
            
            /* ç§»åŠ¨ç«¯éšè—åŸå›æ”¶ç«™ï¼Œä½¿ç”¨ä¾§è¾¹æ ä¸­çš„å›æ”¶ç«™æŒ‰é’®å’Œå¼¹çª— */
            @media (orientation: portrait) {
                .recycle-bin {
                    display: none !important;
                }
            }
            
            /* ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—æ ·å¼ï¼ˆåœ¨æ‰€æœ‰æ–¹å‘éƒ½ç”Ÿæ•ˆï¼‰ */
            .mobile-recycle-modal {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(3px);
                -webkit-backdrop-filter: blur(3px);
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 0.15s ease;
            }
            
            .mobile-recycle-content {
                background: white;
                border-radius: var(--radius-medium);
                width: 90%;
                max-width: 400px;
                max-height: 80vh;
                box-shadow: var(--shadow-heavy);
                display: flex;
                flex-direction: column;
                border: 1px solid var(--border-light);
            }
            
            .mobile-recycle-header {
                padding: 20px;
                border-bottom: 1px solid var(--border-light);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .mobile-recycle-header h3 {
                margin: 0;
                font-size: 1.1rem;
            }
            
            .mobile-recycle-close {
                background: none;
                border: none;
                font-size: 1.2rem;
                cursor: pointer;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background-color 0.2s;
            }
            
            .mobile-recycle-close:hover {
                background-color: var(--bg-light);
            }
            
            .mobile-recycle-body {
                flex: 1;
                padding: 20px;
                overflow-y: auto;
                min-height: 0; /* ç¡®ä¿flexå¸ƒå±€æ­£ç¡®å·¥ä½œ */
            }
            
            .mobile-recycle-items {
                max-height: 300px; /* è®¾ç½®æœ€å¤§é«˜åº¦ä»¥é™åˆ¶å†…å®¹åŒºåŸŸ */
                overflow-y: auto; /* ä¸ºå†…å®¹åŒºåŸŸå•ç‹¬æ·»åŠ æ»šåŠ¨æ¡ */
                -webkit-overflow-scrolling: touch; /* ä¸ºiOSè®¾å¤‡æä¾›å¹³æ»‘æ»šåŠ¨ä½“éªŒ */
            }
            
            /* ä¸ºç§»åŠ¨å›æ”¶ç«™é¡¹ç›®æ·»åŠ é€‚å½“çš„é—´è·å’Œæ ·å¼ */
            .mobile-recycle-items .recycle-item {
                margin-bottom: 10px; /* å¢åŠ é¡¹ç›®é—´è· */
                padding: 15px; /* å¢åŠ å†…è¾¹è· */
                border-radius: var(--radius-small);
                border: 1px solid var(--border-light);
                background-color: white;
            }
            
            /* ç¾åŒ–æ»šåŠ¨æ¡æ ·å¼ */
            .mobile-recycle-body::-webkit-scrollbar,
            .mobile-recycle-items::-webkit-scrollbar {
                width: 6px;
            }
            
            .mobile-recycle-body::-webkit-scrollbar-track,
            .mobile-recycle-items::-webkit-scrollbar-track {
                background: var(--bg-light);
                border-radius: 3px;
            }
            
            .mobile-recycle-body::-webkit-scrollbar-thumb,
            .mobile-recycle-items::-webkit-scrollbar-thumb {
                background: var(--border);
                border-radius: 3px;
            }
            
            .mobile-recycle-body::-webkit-scrollbar-thumb:hover,
            .mobile-recycle-items::-webkit-scrollbar-thumb:hover {
                background: var(--text-secondary);
            }
            
            .mobile-recycle-footer {
                padding: 15px 20px;
                border-top: 1px solid var(--border-light);
                display: flex;
                gap: 10px;
            }
            
            .mobile-recycle-footer .btn {
                flex: 1;
            }
            
            /* è°ƒæ•´å¤´éƒ¨ä½ç½®å’Œæ ‡é¢˜å­—å· */
            .header {
                text-align: center;
                margin-top: 0;
                margin-bottom: 20px; /* å‡å°‘åº•éƒ¨é—´è·ï¼Œä½¿å†…å®¹ä¸Šç§» */
                padding: 15px 0;
            }
            
            .header h1 {
                font-size: 1.8rem; /* ç¼©å°æ ‡é¢˜å­—å· */
                margin-bottom: 5px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .header p {
                font-size: 0.9rem; /* ç¼©å°å‰¯æ ‡é¢˜å­—å· */
            }
            
            /* è°ƒæ•´å†…å®¹ä¸Šç§» */
            .notebook-list,
            #current-notebook {
                margin-top: 0;
            }
            
            /* å¢å¼ºç§»åŠ¨ç«¯è§¦æ‘¸ä½“éªŒ */
            .paper, .notebook-item, .recycle-item {
                touch-action: manipulation;
            }
            
            /* å¢å¤§å¯ç‚¹å‡»åŒºåŸŸ */
            .action-btn {
                width: 40px;
                height: 40px;
            }
            
            /* ç§»åŠ¨ç«¯ä¾§è¾¹æ èœå•æ ·å¼è°ƒæ•´ */
            .sidebar-nav .btn {
                /* è®©æ‰€æœ‰èœå•æŒ‰é’®å®½åº¦ä¸æœ€é•¿èœå•åç§°å¹³é½ */
                width: auto;
                padding: 12px 15px;
                font-size: 0.85rem;
                /* ç¡®ä¿æ–‡å­—å’Œå›¾æ ‡å¯¹é½ */
                justify-content: flex-start;
                /* ä¿æŒå›¾æ ‡å’Œæ–‡å­—é—´è· */
                gap: 8px;
                /* ç¡®ä¿æŒ‰é’®å†…å®¹å®Œæ•´æ˜¾ç¤ºï¼Œä¸æ¢è¡Œ */
                white-space: nowrap;
                /* ç¡®ä¿æ‰€æœ‰æŒ‰é’®ä¸æœ€é•¿æŒ‰é’®ç­‰å®½ */
                align-self: stretch;
            }
            
            /* é€‚åº”ä¾§è¾¹æ çš„å›¾æ ‡å¤§å° - å›¾æ ‡é•¿åº¦å¯ä»¥å˜ */
            .sidebar-nav .btn svg {
                width: 14px;
                height: 14px;
                flex-shrink: 0;
            }
            
            /* è®©ä¾§è¾¹æ å®½åº¦ä¸æœ€é•¿èœå•åç§°å¹³é½ï¼Œæ¯”å†…å®¹ç•¥å®½ */
            .sidebar-nav {
                width: fit-content;
                min-width: 140px;
                max-width: 200px;
                padding: 0 2px 0 5px; /* å‡å°‘å³ä¾§å†…è¾¹è· */
            }
            
            /* ç¡®ä¿ä¾§è¾¹æ å†…å®¹åŒºåŸŸä¸å½±å“å®½åº¦è®¡ç®— */
            .sidebar-content {
                width: fit-content;
                padding: 10px 2px 10px 5px; /* å‡å°‘å³ä¾§å†…è¾¹è· */
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .btn-sm {
                padding: 8px 16px;
                font-size: 1rem;
            }
            
            .btn-xs {
                padding: 4px 10px;
                font-size: 0.85rem;
            }
            
            /* æ¨¡æ€æ¡†é€‚é… */
            .modal-content {
                width: 90%;
                max-width: 400px;
                margin: 20% auto;
            }
            
            /* ä¼˜åŒ–è¾“å…¥æ¡†ä½“éªŒ */
            input, textarea, select {
                font-size: 1rem;
                padding: 12px;
                height: auto;
            }
            
            /* ä¼˜åŒ–è®°å½•çº¸å•å…ƒæ ¼è§¦æ‘¸ä½“éªŒ */
            .cell {
                min-height: 50px;
                padding: 8px 12px;
                transition: background-color 0.2s ease;
            }
            
            /* ä¸‰æ ¼å¸ƒå±€æ ·å¼ */
            .grid-container {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 10px;
                width: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* å››æ ¼å¸ƒå±€æ ·å¼ */
            .grid-container.four-column {
                grid-template-columns: 1fr 1fr 1fr 1fr;
                gap: 8px;
                width: 100%;
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            /* å‡å°å¤´éƒ¨ä¸å†…å®¹ä¹‹é—´çš„é—´è· */
            .header {
                margin-bottom: 10px;
                padding: 5px 0;
            }
            
            /* ä¼˜åŒ–ç§»åŠ¨ç«¯ç«–å±æ¨¡å¼ä¸‹è®°å½•çº¸çš„æ˜¾ç¤ºæ•ˆæœ */
            .paper {
                /* å‡å°‘å†…è¾¹è·ï¼Œè®©å†…å®¹æ›´é è¿‘çº¸å¼ è¾¹ç¼˜ */
                padding: 5px 10px;
                /* å‡å°‘åº•éƒ¨è¾¹è·ï¼Œè®©çº¸å¼ æ›´ç´§å¯†æ’åˆ— */
                margin-bottom: 10px;
                /* ç¡®ä¿è®°å½•çº¸å æ»¡å¯ç”¨å®½åº¦ */
                width: 100%;
                box-sizing: border-box;
            }
            
            /* è°ƒæ•´çº¸å¼ å¤´éƒ¨æ ·å¼ */
            .paper-header {
                margin-bottom: 8px;
                padding-bottom: 5px;
            }
            
            /* ç¡®ä¿è®°å½•æœ¬å®¹å™¨å æ»¡å®½åº¦ */
            .notebook {
                padding: 10px 5px;
                width: 100%;
                box-sizing: border-box;
                margin-bottom: 10px;
            }
            
            .cell:active {
                background-color: var(--bg-light);
            }
            
            /* ç§»åŠ¨ç«¯æ»šåŠ¨ä¼˜åŒ– - ç¡®ä¿æ»šåŠ¨æ¡å¯è§ */
            ::-webkit-scrollbar {
                width: 8px;
                height: 8px;
                -webkit-appearance: none;
            }
            
            ::-webkit-scrollbar-track {
                background-color: rgba(0, 0, 0, 0.05);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb {
                background-color: rgba(0, 0, 0, 0.2);
                border-radius: 4px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background-color: rgba(0, 0, 0, 0.3);
            }
            
            /* é’ˆå¯¹Firefoxçš„æ»šåŠ¨æ¡æ ·å¼ */
            * {
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.2) rgba(0, 0, 0, 0.05);
            }
            
            /* ç§»åŠ¨ç«¯ç«–å±æ¨¡å¼æ»šåŠ¨ä¼˜åŒ– */
            @media (max-width: 768px) and (orientation: portrait) {
                /* å…è®¸bodyå’Œcontainerè‡ªç„¶æ»šåŠ¨ */
                body {
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                    display: block;
                    min-height: auto;
                    /* æ€§èƒ½ä¼˜åŒ– */
                    -webkit-text-size-adjust: 100%;
                    text-size-adjust: 100%;
                    backface-visibility: hidden;
                    -webkit-backface-visibility: hidden;
                    /* ç§»é™¤ä»»ä½•å¯èƒ½çš„è¾¹è· */
                    margin: 0;
                    padding: 0;
                }
                
                .container {
                    overflow-y: visible;
                    -webkit-overflow-scrolling: touch;
                    /* ç¡®ä¿å®¹å™¨ä¸ä¼šé˜»æ­¢é¡µé¢æ»šåŠ¨ */
                    position: static;
                    min-height: auto;
                    max-height: none;
                    /* æ€§èƒ½ä¼˜åŒ– */
                    transform: translateZ(0);
                    -webkit-transform: translateZ(0);
                    /* ç¡®ä¿æ²¡æœ‰é¢å¤–çš„å†…è¾¹è· */
                    padding: 0;
                    padding-top: 65px;
                }
                
                /* ä¼˜åŒ–æ»šåŠ¨ä½“éªŒ */
                * {
                    touch-action: manipulation;
                    -webkit-touch-callout: default;
                    /* æ€§èƒ½ä¼˜åŒ– */
                    will-change: auto;
                }
                
                /* ä¼˜åŒ–æ»šåŠ¨å®¹å™¨ */
                .scrollable {
                    overflow-y: auto;
                    -webkit-overflow-scrolling: touch;
                    /* ç¡¬ä»¶åŠ é€Ÿ */
                    transform: translateZ(0);
                    -webkit-transform: translateZ(0);
                }
                
                /* ç¡®ä¿è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ä¸ä¼šå¯¼è‡´é¡µé¢è¿‡åº¦ç¼©æ”¾ï¼Œå¹¶ä¼˜åŒ–è§¦æ‘¸ä½“éªŒ */
                input, textarea, select {
                    font-size: 16px; /* iOS Safari å¼ºåˆ¶è®¾ç½®ä»¥é˜²æ­¢è‡ªåŠ¨ç¼©æ”¾ */
                    /* ç§»é™¤transformç¼©æ”¾ï¼Œæ”¹ä¸ºç›´æ¥è°ƒæ•´åˆé€‚çš„å°ºå¯¸ */
                    padding: 4px 8px;
                    touch-action: manipulation;
                    -webkit-user-select: text;
                    user-select: text;
                    cursor: text;
                }
                
                /* ä¼˜åŒ–è®°å½•çº¸å•å…ƒæ ¼ä»¥æ˜¾ç¤ºæ›´å¤šå†…å®¹ */
                .cell {
                    min-height: 40px;
                    padding: 4px 8px;
                    font-size: 0.75rem;
                }
                
                /* è¿›ä¸€æ­¥å‡å°çº¸å¼ å†…è¾¹è·å’Œå¤–è¾¹è· */
                .paper {
                    padding: 3px 6px;
                    margin-bottom: 8px;
                }
                
                /* åœ¨ç§»åŠ¨è®¾å¤‡ç«–å±æ¨¡å¼ä¸‹ç¦ç”¨æ¨ªçº¿çº¸å’Œç½‘æ ¼çº¸èƒŒæ™¯ */
                @media (max-width: 768px) and (orientation: portrait) {
                    .style-group label:contains('èƒŒæ™¯å›¾ç‰‡') + div .bg-image-option[data-image="lined"],
                    .style-group label:contains('èƒŒæ™¯å›¾ç‰‡') + div .bg-image-option[data-image="grid"] {
                        display: none !important;
                    }
                    
                    /* ç¡®ä¿ç§»åŠ¨è®¾å¤‡ç«–å±æ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºæ¨ªçº¿çº¸å’Œç½‘æ ¼çº¸èƒŒæ™¯ */
                    .paper.bg-image-lined,
                    .paper.bg-image-grid,
                    .paper.bg-image-lined .grid-container,
                    .paper.bg-image-grid .grid-container {
                        background-image: none !important;
                    }
                    
                    /* ç¡®ä¿CSSé€‰æ‹©å™¨å…¼å®¹æ€§ */
                    .style-group label:nth-of-type(4) + div .bg-image-option[data-image="lined"],
                    .style-group label:nth-of-type(4) + div .bg-image-option[data-image="grid"] {
                        display: none !important;
                    }
                }
                /* ä¿®å¤ç§»åŠ¨è®¾å¤‡ç«–å±æ¨¡å¼ä¸‹çš„ç½‘æ ¼æ˜¾ç¤ºé—®é¢˜ */
                .grid-container {
                    gap: 20px; /* å‡å°é—´è·ï¼Œç¡®ä¿åœ¨ç«–å±æ¨¡å¼ä¸‹èƒ½æ›´å¥½åœ°å±•ç¤ºä¸‰åˆ— */
                }
                
                /* ä¼˜åŒ–åˆ—ä¹‹é—´çš„ç«–çº¿æ˜¾ç¤ºï¼Œé˜²æ­¢å‡ºç°å¤šä½™ç«–çº¿ */
                .column:not(:last-child)::after {
                    right: -10px; /* è°ƒæ•´ç«–çº¿ä½ç½®ï¼Œä½¿å…¶ä¸å‡å°çš„gapåŒ¹é… */
                    width: 1px;
                }
                
                /* ç¡®ä¿ç½‘æ ¼çº¿é«˜åº¦ä¸å®½åº¦æ¯”ä¾‹åè°ƒï¼Œå½¢æˆæ­£æ–¹å½¢ç½‘æ ¼ */
                .grid-line {
                    height: 2.5rem; /* è°ƒæ•´é«˜åº¦ï¼Œä½¿å…¶ä¸å®½åº¦æ›´åè°ƒ */
                }
                
                /* ç¡®ä¿å››æ ¼å¸ƒå±€ä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º */
                .grid-container.four-column {
                    gap: 15px; /* å‡å°å››æ ¼å¸ƒå±€çš„é—´è· */
                }
                
                /* å‡å°çº¸å¼ å¤´éƒ¨ä¸å†…å®¹çš„é—´è· */
                .paper-header {
                    margin-bottom: 6px;
                    padding-bottom: 3px;
                }
                
                /* å‡å°çº¸å¼ æ ‡é¢˜å­—ä½“å¤§å° */
                .paper h3 {
                    font-size: 0.9rem;
                    margin: 4px 0;
                }
                
                /* å‡å°ç½‘æ ¼çº¿ä¹‹é—´çš„é—´è· */
                .grid-line {
                    min-height: 36px;
                    line-height: 1.2;
                }
                
                /* ç§»é™¤å¯èƒ½å¹²æ‰°æ»šåŠ¨çš„æ ·å¼ */
                * {
                    outline: none;
                    -webkit-outline: none;
                }
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®é—´è·è°ƒæ•´ */
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .modal-actions .btn:last-child {
                margin-bottom: 0;
            }
        }
        
        /* ç§»åŠ¨ç«¯æ¨ªå±é€‚é… */
        @media (max-height: 480px) and (orientation: landscape) {
            /* é˜²æ­¢bodyæ»šåŠ¨ï¼Œé¿å…å¤šä¸ªæ»šåŠ¨æ¡å†²çª */
            body {
                overflow: hidden;
                padding-bottom: 0;
            }
            
            /* è°ƒæ•´å®¹å™¨ä¸ºå”¯ä¸€çš„æ»šåŠ¨å…ƒç´  */
            .container {
                padding: 10px;
                min-height: 100vh;
                max-height: 100vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
            
            /* è°ƒæ•´å¤´éƒ¨å’Œæ ‡é¢˜ */
            .header h1 {
                font-size: 1.4rem; /* ç¼©å°æ ‡é¢˜å­—å· */
                margin-bottom: 5px;
            }
            
            /* è°ƒæ•´"æé€Ÿåˆ†ç±»è®°å½•äº‹é¡¹"æ–‡æœ¬ä¸ä¸‹æ–¹å†…å®¹çš„é—´è· */
            .header p {
                margin-bottom: 5px; /* å‡å°ä¸ä¸‹æ–¹å†…å®¹çš„é—´è· */
            }
            
            /* è¿›ä¸€æ­¥å‡å°headerä¸controlsä¹‹é—´çš„è·ç¦» */
            .header {
                margin-bottom: 0; /* å®Œå…¨ç§»é™¤å¤´éƒ¨ä¸æ§åˆ¶æ ä¹‹é—´çš„é—´è· */
            }
            
            /* æ§åˆ¶æ æŒ‰é’®æ ·å¼ - æ˜¾ç¤ºå››ä¸ªä¸»è¦æŒ‰é’®å¹¶ä¿æŒåœ¨ä¸€è¡Œ */
            .controls {
                display: flex;
                justify-content: center;
                gap: 6px;
                flex-wrap: nowrap;
            }
            
            .controls .btn {
                flex: 0 0 calc(25% - 6px); /* æ¯è¡Œæ˜¾ç¤º4ä¸ªæŒ‰é’® */
                padding: 6px 8px; /* å‡å°æŒ‰é’®å†…è¾¹è· */
                font-size: 0.8rem; /* å‡å°æŒ‰é’®å­—ä½“å¤§å° */
                min-width: auto; /* å…è®¸æŒ‰é’®è‡ªé€‚åº”å®½åº¦ */
                height: 36px; /* å‡å°æŒ‰é’®é«˜åº¦ */
            }
            
            /* æŒ‰é’®ä¸­çš„SVGå›¾æ ‡ä¹Ÿéœ€è¦ç›¸åº”å‡å° */
            .controls .btn svg {
                width: 14px;
                height: 14px;
            }
            
            /* åªéšè—ä¸éœ€è¦çš„æ§åˆ¶æŒ‰é’® */
            .controls #sync-btn,
            .controls #settings-btn {
                display: none; /* åœ¨ç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹éšè—è¿™äº›æŒ‰é’® */
            }
            
            /* è°ƒæ•´æ§åˆ¶æ å®¹å™¨æ ·å¼ */
            .controls {
                max-width: 100%; /* ç¡®ä¿æ§åˆ¶æ å æ»¡å®½åº¦ */
                margin-top: 0; /* ç¡®ä¿æ§åˆ¶æ æ²¡æœ‰é¡¶éƒ¨é—´è· */
                margin-bottom: 15px;
            }
            
            /* è®°å½•çº¸å†…å®¹ä¸éœ€è¦ç‹¬ç«‹æ»šåŠ¨ï¼Œç”±containerç»Ÿä¸€å¤„ç† */
            .notebook-content {
                max-height: none;
                overflow: visible;
            }
            
            /* ç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹çš„å›æ”¶ç«™æ ·å¼ - ç¾è§‚ç®€çº¦ä¼˜åŒ–ç‰ˆ */
            .recycle-bin {
                position: fixed; /* å›ºå®šå®šä½ï¼Œä¸éšé¡µé¢æ»šåŠ¨ */
                right: 10px; /* å³ä¾§è¾¹è· */
                top: 60px; /* å‘ä¸Šç§»åŠ¨ï¼Œå‡å°é¡¶éƒ¨è¾¹è· */
                width: 220px; /* ç•¥å¾®ç¼©å°å®½åº¦ï¼Œæ›´ç´§å‡‘ */
                max-height: calc(100vh - 80px); /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹• */
                background: white;
                border-radius: var(--radius-medium);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* æ›´æŸ”å’Œçš„é˜´å½±ï¼Œæ›´ç°ä»£ */
                padding: 10px; /* å‡å°å†…è¾¹è·ï¼Œæ›´ç´§å‡‘ */
                z-index: 90; /* ç¡®ä¿åœ¨æ™®é€šå†…å®¹ä¹‹ä¸Š */
                border: 1px solid #f0f0f0; /* æ›´æŸ”å’Œçš„è¾¹æ¡†é¢œè‰² */
                animation: fadeIn 0.3s ease;
                display: flex;
                flex-direction: column;
                display: none; /* é»˜è®¤éšè— */
                background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); /* è½»å¾®æ¸å˜èƒŒæ™¯ï¼Œå¢åŠ å±‚æ¬¡æ„Ÿ */
            }

            /* ä¸ºç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹çš„å›æ”¶ç«™å¤´éƒ¨é€‚é… */
            .recycle-header {
                margin-bottom: 8px; /* å‡å°é—´è· */
                padding-bottom: 6px; /* å‡å°åº•éƒ¨å†…è¾¹è· */
                border-bottom: 1px solid #e9ecef; /* æ›´ç»†çš„è¾¹æ¡† */
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .recycle-header h3 {
                font-size: 0.85rem; /* ç¼©å°å­—ä½“ */
                font-weight: 600;
                color: #333;
                margin: 0;
            }

            /* ä¸ºç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹çš„å›æ”¶ç«™é¡¹ç›®é€‚é… */
            .recycle-item {
                padding: 6px; /* å‡å°å†…è¾¹è· */
                margin-bottom: 4px; /* å‡å°é¡¹ç›®é—´è· */
                border-radius: var(--radius-small);
                transition: all 0.2s ease;
            }

            .recycle-item:hover {
                background-color: #f8f9fa; /* è½»å¾®çš„æ‚¬åœæ•ˆæœ */
                transform: translateX(2px); /* è½»å¾®çš„æ¨ªå‘ç§»åŠ¨ï¼Œå¢åŠ äº¤äº’æ„Ÿ */
            }

            .recycle-item-title {
                font-size: 0.8rem; /* ç¼©å°å­—ä½“ */
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .recycle-item-meta {
                font-size: 0.65rem; /* ç¼©å°å­—ä½“ */
                color: #666;
            }

            /* ä¿ç•™ç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹å›æ”¶ç«™çš„æ»šåŠ¨æ¡æ ·å¼ */
            .recycle-items {
                flex: 1;
                overflow-y: auto;
                margin-bottom: 8px;
                min-height: 0;
            }

            /* é’ˆå¯¹ç§»åŠ¨ç«¯æ¨ªå±æ¨¡å¼ä¸‹çš„å›æ”¶ç«™ï¼Œå–æ¶ˆåŸæœ‰çš„éšè—è§„åˆ™ */
            @media (max-width: 768px) {
                /* ç§»é™¤å¼ºåˆ¶éšè—å›æ”¶ç«™çš„è§„åˆ™ï¼Œè®©æ¨ªå±æ¨¡å¼å¯ä»¥æ˜¾ç¤ºå›æ”¶ç«™ */
                .recycle-bin:not(.mobile-recycle-hidden) {
                    display: flex !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    pointer-events: auto !important;
                    width: 240px !important;
                    height: auto !important;
                    overflow: visible !important;
                }
            }
            
            /* åŠ å®½æ»šåŠ¨æ¡ä»¥ä¾¿äºç”¨æˆ·ç›´æ¥æ‹–åŠ¨ */
            ::-webkit-scrollbar {
                width: 15px;
                height: 15px;
                -webkit-appearance: none;
            }
            
            ::-webkit-scrollbar-track {
                background-color: rgba(0, 0, 0, 0.05);
                border-radius: 5px;
            }
            
            ::-webkit-scrollbar-thumb {
                background-color: rgba(0, 0, 0, 0.3);
                border-radius: 5px;
            }
            
            /* é’ˆå¯¹Firefoxçš„æ»šåŠ¨æ¡æ ·å¼ */
            * {
                scrollbar-width: thin;
                scrollbar-color: rgba(0, 0, 0, 0.3) rgba(0, 0, 0, 0.05);
            }
        }
    </style>
    <style>
        /* ä¾§è¾¹æ å¯¼èˆªæ ·å¼ */
        .sidebar {}
        
        /* æ±‰å ¡èœå•æŒ‰é’® */
        .menu-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-small);
            box-shadow: var(--shadow-light);
            cursor: pointer;
            z-index: 1005;
            align-items: center;
            justify-content: center;
        }
        
        .menu-btn svg {
            width: 24px;
            height: 24px;
        }
        
        /* ä¾§è¾¹æ å®¹å™¨ */
        .sidebar-nav {
            position: fixed;
            top: 0;
            left: -220px;
            width: 220px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
            z-index: 1004;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding-top: 80px;
        }
        
        .sidebar-nav.open {
            left: 0;
        }
        
        /* ä¾§è¾¹æ å†…å®¹ */
        .sidebar-content {
            padding: 20px;
        }
        
        .sidebar-nav .btn {
            width: 100%;
            margin-bottom: 12px;
            justify-content: flex-start;
        }
        
        .sidebar-nav .btn svg {
            margin-right: 12px;
        }
        
        /* é®ç½©å±‚ */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1003;
            display: none;
        }
        
        .sidebar-overlay.visible {
            display: block;
        }
    </style>
</head>
<body>

    
    <!-- ç«–å±å¼ºåˆ¶å…¨å±æç¤ºè¦†ç›–å±‚ -->
    <div class="orientation-overlay" id="portrait-fullscreen-overlay">
        <div class="orientation-icon">ğŸ“±</div>
                <div class="orientation-submessage">æˆ‘ä»¬å»ºè®®æ‚¨å°†æ‰‹æœºç¿»è½¬åˆ°æ¨ªå±ï¼Œä½“éªŒæœ€ä½³</div>
        <div class="orientation-submessage">ä¸ºä¿è¯åŠŸèƒ½æ­£å¸¸ä½¿ç”¨ï¼Œæ‚¨å¿…é¡»è¿›å…¥å…¨å±æ¨¡å¼</div>
        <div class="orientation-submessage">æŒ‰ä¸€æ¬¡è¿”å›é”®å¯é€€å‡ºå…¨å±</div>
        <div class="orientation-options">
            <button class="orientation-option-btn" id="enter-portrait-fullscreen-btn" style="background: rgba(76, 175, 80, 0.3); border-color: rgba(76, 175, 80, 0.5);">è¿›å…¥å…¨å±</button>
        </div>
    </div>
    <!-- ä¾§è¾¹æ å¯¼èˆª -->
    <button class="menu-btn" id="menu-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
    
    <div class="sidebar-nav" id="sidebar-nav">
        <div class="sidebar-content">
            <button class="btn btn-primary" id="sidebar-new-paper-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ–°å»ºè®°å½•çº¸
            </button>
            <button class="btn btn-primary" id="sidebar-new-notebook-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                æ–°å»ºè®°å½•æœ¬
            </button>

            <button class="btn btn-secondary" id="sidebar-four-column-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="18"></rect><rect x="14" y="3" width="7" height="18"></rect><rect x="8" y="3" width="6" height="18"></rect></svg>
                å››æ ¼è®°å½•
            </button>
            <button class="btn btn-secondary" id="sidebar-template-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                æ¨¡æ¿é€‰æ‹©
            </button>
            <button class="btn btn-tertiary" id="sidebar-sync-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                åŒæ­¥ä¸å¤‡ä»½
            </button>
            <button class="btn btn-tertiary" id="sidebar-settings-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                è®¾ç½®
            </button>
            
            <!-- å›æ”¶ç«™ä¾§è¾¹æ æŒ‰é’® -->
            <button class="btn btn-tertiary" id="sidebar-recycle-btn" style="margin-top: 30px; background: linear-gradient(135deg, #4caf50, #66bb6a); color: white;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                å›æ”¶ç«™
            </button>
        </div>
    </div>
    
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    
    <div class="container">
        <div class="header">
            <h1>ä¸‰æ ¼è®°å½•æœ¬</h1>
            <p>æé€Ÿåˆ†ç±»è®°å½•äº‹é¡¹</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" id="new-paper-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                æ–°å»ºè®°å½•çº¸
            </button>

            <button class="btn btn-secondary" id="four-column-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="18"></rect><rect x="14" y="3" width="7" height="18"></rect><rect x="8" y="3" width="6" height="18"></rect></svg>
                å››æ ¼è®°å½•
            </button>
            <button class="btn btn-tertiary" id="sync-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                åŒæ­¥ä¸å¤‡ä»½
            </button>
            <button class="btn btn-primary" id="new-notebook-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                æ–°å»ºè®°å½•æœ¬
            </button>
            <button class="btn btn-secondary" id="template-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                æ¨¡æ¿é€‰æ‹©
            </button>
            <button class="btn btn-tertiary" id="settings-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                è®¾ç½®
            </button>
        </div>

        <div class="notebook-list" id="notebook-list">
            <h3>
                æˆ‘çš„è®°å½•æœ¬
                <button class="sort-toggle-btn" id="sort-toggle-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                </button>
                <button class="view-toggle-btn" id="view-toggle-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    <span>åˆ—è¡¨è§†å›¾</span>
                </button>
            </h3>
            <div id="notebooks-container"></div>
        </div>

        <div id="current-notebook" class="notebook">
            <div id="papers-container"></div>
        </div>
    </div>

    <!-- æ–°å»ºè®°å½•çº¸æ¨¡æ€æ¡† -->
    <div id="new-paper-modal" class="modal">
        <div class="modal-content">
            <h3>æ–°å»ºè®°å½•çº¸</h3>
            <input type="text" id="paper-title" placeholder="è¯·è¾“å…¥è®°å½•çº¸æ ‡é¢˜">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">æ·»åŠ æ ‡ç­¾ï¼ˆå¯é€‰ï¼Œç”¨é€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="paper-tags" placeholder="ä¾‹å¦‚ï¼šå·¥ä½œ,å­¦ä¹ ,è®¡åˆ’">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" id="confirm-paper-btn">ç¡®å®š</button>
                <button class="btn btn-secondary" id="cancel-paper-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="template-modal" class="modal">
        <div class="modal-content">
            <h3>é€‰æ‹©è®°å½•çº¸æ¨¡æ¿</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px;">
                <div class="template-item" data-template="todo">
                    <div style="font-weight: bold; font-size: 0.95rem; margin-bottom: 3px;">å¾…åŠäº‹é¡¹</div>
                    <div style="font-size: 0.8rem; color: #666;">å¾…åŠ/è¿›è¡Œä¸­/å·²å®Œæˆ</div>
                </div>
                <div class="template-item" data-template="notes">
                    <div style="font-weight: bold; font-size: 0.95rem; margin-bottom: 3px;">å­¦ä¹ ç¬”è®°</div>
                    <div style="font-size: 0.8rem; color: #666;">çŸ¥è¯†ç‚¹/é‡ç‚¹/æ€»ç»“</div>
                </div>
                <div class="template-item" data-template="meeting">
                    <div style="font-weight: bold; font-size: 0.95rem; margin-bottom: 3px;">ä¼šè®®è®°å½•</div>
                    <div style="font-size: 0.8rem; color: #666;">è®¨è®º/å†³è®®/è¡ŒåŠ¨é¡¹</div>
                </div>
                <div class="template-item locked" data-template="speaker">
                    <div style="font-weight: bold; font-size: 0.95rem; margin-bottom: 3px;">å­å­çš„å°äºº</div>
                    <div style="font-size: 0.75rem; color: #666; line-height: 1.3;">é†’æ¥çš„ç¬¬nä¸ªå°æ—¶/å¹²æ´»å•¦/åšå®Œäº†æ²¡æœ‰</div>
                    <div style="font-size: 0.7rem; color: #999; margin-top: 2px;">(å·²ç¦ç”¨)</div>
                </div>
            </div>
            <input type="text" id="template-paper-title" placeholder="è¯·è¾“å…¥è®°å½•çº¸æ ‡é¢˜" style="margin-bottom: 12px;">
            <div class="modal-actions">
                <button class="btn btn-primary" id="confirm-template-btn">ä½¿ç”¨æ¨¡æ¿</button>
                <button class="btn btn-secondary" id="cancel-template-btn">å–æ¶ˆ</button>
             </div>
        </div>
    </div>

    <!-- æœ¬åœ°å¤‡ä»½ä¸æ¢å¤æ¨¡æ€æ¡† -->
    <div id="sync-modal" class="modal">
        <div class="modal-content">
            <h3>æœ¬åœ°å¤‡ä»½ä¸æ¢å¤</h3>
            
            <!-- æœ¬åœ°å¤‡ä»½ä¸æ¢å¤éƒ¨åˆ† -->
            <div class="sync-section" style="margin-bottom: 15px;">
                <p style="margin-bottom: 15px; color: #666;">å¤‡ä»½æ‰€æœ‰æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶æˆ–ä»æœ¬åœ°æ–‡ä»¶æ¢å¤æ•°æ®</p>
                <div style="display: flex; justify-content: space-between;">
                    <button class="btn btn-primary" id="local-backup-btn" style="flex: 1; margin-right: 10px;">åˆ›å»ºæœ¬åœ°å¤‡ä»½</button>
                    <button class="btn btn-secondary" id="local-restore-btn" style="flex: 1; margin-left: 10px;">ä»å¤‡ä»½æ¢å¤</button>
                </div>
            </div>
            
            <!-- äºŒç»´ç åˆ†äº«éƒ¨åˆ† - å·²ç¦ç”¨ -->
            <div class="sync-section" style="margin-bottom: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px; display: none;">
                <p style="margin-bottom: 15px; color: #666;">é€šè¿‡äºŒç»´ç åˆ†äº«æ•°æ®åˆ°å…¶ä»–è®¾å¤‡</p>
                <div style="display: flex; justify-content: space-between; gap: 10px;">
                    <button class="btn btn-primary" id="generate-qr-btn" style="flex: 1;">ç”Ÿæˆåˆ†äº«äºŒç»´ç </button>
                    <button class="btn btn-secondary" id="scan-qr-btn" style="flex: 1;">æ‰«æäºŒç»´ç </button>
                </div>
            </div>
            
            <!-- å­˜å‚¨è®¾ç½®éƒ¨åˆ† -->
            <div class="sync-section" style="margin-bottom: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                <h4 style="margin-bottom: 10px; color: #333;">å­˜å‚¨è®¾ç½®</h4>
                <div class="style-group" style="margin-bottom: 8px;">
                    <label>æ•°æ®å­˜å‚¨ä½ç½®</label>
                    <div class="style-options" style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <div class="storage-option" style="margin-bottom: 0; display: flex; align-items: center; padding: 4px 8px; border-radius: var(--radius-small); transition: background-color 0.2s;">
                            <input type="radio" id="local-storage" name="storage-type" value="local" checked>
                            <label for="local-storage" style="margin-left: 6px; cursor: pointer; white-space: nowrap;">æœ¬åœ°å­˜å‚¨</label>
                        </div>
                        <div class="storage-option" style="margin-bottom: 0; display: flex; align-items: center; padding: 4px 8px; border-radius: var(--radius-small); transition: background-color 0.2s;">
                            <input type="radio" id="cloud-storage" name="storage-type" value="cloud" disabled>
                            <label for="cloud-storage" style="margin-left: 6px; cursor: not-allowed; opacity: 0.7; white-space: nowrap;">äº‘å­˜å‚¨ <span style="color: #999; font-size: 0.85rem;">(æš‚æœªå¼€æ”¾)</span></label>
                        </div>
                    </div>
                </div>
                
                <div class="style-group" style="margin-bottom: 5px;">
                    <label>æ•°æ®å­˜å‚¨ç›®å½•</label>
                    <div class="storage-path-container" style="margin-top: 3px; display: flex; align-items: center; gap: 6px;">
                        <input type="text" id="storage-path" readonly style="
                            flex: 1;
                            padding: 6px 10px;
                            border: 1px solid var(--border-light);
                            border-radius: var(--radius-small);
                            background-color: var(--bg-light);
                            font-size: 0.9rem;
                            color: var(--text-secondary);
                        " value="æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ (localStorage)">
                        <button id="change-storage-path" class="btn btn-primary" style="
                            padding: 6px 14px;
                            background-color: var(--primary-color);
                            color: white;
                            border: none;
                            border-radius: var(--radius-small);
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: background-color 0.2s ease;
                            min-height: 32px;
                        ">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="transform: translateY(-4px) !important;">
                                <path d="M3 7h18v14H3z"></path>
                                <path d="M10 13h4"></path>
                                <path d="M7 7v0c0-1.1.9-2 2-2h8c1.1 0 2 .9 2 2v0h0"></path>
                            </svg>
                        </button>
                    </div>
                    <p style="margin-top: 4px; font-size: 0.85rem; color: var(--text-secondary);">
                        æ•°æ®å°†ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚
                    </p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-sync-btn">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <!-- äºŒç»´ç æ˜¾ç¤ºæ¨¡æ€æ¡† - ä¼˜åŒ–æ ·å¼ - å·²ç¦ç”¨ -->
    <div id="qr-modal" class="modal" style="display: none !important;">
        <div class="modal-content" style="width: 360px; max-width: 95%; position: relative; background: linear-gradient(145deg, #ffffff, #f8f9fa); border-radius: var(--radius-large); padding: 20px 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12); border: none; box-sizing: border-box; overflow-x: auto;">
            <h3 style="text-align: center; color: var(--primary-color); margin-bottom: 8px; font-size: 1.3rem; font-weight: 700; padding-bottom: 6px; position: relative;">
                æ‰«æäºŒç»´ç åˆ†äº«æ•°æ®
                <span style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 50px; height: 3px; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); border-radius: 2px;"></span>
            </h3>
            
            <p style="margin-bottom: 15px; color: var(--text-secondary); text-align: center; font-size: 0.85rem;">è¯·ä½¿ç”¨å…¶ä»–è®¾å¤‡æ‰«æä¸‹æ–¹äºŒç»´ç è·å–æ•°æ®</p>
            
            <div style="display: flex; justify-content: center; margin-bottom: 15px; overflow: hidden;">
                <div id="qr-code-container" style="padding: 15px; background: white; border-radius: var(--radius-medium); box-shadow: var(--shadow-light);">
                    <!-- äºŒç»´ç å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: var(--bg-light); border-radius: var(--radius-small); border-left: 3px solid var(--warning-color);">
                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 3px;">æœ‰æ•ˆæœŸï¼š2åˆ†é’Ÿ</p>
                <p id="qr-expire-countdown" style="color: var(--accent-color); font-weight: bold; font-size: 0.95rem;">120</p>
            </div>
            
            <div class="modal-actions" style="justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="cancel-qr-btn" style="min-width: 100px; padding: 10px 20px; transition: all 0.3s ease;">å…³é—­</button>
                <button class="btn btn-primary" id="refresh-qr-btn" style="min-width: 120px; padding: 10px 24px; transition: all 0.3s ease;">åˆ·æ–°äºŒç»´ç </button>
            </div>
            
            <!-- å“åº”å¼è®¾è®¡è„šæœ¬ -->
            <script>
                // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–ï¼Œè°ƒæ•´äºŒç»´ç å¤§å°
                function adjustQrCodeSize() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
                
                // åœ¨æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶è°ƒç”¨è°ƒæ•´å‡½æ•° - å·²ç¦ç”¨äºŒç»´ç åŠŸèƒ½ï¼Œç§»é™¤ç›¸å…³äº‹ä»¶ç›‘å¬
                // document.getElementById('generate-qr-btn')?.addEventListener('click', adjustQrCodeSize);
                // document.getElementById('refresh-qr-btn')?.addEventListener('click', adjustQrCodeSize);
                
                // ç›‘å¬çª—å£å°ºå¯¸å˜åŒ–å’Œè®¾å¤‡æ–¹å‘å˜åŒ– - å·²ç¦ç”¨äºŒç»´ç åŠŸèƒ½ï¼Œç§»é™¤ç›¸å…³äº‹ä»¶ç›‘å¬
                // window.addEventListener('resize', adjustQrCodeSize);
                // window.addEventListener('orientationchange', adjustQrCodeSize);
            </script>
        </div>
    </div>

    <!-- äºŒç»´ç æ‰«ææ¨¡æ€æ¡† - å·²ç¦ç”¨ -->
    <div id="scan-modal" class="modal" style="display: none !important;">
        <div class="modal-content" style="width: 100vw; height: 100vh; max-width: none; max-height: none; position: fixed; top: 0; left: 0; margin: 0; padding: 0; border: none; border-radius: 0; background: transparent; overflow: hidden;">
            
            <!-- è§†é¢‘å®¹å™¨ï¼Œå…¨å±è¦†ç›– -->
            <div id="scanner-container" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000;">
                <!-- è§†é¢‘å…ƒç´ å°†åœ¨è¿™é‡ŒåŠ¨æ€åˆ›å»º -->
                
                <!-- åŠé€æ˜é®ç½©å±‚ - å››ä¸ªæ–¹å‘çš„é»‘è‰²é®ç½©ï¼Œä¸­é—´ç•™å‡ºæ‰«æåŒºåŸŸ -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0;">
                    <!-- é¡¶éƒ¨é®ç½© -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: calc(50vh - 140px); background: rgba(0, 0, 0, 0.6);"></div>
                    <!-- åº•éƒ¨é®ç½© -->
                    <div style="position: absolute; bottom: 0; left: 0; right: 0; height: calc(50vh - 140px); background: rgba(0, 0, 0, 0.6);"></div>
                    <!-- å·¦ä¾§é®ç½© -->
                    <div style="position: absolute; top: calc(50vh - 140px); left: 0; width: calc(50vw - 140px); height: 280px; background: rgba(0, 0, 0, 0.6);"></div>
                    <!-- å³ä¾§é®ç½© -->
                    <div style="position: absolute; top: calc(50vh - 140px); right: 0; width: calc(50vw - 140px); height: 280px; background: rgba(0, 0, 0, 0.6);"></div>
                </div>
                
                <!-- æ‰«ææ¡†æŒ‡ç¤ºå™¨ï¼ˆåŒ…å«æ‰«æçº¿å’Œå››è§’ï¼‰ -->
                <div id="scanning-indicator" style="position: absolute; top: 50%; left: 50%; width: 280px; height: 280px; transform: translate(-50%, -50%); pointer-events: none;">
                    <!-- æ‰«æçº¿åŠ¨ç”» -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: rgba(76, 175, 80, 0.8); animation: scan-line 2s linear infinite;"></div>
                    
                    <!-- å››ä¸ªè§’ -->
                    <div style="position: absolute; top: -2px; left: -2px; width: 20px; height: 20px; border-top: 3px solid #4caf50; border-left: 3px solid #4caf50; border-radius: 4px 0 0 0;"></div>
                    <div style="position: absolute; top: -2px; right: -2px; width: 20px; height: 20px; border-top: 3px solid #4caf50; border-right: 3px solid #4caf50; border-radius: 0 4px 0 0;"></div>
                    <div style="position: absolute; bottom: -2px; left: -2px; width: 20px; height: 20px; border-bottom: 3px solid #4caf50; border-left: 3px solid #4caf50; border-radius: 0 0 0 4px;"></div>
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 20px; height: 20px; border-bottom: 3px solid #4caf50; border-right: 3px solid #4caf50; border-radius: 0 0 4px 0;"></div>
                </div>
                
                <!-- å…³é—­æŒ‰é’® -->
                <div id="close-scan-btn" style="position: absolute; top: 20px; right: 20px; width: 44px; height: 44px; border-radius: 50%; background: rgba(0, 0, 0, 0.5); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; z-index: 1000; transition: all 0.3s ease;">âœ•</div>
                
                <!-- å–æ¶ˆæŒ‰é’® -->
                <button id="cancel-scan-btn" style="position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); padding: 12px 32px; background: rgba(255, 255, 255, 0.9); color: #333; border: none; border-radius: 25px; font-size: 16px; font-weight: 600; cursor: pointer; z-index: 1000; transition: all 0.3s ease;">å–æ¶ˆ</button>
                
                <!-- æç¤ºæ–‡å­— -->
                <div style="position: absolute; bottom: 120px; left: 0; right: 0; text-align: center; color: white; font-size: 16px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                    å°†äºŒç»´ç å¯¹å‡†æ‰«ææ¡†
                </div>
            </div>
            
            <!-- æ‰«æåŠ¨ç”»æ ·å¼ -->
            <style>
                @keyframes scan-line {
                    0% { top: 0; opacity: 0.8; }
                    50% { opacity: 1; }
                    100% { top: 100%; opacity: 0.8; }
                }
                
                #cancel-scan-btn:hover {
                    background: white;
                    transform: translateX(-50%) scale(1.05);
                }
                
                #close-scan-btn:hover {
                    background: rgba(0, 0, 0, 0.7);
                    transform: scale(1.1);
                }
                
                /* å“åº”å¼è°ƒæ•´ */
                @media (max-width: 480px) {
                    #scanning-indicator {
                        width: 240px !important;
                        height: 240px !important;
                    }
                    
                    #cancel-scan-btn {
                        padding: 10px 24px !important;
                        font-size: 14px !important;
                    }
                }
            </style>
        </div>
    </div>

    <!-- è®°å½•çº¸æ“ä½œèœå• -->
    <div id="paper-menu" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>è®°å½•çº¸æ“ä½œ</h3>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-secondary" id="add-image-btn" style="justify-content: flex-start;">æ’å…¥å›¾ç‰‡</button>
                <button class="btn btn-secondary" id="rich-text-btn" style="justify-content: flex-start;">å¯Œæ–‡æœ¬ç¼–è¾‘</button>
                <button class="btn btn-secondary" id="add-tags-btn" style="justify-content: flex-start;">æ·»åŠ /ç¼–è¾‘æ ‡ç­¾</button>
                <button class="btn btn-primary" id="delete-paper-btn" style="justify-content: flex-start; background: linear-gradient(45deg, #ff6b6b, #ee5a5a);">åˆ é™¤è®°å½•çº¸</button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="close-paper-menu-btn">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ’å…¥æ¨¡æ€æ¡† -->
    <div id="image-modal" class="modal">
        <div class="modal-content">
            <h3>æ’å…¥å›¾ç‰‡</h3>
            <p style="margin-bottom: 10px; color: #666;">è¯·é€‰æ‹©è¦æ’å…¥çš„ä½ç½®ï¼š</p>
            <div style="margin-bottom: 15px;">
                <select id="image-column">
                    <option value="0">ç¬¬ä¸€åˆ—</option>
                    <option value="1">ç¬¬äºŒåˆ—</option>
                    <option value="2">ç¬¬ä¸‰åˆ—</option>
                    <option value="3">ç¬¬å››åˆ—</option>
                </select>
                <select id="image-row">
                    <!-- åŠ¨æ€ç”Ÿæˆè¡Œé€‰é¡¹ -->
                </select>
            </div>
            <p style="margin-bottom: 10px; color: #666;">è¯·è¾“å…¥å›¾ç‰‡URLï¼š</p>
            <input type="text" id="image-url" placeholder="https://example.com/image.jpg" style="margin-bottom: 20px;">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-image-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirm-image-btn">æ’å…¥</button>
            </div>
        </div>
    </div>

    <!-- å¯Œæ–‡æœ¬ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="rich-text-modal" class="modal">
        <div class="modal-content">
            <h3>å¯Œæ–‡æœ¬ç¼–è¾‘</h3>
            <p style="margin-bottom: 10px; color: #666;">è¯·é€‰æ‹©è¦ç¼–è¾‘çš„ä½ç½®ï¼š</p>
            <div style="margin-bottom: 15px;">
                <select id="rich-text-column">
                    <option value="0">ç¬¬ä¸€åˆ—</option>
                    <option value="1">ç¬¬äºŒåˆ—</option>
                    <option value="2">ç¬¬ä¸‰åˆ—</option>
                    <option value="3">ç¬¬å››åˆ—</option>
                </select>
                <select id="rich-text-row">
                    <!-- åŠ¨æ€ç”Ÿæˆè¡Œé€‰é¡¹ -->
                </select>
            </div>
            <div style="border: 1px solid #ddd; border-radius: 5px; padding: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button class="btn btn-sm" id="format-bold">B</button>
                    <button class="btn btn-sm" id="format-italic">I</button>
                    <button class="btn btn-sm" id="format-underline">U</button>
                    <select id="format-color">
                        <option value="black">é»‘è‰²</option>
                        <option value="red">çº¢è‰²</option>
                        <option value="blue">è“è‰²</option>
                        <option value="green">ç»¿è‰²</option>
                    </select>
                </div>
                <textarea id="rich-text-content" rows="10" style="width: 100%; border: 1px solid #ddd; border-radius: 5px; padding: 10px;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-rich-text-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirm-rich-text-btn">åº”ç”¨</button>
            </div>
        </div>
    </div>

    <!-- æ ‡ç­¾ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="tags-modal" class="modal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æ ‡ç­¾</h3>
            <input type="text" id="edit-paper-tags" placeholder="æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰">
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-tags-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="confirm-tags-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <!-- æ ‡é¢˜å’Œæ ‡ç­¾è¡Œå®¹å™¨ - å›ºå®šåœ¨é¡¶éƒ¨ -->
            <div class="modal-header">
                <h3>è®¾ç½®</h3>
                
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="paper-style">è®°å½•çº¸æ ·å¼</button>
                    <button class="tab-btn" data-tab="theme">ä¸»é¢˜è®¾ç½®</button>
                    <button class="tab-btn" data-tab="alignment">å¯¹é½è®¾ç½®</button>
                </div>
            </div>
            
            <!-- å†…å®¹åŒºåŸŸå®¹å™¨ - å¯æ»šåŠ¨ -->
            <div class="tab-content-container">
                <div class="tab-content" id="paper-style-content">
                <style>
                    .bg-image-option {
                        padding: 8px 16px;
                        border: 1px solid var(--border-light);
                        border-radius: var(--radius-small);
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                        font-size: 0.85rem;
                        background: white;
                    }
                    
                    .bg-image-option:hover {
                        background: var(--bg-light);
                    }
                    
                    .bg-image-option.active {
                        background: var(--primary-color);
                        color: white;
                        border-color: var(--primary-color);
                    }
                    
                    /* èƒŒæ™¯å›¾ç‰‡æ ·å¼ç±» - è°ƒæ•´ä¸ºä¸å•å…ƒæ ¼é«˜åº¦ç²¾ç¡®åŒ¹é… */
                    /* æ¨ªçº¿çº¸æ ·å¼ */
                    .paper.bg-image-lined {
                        background-image: linear-gradient(to bottom, transparent calc(100% - 1px), var(--border-light) 1px);
                        background-size: 100% 2.8125rem;
                    }
                    
                    /* ç½‘æ ¼çº¸æ ·å¼ - ç¡®ä¿ç½‘æ ¼ä¸ºæ­£æ–¹å½¢ä¸”ä¸è¾“å…¥åŒºç²¾ç¡®å¯¹é½ */
                    .paper.bg-image-grid {
                        background-image:
                            linear-gradient(to right, var(--border-light) 1px, transparent 1px),
                            linear-gradient(to bottom, var(--border-light) 1px, transparent 1px);
                        background-size: 2.8125rem 2.8125rem;
                        background-position: 0 0;
                        background-repeat: repeat;
                        background-attachment: scroll;
                    }
                    
                    /* ç‚¹é˜µçº¸æ ·å¼ - ç¡®ä¿ç‚¹é˜µåœ¨è¾“å…¥åŒºå‚ç›´å±…ä¸­ */
                    .paper.bg-image-dot {
                        background-image: radial-gradient(var(--border-light) 1px, transparent 1px);
                        background-size: 2.8125rem 2.8125rem;
                        background-position: 0 10px;
                        background-repeat: repeat;
                        background-attachment: local;
                    }
                    
                    /* å››æ ¼è®°å½•çº¸ç‰¹å®šæ ·å¼ - æ¨ªçº¿çº¸ */
                    .paper.bg-image-lined .grid-container.four-column {
                        background-image: linear-gradient(to bottom, transparent calc(100% - 1px), var(--border-light) 1px);
                        background-size: 100% 2.8125rem;
                    }
                    
                    /* å››æ ¼è®°å½•çº¸ç‰¹å®šæ ·å¼ - ç½‘æ ¼çº¸ */
                    .paper.bg-image-grid .grid-container.four-column {
                        background-image:
                            linear-gradient(to right, var(--border-light) 1px, transparent 1px),
                            linear-gradient(to bottom, var(--border-light) 1px, transparent 1px);
                        background-size: 2.8125rem 2.8125rem;
                        background-position: 0 0;
                        background-repeat: repeat;
                        background-attachment: scroll;
                    }
                    
                    /* å››æ ¼è®°å½•çº¸ç‰¹å®šæ ·å¼ - ç‚¹é˜µçº¸ */
                    .paper.bg-image-dot .grid-container.four-column {
                        background-image: radial-gradient(var(--border-light) 1px, transparent 1px);
                        background-size: 2.8125rem 2.8125rem;
                        background-position: 0 10px;
                        background-repeat: repeat;
                        background-attachment: local;
                    }
                    
                    /* å“åº”å¼è°ƒæ•´èƒŒæ™¯å›¾ç‰‡å¤§å° - ä¸å•å…ƒæ ¼é«˜åº¦åŒæ­¥è°ƒæ•´ */
                    @media (max-width: 768px) {
                        .grid-line {
                            height: 2.1rem;
                        }
                        
                        .paper.bg-image-lined, .paper.bg-image-lined .grid-container.four-column {
                            background-size: 100% 2.1rem;
                        }
                        
                        .paper.bg-image-grid, .paper.bg-image-grid .grid-container.four-column {
                            background-size: 2.1rem 2.1rem;
                            background-position: 0 0;
                            background-repeat: repeat;
                            background-attachment: scroll;
                        }
                        
                        .paper.bg-image-dot, .paper.bg-image-dot .grid-container.four-column {
                            background-size: 2.1rem 2.1rem;
                            background-position: 0 0;
                            background-repeat: repeat;
                            background-attachment: local;
                        }
                        
                        /* å“åº”å¼ä¸‹ç½‘æ ¼çº¸èƒŒæ™¯çš„é€‰ä¸­è®°å½•çº¸ - ç§»é™¤è¡Œçº¿æ¡ä¿ç•™ç«–çº¿æ¡ */
                        .paper.selected.bg-image-grid {
                            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
                        }
                        
                        .paper.selected.bg-image-grid .grid-container.four-column {
                            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
                        }
                        
                        /* å“åº”å¼ä¸‹ç¡®ä¿è¾“å…¥åŒºä¸‹è¾¹ç•Œä¸ç½‘æ ¼çº¸æ–¹æ ¼ä¸‹è¾¹çº¿å¹³é½ */
                        .paper.bg-image-grid .grid-line {
                            height: calc(2.1rem - 1px);
                            border-bottom: none;
                        }
                        
                        .paper.bg-image-grid .grid-container.four-column .grid-line {
                            height: calc(2.1rem - 1px);
                            border-bottom: none;
                        }
                    }
                    
                    /* æ¨ªå±æ¨¡å¼è¿›ä¸€æ­¥ä¼˜åŒ– - ä¸å•å…ƒæ ¼é«˜åº¦åŒæ­¥è°ƒæ•´ */
                    @media (max-height: 480px) and (orientation: landscape) {
                        .grid-line {
                            height: 1.75rem;
                        }
                        
                        .paper.bg-image-lined, .paper.bg-image-lined .grid-container.four-column {
                            background-size: 100% 1.75rem;
                        }
                        
                        .paper.bg-image-grid, .paper.bg-image-grid .grid-container.four-column {
                            background-size: 1.75rem 1.75rem;
                            background-position: 0 0;
                            background-repeat: repeat;
                            background-attachment: scroll;
                        }
                        
                        .paper.bg-image-dot, .paper.bg-image-dot .grid-container.four-column {
                            background-size: 1.75rem 1.75rem;
                            background-position: 0 0;
                            background-repeat: repeat;
                            background-attachment: local;
                        }
                        
                        /* æ¨ªå±æ¨¡å¼ä¸‹ç½‘æ ¼çº¸èƒŒæ™¯çš„é€‰ä¸­è®°å½•çº¸ - ç§»é™¤è¡Œçº¿æ¡ä¿ç•™ç«–çº¿æ¡ */
                        .paper.selected.bg-image-grid {
                            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
                        }
                        
                        .paper.selected.bg-image-grid .grid-container.four-column {
                            background-image: linear-gradient(to right, var(--border-light) 1px, transparent 1px);
                        }
                        
                        /* æ¨ªå±æ¨¡å¼ä¸‹ç¡®ä¿è¾“å…¥åŒºä¸‹è¾¹ç•Œä¸ç½‘æ ¼çº¸æ–¹æ ¼ä¸‹è¾¹çº¿å¹³é½ */
                        .paper.bg-image-grid .grid-line {
                            height: calc(1.75rem - 1px);
                            border-bottom: none;
                        }
                        
                        .paper.bg-image-grid .grid-container.four-column .grid-line {
                            height: calc(1.75rem - 1px);
                            border-bottom: none;
                        }
                    }
                    
                    /* è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡æ ·å¼ */
                    .paper.bg-image-custom {
                        background-size: cover;
                        background-position: center;
                        background-repeat: no-repeat;
                        background-color: #ffffff;
                    }
                    
                    /* å­å­çš„å°äººæ¨¡æ¿èƒŒæ™¯å›¾ç‰‡æ ·å¼ - å¢åŠ ä¼˜å…ˆçº§ç¡®ä¿æ­£ç¡®æ˜¾ç¤º */
        .paper.bg-image-speaker {
            background-image: url("å­å­å­çš„å°äººæ¨¡æ¿èƒŒæ™¯å›¾.png") !important;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #ffffff;
        }
                </style>

                <div class="style-group">
                    <label>èƒŒæ™¯å›¾ç‰‡</label>
                    <div style="display: flex; flex-direction: column; gap: 6px;">
                        <input type="file" id="background-image-upload" accept="image/*" style="padding: 6px;">
                        <div id="background-image-preview" style="display: none; text-align: center;">
                            <img id="preview-image" style="max-width: 100%; max-height: 150px; border-radius: 5px; border: 1px solid var(--border-light);">
                            <button id="remove-background-image" class="btn btn-sm btn-danger" style="margin-top: 8px;">ç§»é™¤å›¾ç‰‡</button>
                        </div>
                        <div class="style-options" style="margin-top: 6px;">
                            <div class="bg-image-option" data-image="none">æ— èƒŒæ™¯</div>
                            <div class="bg-image-option" data-image="lined">æ¨ªçº¿çº¸</div>
                            <div class="bg-image-option" data-image="grid">ç½‘æ ¼çº¸</div>
                            <div class="bg-image-option" data-image="dot">ç‚¹é˜µçº¸</div>
                        </div>
                    </div>
                </div>

                <div class="style-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>è¡Œçº¿æ¡æ ·å¼</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-line-style-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-line-style-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-top: 10px;">
                        <div class="line-style-option dashed" data-style="dashed" data-label="è™šçº¿"></div>
                        <div class="line-style-option solid" data-style="solid" data-label="å®çº¿"></div>
                        <div class="line-style-option dotted" data-style="dotted" data-label="ç‚¹çº¿"></div>
                        <div class="line-style-option double" data-style="double" data-label="åŒå®çº¿"></div>
                    </div>
                </div>
                
                <div class="style-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>ç«–çº¿æ¡æ ·å¼</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-column-style-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-column-style-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" id="column-border-style-options" style="margin-top: 10px;">
                        <div class="line-style-option dashed" data-style="dashed" data-label="è™šçº¿"></div>
                        <div class="line-style-option solid" data-style="solid" data-label="å®çº¿"></div>
                        <div class="line-style-option dotted" data-style="dotted" data-label="ç‚¹çº¿"></div>
                    </div>
                </div>
                
                <div class="style-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>çº¿æ¡é¢œè‰²</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-line-color-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-line-color-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-bottom: 12px; margin-top: 10px;">
                        <div class="color-option" style="background: #000000;" data-color="#000000"></div>
                        <div class="color-option" style="background: #ff6b6b;" data-color="#ff6b6b"></div>
                        <div class="color-option" style="background: #4ecdc4;" data-color="#4ecdc4"></div>
                        <div class="color-option" style="background: #ffe66d;" data-color="#ffe66d"></div>
                        <div class="color-option" style="background: #667eea;" data-color="#667eea"></div>
                        <div class="color-option" style="background: #48bb78;" data-color="#48bb78"></div>
                        <div class="color-option" style="background: #9f7aea;" data-color="#9f7aea"></div>
                        <div class="color-option" style="background: #f56565;" data-color="#f56565"></div>
                        <div class="color-option" style="background: #ed8936;" data-color="#ed8936"></div>
                        <div class="color-option" style="background: #4a5568;" data-color="#4a5568"></div>
                    </div>
                    <div class="style-options">
                        <div class="color-option" style="background: #ffedcc;" data-color="#ffedcc"></div>
                        <div class="color-option" style="background: #ccf6ff;" data-color="#ccf6ff"></div>
                        <div class="color-option" style="background: #e5ffcc;" data-color="#e5ffcc"></div>
                        <div class="color-option" style="background: #ffcceb;" data-color="#ffcceb"></div>
                        <div class="color-option" style="background: #e6ccff;" data-color="#e6ccff"></div>
                        <div class="color-option" style="background: #f0f0d8;" data-color="#f0f0d8"></div>
                        <div class="color-option" style="background: #d9f0ff;" data-color="#d9f0ff"></div>
                        <div class="color-option" style="background: #fff5cc;" data-color="#fff5cc"></div>
                        <div class="color-option" style="background: #ccebff;" data-color="#ccebff"></div>
                        <div class="color-option" style="background: #ccffec;" data-color="#ccffec"></div>
                    </div>
                </div>
                
                <div class="style-group">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>èƒŒæ™¯é¢œè‰²</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-bg-color-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-bg-color-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-top: 10px;">
                        <div class="bg-option" style="background: #ffffff;" data-bg="#ffffff"></div>
                        <div class="bg-option" style="background: #f9f7f1;" data-bg="#f9f7f1"></div>
                        <div class="bg-option" style="background: #e6f7ff;" data-bg="#e6f7ff"></div>
                        <div class="bg-option" style="background: #fff7e6;" data-bg="#fff7e6"></div>
                        <div class="bg-option" style="background: #f6ffed;" data-bg="#f6ffed"></div>
                        <div class="bg-option" style="background: #faf5ff;" data-bg="#faf5ff"></div>
                        <div class="bg-option" style="background: #fff5f5;" data-bg="#fff5f5"></div>
                        <div class="bg-option" style="background: #edf2f7;" data-bg="#edf2f7"></div>
                        <div class="bg-option" style="background: #e6fffa;" data-bg="#e6fffa"></div>
                        <div class="bg-option" style="background: #f8f5f2;" data-bg="#f8f5f2"></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="theme-content" style="display: none;">
                <div class="style-group">
                    <label>ä¸»é¢˜é¢œè‰²</label>
                    <div class="style-options">
                        <div class="theme-option" data-theme="default">
                            <div style="display: flex;">
                                <div style="background: #3a86ff; width: 20px; height: 20px;"></div>
                                <div style="background: #8338ec; width: 20px; height: 20px;"></div>
                            </div>
                            <span>é»˜è®¤</span>
                        </div>
                        <div class="theme-option" data-theme="dark">
                            <div style="display: flex;">
                                <div style="background: #2d3748; width: 20px; height: 20px;"></div>
                                <div style="background: #4a5568; width: 20px; height: 20px;"></div>
                            </div>
                            <span>æš—é»‘</span>
                        </div>
                        <div class="theme-option" data-theme="pastel">
                            <div style="display: flex;">
                                <div style="background: #ff9e9e; width: 20px; height: 20px;"></div>
                                <div style="background: #ffd9c0; width: 20px; height: 20px;"></div>
                            </div>
                            <span>æŸ”å’Œ</span>
                        </div>
                        <div class="theme-option" data-theme="vibrant">
                            <div style="display: flex;">
                                <div style="background: #ff0054; width: 20px; height: 20px;"></div>
                                <div style="background: #1e3a8a; width: 20px; height: 20px;"></div>
                            </div>
                            <span>é²œè‰³</span>
                        </div>
                    </div>
                </div>
                
                <div class="style-group" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>æ–‡å­—é¢œè‰²</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-text-color-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-text-color-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-top: 10px;">
                        <div class="text-color-option color-option" style="background: #000000;" data-color="#000000"></div>
                        <div class="text-color-option color-option" style="background: #ffffff; border: 1px solid #cccccc;" data-color="#ffffff"></div>
                        <div class="text-color-option color-option" style="background: #666666;" data-color="#666666"></div>
                        <div class="text-color-option color-option" style="background: #999999;" data-color="#999999"></div>
                        <div class="text-color-option color-option" style="background: #ff6b6b;" data-color="#ff6b6b"></div>
                        <div class="text-color-option color-option" style="background: #4ecdc4;" data-color="#4ecdc4"></div>
                        <div class="text-color-option color-option" style="background: #ffe66d;" data-color="#ffe66d"></div>
                        <div class="text-color-option color-option" style="background: #667eea;" data-color="#667eea"></div>
                        <div class="text-color-option color-option" style="background: #48bb78;" data-color="#48bb78"></div>
                        <div class="text-color-option color-option" style="background: #9f7aea;" data-color="#9f7aea"></div>
                        <div class="text-color-option color-option" style="background: #f56565;" data-color="#f56565"></div>
                        <div class="text-color-option color-option" style="background: #ed8936;" data-color="#ed8936"></div>
                        <div class="text-color-option color-option" style="background: #2dd4bf;" data-color="#2dd4bf"></div>
                        <div class="text-color-option color-option" style="background: #db2777;" data-color="#db2777"></div>
                        <div class="text-color-option color-option" style="background: #f97316;" data-color="#f97316"></div>
                        <div class="text-color-option color-option" style="background: #ffe4e1; border: 1px solid #cccccc;" data-color="#ffe4e1"></div>
                        <div class="text-color-option color-option" style="background: #e0f7fa; border: 1px solid #cccccc;" data-color="#e0f7fa"></div>
                        <div class="text-color-option color-option" style="background: #e8f5e9; border: 1px solid #cccccc;" data-color="#e8f5e9"></div>
                        <div class="text-color-option color-option" style="background: #f3e5f5; border: 1px solid #cccccc;" data-color="#f3e5f5"></div>
                    </div>
                </div>
                
                <div class="style-group" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>å­—å·è®¾ç½®</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-font-size-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-font-size-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-top: 10px;">
                        <select id="font-size-select" style="padding: 6px 12px; border: 1px solid var(--border-medium); border-radius: var(--radius-small); background: white; font-size: 0.9rem;">
                            <option value="12px">12px - å°</option>
                            <option value="14px" selected>14px - æ ‡å‡†</option>
                            <option value="16px">16px - ä¸­</option>
                            <option value="18px">18px - å¤§</option>
                            <option value="20px">20px - è¾ƒå¤§</option>
                            <option value="24px">24px - è¶…å¤§</option>
                        </select>
                    </div>
                </div>
                
                <div class="style-group" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <label>å­—ä½“è®¾ç½®</label>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-xs" id="apply-font-current">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                            <button class="btn btn-xs" id="apply-font-all">åº”ç”¨åˆ°å…¨éƒ¨</button>
                        </div>
                    </div>
                    <div class="style-options" style="margin-top: 10px; flex-wrap: wrap; display: flex; gap: 6px; justify-content: flex-start;">
                        <div class="font-option" data-font="SimSun, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">å®‹ä½“</div>
                        <div class="font-option" data-font="Microsoft YaHei, sans-serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">å¾®è½¯é›…é»‘</div>
                        <div class="font-option" data-font="Courier New, monospace" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">ç­‰å®½å­—ä½“</div>
                        <div class="font-option" data-font="KaiTi, STKaiti, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">æ¥·ä½“</div>
                        <div class="font-option" data-font="SimHei, STHeiti, sans-serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">é»‘ä½“</div>
                        <div class="font-option" data-font="YouYuan, STKaiti, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">å¹¼åœ†</div>
                        <div class="font-option" data-font="FangSong, STFangsong, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">ä»¿å®‹</div>
                        <div class="font-option" data-font="FZShuTi, STKaiti, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">æ–¹æ­£èˆ’ä½“</div>
                        <div class="font-option" data-font="FZYaoTi, STKaiti, serif" style="margin: 2px 2px; padding: 4px 5px; font-size: 12px;">æ–¹æ­£å§šä½“</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="alignment-content" style="display: none;">
                <div class="style-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="text-align: left; display: block; margin: 0;">è®°å½•çº¸çš„æ–‡å­—å¯¹é½æ–¹å¼</label>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" id="apply-to-current-paper" style="padding: 4px 10px; font-size: 12px;">åº”ç”¨åˆ°æœ¬è®°å½•çº¸</button>
                        <button class="btn btn-sm btn-primary" id="apply-to-all-papers" style="padding: 4px 10px; font-size: 12px;">åº”ç”¨åˆ°å…¨éƒ¨</button>
                    </div>
                </div>
                    <div class="style-options">
                        <div class="alignment-option" data-alignment="left" data-label="å·¦å¯¹é½">
                            <span>å·¦å¯¹é½</span>
                        </div>
                        <div class="alignment-option" data-alignment="center" data-label="å±…ä¸­å¯¹é½">
                            <span>å±…ä¸­å¯¹é½</span>
                        </div>
                        <div class="alignment-option" data-alignment="right" data-label="å³å¯¹é½">
                            <span>å³å¯¹é½</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å­˜å‚¨è®¾ç½®å·²ç§»åŠ¨åˆ°åŒæ­¥ä¸å¤‡ä»½èœå• -->
        </div>

        <div class="modal-actions">
                <button class="btn btn-primary" id="confirm-settings-btn">åº”ç”¨</button>
                <button class="btn btn-secondary" id="cancel-settings-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å›æ”¶ç«™ -->
    <div class="recycle-bin">
        <div class="recycle-header">
            <h3>å›æ”¶ç«™</h3>
            <span class="recycle-count" id="recycle-count">0</span>
        </div>
        <div class="recycle-items" id="recycle-items">
            <div style="text-align: center; color: #999; font-size: 0.9rem;">å›æ”¶ç«™ä¸ºç©º</div>
        </div>
        <div class="recycle-footer" style="flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-light);">
            <!-- å·¦ä¾§æ”¶èµ·æŒ‰é’® -->
            <div class="btn-with-tooltip" style="position: relative;">
                <button id="collapse-recycle-btn" style="background: var(--bg-light); border: none; border-radius: var(--radius-small); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <span class="tooltip-text" style="visibility: hidden; opacity: 0; transition: opacity 0.3s; position: absolute; top: 50%; left: 100%; transform: translateY(-50%); margin-left: 5px; padding: 4px 8px; background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 0.75rem; border-radius: 4px; white-space: nowrap; z-index: 1000;">æ”¶èµ·</span>
            </div>
            <!-- å³ä¾§æ¸…ç©ºæŒ‰é’® -->
            <button class="empty-btn" id="empty-recycle-btn" disabled>æ¸…ç©ºå›æ”¶ç«™</button>
        </div>
    </div>
    
    <!-- ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª— -->
    <div class="mobile-recycle-modal" id="mobile-recycle-modal" style="display: none;">
        <div class="mobile-recycle-content">
            <div class="mobile-recycle-header">
                <h3>å›æ”¶ç«™</h3>
                <button class="mobile-recycle-close" id="mobile-recycle-close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="mobile-recycle-body">
                <div class="recycle-filter-buttons" id="mobile-recycle-filter">
                    <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn" data-filter="paper">è®°å½•çº¸</button>
                    <button class="filter-btn" data-filter="notebook">è®°å½•æœ¬</button>
                </div>
                <div class="recycle-items" id="mobile-recycle-items">
                    <div style="text-align: center; color: #999; font-size: 0.9rem;">å›æ”¶ç«™ä¸ºç©º</div>
                </div>
            </div>
            <div class="mobile-recycle-footer">
                <button class="btn btn-secondary" id="mobile-recycle-close-btn">å…³é—­</button>
                <button class="btn btn-danger" id="mobile-empty-recycle-btn" disabled>æ¸…ç©ºå›æ”¶ç«™</button>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºè®°å½•æœ¬æ¨¡æ€æ¡† -->
    <div id="new-notebook-modal" class="modal">
        <div class="modal-content">
            <h3>æ–°å»ºè®°å½•æœ¬</h3>
            <input type="text" id="notebook-title" placeholder="è¯·è¾“å…¥è®°å½•æœ¬æ ‡é¢˜">
            <div class="modal-actions">
                <button class="btn btn-primary" id="confirm-notebook-btn">ç¡®å®š</button>
                <button class="btn btn-secondary" id="cancel-notebook-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† - ç®€åŒ–ç‰ˆæœ¬ -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#fee2e2"/>
                    <path d="M15.5 8.5L8.5 15.5" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15.5 15.5L8.5 8.5" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h3 id="delete-confirm-title" class="delete-confirm-title">ç¡®è®¤åˆ é™¤</h3>
            <p id="delete-confirm-message" class="delete-confirm-message">æ‚¨ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="delete-confirm-actions">
                <button id="delete-cancel-btn" class="delete-confirm-cancel">å–æ¶ˆ</button>
                <button id="delete-confirm-btn" class="delete-confirm-submit">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>

    <!-- æ¢å¤ç¡®è®¤æ¨¡æ€æ¡† - åŸºäºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†æ ·å¼ -->
    <div id="restore-confirm-modal" class="modal">
        <div class="modal-content delete-confirm-content">
            <div class="delete-confirm-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" fill="#dcfce7"/>
                    <path d="M9 12L11 14L15 10" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h3 id="restore-confirm-title" class="delete-confirm-title">ç¡®è®¤æ¢å¤</h3>
            <p id="restore-confirm-message" class="delete-confirm-message">ç¡®å®šè¦æ¢å¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ</p>
            <div class="delete-confirm-actions">
                <button id="restore-cancel-btn" class="delete-confirm-cancel">å–æ¶ˆ</button>
                <button id="restore-confirm-btn" class="delete-confirm-submit">ç¡®è®¤æ¢å¤</button>
            </div>
        </div>
    </div>

    <script>
        // æ•°æ®æ¨¡å‹
        let notebooks = [];
        let currentNotebookId = null;
        let currentPaperId = null;
        let recycleBinData = [];
        
        // åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†ç›¸å…³å˜é‡
        let deleteConfirmCallback = null;
        let deleteConfirmParams = null;
        let templates = {
            'blank': {
                name: 'ç©ºç™½æ¨¡æ¿',
                data: Array(3).fill().map(() => Array(25).fill(''))
            },
            'todo': {
                name: 'å¾…åŠäº‹é¡¹',
                data: [
                    // ç¬¬ä¸€åˆ—ï¼šå¾…åŠäº‹é¡¹
                    Array(25).fill('').map((_, i) => i === 0 ? 'å¾…åŠäº‹é¡¹' : ''),
                    // ç¬¬äºŒåˆ—ï¼šè¿›è¡Œä¸­
                    Array(25).fill('').map((_, i) => i === 0 ? 'è¿›è¡Œä¸­' : ''),
                    // ç¬¬ä¸‰åˆ—ï¼šå·²å®Œæˆ
                    Array(25).fill('').map((_, i) => i === 0 ? 'å·²å®Œæˆ' : '')
                ]
            },
            'notes': {
                name: 'å­¦ä¹ ç¬”è®°',
                data: [
                    // ç¬¬ä¸€åˆ—ï¼šçŸ¥è¯†ç‚¹
                    Array(25).fill('').map((_, i) => i === 0 ? 'çŸ¥è¯†ç‚¹' : ''),
                    // ç¬¬äºŒåˆ—ï¼šé‡ç‚¹
                    Array(25).fill('').map((_, i) => i === 0 ? 'é‡ç‚¹' : ''),
                    // ç¬¬ä¸‰åˆ—ï¼šæ€»ç»“
                    Array(25).fill('').map((_, i) => i === 0 ? 'æ€»ç»“' : '')
                ]
            },
            'meeting': {
                name: 'ä¼šè®®è®°å½•',
                data: [
                    // ç¬¬ä¸€åˆ—ï¼šè®¨è®º
                    Array(25).fill('').map((_, i) => i === 0 ? 'è®¨è®ºå†…å®¹' : ''),
                    // ç¬¬äºŒåˆ—ï¼šå†³è®®
                    Array(25).fill('').map((_, i) => i === 0 ? 'å†³è®®äº‹é¡¹' : ''),
                    // ç¬¬ä¸‰åˆ—ï¼šè¡ŒåŠ¨é¡¹
                    Array(25).fill('').map((_, i) => i === 0 ? 'è¡ŒåŠ¨é¡¹' : '')
                ]
            },
            'speaker': {
                name: 'å­å­çš„å°äºº',
                data: [
                    // ç¬¬ä¸€åˆ—ï¼šé†’æ¥çš„ç¬¬nä¸ªå°æ—¶
                    Array(25).fill('').map((_, i) => i === 0 ? 'é†’æ¥çš„ç¬¬nä¸ªå°æ—¶' : ''),
                    // ç¬¬äºŒåˆ—ï¼šå¹²æ´»å•¦
                    Array(25).fill('').map((_, i) => i === 0 ? 'å¹²æ´»å•¦' : ''),
                    // ç¬¬ä¸‰åˆ—ï¼šåšå®Œäº†æ²¡æœ‰
                    Array(25).fill('').map((_, i) => i === 0 ? 'åšå®Œäº†æ²¡æœ‰' : '')
                ]
            }
        };
        
        // å½“å‰æ ·å¼è®¾ç½®
        let currentStyle = {
            lineStyle: 'dashed',
            lineColor: '#a0d4e6',
            backgroundColor: '#ffffff',
            textAlignment: 'center', // é»˜è®¤å±…ä¸­å¯¹é½
            columnBorderStyle: 'solid' // é»˜è®¤ç«–çº¿æ¡æ ·å¼ä¸ºå®çº¿
        };

        // DOMå…ƒç´ 
        const newPaperBtn = document.getElementById('new-paper-btn');
        const newNotebookBtn = document.getElementById('new-notebook-btn');
        const exportBtn = document.getElementById('export-btn');
        const syncBtn = document.getElementById('sync-btn');
        const templateBtn = document.getElementById('template-btn');
        const papersContainer = document.getElementById('papers-container');
        const notebooksContainer = document.getElementById('notebooks-container');
        const newPaperModal = document.getElementById('new-paper-modal');
        const newNotebookModal = document.getElementById('new-notebook-modal');
        const syncModal = document.getElementById('sync-modal');
        const templateModal = document.getElementById('template-modal');
        const paperMenuModal = document.getElementById('paper-menu');
        const imageModal = document.getElementById('image-modal');
        const richTextModal = document.getElementById('rich-text-modal');
        const tagsModal = document.getElementById('tags-modal');
        const settingsModal = document.getElementById('settings-modal');
        const cancelPaperBtn = document.getElementById('cancel-paper-btn');
        const confirmPaperBtn = document.getElementById('confirm-paper-btn');
        const cancelNotebookBtn = document.getElementById('cancel-notebook-btn');
        const confirmNotebookBtn = document.getElementById('confirm-notebook-btn');
        const cancelSyncBtn = document.getElementById('cancel-sync-btn');
        const cancelTemplateBtn = document.getElementById('cancel-template-btn');
        const confirmTemplateBtn = document.getElementById('confirm-template-btn');
        const closePaperMenuBtn = document.getElementById('close-paper-menu-btn');
        const addImageBtn = document.getElementById('add-image-btn');
        const richTextEditBtn = document.getElementById('rich-text-btn');
        const addTagsBtn = document.getElementById('add-tags-btn');
        const deletePaperBtn = document.getElementById('delete-paper-btn');
        const cancelImageBtn = document.getElementById('cancel-image-btn');
        const confirmImageBtn = document.getElementById('confirm-image-btn');
        
        // æ ·å¼ç›¸å…³DOMå…ƒç´ 
        const settingsBtn = document.getElementById('settings-btn');
        const cancelSettingsBtn = document.getElementById('cancel-settings-btn');
        const confirmSettingsBtn = document.getElementById('confirm-settings-btn');
        const lineStyleOptions = document.querySelectorAll('.line-style-option:not(#column-border-style-options .line-style-option)');
        const columnBorderStyleOptions = document.querySelectorAll('#column-border-style-options .line-style-option');
        const colorOptions = document.querySelectorAll('.color-option:not(.text-color-option)');
        const textColorOptions = document.querySelectorAll('.text-color-option');
        const bgOptions = document.querySelectorAll('.bg-option');
        const applyTextColorCurrentBtn = document.getElementById('apply-text-color-current');
        const applyTextColorAllBtn = document.getElementById('apply-text-color-all');
        
        // å›æ”¶ç«™ç›¸å…³DOMå…ƒç´ 
        const recycleCount = document.getElementById('recycle-count');
        const recycleItems = document.getElementById('recycle-items');
        const emptyRecycleBtn = document.getElementById('empty-recycle-btn');
        const cancelRichTextBtn = document.getElementById('cancel-rich-text-btn');
        const confirmRichTextBtn = document.getElementById('confirm-rich-text-btn');
        const cancelTagsBtn = document.getElementById('cancel-tags-btn');
        const confirmTagsBtn = document.getElementById('confirm-tags-btn');
        const paperTitle = document.getElementById('paper-title');
        const notebookTitle = document.getElementById('notebook-title');
        const templatePaperTitle = document.getElementById('template-paper-title');
        const paperTagsInput = document.getElementById('paper-tags');
        const editPaperTagsInput = document.getElementById('edit-paper-tags');
        const imageColumnSelect = document.getElementById('image-column');
        const imageRowSelect = document.getElementById('image-row');
        const imageUrlInput = document.getElementById('image-url');
        const richTextColumnSelect = document.getElementById('rich-text-column');
        const richTextRowSelect = document.getElementById('rich-text-row');
        const richTextContent = document.getElementById('rich-text-content');
        const formatBoldBtn = document.getElementById('format-bold');
        const formatItalicBtn = document.getElementById('format-italic');
        const formatUnderlineBtn = document.getElementById('format-underline');
        const formatColorSelect = document.getElementById('format-color');
        const templateItems = document.querySelectorAll('.template-item');
        let selectedTemplate = 'blank';

        // æ·»åŠ é˜²æŠ–å‡½æ•°ä»¥æé«˜æ–¹å‘æ£€æµ‹çš„å¯é æ€§
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
        function isMobile() {
            // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·ä»£ç†å­—ç¬¦ä¸²æ£€æµ‹ç§»åŠ¨è®¾å¤‡
            const isMobileUA = /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            // ç»“åˆè®¾å¤‡ç‰¹æ€§æ£€æµ‹
            const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isSmallScreen = window.innerWidth <= 1024;
            
            // åŸºäºç”¨æˆ·ä»£ç†å’Œè®¾å¤‡ç‰¹æ€§çš„ç»¼åˆåˆ¤æ–­
            return isMobileUA || (hasTouch && isSmallScreen);
        }
        
        // æ£€æµ‹å¹¶å¤„ç†å±å¹•æ–¹å‘ï¼Œç‰¹åˆ«æ˜¯æ›´æ–°å›æ”¶ç«™UI
        function checkScreenOrientation() {
            const isPortrait = window.innerHeight > window.innerWidth;
            const isMobileDevice = isMobile();
            const mobileRecycleModal = document.getElementById('mobile-recycle-modal');
            const recycleBin = document.querySelector('.recycle-bin');
            
            // ç¡®ä¿ä¸¤ä¸ªå…ƒç´ éƒ½å­˜åœ¨
            if (!mobileRecycleModal || !recycleBin) return;
            
            // æ›´å‡†ç¡®åœ°æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å›æ”¶ç«™ç•Œé¢åœ¨æ˜¾ç¤º
            const isMobileRecycleVisible = mobileRecycleModal.style.display !== 'none' && 
                                          mobileRecycleModal.style.visibility !== 'hidden';
            const isSidebarRecycleVisible = recycleBin.style.display && recycleBin.style.display !== 'none';
            const isRecycleBinVisible = isMobileRecycleVisible || isSidebarRecycleVisible;
            
            // åªæœ‰åœ¨å›æ”¶ç«™ç•Œé¢å½“å‰å¯è§çš„æƒ…å†µä¸‹æ‰æ›´æ–°å¸ƒå±€
            if (isRecycleBinVisible) {
                if (isMobileDevice && isPortrait) {
                    // ç§»åŠ¨è®¾å¤‡ä¸”ç«–å±æ—¶ï¼šæ˜¾ç¤ºç§»åŠ¨ç«¯å¼¹çª—å¼å›æ”¶ç«™
                    mobileRecycleModal.style.display = 'flex';
                    mobileRecycleModal.style.visibility = 'visible';
                    mobileRecycleModal.style.pointerEvents = 'auto';
                    recycleBin.style.display = 'none';
                    
                    // æ›´æ–°ç§»åŠ¨ç«¯å›æ”¶ç«™å†…å®¹
                    if (typeof window.updateMobileRecycleBin === 'function') {
                        window.updateMobileRecycleBin();
                    }
                } else {
                    // åœ¨PCç«¯æˆ–ç§»åŠ¨è®¾å¤‡æ¨ªå±æ—¶æ˜¾ç¤ºåŸå§‹å›æ”¶ç«™ï¼Œéšè—ç§»åŠ¨ç«¯å¼¹çª—
                    recycleBin.style.display = 'flex';
                    
                    // å®Œå…¨æ¸…ç©ºæ‰€æœ‰å¯èƒ½è¦†ç›–CSSçš„å†…è”æ ·å¼
                    const allProperties = ['height', 'width', 'position', 'left', 'top', 'right', 'bottom', 'zIndex', 'flexDirection', 'padding', 'margin', 'backgroundColor', 'borderRadius', 'boxShadow', 'border'];
                    allProperties.forEach(prop => {
                        recycleBin.style[prop] = '';
                    });
                    
                    // ä¸ºå†…å®¹åŒºåŸŸä¹Ÿæ¸…ç©ºå†…è”æ ·å¼ï¼Œç¡®ä¿CSSå®Œå…¨æ§åˆ¶
                    const recycleItems = recycleBin.querySelector('.recycle-items');
                    if (recycleItems) {
                        ['overflowY', 'minHeight', 'maxHeight', 'flex', 'padding', 'margin'].forEach(prop => {
                            recycleItems.style[prop] = '';
                        });
                    }
                    
                    // ç¡®ä¿ç§»åŠ¨ç«¯å¼¹çª—å®Œå…¨éšè—
                    mobileRecycleModal.style.display = 'none';
                    mobileRecycleModal.style.visibility = 'hidden';
                    mobileRecycleModal.style.pointerEvents = 'none';
                }
            }
        }
        
        // åˆ›å»ºé˜²æŠ–ç‰ˆæœ¬çš„æ–¹å‘æ£€æµ‹å‡½æ•°ï¼Œå¢åŠ å»¶è¿Ÿä»¥æé«˜å¯é æ€§
        const debouncedCheckScreenOrientation = debounce(checkScreenOrientation, 200);
        
        // å¤„ç†è·³è¿‡æ¨ªå±æç¤º
        function handleSkipOrientationPrompt(option) {
            // ç”±äºå±å¹•æ—‹è½¬æç¤ºè¦†ç›–å±‚å·²è¢«ç§»é™¤ï¼Œæ­¤å‡½æ•°åªä¿ç•™"ä¸å†æç¤º"çš„åŠŸèƒ½
            if (option === 'forever') {
                localStorage.setItem('skipOrientationPrompt', 'true');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // ä»localStorageåŠ è½½æ•°æ®
            loadFromLocalStorage();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å›æ”¶ç«™æ•°æ®
            const savedRecycleBin = localStorage.getItem('recycleBinData');
            if (savedRecycleBin) {
                recycleBinData = JSON.parse(savedRecycleBin);
            }
            
            // åˆå§‹åŒ–ç­›é€‰ç±»å‹
            window.recycleFilterType = 'all'; // 'all', 'paper', 'notebook'
            
            // æ›´æ–°å›æ”¶ç«™UI
            updateRecycleBinUI();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ ·å¼è®¾ç½®
            const savedStyle = localStorage.getItem('currentStyle');
            if (savedStyle) {
                currentStyle = JSON.parse(savedStyle);
            }
            
            renderNotebooksList();
            if (notebooks.length > 0) {
                switchToNotebook(notebooks[0].id);
            }
            setupEventListeners();
            
            // æ·»åŠ è·³è¿‡é€‰é¡¹æŒ‰é’®äº‹ä»¶ç›‘å¬
            const skipOnceBtn = document.getElementById('orientation-skip-once');
            const skipForeverBtn = document.getElementById('orientation-skip-forever');
            
            if (skipOnceBtn) {
                skipOnceBtn.addEventListener('click', function() {
                    handleSkipOrientationPrompt('once');
                });
            }
            
            if (skipForeverBtn) {
                skipForeverBtn.addEventListener('click', function() {
                    handleSkipOrientationPrompt('forever');
                });
            }
            
            // åº”ç”¨ä¿å­˜çš„ä¸»é¢˜è®¾ç½®
            applyThemeToUI();
            
            // åˆå§‹åŒ–å±å¹•æ–¹å‘æ£€æµ‹
            checkScreenOrientation();
            window.addEventListener('resize', debouncedCheckScreenOrientation);
            window.addEventListener('orientationchange', debouncedCheckScreenOrientation);
            // ä¸ºäº†ç¡®ä¿åœ¨ä»æ¨ªå±è¿”å›ç«–å±æ—¶èƒ½æ­£ç¡®æ£€æµ‹ï¼Œé¢å¤–æ·»åŠ ä¸€ä¸ªå®šæ—¶å™¨æ£€æŸ¥
            let orientationCheckTimer;
            function startOrientationCheckTimer() {
                if (orientationCheckTimer) clearInterval(orientationCheckTimer);
                orientationCheckTimer = setInterval(() => {
                    checkScreenOrientation();
                }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
            }
            
            function stopOrientationCheckTimer() {
                if (orientationCheckTimer) {
                    clearInterval(orientationCheckTimer);
                    orientationCheckTimer = null;
                }
            }
            
            // åœ¨æ–¹å‘å˜åŒ–æ—¶å¯åŠ¨çŸ­æš‚çš„è¿ç»­æ£€æŸ¥
            window.addEventListener('orientationchange', () => {
                startOrientationCheckTimer();
                // å»¶é•¿æ£€æŸ¥æ—¶é—´åˆ°5ç§’ï¼Œç¡®ä¿å¤æ‚æ–¹å‘å˜åŒ–ä¹Ÿèƒ½æ­£ç¡®æ£€æµ‹
                setTimeout(stopOrientationCheckTimer, 5000);
            });
            
            // æ·»åŠ é¢å¤–çš„æ£€æŸ¥æœºåˆ¶ï¼Œä¸“é—¨å¤„ç†ä»æ¨ªå±åˆ°ç«–å±çš„è½¬æ¢
            let lastOrientation = window.innerHeight > window.innerWidth; // åˆå§‹æ–¹å‘
            window.addEventListener('resize', () => {
                const currentOrientation = window.innerHeight > window.innerWidth;
                // æ£€æµ‹ä»æ¨ªå±åˆ°ç«–å±çš„è½¬æ¢
                if (!lastOrientation && currentOrientation) {
                    // è¿ç»­æ£€æŸ¥å¤šæ¬¡ä»¥ç¡®ä¿æ­£ç¡®æ£€æµ‹
                    let counter = 0;
                    const transitionCheckInterval = setInterval(() => {
                        checkScreenOrientation();
                        counter++;
                        if (counter >= 5) {
                            clearInterval(transitionCheckInterval);
                        }
                    }, 200);
                }
                lastOrientation = currentOrientation;
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // åˆå§‹åŒ–åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            initDeleteConfirmModal();
            // åˆå§‹åŒ–æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
            initRestoreConfirmModal();
            
            // æ¨¡æ¿é€‰æ‹©åŠŸèƒ½
            templateItems.forEach(item => {
                item.addEventListener('click', function() {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºé”å®šçš„æ¨¡æ¿
                    if (this.classList.contains('locked')) {
                        showToast('æœ¬åœ°åº”ç”¨å·²ç¦ç”¨è¯¥æ¨¡æ¿');
                        return;
                    }
                    
                    templateItems.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedTemplate = this.dataset.template;
                });
            });

            // æ‰“å¼€æ¨¡æ¿é€‰æ‹©æ¨¡æ€æ¡†
            templateBtn.addEventListener('click', function() {
                templatePaperTitle.value = '';
                templateModal.style.display = 'flex';
                
                // å¦‚æœæœ‰æ¨¡æ¿é¡¹ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ¨¡æ¿
                if (templateItems.length > 0) {
                    // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªéé”å®šçš„æ¨¡æ¿
                    let firstAvailableTemplate = null;
                    templateItems.forEach(item => {
                        if (!item.classList.contains('locked') && !firstAvailableTemplate) {
                            firstAvailableTemplate = item;
                        }
                        item.classList.remove('selected');
                    });
                    
                    if (firstAvailableTemplate) {
                        selectedTemplate = firstAvailableTemplate.dataset.template;
                        firstAvailableTemplate.classList.add('selected');
                    } else {
                        selectedTemplate = '';
                    }
                } else {
                    selectedTemplate = '';
                }
            });

            // ç¡®è®¤åˆ›å»ºå¸¦æ¨¡æ¿çš„è®°å½•çº¸
            confirmTemplateBtn.addEventListener('click', function() {
                const title = templatePaperTitle.value.trim();
                if (!title) {
                    // å¦‚æœæ ‡é¢˜ä¸ºç©ºï¼Œæç¤ºç”¨æˆ·è¾“å…¥
                    alert('è¯·è¾“å…¥è®°å½•çº¸æ ‡é¢˜ï¼');
                    templatePaperTitle.focus();
                    return;
                }
                createPaperWithTemplate(title, selectedTemplate);
                templateModal.style.display = 'none';
            });
            
            // è®°å½•çº¸å¿«æ·åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            papersContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-btn')) {
                    const paperId = e.target.closest('.paper').dataset.paperId;
                    moveToRecycleBin(paperId);
                }
            });
            
            // è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            settingsBtn.addEventListener('click', function() {
                showSettingsModal();
            });
            
            // åˆå§‹åŒ–å­˜å‚¨è®¾ç½®ç›¸å…³äº‹ä»¶
            const changeStoragePathBtn = document.getElementById('change-storage-path');
            const storagePathInput = document.getElementById('storage-path');
            
            if (changeStoragePathBtn && storagePathInput) {
                // å°è¯•ä»localStorageè¯»å–ä¸Šæ¬¡ä¿å­˜çš„å­˜å‚¨è·¯å¾„
                const savedStoragePath = localStorage.getItem('threeGridStoragePath');
                if (savedStoragePath) {
                    storagePathInput.value = savedStoragePath;
                }
                
                changeStoragePathBtn.addEventListener('click', function() {
                    // åˆ›å»ºç›®å½•é€‰æ‹©å™¨
                    const dirInput = document.createElement('input');
                    dirInput.type = 'file';
                    dirInput.style.display = 'none';
                    dirInput.webkitdirectory = true; // å¯ç”¨ç›®å½•é€‰æ‹©
                    dirInput.multiple = false;
                    
                    dirInput.addEventListener('change', function(e) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©ç›®å½•
                        if (e.target.files && e.target.files.length > 0) {
                            // è·å–é€‰æ‹©çš„ç›®å½•è·¯å¾„
                            // åœ¨ä¸åŒæµè§ˆå™¨ä¸­ï¼Œæ–‡ä»¶è·¯å¾„çš„è·å–æ–¹å¼å¯èƒ½ä¸åŒ
                            const file = e.target.files[0];
                            let dirPath = file.webkitRelativePath ? 
                                file.webkitRelativePath.split('/')[0] : file.name;
                            
                            // å¯¹äºæ”¯æŒçš„æµè§ˆå™¨ï¼Œå°è¯•è·å–å®Œæ•´è·¯å¾„ä¿¡æ¯
                            if (file.webkitRelativePath && file.webkitRelativePath.includes('/')) {
                                // æ„å»ºæ¨¡æ‹Ÿçš„å®Œæ•´è·¯å¾„æ˜¾ç¤º
                                dirPath = 'ç”¨æˆ·é€‰æ‹©çš„ç›®å½•/' + dirPath;
                            }
                            
                            // æ›´æ–°è¾“å…¥æ¡†æ˜¾ç¤º
                            storagePathInput.value = dirPath;
                            
                            // ä¿å­˜é€‰æ‹©çš„è·¯å¾„åˆ°localStorage
                            localStorage.setItem('threeGridStoragePath', dirPath);
                            
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            showToast('å­˜å‚¨ç›®å½•å·²æ›´æ–°ï¼š' + dirPath);
                        }
                    });
                    
                    document.body.appendChild(dirInput);
                    dirInput.click();
                    
                    // ç§»é™¤ä¸´æ—¶å…ƒç´ 
                    setTimeout(() => {
                        document.body.removeChild(dirInput);
                    }, 100);
                });
            }
            
            // æ ·å¼é€‰æ‹©äº‹ä»¶
            lineStyleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    lineStyleOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle.lineStyle = this.dataset.style;
                });
                
                // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºæç¤º
                let pressTimer;
                
                option.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    pressTimer = setTimeout(() => {
                        const label = option.getAttribute('data-label');
                        showToast(label);
                    }, 800); // 800æ¯«ç§’é•¿æŒ‰è§¦å‘
                });
                
                option.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
                
                option.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });
            });
            
            // ç«–çº¿æ¡æ ·å¼é€‰æ‹©äº‹ä»¶
            columnBorderStyleOptions.forEach(option => {
                option.addEventListener('click', function() {
                    columnBorderStyleOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle.columnBorderStyle = this.dataset.style;
                });
                
                // ç§»åŠ¨ç«¯é•¿æŒ‰æ˜¾ç¤ºæç¤º
                let pressTimer;
                
                option.addEventListener('touchstart', (e) => {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                    pressTimer = setTimeout(() => {
                        const label = option.getAttribute('data-label');
                        showToast(label);
                    }, 800); // 800æ¯«ç§’é•¿æŒ‰è§¦å‘
                });
                
                option.addEventListener('touchend', () => {
                    clearTimeout(pressTimer);
                });
                
                option.addEventListener('touchmove', () => {
                    clearTimeout(pressTimer);
                });
            });
            

            
            // é•¿æŒ‰å®šæ—¶å™¨
            let colorLongPressTimer;
            
            colorOptions.forEach(option => {
                // å°†æ¯ä¸ªé€‰é¡¹è®¾ä¸ºç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æç¤ºå…ƒç´ çš„ç»å¯¹å®šä½å‚è€ƒ
                option.style.position = 'relative';
                
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle.lineColor = this.dataset.color;
                });
                
                // é¼ æ ‡æ‚¬åœäº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                option.addEventListener('mouseenter', function() {
                    showColorNameNearOption(this, this.dataset.color);
                });
                
                option.addEventListener('mouseleave', function() {
                    hideColorNameTooltip();
                });
                
                // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                option.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶
                    colorLongPressTimer = setTimeout(() => {
                        showColorNameNearOption(this, this.dataset.color);
                        // 2ç§’åè‡ªåŠ¨éšè—
                        setTimeout(hideColorNameTooltip, 2000);
                    }, 500); // é•¿æŒ‰500æ¯«ç§’æ˜¾ç¤ºé¢œè‰²åç§°
                });
                
                option.addEventListener('touchend', function() {
                    clearTimeout(colorLongPressTimer);
                });
                
                option.addEventListener('touchmove', function() {
                    clearTimeout(colorLongPressTimer);
                    hideColorNameTooltip();
                });
            });
            
            // é¢œè‰²åç§°æ˜ å°„
            const colorNames = {
                // èƒŒæ™¯é¢œè‰²
                '#ffffff': 'ç™½è‰²',
                '#f9f7f1': 'ç±³ç™½',
                '#e6f7ff': 'æµ…è“',
                '#fff7e6': 'æµ…é»„',
                '#f6ffed': 'æµ…ç»¿',
                '#faf5ff': 'æµ…ç´«',
                '#fff5f5': 'æµ…ç²‰',
                '#edf2f7': 'æ·¡ç°',
                '#e6fffa': 'æµ…é’',
                '#f8f5f2': 'æµ…æ£•',
                // çº¿æ¡é¢œè‰²å’Œæ–‡å­—é¢œè‰²
                '#000000': 'é»‘è‰²',
                '#333333': 'ç™½è‰²',
                '#666666': 'ä¸­ç°',
                '#999999': 'æµ…ç°',
                '#ffe4e1': 'æµ…çŠç‘šè‰²',
                '#e0f7fa': 'æµ…é’è‰²',
                '#e8f5e9': 'æµ…ç»¿è‰²',
                '#f3e5f5': 'æµ…ç´«è‰²',
                '#ff6b6b': 'çŠç‘šçº¢',
                '#4ecdc4': 'è–„è·ç»¿',
                '#ffe66d': 'æ·¡é»„è‰²',
                '#667eea': 'é›è“è‰²',
                '#48bb78': 'ç¿ ç»¿',
                '#9f7aea': 'ç´«è‰²',
                '#f56565': 'çº¢è‰²',
                '#ed8936': 'æ©™è‰²',
                '#4a5568': 'æ·±ç°',
                '#ffedcc': 'æµ…æ©™',
                '#ccf6ff': 'å¤©è“',
                '#e5ffcc': 'æµ…ç»¿',
                '#ffcceb': 'ç²‰çº¢',
                '#e6ccff': 'æ·¡ç´«',
                '#f0f0d8': 'æ·¡ç±³',
                '#d9f0ff': 'æµ…è“',
                '#fff5cc': 'æµ…é»„',
                '#ccebff': 'æµ·è“',
                '#ccffec': 'æµ…é’',
                '#2dd4bf': 'é’è‰²',
                '#db2777': 'ç«çº¢',
                '#f97316': 'æ·±æ©™'
            };

            // åˆ›å»ºå’Œæ˜¾ç¤ºé¢œè‰²åç§°æ ‡ç­¾
            function createColorNameTooltip() {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æç¤ºå…ƒç´ 
                let tooltip = document.getElementById('color-name-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.id = 'color-name-tooltip';
                    tooltip.style.cssText = `
                        position: absolute;
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 4px 8px;
                        border-radius: 4px;
                        font-size: 0.85rem;
                        z-index: 1003;
                        pointer-events: none;
                        white-space: nowrap;
                    `;
                    document.body.appendChild(tooltip);
                }
                return tooltip;
            }

            // æ˜¾ç¤ºé¢œè‰²åç§°åœ¨é¢œè‰²é€‰é¡¹æ—è¾¹
            function showColorNameNearOption(option, color) {
                const colorName = colorNames[color] || color;
                const tooltip = createColorNameTooltip();
                tooltip.textContent = colorName;
                
                // è·å–é€‰é¡¹ä½ç½®å¹¶è®¾ç½®æç¤ºä½ç½®
                const rect = option.getBoundingClientRect();
                
                // è€ƒè™‘é¡µé¢æ»šåŠ¨ä½ç½®ï¼Œç¡®ä¿tooltipå§‹ç»ˆæ˜¾ç¤ºåœ¨é¢œè‰²é€‰é¡¹æ—è¾¹
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
                
                // è®¾ç½®tooltipä½ç½®åœ¨é¢œè‰²é€‰é¡¹çš„å³ä¸‹æ–¹
                tooltip.style.top = `${rect.top + scrollTop + 5}px`;
                tooltip.style.left = `${rect.right + scrollLeft + 5}px`;
                tooltip.style.display = 'block';
                
                // ç¡®ä¿åœ¨è§†å£å†…
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.bottom > window.innerHeight) {
                    tooltip.style.top = `${rect.top + scrollTop - tooltipRect.height - 5}px`;
                }
                if (tooltipRect.right > window.innerWidth) {
                    tooltip.style.left = `${rect.left + scrollLeft - tooltipRect.width - 5}px`;
                }
            }

            // éšè—é¢œè‰²åç§°æç¤º
            function hideColorNameTooltip() {
                const tooltip = document.getElementById('color-name-tooltip');
                if (tooltip) {
                    tooltip.style.display = 'none';
                }
            }

            // é•¿æŒ‰å®šæ—¶å™¨
            let longPressTimer;
            
            bgOptions.forEach(option => {
                // å°†æ¯ä¸ªé€‰é¡¹è®¾ä¸ºç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æç¤ºå…ƒç´ çš„ç»å¯¹å®šä½å‚è€ƒ
                option.style.position = 'relative';
                
                option.addEventListener('click', function() {
                    bgOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle.backgroundColor = this.dataset.bg;
                });

                // é¼ æ ‡æ‚¬åœäº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                option.addEventListener('mouseenter', function() {
                    showColorNameNearOption(this, this.dataset.bg);
                });

                option.addEventListener('mouseleave', function() {
                    hideColorNameTooltip();
                });

                // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                option.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶
                    longPressTimer = setTimeout(() => {
                        showColorNameNearOption(this, this.dataset.bg);
                        // 2ç§’åè‡ªåŠ¨éšè—
                        setTimeout(hideColorNameTooltip, 2000);
                    }, 500); // é•¿æŒ‰500æ¯«ç§’æ˜¾ç¤ºé¢œè‰²åç§°
                });

                option.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });

                option.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                    hideColorNameTooltip();
                });
            });

            // é•¿æŒ‰å®šæ—¶å™¨
            let textColorLongPressTimer;
            
            textColorOptions.forEach(option => {
                // å°†æ¯ä¸ªé€‰é¡¹è®¾ä¸ºç›¸å¯¹å®šä½ï¼Œä»¥ä¾¿æç¤ºå…ƒç´ çš„ç»å¯¹å®šä½å‚è€ƒ
                option.style.position = 'relative';
                
                option.addEventListener('click', function() {
                    textColorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
                
                // é¼ æ ‡æ‚¬åœäº‹ä»¶ï¼ˆæ¡Œé¢ç«¯ï¼‰
                option.addEventListener('mouseenter', function() {
                    showColorNameNearOption(this, this.dataset.color);
                });
                
                option.addEventListener('mouseleave', function() {
                    hideColorNameTooltip();
                });
                
                // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                option.addEventListener('touchstart', function(e) {
                    e.preventDefault(); // é˜²æ­¢è§¦å‘å…¶ä»–äº‹ä»¶
                    textColorLongPressTimer = setTimeout(() => {
                        showColorNameNearOption(this, this.dataset.color);
                        // 2ç§’åè‡ªåŠ¨éšè—
                        setTimeout(hideColorNameTooltip, 2000);
                    }, 500); // é•¿æŒ‰500æ¯«ç§’æ˜¾ç¤ºé¢œè‰²åç§°
                });
                
                option.addEventListener('touchend', function() {
                    clearTimeout(textColorLongPressTimer);
                });
                
                option.addEventListener('touchmove', function() {
                    clearTimeout(textColorLongPressTimer);
                    hideColorNameTooltip();
                });
            });
            
            // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°å½“å‰è®°å½•çº¸
            applyTextColorCurrentBtn.addEventListener('click', function() {
                const selectedTextColorOption = document.querySelector('.text-color-option.selected');
                if (selectedTextColorOption) {
                    const color = selectedTextColorOption.dataset.color;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyTextColorToPaper(currentPaper, color);
                        showToast('æ–‡å­—é¢œè‰²å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©æ–‡å­—é¢œè‰²');
                }
            });
            
            // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
            applyTextColorAllBtn.addEventListener('click', function() {
                const selectedTextColorOption = document.querySelector('.text-color-option.selected');
                if (selectedTextColorOption) {
                    const color = selectedTextColorOption.dataset.color;
                    applyTextColorToAllPapers(color);
                    showToast('æ–‡å­—é¢œè‰²å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©æ–‡å­—é¢œè‰²');
                }
            });
            
            // åº”ç”¨è¡Œçº¿æ¡æ ·å¼åˆ°å½“å‰è®°å½•çº¸
            document.getElementById('apply-line-style-current').addEventListener('click', function() {
                const selectedLineStyleOption = document.querySelector('.line-style-option.selected:not(#column-border-style-options .line-style-option)');
                if (selectedLineStyleOption) {
                    const style = selectedLineStyleOption.dataset.style;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyLineStyleToPaper(currentPaper, style);
                        showToast('è¡Œçº¿æ¡æ ·å¼å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©è¡Œçº¿æ¡æ ·å¼');
                }
            });
            
            // åº”ç”¨è¡Œçº¿æ¡æ ·å¼åˆ°æ‰€æœ‰è®°å½•çº¸
            document.getElementById('apply-line-style-all').addEventListener('click', function() {
                const selectedLineStyleOption = document.querySelector('.line-style-option.selected:not(#column-border-style-options .line-style-option)');
                if (selectedLineStyleOption) {
                    const style = selectedLineStyleOption.dataset.style;
                    applyLineStyleToAllPapers(style);
                    showToast('è¡Œçº¿æ¡æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©è¡Œçº¿æ¡æ ·å¼');
                }
            });
            
            // åº”ç”¨ç«–çº¿æ¡æ ·å¼åˆ°å½“å‰è®°å½•çº¸
            document.getElementById('apply-column-style-current').addEventListener('click', function() {
                const selectedColumnStyleOption = document.querySelector('#column-border-style-options .line-style-option.selected');
                if (selectedColumnStyleOption) {
                    const style = selectedColumnStyleOption.dataset.style;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyColumnStyleToPaper(currentPaper, style);
                        showToast('ç«–çº¿æ¡æ ·å¼å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©ç«–çº¿æ¡æ ·å¼');
                }
            });
            
            // åº”ç”¨ç«–çº¿æ¡æ ·å¼åˆ°æ‰€æœ‰è®°å½•çº¸
            document.getElementById('apply-column-style-all').addEventListener('click', function() {
                const selectedColumnStyleOption = document.querySelector('#column-border-style-options .line-style-option.selected');
                if (selectedColumnStyleOption) {
                    const style = selectedColumnStyleOption.dataset.style;
                    applyColumnStyleToAllPapers(style);
                    showToast('ç«–çº¿æ¡æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©ç«–çº¿æ¡æ ·å¼');
                }
            });
            
            // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°å½“å‰è®°å½•çº¸
            document.getElementById('apply-line-color-current').addEventListener('click', function() {
                const selectedColorOption = document.querySelector('.color-option.selected:not(.text-color-option)');
                if (selectedColorOption) {
                    const color = selectedColorOption.dataset.color;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyLineColorToPaper(currentPaper, color);
                        showToast('çº¿æ¡é¢œè‰²å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©çº¿æ¡é¢œè‰²');
                }
            });
            
            // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
            document.getElementById('apply-line-color-all').addEventListener('click', function() {
                const selectedColorOption = document.querySelector('.color-option.selected:not(.text-color-option)');
                if (selectedColorOption) {
                    const color = selectedColorOption.dataset.color;
                    applyLineColorToAllPapers(color);
                    showToast('çº¿æ¡é¢œè‰²å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©çº¿æ¡é¢œè‰²');
                }
            });
            
            // åº”ç”¨èƒŒæ™¯é¢œè‰²åˆ°å½“å‰è®°å½•çº¸
            document.getElementById('apply-bg-color-current').addEventListener('click', function() {
                const selectedBgOption = document.querySelector('.bg-option.selected');
                if (selectedBgOption) {
                    const bgColor = selectedBgOption.dataset.bg;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyBgColorToPaper(currentPaper, bgColor);
                        showToast('èƒŒæ™¯é¢œè‰²å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©èƒŒæ™¯é¢œè‰²');
                }
            });
            
            // åº”ç”¨èƒŒæ™¯é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
            document.getElementById('apply-bg-color-all').addEventListener('click', function() {
                const selectedBgOption = document.querySelector('.bg-option.selected');
                if (selectedBgOption) {
                    const bgColor = selectedBgOption.dataset.bg;
                    applyBgColorToAllPapers(bgColor);
                    showToast('èƒŒæ™¯é¢œè‰²å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                } else {
                    showToast('è¯·å…ˆé€‰æ‹©èƒŒæ™¯é¢œè‰²');
                }
            });
            
            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹éšè—æç¤º
            document.addEventListener('click', function(e) {
                if (!e.target.classList.contains('bg-option') && !e.target.classList.contains('color-option')) {
                    hideColorNameTooltip();
                }
            });

            // å¯¹é½é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            const alignmentOptions = document.querySelectorAll('.alignment-option');
            alignmentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    alignmentOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    currentStyle.textAlignment = this.dataset.alignment;
                });
            });
            
            // æ˜¾ç¤ºç®€å•æç¤ºçš„å‡½æ•°
        window.showToast = function(message) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨toastå…ƒç´ 
            let toast = document.getElementById('style-toast');
            if (toast) {
                document.body.removeChild(toast);
            }
            
            // åˆ›å»ºæ–°çš„toastå…ƒç´  - ç®€æ´é£æ ¼
            toast = document.createElement('div');
            toast.id = 'style-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 30%;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(243, 244, 246, 0.95);
                color: #374151;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 1rem;
                z-index: 1002;
                pointer-events: none;
                opacity: 1;
                border: 1px solid #e5e7eb;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                transition: all 0.2s ease;
            `;
            
            document.body.appendChild(toast);
            
            // 2ç§’åç§»é™¤toast
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                    toast.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(10px)';
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 400);
                }
            }, 2000);
        };
        
        // å…¨å±€å…¨å±ç›¸å…³å‡½æ•° - ç§»åˆ°initMobileOptimizationså¤–éƒ¨ä»¥ç¡®ä¿å…¨å±€å¯è®¿é—®
        // è¯·æ±‚å…¨å±æ˜¾ç¤ºçš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
        window.requestFullscreen = function() {
            if (document.fullscreenElement) {
                console.log('å·²ç»æ˜¯å…¨å±çŠ¶æ€');
                return; // å·²ç»æ˜¯å…¨å±çŠ¶æ€
            }
            
            const docEl = document.documentElement;
            
            if (docEl.requestFullscreen) {
                docEl.requestFullscreen().catch(err => {
                    console.log(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`);
                    // å°è¯•é€šè¿‡ç”¨æˆ·äº¤äº’æ–¹å¼è§¦å‘å…¨å±
                    if (window.setupFullscreenUserInteraction) {
                        window.setupFullscreenUserInteraction();
                    }
                });
            } else if (docEl.webkitRequestFullscreen) { // Safari
                docEl.webkitRequestFullscreen().catch(err => {
                    console.log(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`);
                    if (window.setupFullscreenUserInteraction) {
                        window.setupFullscreenUserInteraction();
                    }
                });
            } else if (docEl.msRequestFullscreen) { // IE11
                try {
                    docEl.msRequestFullscreen();
                } catch (err) {
                    console.log(`å…¨å±è¯·æ±‚å¤±è´¥: ${err.message}`);
                    if (window.setupFullscreenUserInteraction) {
                        window.setupFullscreenUserInteraction();
                    }
                }
            }
        };
        
        // é€€å‡ºå…¨å±æ˜¾ç¤ºçš„å‡½æ•°
        window.exitFullscreen = function() {
            if (!document.fullscreenElement) return; // ä¸æ˜¯å…¨å±çŠ¶æ€
            
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) { // Safari
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { // IE11
                document.msExitFullscreen();
            }
        };
        
        // ç§»åŠ¨ç«¯ä¼˜åŒ–å‡½æ•°
        function initMobileOptimizations() {
            // æ›´å‡†ç¡®åœ°æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
            const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isTablet = window.matchMedia('(max-width: 1024px)').matches;
            const isSmallScreen = window.matchMedia('(max-width: 768px)').matches;
            
            // å¯¹ç§»åŠ¨è®¾å¤‡å’Œå°å±å¹•å¹³æ¿éƒ½åº”ç”¨å…¨å±ä¼˜åŒ–
            if (!isMobile && !isTablet && !isSmallScreen) return;
            
            // æ£€æµ‹å±å¹•æ–¹å‘
            function isPortrait() {
                return window.innerHeight > window.innerWidth;
            }
            
            // è®°å½•é”®ç›˜æ´»åŠ¨çŠ¶æ€
            let isKeyboardActive = false;
            
            // åˆå§‹åŒ–è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬ï¼Œæ£€æµ‹é”®ç›˜çŠ¶æ€
            function setupKeyboardActivityDetection() {
                const inputs = document.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        isKeyboardActive = true;
                    });
                    
                    input.addEventListener('blur', () => {
                        // å»¶è¿Ÿä¸€å°æ®µæ—¶é—´å†è®¾ç½®é”®ç›˜ä¸æ´»åŠ¨ï¼Œç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·
                        setTimeout(() => {
                            isKeyboardActive = false;
                        }, 300);
                    });
                });
            }
            
            // è®¾ç½®ç”¨æˆ·äº¤äº’è§¦å‘å…¨å±çš„æ–¹å¼
            window.setupFullscreenUserInteraction = function() {
                // æ£€æµ‹æ˜¯å¦å·²ç»æ·»åŠ è¿‡ç‚¹å‡»äº‹ä»¶
                if (document.getElementById('fullscreen-overlay')) return;
                
                // åˆ›å»ºä¸€ä¸ªåŠé€æ˜è¦†ç›–å±‚ï¼Œå¼•å¯¼ç”¨æˆ·ç‚¹å‡»ä»¥è¿›å…¥å…¨å±
                const overlay = document.createElement('div');
                overlay.id = 'fullscreen-overlay';
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.right = '0';
                overlay.style.bottom = '0';
                overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                overlay.style.color = 'white';
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.alignItems = 'center';
                overlay.style.justifyContent = 'center';
                overlay.style.zIndex = '9999';
                overlay.style.padding = '20px';
                overlay.style.textAlign = 'center';
                
                overlay.innerHTML = `
                    <h3 style="margin-bottom: 20px;">ç‚¹å‡»è¿›å…¥å…¨å±æ¨¡å¼</h3>
                    <p style="margin-bottom: 30px;">ä¸ºè·å¾—æœ€ä½³ä½“éªŒï¼Œè¯·ç‚¹å‡»è¿›å…¥å…¨å±æ¨¡å¼</p>
                    <button id="enter-fullscreen-btn" style="
                        padding: 12px 24px;
                        background-color: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        font-size: 16px;
                        cursor: pointer;
                        transition: background-color 0.3s;
                    ">
                        è¿›å…¥å…¨å±
                    </button>
                `;
                
                document.body.appendChild(overlay);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                document.getElementById('enter-fullscreen-btn').addEventListener('click', function() {
                    // ç§»é™¤è¦†ç›–å±‚
                    document.body.removeChild(overlay);
                    // é‡æ–°è¯·æ±‚å…¨å±
                    requestFullscreen();
                });
            }
            
            // è®¾ç½®é”®ç›˜æ´»åŠ¨æ£€æµ‹
            setupKeyboardActivityDetection();
            
            // å¤„ç†è¿”å›é”®äº‹ä»¶ï¼Œå®ç°æŒ‰ä¸€æ¬¡é€€å‡ºå…¨å±
            function handleBackButton() {
                // å¦‚æœå½“å‰æ˜¯å…¨å±çŠ¶æ€
                if (document.fullscreenElement) {
                    // æŒ‰ä¸€æ¬¡å°±é€€å‡ºå…¨å±
                    exitFullscreen();
                    
                    // éšè—ç«–å±å…¨å±æç¤º
                    const portraitFullscreenOverlay = document.getElementById('portrait-fullscreen-overlay');
                    if (portraitFullscreenOverlay) {
                        portraitFullscreenOverlay.classList.remove('visible');
                    }
                    
                    // é˜»æ­¢é»˜è®¤è¿”å›è¡Œä¸º
                    return true;
                }
                
                return false;
            }
            
            // è®¾ç½®è¿”å›é”®ç›‘å¬
            function setupBackButtonListener() {
                // ç›‘å¬Androidè®¾å¤‡çš„è¿”å›é”®
                document.addEventListener('backbutton', function(e) {
                    if (handleBackButton()) {
                        e.preventDefault();
                    }
                }, false);
                
                // ç›‘å¬iOSè®¾å¤‡çš„æ‰‹åŠ¿ï¼ˆé€šè¿‡history APIï¼‰
                window.addEventListener('popstate', function(e) {
                    if (handleBackButton()) {
                        history.pushState(null, null, window.location.href);
                    }
                }, false);
                
                // åˆå§‹åŒ–historyçŠ¶æ€
                history.pushState(null, null, window.location.href);
            }
            
            // å¤„ç†å±å¹•æ–¹å‘å˜åŒ–
            function handleOrientationChange() {
                // å¦‚æœé”®ç›˜æ­£åœ¨æ´»åŠ¨ï¼Œä¸è¿›è¡Œå…¨å±çŠ¶æ€åˆ‡æ¢
                if (isKeyboardActive) {
                    console.log('é”®ç›˜æ­£åœ¨æ´»åŠ¨ï¼Œè·³è¿‡å…¨å±çŠ¶æ€åˆ‡æ¢');
                    return;
                }
                
                // æ£€æµ‹æ˜¯å¦åœ¨å¼€å‘æœåŠ¡å™¨ç¯å¢ƒ(localhost)
                const isDevServer = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿æ–¹å‘å˜åŒ–å·²ç»å®Œæˆ
                setTimeout(() => {
                    const currentOrientation = isPortrait();
                    
                    console.log(`å±å¹•æ–¹å‘: ${currentOrientation ? 'ç«–å±' : 'æ¨ªå±'}`);
                    
                    const portraitFullscreenOverlay = document.getElementById('portrait-fullscreen-overlay');
                    
                    if (currentOrientation) {
                        // ç«–å±æ¨¡å¼ï¼šå¦‚æœå½“å‰å·²æ˜¯å…¨å±çŠ¶æ€ï¼Œåˆ™ä¿æŒå…¨å±
                        if (!isDevServer && document.fullscreenElement) {
                            console.log('ç«–å±æ¨¡å¼ï¼šä¿æŒå…¨å±çŠ¶æ€');
                            // ç¡®ä¿ç§»é™¤å¼ºåˆ¶å…¨å±æç¤º
                            if (portraitFullscreenOverlay) {
                                portraitFullscreenOverlay.classList.remove('visible');
                                document.body.classList.remove('portrait-fullscreen-modal-open');
                            }
                        } 
                        // å¦‚æœä¸æ˜¯å…¨å±çŠ¶æ€ï¼Œæ˜¾ç¤ºå¼ºåˆ¶å…¨å±æç¤º
                        else if (!isDevServer && !document.fullscreenElement) {
                            console.log('ç«–å±æ¨¡å¼ï¼šæ˜¾ç¤ºå¼ºåˆ¶å…¨å±æç¤º');
                            if (portraitFullscreenOverlay) {
                                portraitFullscreenOverlay.classList.add('visible');
                                // æ·»åŠ ç±»ç¦æ­¢èƒŒæ™¯æ»šåŠ¨
                                document.body.classList.add('portrait-fullscreen-modal-open');
                            }
                        } else {
                            // å¼€å‘æœåŠ¡å™¨ç¯å¢ƒï¼Œéšè—æç¤º
                            if (portraitFullscreenOverlay) {
                                portraitFullscreenOverlay.classList.remove('visible');
                                // ç§»é™¤ç±»å…è®¸èƒŒæ™¯æ»šåŠ¨
                                document.body.classList.remove('portrait-fullscreen-modal-open');
                            }
                        }
                    } else {
                        // æ¨ªå±æ¨¡å¼ï¼šéšè—ç«–å±å…¨å±æç¤ºå¹¶ç§»é™¤é™åˆ¶ç±»
                        // æ— è®ºä»€ä¹ˆæƒ…å†µï¼Œåœ¨æ¨ªå±æ¨¡å¼ä¸‹éƒ½ç§»é™¤portrait-fullscreen-modal-openç±»
                        document.body.classList.remove('portrait-fullscreen-modal-open');
                        
                        if (portraitFullscreenOverlay) {
                            portraitFullscreenOverlay.classList.remove('visible');
                        }
                        
                        // åœ¨æ¨ªå±æ¨¡å¼ä¸‹ï¼Œä»…åœ¨éå¼€å‘æœåŠ¡å™¨ç¯å¢ƒè¯·æ±‚å…¨å±
                        if (!isDevServer && !document.fullscreenElement) {
                            console.log('æ¨ªå±æ¨¡å¼ï¼šè¯·æ±‚è¿›å…¥å…¨å±');
                            requestFullscreen();
                        }
                    }
                }, 700); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œæé«˜æ–¹å‘åˆ¤æ–­çš„å‡†ç¡®æ€§
            }
            
            // è®¾ç½®ç«–å±å¼ºåˆ¶å…¨å±æŒ‰é’®äº‹ä»¶
            function setupPortraitFullscreenButton() {
                const enterPortraitFullscreenBtn = document.getElementById('enter-portrait-fullscreen-btn');
                const portraitFullscreenOverlay = document.getElementById('portrait-fullscreen-overlay');
                
                if (enterPortraitFullscreenBtn) {
                    enterPortraitFullscreenBtn.addEventListener('click', function() {
                        if (portraitFullscreenOverlay) {
                            portraitFullscreenOverlay.classList.remove('visible');
                            // ç§»é™¤ç±»å…è®¸èƒŒæ™¯æ»šåŠ¨
                            document.body.classList.remove('portrait-fullscreen-modal-open');
                        }
                        
                        // åœ¨ç«–å±æ¨¡å¼ä¸‹ç›´æ¥è¯·æ±‚å…¨å±ï¼Œä¸è¿›è¡Œæ–¹å‘åˆ‡æ¢
                        requestFullscreen();
                    });
                }
            }
            
            // åˆå§‹æ£€æµ‹å¹¶è®¾ç½®
            handleOrientationChange();
            
            // åˆå§‹åŒ–è¿”å›é”®ç›‘å¬
            setupBackButtonListener();
            
            // åˆå§‹åŒ–ç«–å±å…¨å±æŒ‰é’®
            setupPortraitFullscreenButton();
            
            // æ·»åŠ æ–¹å‘å˜åŒ–äº‹ä»¶ç›‘å¬
            window.addEventListener('orientationchange', handleOrientationChange);
            
            // é˜²æŠ–å¤„ç†resizeäº‹ä»¶ï¼Œé¿å…é”®ç›˜è°ƒèµ·æ—¶é¢‘ç¹è§¦å‘
            let orientationChangeTimeout;
            function debouncedOrientationChangeHandler() {
                // å†æ¬¡æ£€æŸ¥é”®ç›˜çŠ¶æ€ï¼Œç¡®ä¿ä¸ä¼šåœ¨é”®ç›˜å¼¹å‡ºæ—¶è§¦å‘å…¨å±åˆ‡æ¢
                if (isKeyboardActive) {
                    console.log('é”®ç›˜æ­£åœ¨æ´»åŠ¨ï¼Œå–æ¶ˆè®¡åˆ’ä¸­çš„å…¨å±çŠ¶æ€åˆ‡æ¢');
                    clearTimeout(orientationChangeTimeout);
                    return;
                }
                
                clearTimeout(orientationChangeTimeout);
                orientationChangeTimeout = setTimeout(handleOrientationChange, 1000); // å¢åŠ é˜²æŠ–å»¶è¿Ÿåˆ°1000ms
            }
            window.addEventListener('resize', debouncedOrientationChangeHandler);
            
            // åŒå‡»å±å¹•å¯ä»¥åˆ‡æ¢å…¨å±çŠ¶æ€ï¼ˆç»™ç”¨æˆ·æ§åˆ¶çš„é€‰é¡¹ï¼‰
            document.addEventListener('dblclick', function(e) {
                // æ’é™¤ç‚¹å‡»åœ¨æŒ‰é’®ã€è¾“å…¥æ¡†ç­‰äº¤äº’å…ƒç´ ä¸Šçš„æƒ…å†µ
                if (e.target.tagName.toLowerCase() === 'button' || 
                    e.target.tagName.toLowerCase() === 'input' || 
                    e.target.tagName.toLowerCase() === 'textarea' || 
                    e.target.closest('.modal') || 
                    e.target.closest('#sidebar-nav')) {
                    return;
                }
                
                if (document.fullscreenElement) {
                    exitFullscreen();
                } else {
                    requestFullscreen();
                }
            });
            
            // ä¼˜åŒ–æ»šåŠ¨è¡Œä¸º - åœ¨æ‰€æœ‰æ–¹å‘ä¸‹æä¾›è‰¯å¥½çš„æ»šåŠ¨ä½“éªŒ
            let scrollStartY = 0;
            let currentScrollTop = 0;
            let isScrolling = false;
            
            // è·å–ä¸»å®¹å™¨å…ƒç´ ï¼Œä½œä¸ºæ¨ªå±æ¨¡å¼ä¸‹çš„ä¸»è¦æ»šåŠ¨å®¹å™¨
            const container = document.querySelector('.container');
            
            // è‡ªå®šä¹‰æ»šåŠ¨è¡Œä¸º - æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬
            function handleVerticalScroll(event) {
                // è·å–å½“å‰å±å¹•æ–¹å‘
                const portrait = isPortrait();
                
                // å¯¹äºç«–å±æ¨¡å¼ï¼Œä½¿ç”¨ç®€å•çš„å¤„ç†é€»è¾‘ä»¥æé«˜æ€§èƒ½
                if (portrait) {
                    if (event.type === 'touchstart') {
                        scrollStartY = event.touches[0].clientY;
                        isScrolling = true;
                        // åªåœ¨ç«–å±æ¨¡å¼ä¸‹è·å–window.scrollY
                        currentScrollTop = window.scrollY;
                    } else if (event.type === 'touchend' || event.type === 'touchcancel') {
                        isScrolling = false;
                    }
                    // å¯¹äºtouchmoveäº‹ä»¶ï¼Œåœ¨ç«–å±æ¨¡å¼ä¸‹å®Œå…¨äº¤ç»™æµè§ˆå™¨åŸç”Ÿå¤„ç†
                    return;
                }
                
                // æ¨ªå±æ¨¡å¼ä¸‹çš„å¤„ç†é€»è¾‘
                // æ£€æŸ¥æ˜¯å¦è§¦æ‘¸åœ¨ä¾§è¾¹æ ä¸Š
                const sidebarNav = document.getElementById('sidebar-nav');
                const touchTarget = document.elementFromPoint(
                    event.type === 'touchmove' ? event.touches[0].clientX : event.clientX,
                    event.type === 'touchmove' ? event.touches[0].clientY : event.clientY
                );
                const isTouchingSidebar = sidebarNav && sidebarNav.contains(touchTarget);
                
                // å¦‚æœè§¦æ‘¸åœ¨ä¾§è¾¹æ ä¸Šï¼Œè®©é»˜è®¤æ»šåŠ¨è¡Œä¸ºå¤„ç†
                if (isTouchingSidebar) {
                    return;
                }
                
                if (event.type === 'touchstart') {
                    scrollStartY = event.touches[0].clientY;
                    // æ¨ªå±æ¨¡å¼ä¸‹è·å–container.scrollTop
                    currentScrollTop = container.scrollTop;
                    isScrolling = true;
                } else if (event.type === 'touchmove' && isScrolling) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ¨¡æ€æ¡†æ˜¾ç¤ºå¹¶è§¦æ‘¸åœ¨æ¨¡æ€æ¡†å†…
                    const visibleModal = document.querySelector('.modal:not([style*="display: none"])');
                    if (visibleModal) {
                        const modalTouchTarget = document.elementFromPoint(
                            event.touches[0].clientX,
                            event.touches[0].clientY
                        );
                        // å¦‚æœè§¦æ‘¸ç›®æ ‡åœ¨æ¨¡æ€æ¡†å†…ï¼Œåˆ™å…è®¸æ»šåŠ¨
                        if (visibleModal.contains(modalTouchTarget)) {
                            return;
                        }
                    }
                    
                    const touchY = event.touches[0].clientY;
                    const scrollDistance = scrollStartY - touchY;
                    
                    // æ¨ªå±æ¨¡å¼ä¿æŒç°æœ‰çš„è‡ªå®šä¹‰æ»šåŠ¨è¡Œä¸º
                    const scrollFactor = 1.8;
                    const enhancedScrollDistance = scrollDistance * scrollFactor;
                    container.scrollTop = currentScrollTop + enhancedScrollDistance;
                    
                    event.preventDefault();
                } else if (event.type === 'touchend' || event.type === 'touchcancel') {
                    isScrolling = false;
                }
            }
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬æ¥ä¼˜åŒ–æ»šåŠ¨
            document.addEventListener('touchstart', handleVerticalScroll, { passive: true });
            
            // ä¼˜åŒ–ç‰ˆ - è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            // æ·»åŠ é˜²æŠ–ï¼Œé¿å…åœ¨æ–¹å‘å˜åŒ–æ—¶é¢‘ç¹è§¦å‘
            let resizeTimeout;
            function setupDynamicScrollListener() {
                // å…ˆç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                document.removeEventListener('touchmove', handleVerticalScroll);
                
                // æ ¹æ®å±å¹•æ–¹å‘è®¾ç½®passiveå±æ€§
                const isPassive = isPortrait();
                document.addEventListener('touchmove', handleVerticalScroll, { passive: isPassive });
            }
            
            // é˜²æŠ–å¤„ç†resizeäº‹ä»¶
            function debouncedResizeHandler() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    setupDynamicScrollListener();
                }, 100); // 100msçš„é˜²æŠ–å»¶è¿Ÿ
            }
            
            // åˆå§‹è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupDynamicScrollListener();
            
            // ç›‘å¬å±å¹•å°ºå¯¸å˜åŒ–å’Œæ–¹å‘å˜åŒ–ï¼ŒåŠ¨æ€è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('resize', debouncedResizeHandler);
            window.addEventListener('orientationchange', debouncedResizeHandler);
            
            document.addEventListener('touchend', handleVerticalScroll, { passive: true });
            document.addEventListener('touchcancel', handleVerticalScroll, { passive: true });
            
            // 1. æ·»åŠ è§¦æ‘¸åé¦ˆä¼˜åŒ–
            document.querySelectorAll('.btn, .cell, .action-btn, .style-option, .bg-option, .color-option').forEach(element => {
                element.style.tapHighlightColor = 'transparent';
                element.style.webkitTapHighlightColor = 'transparent';
                element.style.userSelect = 'none';
                element.style.webkitUserSelect = 'none';
            });
            
            // 2. ä¼˜åŒ–é¡µé¢ç¼©æ”¾æ§åˆ¶ï¼Œåªåœ¨çœŸæ­£éœ€è¦æ—¶é˜²æ­¢é¡µé¢ç¼©æ”¾
            // ä½¿ç”¨passive: trueæ¥æé«˜æ»šåŠ¨æ€§èƒ½
            document.addEventListener('touchmove', function(e) {
                // åªæœ‰åœ¨æ£€æµ‹åˆ°å®é™…ç¼©æ”¾æ“ä½œæ—¶æ‰å°è¯•é˜»æ­¢é»˜è®¤è¡Œä¸º
                // å¹¶ä¸”ç¡®ä¿è¿™ä¸ä¼šå½±å“æ­£å¸¸çš„æ»šåŠ¨ä½“éªŒ
                if (isPortrait() && e.scale !== 1) {
                    try {
                        e.preventDefault();
                    } catch (err) {
                        // åœ¨æŸäº›æµè§ˆå™¨ä¸­ï¼Œpassive: trueçš„ç›‘å¬å™¨è°ƒç”¨preventDefaultä¼šæŠ›å‡ºé”™è¯¯
                        // æˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å¿½ç•¥è¿™äº›é”™è¯¯
                    }
                }
            }, { passive: true });
            
            // 3. ä¼˜åŒ–åŒå‡»ç¼©æ”¾æ§åˆ¶ï¼Œåªåœ¨ç«–å±æ¨¡å¼ä¸‹é˜²æ­¢åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = (new Date()).getTime();
                // åªåœ¨ç«–å±æ¨¡å¼ä¸‹é˜²æ­¢åŒå‡»ç¼©æ”¾ï¼Œä½†å…è®¸ç‚¹å‡»åœ¨paper-titleä¸Šå’Œå›æ”¶ç«™å¼¹çª—å†…çš„åŒå‡»é€šè¿‡
                if (isPortrait() && now - lastTouchEnd <= 300 && !e.target.classList.contains('paper-title') && !e.target.closest('.mobile-recycle-modal')) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // 4. ä¼˜åŒ–è¾“å…¥æ¡†è·å–ç„¦ç‚¹æ—¶çš„è¡Œä¸º
            const inputs = document.querySelectorAll('input, textarea, select');
            
            // æ”¹è¿›çš„æ»šåŠ¨ä½ç½®ç®¡ç†ç³»ç»Ÿ
            let scrollPositions = {}; // å­˜å‚¨æ¯ä¸ªè¾“å…¥æ¡†çš„æ»šåŠ¨ä½ç½®
            let lastActiveInputId = null; // è®°å½•æœ€åæ´»åŠ¨çš„è¾“å…¥æ¡†ID
            let keyboardVisibleStartTime = 0;
            let isScrollingBack = false;
            let keyboardOpenTimeout = null;
            let defaultScrollPosition = 0; // å…¨å±€é»˜è®¤æ»šåŠ¨ä½ç½®å¤‡ä»½
            
            // ä¸ºæ¯ä¸ªè¾“å…¥æ¡†æ·»åŠ å”¯ä¸€IDï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
            inputs.forEach((input, index) => {
                if (!input.id) {
                    input.id = `input-${Date.now()}-${index}`;
                }
            });
            
            // æ·»åŠ å…¨å±€æ»šåŠ¨äº‹ä»¶ç›‘å¬ï¼Œç”¨äºæ›´æ–°é»˜è®¤æ»šåŠ¨ä½ç½®
            window.addEventListener('scroll', function() {
                // åªæœ‰å½“ä¸åœ¨æ»šåŠ¨æ¢å¤è¿‡ç¨‹ä¸­æ—¶æ‰æ›´æ–°é»˜è®¤æ»šåŠ¨ä½ç½®
                if (!isScrollingBack && document.activeElement && 
                    !(document.activeElement.tagName.toLowerCase() === 'input' || 
                      document.activeElement.tagName.toLowerCase() === 'textarea' || 
                      document.activeElement.tagName.toLowerCase() === 'select')) {
                    defaultScrollPosition = window.scrollY;
                }
            }, { passive: true });
            
            // ç›‘å¬è¾“å…¥æ¡†èšç„¦ï¼Œä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            inputs.forEach(input => {
                // ç‚¹å‡»è¾“å…¥æ¡†æ—¶ï¼Œå…ˆæ»šåŠ¨åˆ°å¯è§†åŒºåŸŸ
                input.addEventListener('touchstart', function(e) {
                    // åªåœ¨ç«–å±æ¨¡å¼ä¸‹ä¿å­˜æ»šåŠ¨ä½ç½®
                    if (isPortrait() && !isScrollingBack) {
                        // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„é”®ç›˜æ”¶èµ·è¶…æ—¶
                        if (keyboardOpenTimeout) {
                            clearTimeout(keyboardOpenTimeout);
                            keyboardOpenTimeout = null;
                        }
                        
                        // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®ï¼ˆä¸ºå½“å‰è¾“å…¥æ¡†ä¿å­˜ï¼‰
                        const currentScrollY = window.scrollY;
                        scrollPositions[this.id] = currentScrollY;
                        lastActiveInputId = this.id;
                        
                        // å»¶è¿Ÿæ»šåŠ¨åˆ°è¾“å…¥æ¡†ä½ç½®ï¼Œé¿å…å¿«é€Ÿç‚¹å‡»å¯¼è‡´çš„é—®é¢˜
                        setTimeout(() => {
                            // ç¡®ä¿åœ¨æ»šåŠ¨å‰æ£€æŸ¥æ˜¯å¦ä»éœ€è¦æ»šåŠ¨
                            if (!isScrollingBack && document.activeElement !== this) {
                                const inputRect = this.getBoundingClientRect();
                                // åªæœ‰å½“è¾“å…¥æ¡†ä¸åœ¨å¯è§†åŒºåŸŸä¸­å¿ƒæ—¶æ‰æ»šåŠ¨
                                if (inputRect.top < window.innerHeight * 0.2 || inputRect.bottom > window.innerHeight * 0.8) {
                                    this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }
                        }, 150);
                    }
                });
                
                // ç›‘å¬è¾“å…¥æ¡†èšç„¦äº‹ä»¶ï¼Œæ ‡è®°é”®ç›˜å¯è§çŠ¶æ€
                input.addEventListener('focus', function() {
                    if (isPortrait()) {
                        keyboardVisibleStartTime = Date.now();
                        lastActiveInputId = this.id;
                        
                        // è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œå½“é”®ç›˜é•¿æ—¶é—´æ‰“å¼€æ—¶æ›´æ–°æ»šåŠ¨ä½ç½®
                        keyboardOpenTimeout = setTimeout(() => {
                            // å¦‚æœé”®ç›˜å·²ç»æ‰“å¼€å¾ˆé•¿æ—¶é—´ï¼Œæ›´æ–°ä¿å­˜çš„æ»šåŠ¨ä½ç½®
                            if (document.activeElement === this) {
                                scrollPositions[this.id] = window.scrollY;
                            }
                        }, 1000); // 1ç§’åæ›´æ–°ä½ç½®
                    }
                });
                
                // ç›‘å¬è¾“å…¥æ¡†å¤±ç„¦ï¼Œæ¢å¤æ»šåŠ¨ä½ç½®
                input.addEventListener('blur', function() {
                    // åªåœ¨ç«–å±æ¨¡å¼ä¸‹æ¢å¤ä½ç½®
                    if (isPortrait()) {
                        // æ¸…é™¤é”®ç›˜æ‰“å¼€è¶…æ—¶
                        if (keyboardOpenTimeout) {
                            clearTimeout(keyboardOpenTimeout);
                            keyboardOpenTimeout = null;
                        }
                        
                        // æ£€æŸ¥é”®ç›˜æ‰“å¼€çš„æ—¶é—´ï¼Œé¿å…å¿«é€Ÿç‚¹å‡»/å¤±ç„¦å¯¼è‡´çš„é—®é¢˜
                        const keyboardOpenDuration = Date.now() - keyboardVisibleStartTime;
                        
                        // åªæœ‰å½“é”®ç›˜æ‰“å¼€äº†è¶³å¤Ÿé•¿çš„æ—¶é—´ï¼ˆè¶…è¿‡100msï¼‰æ‰éœ€è¦æ¢å¤ä½ç½®
                        // å¯¹äºå¿«é€Ÿæ”¶èµ·é”®ç›˜çš„æƒ…å†µï¼Œä½¿ç”¨defaultScrollPositionä½œä¸ºåå¤‡
                        if (keyboardOpenDuration > 100) {
                            // æ ‡è®°æ­£åœ¨æ»šåŠ¨å›åŸä½
                            isScrollingBack = true;
                            
                            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·ï¼Œå¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°600ms
                            setTimeout(() => {
                                // æ£€æŸ¥å½“å‰æ˜¯å¦è¿˜æœ‰å…¶ä»–è¾“å…¥æ¡†å¤„äºç„¦ç‚¹çŠ¶æ€
                                const activeElement = document.activeElement;
                                const isAnotherInputFocused = activeElement && 
                                    (activeElement.tagName.toLowerCase() === 'input' || 
                                     activeElement.tagName.toLowerCase() === 'textarea' || 
                                     activeElement.tagName.toLowerCase() === 'select');
                                
                                if (!isAnotherInputFocused) {
                                    // ä½¿ç”¨æœ€åæ´»åŠ¨çš„è¾“å…¥æ¡†IDè·å–æ»šåŠ¨ä½ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤æ»šåŠ¨ä½ç½®
                                    let targetScrollPosition = lastActiveInputId ? scrollPositions[lastActiveInputId] : null;
                                    
                                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ»šåŠ¨ä½ç½®æˆ–é”®ç›˜å¿«é€Ÿæ”¶èµ·ï¼Œä½¿ç”¨å…¨å±€é»˜è®¤æ»šåŠ¨ä½ç½®
                                    if (targetScrollPosition === null || keyboardOpenDuration < 300) {
                                        targetScrollPosition = defaultScrollPosition;
                                    }
                                    
                                    // æ»šåŠ¨å›ä¿å­˜çš„ä½ç½®ï¼Œä½¿ç”¨æ›´å¯é çš„æ–¹å¼
                                    try {
                                        // ç¡®ä¿targetScrollPositionæœ‰æ•ˆ
                                        if (targetScrollPosition !== null && targetScrollPosition >= 0) {
                                            // è·å–å½“å‰æ»šåŠ¨ä½ç½®ï¼Œåªæœ‰å½“å·®å¼‚è¶³å¤Ÿå¤§æ—¶æ‰æ»šåŠ¨
                                            const currentScrollY = window.scrollY;
                                            if (Math.abs(currentScrollY - targetScrollPosition) > 10) {
                                                window.scrollTo({ 
                                                    top: targetScrollPosition, 
                                                    behavior: 'smooth' 
                                                });
                                            }
                                        }
                                    } catch (err) {
                                        console.log('Scroll restoration error:', err);
                                    }
                                }
                                
                                // é‡ç½®çŠ¶æ€æ ‡å¿—ï¼Œå¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿æ»šåŠ¨å®Œæˆ
                                setTimeout(() => {
                                    isScrollingBack = false;
                                }, 600);
                            }, 600); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·å¹¶é¿å…é¡µé¢è·³åŠ¨
                        }
                    }
                });
            });
            
            // 5. ä¸ºå››æ ¼è®°å½•çº¸çš„è¾“å…¥æ¡†æ·»åŠ ç‰¹æ®Šå¤„ç†ï¼ˆè§£å†³ç¼©æ”¾åæ— æ³•è°ƒç”¨é”®ç›˜çš„é—®é¢˜ï¼‰
            // ä¼˜åŒ–å››æ ¼è®°å½•çº¸çš„è§¦æ‘¸äº‹ä»¶å¤„ç†ï¼ŒåŒºåˆ†ç‚¹å‡»å’Œæ»‘åŠ¨æ“ä½œ
            let touchStartTime = 0;
            let touchStartX = 0;
            let touchStartY = 0;
            const CLICK_THRESHOLD = 5; // æ»‘åŠ¨è·ç¦»é˜ˆå€¼ï¼Œå°äºæ­¤å€¼è§†ä¸ºç‚¹å‡»
            const TAP_TIMEOUT = 200; // ç‚¹å‡»æ—¶é—´é˜ˆå€¼ï¼Œå°äºæ­¤å€¼è§†ä¸ºç‚¹å‡»
            
            document.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                const touchEndTime = Date.now();
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                // è®¡ç®—è§¦æ‘¸æ—¶é—´å’Œè·ç¦»
                const touchDuration = touchEndTime - touchStartTime;
                const touchDistanceX = Math.abs(touchEndX - touchStartX);
                const touchDistanceY = Math.abs(touchEndY - touchStartY);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯åœ¨å››æ ¼è®°å½•çº¸ä¸­ç‚¹å‡»äº†è¾“å…¥æ¡†ï¼Œä¸”ç¬¦åˆç‚¹å‡»æ¡ä»¶
                const fourColumnGrid = e.target.closest('.grid-container.four-column');
                const isInputElement = e.target.tagName.toLowerCase() === 'input' || 
                                      e.target.tagName.toLowerCase() === 'textarea' || 
                                      e.target.tagName.toLowerCase() === 'select';
                
                // åªåœ¨ç«–å±æ¨¡å¼ä¸‹å¤„ç†å››æ ¼è®°å½•çº¸çš„è¾“å…¥æ¡†é—®é¢˜ï¼Œä¸”åªæœ‰åœ¨çœŸæ­£çš„ç‚¹å‡»ï¼ˆéæ»‘åŠ¨ï¼‰æ—¶æ‰è§¦å‘
                if (isPortrait() && fourColumnGrid && isInputElement && 
                    touchDuration < TAP_TIMEOUT && 
                    touchDistanceX < CLICK_THRESHOLD && 
                    touchDistanceY < CLICK_THRESHOLD && 
                    !isScrollingBack) {
                    // æ¸…é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„é”®ç›˜æ”¶èµ·è¶…æ—¶
                    if (keyboardOpenTimeout) {
                        clearTimeout(keyboardOpenTimeout);
                        keyboardOpenTimeout = null;
                    }
                    
                    // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                    const currentScrollY = window.scrollY;
                    const inputId = e.target.id || `input-${Date.now()}`;
                    scrollPositions[inputId] = currentScrollY;
                    lastActiveInputId = inputId;
                    keyboardVisibleStartTime = Date.now();
                    
                    // å¼ºåˆ¶è§¦å‘è¾“å…¥æ¡†çš„èšç„¦ï¼Œè§£å†³ç¼©æ”¾åè§¦æ‘¸ä½ç½®ä¸åŒ¹é…çš„é—®é¢˜
                    e.target.focus();
                    
                    // æ»šåŠ¨åˆ°è¾“å…¥æ¡†ä½ç½®
                    setTimeout(() => {
                        // ä½¿ç”¨getBoundingClientRectæ£€æµ‹å…ƒç´ ä½ç½®ï¼Œé¿å…ä¸å¿…è¦çš„æ»šåŠ¨
                        const inputRect = e.target.getBoundingClientRect();
                        if (inputRect.top < window.innerHeight * 0.2 || inputRect.bottom > window.innerHeight * 0.8) {
                            e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        // è®¾ç½®ä¸€ä¸ªè¶…æ—¶ï¼Œå½“é”®ç›˜é•¿æ—¶é—´æ‰“å¼€æ—¶æ›´æ–°æ»šåŠ¨ä½ç½®
                        keyboardOpenTimeout = setTimeout(() => {
                            // å¦‚æœé”®ç›˜å·²ç»æ‰“å¼€å¾ˆé•¿æ—¶é—´ï¼Œæ›´æ–°ä¿å­˜çš„æ»šåŠ¨ä½ç½®
                            if (document.activeElement === e.target) {
                                scrollPositions[inputId] = window.scrollY;
                            }
                        }, 1000); // 1ç§’åæ›´æ–°ä½ç½®
                    }, 150);
                }
            }, { passive: false });
            
            // æ ‡è®°ç”¨æˆ·æ˜¯å¦åœ¨é”®ç›˜æ‰“å¼€æœŸé—´ä¸»åŠ¨æ»‘åŠ¨äº†é¡µé¢
            let userInitiatedScroll = false;
            
            // ç›‘å¬ç”¨æˆ·æ»‘åŠ¨äº‹ä»¶
            document.addEventListener('touchmove', function(e) {
                // åªæœ‰åœ¨é”®ç›˜æ‰“å¼€ä¸”ç”¨æˆ·ä¸»åŠ¨æ»‘åŠ¨æ—¶æ‰è®¾ç½®æ ‡å¿—
                if (isPortrait() && document.activeElement && 
                    (document.activeElement.tagName.toLowerCase() === 'input' || 
                     document.activeElement.tagName.toLowerCase() === 'textarea' || 
                     document.activeElement.tagName.toLowerCase() === 'select') && 
                    !isScrollingBack) {
                    userInitiatedScroll = true;
                }
            }, { passive: true });
            

            
            // æ·»åŠ å…¨å±€ç‚¹å‡»äº‹ä»¶ç›‘å¬ï¼Œç”¨äºæ£€æµ‹ç‚¹å‡»è¾“å…¥æ¡†å¤–åŒºåŸŸå¯¼è‡´é”®ç›˜æ”¶èµ·çš„æƒ…å†µ
            document.addEventListener('touchstart', function(e) {
                // æ£€æŸ¥ç‚¹å‡»ç›®æ ‡æ˜¯å¦ä¸æ˜¯è¾“å…¥æ¡†åŠå…¶çˆ¶å…ƒç´ 
                const isInputElement = e.target.tagName.toLowerCase() === 'input' || 
                                      e.target.tagName.toLowerCase() === 'textarea' || 
                                      e.target.tagName.toLowerCase() === 'select';
                const hasInputParent = e.target.closest('input, textarea, select') !== null;
                
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¾“å…¥æ¡†ï¼Œä¸”å½“å‰æœ‰å…ƒç´ è·å¾—ç„¦ç‚¹
                if (!isInputElement && !hasInputParent && isPortrait() && 
                    document.activeElement && !isScrollingBack) {
                    const activeElement = document.activeElement;
                    const isInputFocused = activeElement && 
                        (activeElement.tagName.toLowerCase() === 'input' || 
                         activeElement.tagName.toLowerCase() === 'textarea' || 
                         activeElement.tagName.toLowerCase() === 'select');
                    
                    // åªæœ‰å½“è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹ä¸”é”®ç›˜æ‰“å¼€äº†è¶³å¤Ÿé•¿æ—¶é—´æ—¶æ‰æ¢å¤ä½ç½®
                    if (isInputFocused) {
                            const keyboardOpenDuration = Date.now() - keyboardVisibleStartTime;
                            
                            if (keyboardOpenDuration > 100) {
                                // æ ‡è®°æ­£åœ¨æ»šåŠ¨å›åŸä½
                                isScrollingBack = true;
                                
                                // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·ï¼Œå¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°600ms
                                setTimeout(() => {
                                    try {
                                        // å¦‚æœç”¨æˆ·ä¸»åŠ¨æ»‘åŠ¨äº†é¡µé¢ï¼Œåˆ™ä¸æ¢å¤æ»šåŠ¨ä½ç½®
                                        if (!userInitiatedScroll) {
                                            // ä½¿ç”¨æœ€åæ´»åŠ¨çš„è¾“å…¥æ¡†IDè·å–æ»šåŠ¨ä½ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤æ»šåŠ¨ä½ç½®
                                            let targetScrollPosition = lastActiveInputId ? scrollPositions[lastActiveInputId] : null;
                                            
                                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ»šåŠ¨ä½ç½®æˆ–é”®ç›˜å¿«é€Ÿæ”¶èµ·ï¼Œä½¿ç”¨å…¨å±€é»˜è®¤æ»šåŠ¨ä½ç½®
                                            if (targetScrollPosition === null || keyboardOpenDuration < 300) {
                                                targetScrollPosition = defaultScrollPosition;
                                            }
                                            
                                            // ç¡®ä¿targetScrollPositionæœ‰æ•ˆ
                                            if (targetScrollPosition !== null && targetScrollPosition >= 0) {
                                                // è·å–å½“å‰æ»šåŠ¨ä½ç½®ï¼Œåªæœ‰å½“å·®å¼‚è¶³å¤Ÿå¤§æ—¶æ‰æ»šåŠ¨
                                                const currentScrollY = window.scrollY;
                                                if (Math.abs(currentScrollY - targetScrollPosition) > 10) {
                                                    window.scrollTo({ 
                                                        top: targetScrollPosition, 
                                                        behavior: 'smooth' 
                                                    });
                                                }
                                            }
                                        }
                                    } catch (err) {
                                        console.log('Scroll restoration error:', err);
                                    }
                                    
                                    // é‡ç½®çŠ¶æ€æ ‡å¿—å’Œç”¨æˆ·æ»‘åŠ¨æ ‡å¿—ï¼Œå¢åŠ å»¶è¿Ÿæ—¶é—´ç¡®ä¿æ»šåŠ¨å®Œæˆ
                                    setTimeout(() => {
                                        isScrollingBack = false;
                                        userInitiatedScroll = false; // é‡ç½®ç”¨æˆ·ä¸»åŠ¨æ»‘åŠ¨æ ‡å¿—
                                    }, 600);
                                }, 600); // å¢åŠ å»¶è¿Ÿæ—¶é—´ï¼Œç¡®ä¿é”®ç›˜å®Œå…¨æ”¶èµ·å¹¶é¿å…é¡µé¢è·³åŠ¨
                            }
                        }
                }
            }, { passive: true });
            
            // 5. ç§»é™¤ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ - æ ¹æ®ç”¨æˆ·éœ€æ±‚
            
            // 6. ä¸ºè®°å½•çº¸å•å…ƒæ ¼æ·»åŠ é•¿æŒ‰æ‰‹åŠ¿æ”¯æŒ
            document.querySelectorAll('.cell').forEach(cell => {
                let longPressTimer;
                
                cell.addEventListener('touchstart', function() {
                    longPressTimer = setTimeout(() => {
                        // è§¦å‘è®°å½•çº¸æ“ä½œèœå•ï¼ˆå¦‚æœå·²å®ç°ï¼‰
                        if (typeof openPaperMenu === 'function') {
                            openPaperMenu(this.closest('.paper'));
                        }
                    }, 800);
                }, { passive: true });
                
                cell.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });
                
                cell.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                });
            });
        }
        
        // ä¾§è¾¹æ å¯¼èˆªåŠŸèƒ½å®ç°
        function initSidebar() {
            const menuBtn = document.getElementById('menu-btn');
            const sidebarNav = document.getElementById('sidebar-nav');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarButtons = document.querySelectorAll('.sidebar-nav .btn');
            
            // åˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º/éšè—
            function toggleSidebar() {
                sidebarNav.classList.toggle('open');
                sidebarOverlay.classList.toggle('visible');
                document.body.style.overflow = sidebarNav.classList.contains('open') ? 'hidden' : '';
            }
            
            // ç»‘å®šæ±‰å ¡èœå•ç‚¹å‡»äº‹ä»¶
            menuBtn.addEventListener('click', toggleSidebar);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­ä¾§è¾¹æ 
            sidebarOverlay.addEventListener('click', toggleSidebar);
            
            // ç‚¹å‡»ä¾§è¾¹æ ä¸­çš„æŒ‰é’®åå…³é—­ä¾§è¾¹æ å¹¶è§¦å‘ç›¸åº”æ“ä½œ
            sidebarButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    toggleSidebar();
                    
                    // ç‰¹æ®Šå¤„ç†å›æ”¶ç«™æŒ‰é’®
                    if (this.id === 'sidebar-recycle-btn') {
                        // æ ¹æ®è®¾å¤‡ç±»å‹å’Œå±å¹•æ–¹å‘æ˜¾ç¤ºä¸åŒçš„å›æ”¶ç«™ç•Œé¢
                        setTimeout(() => {
                            // è·å–ä¸¤ç§å›æ”¶ç«™å…ƒç´ 
                            const mobileRecycleModal = document.getElementById('mobile-recycle-modal');
                            const recycleBin = document.querySelector('.recycle-bin');
                            
                            // æ£€æŸ¥å±å¹•æ–¹å‘
                            const isPortrait = window.innerHeight > window.innerWidth;
                            
                            if (isMobile() && isPortrait) {
                                // åªåœ¨ç§»åŠ¨è®¾å¤‡ä¸”ç«–å±æ—¶æ˜¾ç¤ºå¼¹çª—å¼å›æ”¶ç«™
                                mobileRecycleModal.style.display = 'flex';
                                mobileRecycleModal.style.visibility = 'visible';
                                mobileRecycleModal.style.pointerEvents = 'auto';
                                recycleBin.style.display = 'none';
                                
                                // æ›´æ–°ç§»åŠ¨ç«¯å›æ”¶ç«™å†…å®¹
                                window.updateMobileRecycleBin();
                            } else {
                                // åœ¨PCç«¯æˆ–ç§»åŠ¨è®¾å¤‡æ¨ªå±æ—¶æ˜¾ç¤ºåŸå§‹å›æ”¶ç«™ï¼Œéšè—ç§»åŠ¨ç«¯å¼¹çª—
                                // åªè®¾ç½®æ˜¾ç¤ºå±æ€§ï¼Œå…¶ä»–æ ·å¼å®Œå…¨ç”±CSSåª’ä½“æŸ¥è¯¢æ§åˆ¶
                                recycleBin.style.display = 'flex';
                                
                                // å®Œå…¨æ¸…ç©ºæ‰€æœ‰å¯èƒ½è¦†ç›–CSSçš„å†…è”æ ·å¼
                                const allProperties = ['height', 'width', 'position', 'left', 'top', 'right', 'bottom', 'zIndex', 'flexDirection', 'padding', 'margin', 'backgroundColor', 'borderRadius', 'boxShadow', 'border'];
                                allProperties.forEach(prop => {
                                    recycleBin.style[prop] = '';
                                });
                                
                                // ä¸ºå†…å®¹åŒºåŸŸä¹Ÿæ¸…ç©ºå†…è”æ ·å¼ï¼Œç¡®ä¿CSSå®Œå…¨æ§åˆ¶
                                const recycleItems = recycleBin.querySelector('.recycle-items');
                                if (recycleItems) {
                                    ['overflowY', 'minHeight', 'maxHeight', 'flex', 'padding', 'margin'].forEach(prop => {
                                        recycleItems.style[prop] = '';
                                    });
                                }
                                
                                // åº”ç”¨å½“å‰ä¸»é¢˜æ ·å¼åˆ°å›æ”¶ç«™
                                const currentTheme = localStorage.getItem('threeGridTheme') || 'default';
                                if (currentTheme === 'dark') {
                                    // æš—é»‘ä¸»é¢˜ä¸‹è®¾ç½®å›æ”¶ç«™èƒŒæ™¯è‰²å’Œæ–‡å­—é¢œè‰²
                                    recycleBin.style.backgroundColor = '#2d3748';
                                    recycleBin.style.color = '#e2e8f0';
                                    // ä¸ºå›æ”¶ç«™æ ‡é¢˜è®¾ç½®æ–‡å­—é¢œè‰²
                                    const recycleTitle = recycleBin.querySelector('.recycle-header h3');
                                    if (recycleTitle) {
                                        recycleTitle.style.color = '#e2e8f0';
                                    }
                                    // ä¸ºå›æ”¶ç«™é¡¹ç›®è®¾ç½®èƒŒæ™¯è‰²
                                    const recycleItemElements = recycleBin.querySelectorAll('.recycle-item');
                                    recycleItemElements.forEach(item => {
                                        item.style.backgroundColor = '#4a5568';
                                    });
                                }
                                
                                // ç¡®ä¿ç§»åŠ¨ç«¯å¼¹çª—å®Œå…¨éšè—
                                mobileRecycleModal.style.display = 'none';
                                mobileRecycleModal.style.visibility = 'hidden';
                                mobileRecycleModal.style.pointerEvents = 'none';
                            }
                        }, 300); // ç­‰å¾…ä¾§è¾¹æ å…³é—­åŠ¨ç”»å®Œæˆ
                    } else {
                        // å…¶ä»–æŒ‰é’®ï¼šè§¦å‘åŸæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
                        const originalBtnId = this.id.replace('sidebar-', '');
                        const originalBtn = document.getElementById(originalBtnId);
                        
                        if (originalBtn) {
                            setTimeout(() => {
                                originalBtn.click();
                            }, 300); // ç­‰å¾…ä¾§è¾¹æ å…³é—­åŠ¨ç”»å®Œæˆ
                        }
                    }
                });
            });
        }
        
        // åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            initMobileOptimizations();
            initSidebar();
            
            // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šåˆå§‹åŒ–ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—ï¼ˆæ— è®ºæ¨ªç«–å±ï¼‰
            if (isMobile()) {
                initMobileRecycleBin();
            }
            
            // åˆå§‹åŒ–å¯¹é½æ–¹å¼åº”ç”¨æŒ‰é’®
            initAlignmentApplyButtons();
        });
        
        // åˆå§‹åŒ–ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—
        function initMobileRecycleBin() {
            const mobileRecycleModal = document.getElementById('mobile-recycle-modal');
            const mobileRecycleClose = document.getElementById('mobile-recycle-close');
            const mobileRecycleCloseBtn = document.getElementById('mobile-recycle-close-btn');
            const mobileEmptyRecycleBtn = document.getElementById('mobile-empty-recycle-btn');
            const mobileRecycleFilter = document.getElementById('mobile-recycle-filter');
            const mobileRecycleItems = document.getElementById('mobile-recycle-items');
            
            // å…³é—­å¼¹çª—
            function closeMobileRecycleModal() {
                mobileRecycleModal.style.display = 'none';
            }
            
            // ç»‘å®šå…³é—­æŒ‰é’®äº‹ä»¶
            mobileRecycleClose.addEventListener('click', closeMobileRecycleModal);
            mobileRecycleCloseBtn.addEventListener('click', closeMobileRecycleModal);
            
            // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
            mobileRecycleModal.addEventListener('click', function(e) {
                if (e.target === mobileRecycleModal) {
                    closeMobileRecycleModal();
                }
            });
            
            // æ¸…ç©ºå›æ”¶ç«™æŒ‰é’®äº‹ä»¶
            mobileEmptyRecycleBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºå›æ”¶ç«™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    clearRecycleBin();
                    closeMobileRecycleModal();
                }
            });
            
            // ç­›é€‰æŒ‰é’®äº‹ä»¶
            mobileRecycleFilter.addEventListener('click', function(e) {
                if (e.target.classList.contains('filter-btn')) {
                    // æ›´æ–°æŒ‰é’®é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('#mobile-recycle-filter .filter-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    // åº”ç”¨ç­›é€‰
                    const filterType = e.target.dataset.filter;
                    window.recycleFilterType = filterType;
                    window.updateMobileRecycleBin();
                }
            });
            
            // ç§»åŠ¨ç«¯å›æ”¶ç«™é¡¹ç›®ç‚¹å‡»äº‹ä»¶ï¼ˆæ¢å¤ï¼‰
            mobileRecycleItems.addEventListener('click', function(e) {
                if (e.target.classList.contains('recycle-item') || e.target.closest('.recycle-item')) {
                    const recycleItem = e.target.closest('.recycle-item');
                    const recycleId = recycleItem.dataset.recycleId;
                    // ä½¿ç”¨è‡ªå®šä¹‰æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
                    showRestoreConfirmModal('ç¡®è®¤æ¢å¤', 'ç¡®å®šè¦æ¢å¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ', function() {
                        restoreFromRecycleBin(recycleId);
                        window.updateMobileRecycleBin();
                    });
                }
            });
        }
        
        // æ›´æ–°ç§»åŠ¨ç«¯å›æ”¶ç«™å†…å®¹ - ç»‘å®šåˆ°windowå¯¹è±¡ç¡®ä¿åœ¨ä»»ä½•ä½œç”¨åŸŸéƒ½å¯è®¿é—®
        window.updateMobileRecycleBin = function() {
            const mobileRecycleItems = document.getElementById('mobile-recycle-items');
            const mobileEmptyRecycleBtn = document.getElementById('mobile-empty-recycle-btn');
            
            // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œé¿å…åœ¨PCç«¯æˆ–éç«–å±æ¨¡å¼ä¸‹æŠ¥é”™
            if (!mobileRecycleItems || !mobileEmptyRecycleBtn) {
                return;
            }
            
            // ç¡®ä¿å®¹å™¨æœ‰æ­£ç¡®çš„æ»šåŠ¨æ ·å¼ç±»
            mobileRecycleItems.className = 'recycle-items mobile-recycle-items';
            
            // å¤åˆ¶PCç«¯å›æ”¶ç«™çš„å†…å®¹åˆ°ç§»åŠ¨ç«¯
            const pcRecycleItems = document.getElementById('recycle-items');
            
            // æ¸…ç©ºç§»åŠ¨ç«¯å›æ”¶ç«™
            mobileRecycleItems.innerHTML = '';
            
            // å¦‚æœå›æ”¶ç«™ä¸ºç©º
            if (pcRecycleItems && pcRecycleItems.querySelector('div[style*="text-align: center"]')) {
                mobileRecycleItems.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.9rem;">å›æ”¶ç«™ä¸ºç©º</div>';
                mobileEmptyRecycleBtn.disabled = true;
            } else if (pcRecycleItems) {
                // å¤åˆ¶PCç«¯çš„å›æ”¶ç«™é¡¹ç›®
                const recycleItems = pcRecycleItems.querySelectorAll('.recycle-item');
                recycleItems.forEach(item => {
                    const clonedItem = item.cloneNode(true);
                    mobileRecycleItems.appendChild(clonedItem);
                });
                mobileEmptyRecycleBtn.disabled = false;
            }
            
            // åº”ç”¨ç­›é€‰
            const filterType = window.recycleFilterType || 'all';
            const items = mobileRecycleItems.querySelectorAll('.recycle-item');
            let visibleItemsCount = 0;
            
            items.forEach(item => {
                const itemType = item.querySelector('.recycle-item-type');
                if (!itemType) {
                    item.style.display = 'block';
                    visibleItemsCount++;
                    return;
                }
                
                const isPaper = itemType.classList.contains('paper');
                const isNotebook = itemType.classList.contains('notebook');
                
                if (filterType === 'all' || 
                    (filterType === 'paper' && isPaper) || 
                    (filterType === 'notebook' && isNotebook)) {
                    item.style.display = 'block';
                    visibleItemsCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // å¦‚æœç­›é€‰åæ²¡æœ‰å¯è§é¡¹ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            if (visibleItemsCount === 0 && items.length > 0) {
                mobileRecycleItems.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.9rem;">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®</div>';
            }
            
            // å¼ºåˆ¶é‡æ–°åº”ç”¨æ»šåŠ¨æ ·å¼
            mobileRecycleItems.style.overflowY = 'auto';
            mobileRecycleItems.style.maxHeight = '300px';
            mobileRecycleItems.style['-webkit-overflow-scrolling'] = 'touch';
        };
        

            
            // è®¾ç½®ç¡®è®¤æŒ‰é’®äº‹ä»¶
            confirmSettingsBtn.addEventListener('click', function() {
                applySettings();
                saveStyleToLocalStorage();
                settingsModal.style.display = 'none';
            });
            
            // è®¾ç½®å–æ¶ˆæŒ‰é’®äº‹ä»¶
            cancelSettingsBtn.addEventListener('click', function() {
                settingsModal.style.display = 'none';
            });
            
            // ä¸»é¢˜é€‰é¡¹ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // é€‰é¡¹å¡åˆ‡æ¢äº‹ä»¶
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // æ›´æ–°é€‰é¡¹å¡é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.tab-btn').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”å†…å®¹åŒºåŸŸ
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                    });
                    document.getElementById(`${tabId}-content`).style.display = 'block';
                });
            });
            
            // ç¡®è®¤æ¸…ç©ºå›æ”¶ç«™æ¨¡æ€æ¡†HTML
            const confirmEmptyModalHtml = `
                <div id="confirm-empty-modal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <h3>ç¡®è®¤æ¸…ç©ºå›æ”¶ç«™</h3>
                        <p>ç¡®å®šè¦æ¸…ç©ºå›æ”¶ç«™å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚</p>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="cancel-empty-btn">å–æ¶ˆ</button>
                            <button class="btn btn-primary" id="confirm-empty-btn">ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', confirmEmptyModalHtml);
            
            const confirmEmptyModal = document.getElementById('confirm-empty-modal');
            const cancelEmptyBtn = document.getElementById('cancel-empty-btn');
            const confirmEmptyBtn = document.getElementById('confirm-empty-btn');
            
            // æ¸…ç©ºå›æ”¶ç«™æŒ‰é’®äº‹ä»¶
            emptyRecycleBtn.addEventListener('click', function() {
                confirmEmptyModal.style.display = 'flex';
            });
            
            // å–æ¶ˆæ¸…ç©ºå›æ”¶ç«™
            cancelEmptyBtn.addEventListener('click', function() {
                confirmEmptyModal.style.display = 'none';
            });
            
            // ç¡®è®¤æ¸…ç©ºå›æ”¶ç«™
            confirmEmptyBtn.addEventListener('click', function() {
                confirmEmptyModal.style.display = 'none';
                clearRecycleBin();
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(event) {
                if (event.target === confirmEmptyModal) {
                    confirmEmptyModal.style.display = 'none';
                }
            });
            
            // æ”¶èµ·å›æ”¶ç«™æŒ‰é’®äº‹ä»¶
            const collapseRecycleBtn = document.getElementById('collapse-recycle-btn');
            if (collapseRecycleBtn) {
                // ç‚¹å‡»äº‹ä»¶
                collapseRecycleBtn.addEventListener('click', function() {
                    // åœ¨PCç«¯éšè—å›æ”¶ç«™
                    const recycleBin = document.querySelector('.recycle-bin');
                    recycleBin.style.display = 'none';
                });
                
                // é¼ æ ‡æ‚¬åœæç¤º
                const tooltip = collapseRecycleBtn.nextElementSibling;
                collapseRecycleBtn.addEventListener('mouseenter', function() {
                    tooltip.style.visibility = 'visible';
                    tooltip.style.opacity = '1';
                });
                collapseRecycleBtn.addEventListener('mouseleave', function() {
                    tooltip.style.visibility = 'hidden';
                    tooltip.style.opacity = '0';
                });
                
                // ç§»åŠ¨ç«¯é•¿æŒ‰æç¤ºå’Œç‚¹å‡»æ”¯æŒ
                let longPressTimer;
                collapseRecycleBtn.addEventListener('touchstart', function(e) {
                    // ç§»é™¤preventDefaultï¼Œå…è®¸ç‚¹å‡»äº‹ä»¶æ­£å¸¸è§¦å‘
                    longPressTimer = setTimeout(() => {
                        tooltip.style.visibility = 'visible';
                        tooltip.style.opacity = '1';
                        setTimeout(() => {
                            tooltip.style.visibility = 'hidden';
                            tooltip.style.opacity = '0';
                        }, 2000); // 2ç§’åè‡ªåŠ¨éšè—
                    }, 500); // 500æ¯«ç§’é•¿æŒ‰è§¦å‘
                });
                collapseRecycleBtn.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                });
                collapseRecycleBtn.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                });
                collapseRecycleBtn.addEventListener('touchcancel', function() {
                    clearTimeout(longPressTimer);
                });
            }
            
            // å›æ”¶ç«™é¡¹ç›®ç‚¹å‡»äº‹ä»¶ï¼ˆæ¢å¤ï¼‰
            recycleItems.addEventListener('click', function(e) {
                if (e.target.classList.contains('recycle-item') || e.target.closest('.recycle-item')) {
                    const recycleItem = e.target.closest('.recycle-item');
                    const recycleId = recycleItem.dataset.recycleId;
                    // ä½¿ç”¨è‡ªå®šä¹‰æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
                    showRestoreConfirmModal('ç¡®è®¤æ¢å¤', 'ç¡®å®šè¦æ¢å¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ', function() {
                        restoreFromRecycleBin(recycleId);
                    });
                }
            });
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteConfirmModal(title, message, callback, params = null) {
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmTitle = document.getElementById('delete-confirm-title');
            const deleteConfirmMessage = document.getElementById('delete-confirm-message');
            
            // é‡ç½®çŠ¶æ€
            deleteConfirmCallback = callback;
            deleteConfirmParams = params;
            
            // è®¾ç½®å†…å®¹
            deleteConfirmTitle.textContent = title;
            deleteConfirmMessage.textContent = message;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            deleteConfirmModal.style.display = 'flex';
        }
        
        // å…¨å±€å˜é‡ç”¨äºæ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
        let restoreConfirmCallback = null;
        let restoreConfirmParams = null;
        
        // æ˜¾ç¤ºæ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
        function showRestoreConfirmModal(title, message, callback, params = null) {
            const restoreConfirmModal = document.getElementById('restore-confirm-modal');
            const restoreConfirmTitle = document.getElementById('restore-confirm-title');
            const restoreConfirmMessage = document.getElementById('restore-confirm-message');
            
            // é‡ç½®çŠ¶æ€
            restoreConfirmCallback = callback;
            restoreConfirmParams = params;
            
            // è®¾ç½®å†…å®¹
            restoreConfirmTitle.textContent = title;
            restoreConfirmMessage.textContent = message;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            restoreConfirmModal.style.display = 'flex';
        }
        
        // åˆå§‹åŒ–åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†äº‹ä»¶
        function initDeleteConfirmModal() {
            const deleteConfirmModal = document.getElementById('delete-confirm-modal');
            const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
            const deleteCancelBtn = document.getElementById('delete-cancel-btn');
            const modalContent = deleteConfirmModal.querySelector('.modal-content');
            
            // ç¡®è®¤åˆ é™¤
            deleteConfirmBtn.addEventListener('click', function() {
                if (typeof deleteConfirmCallback === 'function') {
                    deleteConfirmCallback(deleteConfirmParams);
                }
                deleteConfirmModal.style.display = 'none';
            });
            
            // å–æ¶ˆåˆ é™¤
            deleteCancelBtn.addEventListener('click', function() {
                deleteConfirmModal.style.display = 'none';
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            deleteConfirmModal.addEventListener('click', function(e) {
                if (e.target === deleteConfirmModal) {
                    deleteConfirmModal.style.display = 'none';
                }
            });
            
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // åˆå§‹åŒ–æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†äº‹ä»¶
        function initRestoreConfirmModal() {
            const restoreConfirmModal = document.getElementById('restore-confirm-modal');
            const restoreConfirmBtn = document.getElementById('restore-confirm-btn');
            const restoreCancelBtn = document.getElementById('restore-cancel-btn');
            const modalContent = restoreConfirmModal.querySelector('.modal-content');
            
            // ç¡®è®¤æ¢å¤
            restoreConfirmBtn.addEventListener('click', function() {
                if (typeof restoreConfirmCallback === 'function') {
                    restoreConfirmCallback(restoreConfirmParams);
                }
                restoreConfirmModal.style.display = 'none';
            });
            
            // å–æ¶ˆæ¢å¤
            restoreCancelBtn.addEventListener('click', function() {
                restoreConfirmModal.style.display = 'none';
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            restoreConfirmModal.addEventListener('click', function(e) {
                if (e.target === restoreConfirmModal) {
                    restoreConfirmModal.style.display = 'none';
                }
            });
            
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // ä½¿ç”¨æ¨¡æ¿åˆ›å»ºè®°å½•çº¸
        function createPaperWithTemplate(title, templateId) {
            // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•æœ¬
            if (notebooks.length === 0) {
                showToast('è¯·å…ˆåˆ›å»ºä¸€ä¸ªè®°å½•æœ¬');
                return;
            }
            
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;

            // è·å–æ¨¡æ¿æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤çš„ç©ºç™½æ•°æ®ç»“æ„
            const template = templates[templateId] || {
                name: 'è‡ªå®šä¹‰æ¨¡æ¿',
                data: Array(3).fill().map(() => Array(25).fill(''))
            };
            
            // ä¸ºä¸åŒæ¨¡æ¿è®¾ç½®ç‰¹å®šçš„æ ·å¼
            let templateStyle = { ...currentStyle };
            
            switch(templateId) {
                case 'todo':
                    templateStyle = {
                        ...currentStyle,
                        lineStyle: 'dashed',
                        lineColor: '#5cb85c', // ç»¿è‰²
                        backgroundColor: '#f9fff9',
                        columnBorderStyle: 'solid'
                    };
                    break;
                case 'notes':
                    templateStyle = {
                        ...currentStyle,
                        lineStyle: 'dotted',
                        lineColor: '#337ab7', // è“è‰²
                        backgroundColor: '#f0f7ff',
                        columnBorderStyle: 'solid'
                    };
                    break;
                case 'meeting':
                    templateStyle = {
                        ...currentStyle,
                        lineStyle: 'solid',
                        lineColor: '#f0ad4e', // æ©™è‰²
                        backgroundColor: '#fff9f0',
                        columnBorderStyle: 'solid'
                    };
                    break;
                case 'speaker':
                    templateStyle = {
                        ...currentStyle,
                        lineStyle: 'solid',
                        lineColor: '#333333',
                        backgroundColor: '#ffffff',
                        textAlignment: 'center',
                        columnBorderStyle: 'solid',
                        backgroundImage: 'speaker' // ç›´æ¥è®¾ç½®backgroundImageå±æ€§
                    };
                    break;
                default:
                    // å…¶ä»–æ¨¡æ¿æˆ–é»˜è®¤æƒ…å†µä½¿ç”¨å½“å‰æ ·å¼è®¾ç½®
                    templateStyle = { ...currentStyle };
                    break;
            }
            
            const newPaper = {
                id: Date.now().toString(),
                title: title,
                date: new Date().toLocaleDateString('zh-CN'),
                data: JSON.parse(JSON.stringify(template.data)),
                style: templateStyle // åº”ç”¨æ¨¡æ¿ç‰¹å®šçš„æ ·å¼è®¾ç½®
            };

            currentNotebook.papers.unshift(newPaper);
            currentNotebook.updatedAt = new Date().toISOString(); // æ›´æ–°ä¿®æ”¹æ—¶é—´
            debouncedSaveToLocalStorage();
            renderPapers();
        }

        // æ‰“å¼€æœ¬åœ°å¤‡ä»½ä¸æ¢å¤æ¨¡æ€æ¡† - æ§åˆ¶æ æŒ‰é’®
        syncBtn.addEventListener('click', function() {
            // ä¸ºç¡®ä¿å¼¹çª—æ˜¾ç¤ºåœ¨æœ€é¡¶å±‚ï¼Œè®¾ç½®æ›´é«˜çš„z-indexå€¼
            syncModal.style.zIndex = '1005';
            syncModal.style.display = 'flex';
        });
        
        // ä¾§è¾¹æ åŒæ­¥æŒ‰é’®çš„äº‹ä»¶å¤„ç†ç”±initSidebarå‡½æ•°ç»Ÿä¸€å¤„ç†ï¼Œæ— éœ€å•ç‹¬ç»‘å®š

        // æ ‡ç­¾ç³»ç»Ÿ
        // ä¸ºæ–°è®°å½•çº¸æ·»åŠ æ ‡ç­¾
        addTagsBtn.addEventListener('click', function() {
            if (!currentPaperId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            const paper = getCurrentPaper();
            if (!paper) return;
            
            paperTagsInput.value = paper.tags ? paper.tags.join(', ') : '';
            tagsModal.style.display = 'block';
        });

        // ç¡®è®¤æ·»åŠ æ ‡ç­¾
        confirmTagsBtn.addEventListener('click', function() {
            if (!currentPaperId) return;
            
            const paper = getCurrentPaper();
            if (!paper) return;
            
            const tagsText = paperTagsInput.value.trim();
            paper.tags = tagsText ? tagsText.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            
            // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (currentNotebook) {
                currentNotebook.updatedAt = new Date().toISOString();
            }
            
            saveToLocalStorage();
            renderPapers();
            tagsModal.style.display = 'none';
        });

        // æœç´¢æ ‡ç­¾åŠŸèƒ½
        function searchByTag(tag) {
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;
            
            const filteredPapers = currentNotebook.papers.filter(paper => 
                paper.tags && paper.tags.includes(tag)
            );
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æ˜¾ç¤ºç­›é€‰åçš„è®°å½•çº¸åˆ—è¡¨
            alert(`æ‰¾åˆ° ${filteredPapers.length} ä¸ªåŒ…å«æ ‡ç­¾ "${tag}" çš„è®°å½•çº¸`);
            // ä¸ºç®€åŒ–ç¤ºä¾‹ï¼Œæˆ‘ä»¬åœ¨æ§åˆ¶å°æ‰“å°ç­›é€‰ç»“æœ
            console.log('ç­›é€‰ç»“æœ:', filteredPapers);
        }



        // æ’åºè®°å½•æœ¬å‡½æ•°
        function sortNotebooks(sortBy, sortOrder) {
            notebooks.sort((a, b) => {
                if (sortBy === 'title') {
                    // æŒ‰åç§°æ’åº
                    const titleA = a.title.toLowerCase();
                    const titleB = b.title.toLowerCase();
                    if (sortOrder === 'asc') {
                        return titleA.localeCompare(titleB);
                    } else {
                        return titleB.localeCompare(titleA);
                    }
                } else if (sortBy === 'createdAt' || sortBy === 'updatedAt') {
                    // æŒ‰æ—¶é—´æ’åº
                    if (sortOrder === 'asc') {
                        return new Date(a[sortBy]) - new Date(b[sortBy]);
                    } else {
                        return new Date(b[sortBy]) - new Date(a[sortBy]);
                    }
                }
                return 0;
            });
            saveToLocalStorage();
            renderNotebooksList();
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        function loadFromLocalStorage() {
            try {
                // 1. æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·é€‰æ‹©çš„å­˜å‚¨è·¯å¾„
                const storagePath = localStorage.getItem('threeGridStoragePath');
                

                
                if (storagePath && storagePath !== 'æœ¬åœ°æµè§ˆå™¨å­˜å‚¨') {
                    // å¦‚æœæœ‰ç”¨æˆ·é€‰æ‹©çš„å­˜å‚¨è·¯å¾„ï¼Œå°è¯•ä½¿ç”¨å¯¼å…¥åŠŸèƒ½åŠ è½½æ•°æ®
                    showToast('æ£€æµ‹åˆ°æ‚¨å·²è®¾ç½®è‡ªå®šä¹‰å­˜å‚¨è·¯å¾„ï¼Œè¯·ä½¿ç”¨å¯¼å…¥åŠŸèƒ½åŠ è½½æ•°æ®');
                }
                
                // ä»localStorageåŠ è½½æ•°æ®
                loadFromBrowserStorage();
            } catch (error) {
                console.error('åŠ è½½æœ¬åœ°å­˜å‚¨æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                createDefaultNotebook();
            }
        }
        
        // ä»æµè§ˆå™¨localStorageåŠ è½½æ•°æ®çš„æ ¸å¿ƒå‡½æ•°
        function loadFromBrowserStorage() {
            try {
                // 1. åŠ è½½åŸºæœ¬çš„è®°å½•æœ¬æ•°æ®
                const savedNotebooks = localStorage.getItem('threeGridNotebooks');
                if (savedNotebooks) {
                    try {
                        const parsedNotebooks = JSON.parse(savedNotebooks);
                        // éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦æœ‰æ•ˆ
                        if (Array.isArray(parsedNotebooks)) {
                            notebooks = parsedNotebooks;
                            // ç¡®ä¿æ¯ä¸ªnotebookéƒ½æœ‰createdAtå’ŒupdatedAtå±æ€§
                            notebooks.forEach(notebook => {
                                if (!notebook.createdAt) {
                                    notebook.createdAt = new Date().toISOString();
                                    notebook.updatedAt = new Date().toISOString();
                                } else if (!notebook.updatedAt) {
                                    notebook.updatedAt = notebook.createdAt;
                                }
                            });
                            // é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œè¶Šæ–°åˆ›å»ºçš„è®°å½•æœ¬æ’åœ¨è¶Šå‰é¢
                            sortNotebooks('createdAt', 'desc');
                        } else {
                            console.error('æœ¬åœ°å­˜å‚¨æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                            createDefaultNotebook();
                        }
                    } catch (jsonError) {
                        console.error('è§£ææœ¬åœ°å­˜å‚¨æ•°æ®å¤±è´¥:', jsonError);
                        createDefaultNotebook();
                    }
                } else {
                    createDefaultNotebook();
                }
                
                // 2. åŠ è½½å›æ”¶ç«™æ•°æ®ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                try {
                    const savedRecycleBin = localStorage.getItem('recycleBinData');
                    if (savedRecycleBin) {
                        try {
                            const parsedRecycleBin = JSON.parse(savedRecycleBin);
                            // éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦æœ‰æ•ˆ
                            if (Array.isArray(parsedRecycleBin)) {
                                recycleBinData = parsedRecycleBin;
                            } else {
                                console.error('å›æ”¶ç«™æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨ç©ºå›æ”¶ç«™');
                                recycleBinData = [];
                            }
                        } catch (jsonError) {
                            console.error('è§£æå›æ”¶ç«™æ•°æ®å¤±è´¥:', jsonError);
                            recycleBinData = [];
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½å›æ”¶ç«™æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    recycleBinData = [];
                }
                
                // 3. ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ ·å¼è®¾ç½®ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
                try {
                    const savedStyle = localStorage.getItem('currentStyle');
                    if (savedStyle) {
                        try {
                            const parsedStyle = JSON.parse(savedStyle);
                            // éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦æœ‰æ•ˆ
                            if (parsedStyle && typeof parsedStyle === 'object') {
                                currentStyle = parsedStyle;
                            } else {
                                console.error('æ ·å¼è®¾ç½®æ•°æ®æ ¼å¼æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤æ ·å¼');
                                // ä¿æŒç°æœ‰currentStyleä¸å˜ï¼Œå®ƒå·²ç»åœ¨å…¶ä»–åœ°æ–¹åˆå§‹åŒ–äº†
                            }
                        } catch (jsonError) {
                            console.error('è§£ææ ·å¼è®¾ç½®å¤±è´¥:', jsonError);
                            // ä¿æŒç°æœ‰currentStyleä¸å˜
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æ ·å¼è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                    // ä¿æŒç°æœ‰currentStyleä¸å˜
                }
            } catch (error) {
                console.error('ä»æµè§ˆå™¨å­˜å‚¨åŠ è½½æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯:', error);
                createDefaultNotebook();
            }
        }
        
        // åˆ›å»ºé»˜è®¤è®°å½•æœ¬
        function createDefaultNotebook() {
            try {
                // ä½¿ç”¨æ›´å¥å£®çš„ç§»åŠ¨ç«¯æ£€æµ‹æ–¹æ³•
                const isMobile = window.matchMedia('(max-width: 768px)').matches || 
                                navigator.userAgent.match(/(iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini)/i) !== null;
                const defaultRows = isMobile ? 9 : 15;
                
                console.log('æ£€æµ‹åˆ°è®¾å¤‡ç±»å‹:', isMobile ? 'ç§»åŠ¨è®¾å¤‡' : 'PCè®¾å¤‡', 'ï¼Œåˆ›å»ºé»˜è®¤', defaultRows, 'è¡Œè®°å½•çº¸');
                
                // åˆ›å»ºé»˜è®¤çš„ä¸‰æ ¼è®°å½•çº¸æ•°æ®ï¼ŒåŒ…å«ç¤ºä¾‹å†…å®¹
                const defaultPaperData = Array(3).fill().map(() => Array(defaultRows).fill(''));
                
                // ä¸ºç¬¬ä¸€æ ¼æ·»åŠ ç¤ºä¾‹å†…å®¹ï¼ˆå·¦ä¾§ï¼‰
                defaultPaperData[0][0] = '<div style="font-weight: bold; color: #1a56db; text-align: center; padding-bottom: 10px;">ğŸ“ å·¦ä¾§æ </div>';
                defaultPaperData[0][1] = 'è¿™é‡Œå¯ä»¥è®°å½•ä½ çš„çµæ„Ÿã€åˆ›æ„å’Œæƒ³æ³•';
                defaultPaperData[0][3] = 'ğŸ’¡ ç‚¹å‡»å³ä¸‹è§’"+"æŒ‰é’®å¯ä»¥æ·»åŠ æ›´å¤šå†…å®¹';
                
                // ä¸ºç¬¬äºŒæ ¼æ·»åŠ ç¤ºä¾‹å†…å®¹ï¼ˆä¸­é—´ï¼‰
                defaultPaperData[1][0] = '<div style="font-weight: bold; color: #059669; text-align: center; padding-bottom: 10px;">ğŸ“‹ ä¸­é—´æ </div>';
                defaultPaperData[1][1] = 'è¿™é‡Œå¯ä»¥è®°å½•å¾…åŠäº‹é¡¹ã€è®¡åˆ’å’Œç›®æ ‡';
                defaultPaperData[1][3] = 'âœ… å®Œæˆçš„ä»»åŠ¡å¯ä»¥æ ‡è®°å‡ºæ¥';
                
                // ä¸ºç¬¬ä¸‰æ ¼æ·»åŠ ç¤ºä¾‹å†…å®¹ï¼ˆå³ä¾§ï¼‰
                defaultPaperData[2][0] = '<div style="font-weight: bold; color: #b45309; text-align: center; padding-bottom: 10px;">ğŸ’­ å³ä¾§æ </div>';
                defaultPaperData[2][1] = 'è¿™é‡Œå¯ä»¥è®°å½•åæ€ã€æ€»ç»“å’Œæ”¶è·';
                defaultPaperData[2][3] = 'ğŸ“š éšæ—¶å›é¡¾å’Œå®Œå–„ä½ çš„æ€è€ƒ';
                
                notebooks = [{
                    id: Date.now().toString(),
                    title: 'æˆ‘çš„ç¬¬ä¸€ä¸ªè®°å½•æœ¬',
                    papers: [{
                        id: (Date.now() + 1).toString(),
                        title: 'ç¤ºä¾‹è®°å½•çº¸',
                        date: new Date().toLocaleDateString('zh-CN'),
                        data: defaultPaperData,
                        style: { 
                            textAlignment: 'center', 
                            backgroundColor: '#ffffff', 
                            backgroundImage: null, 
                            customBackgroundImage: null 
                        }
                    }],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];
                
                // ç¡®ä¿æ•°æ®ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                saveToLocalStorage();
                
                // åœ¨åˆ›å»ºé»˜è®¤è®°å½•æœ¬åç«‹å³æ¸²æŸ“ï¼Œç¡®ä¿åœ¨ç§»åŠ¨ç«¯èƒ½æ­£ç¡®æ˜¾ç¤º
                renderNotebooksList();
                if (notebooks.length > 0) {
                    switchToNotebook(notebooks[0].id);
                }
                
                console.log('é»˜è®¤è®°å½•æœ¬åˆ›å»ºæˆåŠŸï¼Œå·²åŒ…å«ç¤ºä¾‹è®°å½•çº¸');
            } catch (error) {
                console.error('åˆ›å»ºé»˜è®¤è®°å½•æœ¬å¤±è´¥:', error);
                // å³ä½¿ä¿å­˜å¤±è´¥ï¼Œä¹Ÿè‡³å°‘è®¾ç½®ä¸€ä¸ªåŒ…å«é»˜è®¤æ•°æ®çš„notebooksæ•°ç»„
                notebooks = [{
                    id: Date.now().toString(),
                    title: 'æˆ‘çš„ç¬¬ä¸€ä¸ªè®°å½•æœ¬',
                    papers: [{id: (Date.now() + 1).toString(), title: 'ç¤ºä¾‹è®°å½•çº¸', date: new Date().toLocaleDateString('zh-CN'), data: [[], [], []], style: {textAlignment: 'center', backgroundColor: '#ffffff'}}],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }];
                
                // å¼ºåˆ¶æ¸²æŸ“
                renderNotebooksList();
                if (notebooks.length > 0) {
                    switchToNotebook(notebooks[0].id);
                }
            }
        }
        
        // ä¿å­˜å›æ”¶ç«™æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveRecycleBinToLocalStorage() {
            try {
                localStorage.setItem('recycleBinData', JSON.stringify(recycleBinData));
            } catch (error) {
                console.error('ä¿å­˜å›æ”¶ç«™æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // ä¿å­˜æ ·å¼è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
        function saveStyleToLocalStorage() {
            try {
                localStorage.setItem('currentStyle', JSON.stringify(currentStyle));
            }
            catch (error) {
                console.error('ä¿å­˜æ ·å¼è®¾ç½®å¤±è´¥:', error);
            }
        }
        
        // å¯¼å…¥æ•°æ®åŠŸèƒ½
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            // éªŒè¯æ•°æ®ç»“æ„
                            if (importData.notebooks && Array.isArray(importData.notebooks)) {
                                // å¤‡ä»½å½“å‰æ•°æ®
                                const backupData = {
                                    notebooks: notebooks,
                                    recycleBinData: recycleBinData,
                                    currentStyle: currentStyle
                                };
                                
                                // å¯¼å…¥æ•°æ®
                                notebooks = importData.notebooks || [];
                                if (importData.recycleBinData && Array.isArray(importData.recycleBinData)) {
                                    recycleBinData = importData.recycleBinData;
                                }
                                if (importData.currentStyle && typeof importData.currentStyle === 'object') {
                                    currentStyle = importData.currentStyle;
                                }
                                
                                // ä¿å­˜å¯¼å…¥çš„æ•°æ®
                                saveToLocalStorage();
                                saveRecycleBinToLocalStorage();
                                saveStyleToLocalStorage();
                                
                                // æ›´æ–°UI
                                renderNotebooksList();
                                if (notebooks.length > 0) {
                                    switchToNotebook(notebooks[0].id);
                                }
                                updateRecycleBinUI();
                                applyThemeToUI();
                                
                                showToast('æ•°æ®å¯¼å…¥æˆåŠŸ');
                            } else {
                                showToast('æ— æ•ˆçš„æ•°æ®æ–‡ä»¶ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„ä¸‰æ ¼è®°å½•æœ¬æ•°æ®æ–‡ä»¶');
                            }
                        } catch (error) {
                            console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                            showToast('æ•°æ®è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
                        }
                    };
                    
                    reader.readAsText(file);
                }
            });
            
            document.body.appendChild(input);
            input.click();
            
            // ç§»é™¤ä¸´æ—¶å…ƒç´ 
            setTimeout(() => {
                document.body.removeChild(input);
            }, 100);
        }
        
        // æ³¨æ„ï¼šå­˜å‚¨è®¾ç½®ä¸­çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½å·²ç§»è‡³åŒæ­¥ä¸å¤‡ä»½èœå•ï¼Œæ­¤å¤„ä¸å†æ·»åŠ è¿™äº›åŠŸèƒ½
        
        // å°†è®°å½•çº¸ç§»è‡³å›æ”¶ç«™
        function moveToRecycleBin(paperId) {
            showDeleteConfirmModal(
                'ç¡®è®¤åˆ é™¤è®°å½•çº¸',
                'ç¡®å®šè¦å°†æ­¤è®°å½•çº¸ç§»è‡³å›æ”¶ç«™å—ï¼Ÿ',
                function() {
                    const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
                    if (!currentNotebook) return;
                    
                    const paperIndex = currentNotebook.papers.findIndex(p => p.id === paperId);
                    if (paperIndex === -1) return;
                    
                    const paper = currentNotebook.papers[paperIndex];
                    // ä»è®°å½•æœ¬ä¸­ç§»é™¤
                    currentNotebook.papers.splice(paperIndex, 1);
                    currentNotebook.updatedAt = new Date().toISOString(); // æ›´æ–°ä¿®æ”¹æ—¶é—´

                    // æ·»åŠ åˆ°å›æ”¶ç«™
                    const recycleItem = {
                        id: Date.now().toString(),
                        type: 'paper', // æ ‡è®°ä¸ºè®°å½•çº¸ç±»å‹
                        paper: paper,
                        notebookId: currentNotebookId,
                        deletedAt: new Date().toLocaleString('zh-CN')
                    };
                    recycleBinData.push(recycleItem);
                    
                    // ä¿å­˜æ•°æ®
                    saveToLocalStorage();
                    saveRecycleBinToLocalStorage();
                    
                    // æ›´æ–°UI
                    renderPapers();
                    updateRecycleBinUI();
                    window.updateMobileRecycleBin();
                }
            );
        }
        
        // ä»å›æ”¶ç«™æ¢å¤é¡¹ç›®
        function restoreFromRecycleBin(recycleId) {
            const recycleItemIndex = recycleBinData.findIndex(item => item.id === recycleId);
            if (recycleItemIndex === -1) return;
            
            const recycleItem = recycleBinData[recycleItemIndex];
            
            // æ ¹æ®ç±»å‹æ¢å¤ä¸åŒçš„é¡¹ç›®
            if (recycleItem.type === 'paper') {
                // æ¢å¤è®°å½•çº¸
                const notebook = notebooks.find(n => n.id === recycleItem.notebookId);
                
                if (notebook) {
                    // å°†è®°å½•çº¸æ·»åŠ å›è®°å½•æœ¬
                    notebook.papers.unshift(recycleItem.paper);
                    // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
                    notebook.updatedAt = new Date().toISOString();
                    
                    // ä»å›æ”¶ç«™ç§»é™¤
                    recycleBinData.splice(recycleItemIndex, 1);
                    
                    // ä¿å­˜æ•°æ®
                    saveToLocalStorage();
                    saveRecycleBinToLocalStorage();
                    
                    // æ›´æ–°UI
                    renderPapers();
                    updateRecycleBinUI();
                } else {
                    alert('æ— æ³•æ‰¾åˆ°åŸå§‹è®°å½•æœ¬ï¼Œæ— æ³•æ¢å¤è®°å½•çº¸ã€‚');
                }
            } else if (recycleItem.type === 'notebook') {
                // æ¢å¤è®°å½•æœ¬
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåè®°å½•æœ¬
                const existingNotebook = notebooks.find(n => n.title === recycleItem.notebook.title);
                if (existingNotebook) {
                    alert('å·²å­˜åœ¨åŒåè®°å½•æœ¬ï¼Œè¯·å…ˆé‡å‘½åç°æœ‰è®°å½•æœ¬ã€‚');
                    return;
                }
                
                // å°†è®°å½•æœ¬æ·»åŠ å›è®°å½•æœ¬åˆ—è¡¨
                notebooks.push(recycleItem.notebook);
                
                // ä»å›æ”¶ç«™ç§»é™¤
                recycleBinData.splice(recycleItemIndex, 1);
                
                // ä¿å­˜æ•°æ®
                saveToLocalStorage();
                saveRecycleBinToLocalStorage();
                
                // æ›´æ–°UI
                renderNotebooksList();
                updateRecycleBinUI();
                window.updateMobileRecycleBin();
            }
        }
        
        // æ¸…ç©ºå›æ”¶ç«™
        function clearRecycleBin() {
            recycleBinData = [];
            saveRecycleBinToLocalStorage();
            updateRecycleBinUI();
            window.updateMobileRecycleBin();
        }
        
        // æ›´æ–°å›æ”¶ç«™UI
        function updateRecycleBinUI() {
            // æ·»åŠ ç­›é€‰æŒ‰é’®åŒºåŸŸ
            const recycleBinElement = document.querySelector('.recycle-bin');
            let filterButtons = recycleBinElement.querySelector('.recycle-filter-buttons');
            
            if (!filterButtons) {
                filterButtons = document.createElement('div');
                filterButtons.className = 'recycle-filter-buttons';
                filterButtons.style.display = 'flex';
                filterButtons.style.marginBottom = '15px';
                filterButtons.style.gap = '8px';
                filterButtons.innerHTML = `
                    <button class="filter-btn ${window.recycleFilterType === 'all' ? 'active' : ''}" data-filter="all">å…¨éƒ¨</button>
                    <button class="filter-btn ${window.recycleFilterType === 'paper' ? 'active' : ''}" data-filter="paper">è®°å½•çº¸</button>
                    <button class="filter-btn ${window.recycleFilterType === 'notebook' ? 'active' : ''}" data-filter="notebook">è®°å½•æœ¬</button>
                `;
                
                // æ·»åŠ ç­›é€‰æŒ‰é’®æ ·å¼
                const style = document.createElement('style');
                style.textContent = `
                    .filter-btn {
                        flex: 1;
                        padding: 6px 12px;
                        border: 1px solid var(--border-light);
                        border-radius: var(--radius-small);
                        font-size: 0.85rem;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        /* ä¸è®¾ç½®å›ºå®šèƒŒæ™¯è‰²ï¼Œç”±updateUIElementsStyleså‡½æ•°æ ¹æ®ä¸»é¢˜ç»Ÿä¸€æ§åˆ¶ */
                    }
                    .filter-btn:hover {
                        /* ä¸è®¾ç½®æ‚¬åœèƒŒæ™¯è‰²ï¼Œç”±updateUIElementsStyleså‡½æ•°æ ¹æ®ä¸»é¢˜ç»Ÿä¸€æ§åˆ¶ */
                    }
                    .filter-btn.active {
                        border-color: var(--primary-color);
                        /* ä¸è®¾ç½®æ¿€æ´»çŠ¶æ€èƒŒæ™¯è‰²å’Œæ–‡å­—é¢œè‰²ï¼Œç”±updateUIElementsStyleså‡½æ•°æ ¹æ®ä¸»é¢˜ç»Ÿä¸€æ§åˆ¶ */
                    }
                    .recycle-item-type {
                        display: inline-block;
                        padding: 2px 8px;
                        margin-right: 8px;
                        background: var(--accent-color);
                        color: white;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        vertical-align: middle;
                    }
                    /* ç§»åŠ¨ç«¯å¼¹çª—ä¸­ç¼©çŸ­æ ‡ç­¾é•¿åº¦ */
                    #mobile-recycle-modal .recycle-item-type {
                        max-width: 60px;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                        padding: 2px 6px;
                    }
                    .recycle-item-type.notebook {
                        background: #ff9800;
                    }
                    .recycle-item-type.paper {
                        background: #4caf50;
                    }
                `;
                document.head.appendChild(style);
                
                // æ’å…¥åˆ°å›æ”¶ç«™å¤´éƒ¨ä¸‹æ–¹
                const recycleHeader = recycleBinElement.querySelector('.recycle-header');
                recycleHeader.parentNode.insertBefore(filterButtons, recycleHeader.nextSibling);
                
                // æ·»åŠ ç­›é€‰æŒ‰é’®äº‹ä»¶ç›‘å¬
                filterButtons.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        window.recycleFilterType = this.dataset.filter;
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        filterButtons.querySelectorAll('.filter-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                        updateRecycleBinUI();
                        // é‡æ–°åº”ç”¨ä¸»é¢˜æ ·å¼ï¼Œç¡®ä¿æš—é»‘ä¸»é¢˜ä¸‹æŒ‰é’®æ ·å¼æ­£ç¡®æ˜¾ç¤º
                        updateUIElementsStyles();
                    });
                });
            }
            
            // åº”ç”¨ç­›é€‰
            let filteredItems = recycleBinData;
            if (window.recycleFilterType === 'paper') {
                filteredItems = recycleBinData.filter(item => item.type === 'paper' || !item.type);
            } else if (window.recycleFilterType === 'notebook') {
                filteredItems = recycleBinData.filter(item => item.type === 'notebook');
            }
            
            recycleCount.textContent = filteredItems.length;
            
            if (recycleBinData.length === 0) {
                recycleItems.innerHTML = '<div style="text-align: center; color: #999; font-size: 0.9rem;">å›æ”¶ç«™ä¸ºç©º</div>';
                emptyRecycleBtn.disabled = true;
            } else {
                recycleItems.innerHTML = '';
                
                // åˆ›å»ºæ˜¾ç¤ºçš„é¡¹ç›®åˆ—è¡¨
                let itemsToShow = filteredItems;
                let hasMore = false;
                
                // åªæ˜¾ç¤ºæœ€å3ä¸ªåˆ é™¤çš„é¡¹ç›®
                if (filteredItems.length > 3) {
                    itemsToShow = filteredItems.slice(-3);
                    hasMore = true;
                }
                
                // æ¸²æŸ“æ˜¾ç¤ºçš„é¡¹ç›®
                        itemsToShow.forEach(item => {
                            const recycleItem = document.createElement('div');
                            recycleItem.className = 'recycle-item';
                            recycleItem.setAttribute('data-recycle-id', item.id);
                            
                            // åˆ›å»ºæ¢å¤æŒ‰é’®
                            const restoreButton = document.createElement('button');
                            restoreButton.className = 'restore-btn';
                            restoreButton.textContent = 'æ¢å¤';
                            restoreButton.addEventListener('click', (e) => {
                                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
                                // ä½¿ç”¨è‡ªå®šä¹‰æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
                                showRestoreConfirmModal('ç¡®è®¤æ¢å¤', 'ç¡®å®šè¦æ¢å¤è¿™ä¸ªè®°å½•çº¸å—ï¼Ÿ', function() {
                                    restoreFromRecycleBin(item.id);
                                });
                            });
                            
                            // åˆ›å»ºé¡¹ç›®å†…å®¹å®¹å™¨
                            const contentContainer = document.createElement('div');
                            contentContainer.style.flex = '1';
                            
                            // æ ¹æ®é¡¹ç›®ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
                            if (item.type === 'notebook' || item.notebook) {
                                // è®°å½•æœ¬é¡¹ç›®
                                const notebook = item.notebook || item;
                                const paperCount = notebook.papers ? notebook.papers.length : 0;
                                contentContainer.innerHTML = `
                                    <div class="recycle-item-title">
                                        <span class="recycle-item-type notebook">è®°å½•æœ¬</span>
                                        ${notebook.title}
                                    </div>
                                    <div class="recycle-item-meta">${paperCount} å¼ è®°å½•çº¸</div>
                                    <div class="recycle-item-date">åˆ é™¤æ—¶é—´: ${item.deletedAt}</div>
                                `;
                            } else {
                                // è®°å½•çº¸é¡¹ç›®
                                const paper = item.paper || item;
                                contentContainer.innerHTML = `
                                    <div class="recycle-item-title">
                                        <span class="recycle-item-type paper">è®°å½•çº¸</span>
                                        ${paper.title}
                                    </div>
                                    <div class="recycle-item-date">åˆ é™¤æ—¶é—´: ${item.deletedAt}</div>
                                `;
                            }
                            
                            // ç»„ç»‡é¡¹ç›®ç»“æ„
                            recycleItem.appendChild(contentContainer);
                            recycleItem.appendChild(restoreButton);
                            
                            // æ·»åŠ åˆ°åˆ—è¡¨
                            recycleItems.appendChild(recycleItem);
                        });
                
                // æ·»åŠ å±•å¼€æŒ‰é’®ï¼ˆå¦‚æœæœ‰æ›´å¤šé¡¹ç›®ï¼‰
                if (hasMore) {
                    const showAllBtn = document.createElement('button');
                    showAllBtn.className = 'expand-recycle-btn';
                    showAllBtn.textContent = 'æŸ¥çœ‹å‰©ä½™ ' + (filteredItems.length - 3) + ' ä¸ªé¡¹ç›®';
                    showAllBtn.addEventListener('click', function() {
                        // ç§»é™¤å±•å¼€æŒ‰é’®
                        recycleItems.removeChild(showAllBtn);
                        
                        // æ¸²æŸ“æ‰€æœ‰å‰©ä½™é¡¹ç›®
                            const remainingItems = filteredItems.slice(0, -3);
                            
                            // å¦‚æœç§»åŠ¨ç«¯å›æ”¶ç«™æ‰“å¼€ï¼Œä¹Ÿæ›´æ–°ç§»åŠ¨ç«¯å›æ”¶ç«™
                            if (isMobile() && document.getElementById('mobile-recycle-modal').style.display === 'flex') {
                                updateMobileRecycleBin();
                            }
                        remainingItems.forEach(item => {
                            const recycleItem = document.createElement('div');
                            recycleItem.className = 'recycle-item';
                            recycleItem.setAttribute('data-recycle-id', item.id);
                             
                            // åˆ›å»ºæ¢å¤æŒ‰é’®
                            const restoreButton = document.createElement('button');
                            restoreButton.className = 'restore-btn';
                            restoreButton.textContent = 'æ¢å¤';
                            restoreButton.addEventListener('click', (e) => {
                                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ 
                                // ä½¿ç”¨è‡ªå®šä¹‰æ¢å¤ç¡®è®¤æ¨¡æ€æ¡†
                                showRestoreConfirmModal('ç¡®è®¤æ¢å¤', 'ç¡®å®šè¦æ¢å¤è¿™ä¸ªè®°å½•æœ¬å—ï¼Ÿ', function() {
                                    restoreFromRecycleBin(item.id);
                                });
                            });
                             
                            // åˆ›å»ºé¡¹ç›®å†…å®¹å®¹å™¨
                            const contentContainer = document.createElement('div');
                            contentContainer.style.flex = '1';
                             
                            // æ ¹æ®é¡¹ç›®ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
                            if (item.type === 'notebook' || item.notebook) {
                                // è®°å½•æœ¬é¡¹ç›®
                                const notebook = item.notebook || item;
                                const paperCount = notebook.papers ? notebook.papers.length : 0;
                                contentContainer.innerHTML = `
                                    <div class="recycle-item-title">
                                        <span class="recycle-item-type notebook">è®°å½•æœ¬</span>
                                        ${notebook.title}
                                    </div>
                                    <div class="recycle-item-meta">${paperCount} å¼ è®°å½•çº¸</div>
                                    <div class="recycle-item-date">åˆ é™¤æ—¶é—´: ${item.deletedAt}</div>
                                `;
                            } else {
                                // è®°å½•çº¸é¡¹ç›®
                                const paper = item.paper || item;
                                contentContainer.innerHTML = `
                                    <div class="recycle-item-title">
                                        <span class="recycle-item-type paper">è®°å½•çº¸</span>
                                        ${paper.title}
                                    </div>
                                    <div class="recycle-item-date">åˆ é™¤æ—¶é—´: ${item.deletedAt}</div>
                                `;
                            }
                             
                            // ç»„ç»‡é¡¹ç›®ç»“æ„
                            recycleItem.appendChild(contentContainer);
                            recycleItem.appendChild(restoreButton);
                             
                            // æ·»åŠ åˆ°åˆ—è¡¨é¡¶éƒ¨
                            recycleItems.insertBefore(recycleItem, recycleItems.firstChild);
                        });
                    });
                    recycleItems.appendChild(showAllBtn);
                }
                
                emptyRecycleBtn.disabled = false;
            }
        }
        
        // æ˜¾ç¤ºè®¾ç½®æ¨¡æ€æ¡†
        function showSettingsModal() {
            // åŠ è½½å½“å‰çº¸å¼ çš„æ ·å¼æˆ–ä½¿ç”¨é»˜è®¤æ ·å¼
            const paper = getCurrentPaper();
            if (paper && paper.style) {
                currentStyle = { ...paper.style };
            }
            
            // æ›´æ–°æ ·å¼é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            lineStyleOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle.lineStyle) {
                    option.classList.add('selected');
                }
            });
            
            // æ›´æ–°ç«–çº¿æ¡æ ·å¼é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            columnBorderStyleOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.style === currentStyle.columnBorderStyle) {
                    option.classList.add('selected');
                }
            });
            
            colorOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.color === currentStyle.lineColor) {
                    option.classList.add('selected');
                }
            });
            
            bgOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.bg === currentStyle.backgroundColor) {
                    option.classList.add('selected');
                }
            });

            // æ›´æ–°èƒŒæ™¯å›¾ç‰‡é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const bgImageOptions = document.querySelectorAll('.bg-image-option');
            bgImageOptions.forEach(option => {
                option.classList.remove('active');
                if (option.dataset.image === currentStyle.backgroundImage) {
                    option.classList.add('active');
                }
            });

            // æ˜¾ç¤ºæˆ–éšè—èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ
            const backgroundImagePreview = document.getElementById('background-image-preview');
            const previewImage = document.getElementById('preview-image');
            if (currentStyle.customBackgroundImage) {
                previewImage.src = currentStyle.customBackgroundImage;
                backgroundImagePreview.style.display = 'block';
            } else {
                backgroundImagePreview.style.display = 'none';
            }
            
            // æ›´æ–°ä¸»é¢˜é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.theme === getCurrentTheme()) {
                    option.classList.add('selected');
                }
            });

            // æ›´æ–°å­—ä½“é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const fontOptions = document.querySelectorAll('.font-option');
            const currentPaper = getCurrentPaper();
            let currentFont = '';
            
            // å¦‚æœæœ‰å½“å‰è®°å½•çº¸ï¼Œè·å–å…¶å­—ä½“è®¾ç½®
            if (currentPaper) {
                const paperId = currentPaper.id;
                const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
                currentFont = settings.fontFamily || '';
            }
            
            // åº”ç”¨é€‰ä¸­çŠ¶æ€
            fontOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.font === currentFont) {
                    option.classList.add('selected');
                }
            });
            
            // æ›´æ–°å¯¹é½é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            const alignmentOptions = document.querySelectorAll('.alignment-option');
            alignmentOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.alignment === currentStyle.textAlignment) {
                    option.classList.add('selected');
                }
            });
            
            // æ›´æ–°å­˜å‚¨è®¾ç½®
            const savedStorageType = localStorage.getItem('threeGridStorageType') || 'local';
            const storageOptions = document.querySelectorAll('input[name="storage-type"]');
            storageOptions.forEach(option => {
                option.checked = option.value === savedStorageType;
            });
            
            // æ›´æ–°å­˜å‚¨è·¯å¾„æ˜¾ç¤º
            const storagePathInput = document.getElementById('storage-path');
            const storagePathNote = document.getElementById('storage-path-note');
            
            if (storagePathInput && savedStorageType === 'local') {
                // é‡è¦è¯´æ˜ï¼šç”±äºæµè§ˆå™¨çš„å®‰å…¨é™åˆ¶ï¼ŒJavaScriptæ— æ³•ç›´æ¥è·å–æˆ–æ˜¾ç¤ºæµè§ˆå™¨å­˜å‚¨æ•°æ®çš„å®é™…æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
                // æµè§ˆå™¨å°†localStorageæ•°æ®å­˜å‚¨åœ¨å…¶ç§æœ‰æ•°æ®ç›®å½•ä¸­ï¼Œä¸åŒæµè§ˆå™¨å’Œæ“ä½œç³»ç»Ÿçš„å­˜å‚¨ä½ç½®å„ä¸ç›¸åŒ
                
                // æ£€æµ‹æµè§ˆå™¨ç±»å‹
                let browserName = 'æœªçŸ¥æµè§ˆå™¨';
                let detailedStorageLocation = '';
                
                // æ ¹æ®æµè§ˆå™¨ç±»å‹å’Œæ“ä½œç³»ç»Ÿæä¾›æ›´å…·ä½“çš„å­˜å‚¨ä½ç½®ä¿¡æ¯
                if (navigator.userAgent.indexOf('Chrome') !== -1) {
                    browserName = 'Chrome';
                    if (navigator.platform.indexOf('Win') !== -1) {
                        detailedStorageLocation = 'C:\\Users\\[ç”¨æˆ·å]\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Local Storage';
                    } else if (navigator.platform.indexOf('Mac') !== -1) {
                        detailedStorageLocation = '~/Library/Application Support/Google/Chrome/Default/Local Storage';
                    } else if (navigator.platform.indexOf('Linux') !== -1) {
                        detailedStorageLocation = '~/.config/google-chrome/Default/Local Storage';
                    }
                } else if (navigator.userAgent.indexOf('Firefox') !== -1) {
                    browserName = 'Firefox';
                    if (navigator.platform.indexOf('Win') !== -1) {
                        detailedStorageLocation = 'C:\\Users\\[ç”¨æˆ·å]\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles\\[é…ç½®æ–‡ä»¶]\\storage\\default';
                    } else if (navigator.platform.indexOf('Mac') !== -1) {
                        detailedStorageLocation = '~/Library/Application Support/Firefox/Profiles/[é…ç½®æ–‡ä»¶]/storage/default';
                    } else if (navigator.platform.indexOf('Linux') !== -1) {
                        detailedStorageLocation = '~/.mozilla/firefox/[é…ç½®æ–‡ä»¶]/storage/default';
                    }
                } else if (navigator.userAgent.indexOf('Safari') !== -1) {
                    browserName = 'Safari';
                    detailedStorageLocation = '~/Library/Safari/LocalStorage';
                } else if (navigator.userAgent.indexOf('Edge') !== -1) {
                    browserName = 'Edge';
                    if (navigator.platform.indexOf('Win') !== -1) {
                        detailedStorageLocation = 'C:\\Users\\[ç”¨æˆ·å]\\AppData\\Local\\Microsoft\\Edge\\User Data\\Default\\Local Storage';
                    } else if (navigator.platform.indexOf('Mac') !== -1) {
                        detailedStorageLocation = '~/Library/Application Support/Microsoft Edge/Default/Local Storage';
                    }
                }
                
                // è®¡ç®—localStorageå·²ä½¿ç”¨ç©ºé—´ï¼ˆè¿‘ä¼¼å€¼ï¼‰
                let usedSpace = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        usedSpace += key.length + localStorage.getItem(key).length;
                    }
                }
                usedSpace = Math.round(usedSpace / 1024); // è½¬æ¢ä¸ºKB
                
                // æ˜¾ç¤ºæµè§ˆå™¨å­˜å‚¨ç±»å‹ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç çš„è·¯å¾„
                storagePathInput.value = `${browserName}æµè§ˆå™¨localStorage`;
                
                // æ·»åŠ è¯¦ç»†è¯´æ˜æ–‡å­—ï¼Œè§£é‡Šæµè§ˆå™¨å­˜å‚¨çš„å®é™…æƒ…å†µ
                if (!storagePathNote) {
                    const noteElement = document.createElement('p');
                    noteElement.id = 'storage-path-note';
                    noteElement.style.fontSize = '0.8rem';
                    noteElement.style.color = 'var(--text-secondary)';
                    noteElement.style.marginTop = '4px';
                    noteElement.style.marginBottom = '0';
                    noteElement.innerHTML = `å®é™…å­˜å‚¨ä½ç½®: ${detailedStorageLocation}<br>å·²ä½¿ç”¨ç©ºé—´: çº¦${usedSpace}KB<br><small style="color: #666;">* [ç”¨æˆ·å]å’Œ[é…ç½®æ–‡ä»¶]éœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä¿¡æ¯</small>`;
                    storagePathInput.parentNode.parentNode.appendChild(noteElement);
                } else {
                    storagePathNote.innerHTML = `å®é™…å­˜å‚¨ä½ç½®: ${detailedStorageLocation}<br>å·²ä½¿ç”¨ç©ºé—´: çº¦${usedSpace}KB<br><small style="color: #666;">* [ç”¨æˆ·å]å’Œ[é…ç½®æ–‡ä»¶]éœ€è¦æ›¿æ¢ä¸ºæ‚¨çš„å®é™…ä¿¡æ¯</small>`;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ç«–å±æ¨¡å¼çš„å‡½æ•°
            function isMobilePortrait() {
                return window.innerWidth < 768 && window.innerHeight > window.innerWidth;
            }
            
            // æ·»åŠ èƒŒæ™¯å›¾ç‰‡é€‰é¡¹çš„ç‚¹å‡»äº‹ä»¶å¤„ç†é€»è¾‘
            bgImageOptions.forEach(option => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newOption.addEventListener('click', function(e) {
                    const bgType = this.dataset.image;
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡ç«–å±æ¨¡å¼ï¼Œä¸”ç”¨æˆ·å°è¯•é€‰æ‹©æ¨ªçº¿çº¸æˆ–ç½‘æ ¼çº¸
                    if (isMobilePortrait() && (bgType === 'lined' || bgType === 'grid')) {
                        e.preventDefault();
                        e.stopPropagation();
                        showToast('ç§»åŠ¨ç«¯ç«–å±æ¨¡å¼ç¦ç”¨æ­¤èƒŒæ™¯');
                        return;
                    }
                    
                    // æ­£å¸¸çš„é€‰æ‹©é€»è¾‘ - ä½¿ç”¨this.parentNode.querySelectorAllè·å–å½“å‰æ‰€æœ‰çš„èƒŒæ™¯å›¾ç‰‡é€‰é¡¹
                    this.parentNode.querySelectorAll('.bg-image-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');
                    currentStyle.backgroundImage = bgType;
                    
                    // éšè—è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡é¢„è§ˆ
                    if (backgroundImagePreview) {
                        backgroundImagePreview.style.display = 'none';
                    }
                    if (previewImage) {
                        previewImage.src = '';
                    }
                });
            });
            
            // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®ä¸åŒçš„å¼¹çª—æœ€å¤§é«˜åº¦
            const modalContent = document.querySelector('#settings-modal .modal-content');
            if (isMobilePortrait()) {
                // ç§»åŠ¨è®¾å¤‡ç«–å± - æ›´å°çš„é«˜åº¦ä»¥ç¡®ä¿æœ€ä½³æ˜¾ç¤ºæ•ˆæœ
                modalContent.style.maxHeight = '75vh';
            } else if (isMobile()) {
                // ç§»åŠ¨è®¾å¤‡æ¨ªå± - ä¸­ç­‰é«˜åº¦
                modalContent.style.maxHeight = '80vh';
            } else {
                // PCè®¾å¤‡ - ä¿æŒè¾ƒå¤§é«˜åº¦
                modalContent.style.maxHeight = '85vh';
            }

            // ä¸ºå­—å·è®¾ç½®æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const applyFontSizeCurrentBtn = document.getElementById('apply-font-size-current');
            const applyFontSizeAllBtn = document.getElementById('apply-font-size-all');
            const fontSizeSelect = document.getElementById('font-size-select');
            
            if (applyFontSizeCurrentBtn) {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newApplyFontSizeCurrentBtn = applyFontSizeCurrentBtn.cloneNode(true);
                applyFontSizeCurrentBtn.parentNode.replaceChild(newApplyFontSizeCurrentBtn, applyFontSizeCurrentBtn);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newApplyFontSizeCurrentBtn.addEventListener('click', function() {
                    const fontSize = fontSizeSelect.value;
                    const currentPaper = getCurrentPaper();
                    if (currentPaper) {
                        applyFontSizeToPaper(currentPaper, fontSize);
                        showToast('å­—å·å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                    } else {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                    }
                });
            }
            
            if (applyFontSizeAllBtn) {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newApplyFontSizeAllBtn = applyFontSizeAllBtn.cloneNode(true);
                applyFontSizeAllBtn.parentNode.replaceChild(newApplyFontSizeAllBtn, applyFontSizeAllBtn);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newApplyFontSizeAllBtn.addEventListener('click', function() {
                    const fontSize = fontSizeSelect.value;
                    applyFontSizeToAllPapers(fontSize);
                    showToast('å­—å·å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                });
            }
            
            // ä¸ºå­—ä½“è®¾ç½®æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const applyFontCurrentBtn = document.getElementById('apply-font-current');
            const applyFontAllBtn = document.getElementById('apply-font-all');
            
            if (applyFontCurrentBtn) {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newApplyFontCurrentBtn = applyFontCurrentBtn.cloneNode(true);
                applyFontCurrentBtn.parentNode.replaceChild(newApplyFontCurrentBtn, applyFontCurrentBtn);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newApplyFontCurrentBtn.addEventListener('click', function() {
                    const selectedFontOption = document.querySelector('.font-option.selected');
                    if (selectedFontOption) {
                        const font = selectedFontOption.dataset.font;
                        const currentPaper = getCurrentPaper();
                        if (currentPaper) {
                            applyFontToPaper(currentPaper, font);
                            showToast('å­—ä½“å·²åº”ç”¨åˆ°å½“å‰è®°å½•çº¸');
                        } else {
                            showToast('è¯·å…ˆé€‰æ‹©ä¸€å¼ è®°å½•çº¸');
                        }
                    }
                });
            }
            
            if (applyFontAllBtn) {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newApplyFontAllBtn = applyFontAllBtn.cloneNode(true);
                applyFontAllBtn.parentNode.replaceChild(newApplyFontAllBtn, applyFontAllBtn);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newApplyFontAllBtn.addEventListener('click', function() {
                    const selectedFontOption = document.querySelector('.font-option.selected');
                    if (selectedFontOption) {
                        const font = selectedFontOption.dataset.font;
                        applyFontToAllPapers(font);
                        showToast('å­—ä½“å·²åº”ç”¨åˆ°æ‰€æœ‰è®°å½•çº¸');
                    }
                });
            }
            
            // ä¸ºå­—ä½“é€‰é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
            fontOptions.forEach(option => {
                // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const newOption = option.cloneNode(true);
                option.parentNode.replaceChild(newOption, option);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                newOption.addEventListener('click', function() {
                    fontOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            settingsModal.style.display = 'flex';
        }
        
        // åˆå§‹åŒ–å¯¹é½æ–¹å¼åº”ç”¨æŒ‰é’®
        function initAlignmentApplyButtons() {
            const applyToCurrentBtn = document.getElementById('apply-to-current-paper');
            const applyToAllBtn = document.getElementById('apply-to-all-papers');
            
            if (applyToCurrentBtn && applyToAllBtn) {
                applyToCurrentBtn.addEventListener('click', function() {
                    applyAlignmentToCurrentPaper();
                });
                
                applyToAllBtn.addEventListener('click', function() {
                    applyAlignmentToAllPapers();
                });
            }
        }
        
        // åº”ç”¨å¯¹é½æ–¹å¼åˆ°å½“å‰è®°å½•çº¸
        function applyAlignmentToCurrentPaper() {
            const paper = getCurrentPaper();
            const selectedAlignment = document.querySelector('.alignment-option.selected');
            
            if (paper && selectedAlignment) {
                paper.style = paper.style || {};
                paper.style.textAlignment = selectedAlignment.dataset.alignment;
                
                // ä¿å­˜æ•°æ®
                debouncedSaveToLocalStorage();
                
                // æ›´æ–°UI
                renderPapers();
                
                // æ˜¾ç¤ºæç¤º
                showToast(`å·²å°†å½“å‰è®°å½•çº¸æ–‡æœ¬è®¾ç½®ä¸º${selectedAlignment.dataset.label}`);
            }
        }
        
        // åº”ç”¨å¯¹é½æ–¹å¼åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyAlignmentToAllPapers() {
            const selectedAlignment = document.querySelector('.alignment-option.selected');
            
            if (selectedAlignment) {
                const alignment = selectedAlignment.dataset.alignment;
                const alignmentLabel = selectedAlignment.dataset.label;
                
                // åº”ç”¨åˆ°æ‰€æœ‰ç¬”è®°æœ¬çš„æ‰€æœ‰è®°å½•çº¸
                notebooks.forEach(notebook => {
                    notebook.papers.forEach(paper => {
                        paper.style = paper.style || {};
                        paper.style.textAlignment = alignment;
                    });
                });
                
                // ä¿å­˜æ•°æ®
                debouncedSaveToLocalStorage();
                
                // æ›´æ–°UI
                renderPapers();
                
                // æ˜¾ç¤ºæç¤º
                showToast(`å·²å°†æ‰€æœ‰è®°å½•çº¸æ–‡æœ¬è®¾ç½®ä¸º${alignmentLabel}`);
            }
        }
        
        // åº”ç”¨è®¾ç½®
        function applySettings() {
            const paper = getCurrentPaper();
            
            // ä¿å­˜è®°å½•çº¸æ ·å¼è®¾ç½®
            if (paper) {
                paper.style = { ...currentStyle };
                
                // å¤„ç†èƒŒæ™¯å›¾ç‰‡è®¾ç½®
            const backgroundImagePreview = document.getElementById('background-image-preview');
            const previewImage = document.getElementById('preview-image');
            const selectedBgOption = document.querySelector('.bg-image-option.active');
                
                // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡
                if (backgroundImagePreview && backgroundImagePreview.style.display === 'block' && previewImage && previewImage.src) {
                    paper.style.backgroundImage = null; // æ¸…é™¤é¢„è®¾èƒŒæ™¯
                    paper.style.customBackgroundImage = previewImage.src; // è®¾ç½®è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡
                } else if (selectedBgOption) {
                    // ä½¿ç”¨é¢„è®¾èƒŒæ™¯æˆ–æ— èƒŒæ™¯
                    const bgType = selectedBgOption.dataset.image;
                    paper.style.backgroundImage = bgType === 'none' ? null : bgType;
                    paper.style.customBackgroundImage = null; // æ¸…é™¤è‡ªå®šä¹‰èƒŒæ™¯
                }
            }
            
            // ä¿å­˜ä¸»é¢˜è®¾ç½®
            saveTheme();
            
            // æ£€æŸ¥é€‰æ‹©çš„ä¸»é¢˜å¹¶æ˜¾ç¤ºç›¸åº”æç¤º
            const selectedTheme = document.querySelector('.theme-option.selected')?.dataset.theme || 'default';
            if (selectedTheme === 'dark') {
                showToast('æš—é»‘ä¸»é¢˜å¹¶ä¸ä¼šæ”¹å˜æˆ–è¦†ç›–å·²ä½¿ç”¨çš„èƒŒæ™¯å›¾');
            } else if (selectedTheme === 'pastel') {
                showToast('æŸ”å’Œä¸»é¢˜å¹¶ä¸ä¼šæ”¹å˜æˆ–è¦†ç›–å·²ä½¿ç”¨çš„èƒŒæ™¯å›¾');
            } else if (selectedTheme === 'vibrant') {
                showToast('é²œè‰³ä¸»é¢˜å¹¶ä¸ä¼šæ”¹å˜æˆ–è¦†ç›–å·²ä½¿ç”¨çš„èƒŒæ™¯å›¾');
            }
            
            // ä¿å­˜å­˜å‚¨è®¾ç½®
            const selectedStorageType = document.querySelector('input[name="storage-type"]:checked')?.value || 'local';
            localStorage.setItem('threeGridStorageType', selectedStorageType);
            
            // ä¿å­˜æ•°æ®
            saveToLocalStorage();
            
            // æ›´æ–°UI
            renderPapers();
            applyThemeToUI();
            
            // æ˜¾ç¤ºå¯¹é½è®¾ç½®æç¤º
            const selectedAlignmentOption = document.querySelector('.alignment-option.selected');
            if (selectedAlignmentOption && currentStyle.textAlignment) {
                showToast(`æ–‡æœ¬å·²è®¾ç½®ä¸º${selectedAlignmentOption.dataset.label}`);
            }
            
            // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
            settingsModal.style.display = 'none';
        }
        
        // è·å–å½“å‰ä¸»é¢˜
        function getCurrentTheme() {
            return localStorage.getItem('threeGridTheme') || 'default';
        }
        
        // ä¿å­˜ä¸»é¢˜
        function saveTheme() {
            const selectedTheme = document.querySelector('.theme-option.selected')?.dataset.theme || 'default';
            localStorage.setItem('threeGridTheme', selectedTheme);
        }
        
        // åº”ç”¨ä¸»é¢˜åˆ°UI
        function applyThemeToUI() {
            const theme = getCurrentTheme();
            const root = document.documentElement;
            
            // ç§»é™¤æ‰€æœ‰ä¸»é¢˜ç±»
            root.classList.remove('theme-default', 'theme-dark', 'theme-pastel', 'theme-vibrant');
            
            // æ·»åŠ å½“å‰ä¸»é¢˜ç±»
            root.classList.add(`theme-${theme}`);
            
            // è·å–æ‰€æœ‰éœ€è¦æ›´æ–°é¢œè‰²çš„å…ƒç´ 
            const textElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6, p, span, a, li, td, th, label');
            const inputElements = document.querySelectorAll('input, textarea, select');
            const sidebarElements = document.querySelectorAll('.sidebar, .notebook-item, .paper-item');
            const headerElements = document.querySelectorAll('.header, .menu-btn, .search-btn');
            
            // æ ¹æ®ä¸»é¢˜è®¾ç½®ä¸åŒçš„é¢œè‰²å˜é‡
            if (theme === 'dark') {
                // æš—é»‘ä¸»é¢˜
                root.style.setProperty('--primary-color', '#4a5568');
                root.style.setProperty('--secondary-color', '#2d3748');
                root.style.setProperty('--text-color', '#e2e8f0');
                root.style.setProperty('--bg-color', '#1a202c');
                document.body.style.backgroundColor = '#1a202c';
                document.body.style.color = '#e2e8f0';
                
                // é‡ç½®å…ƒç´ æ ·å¼ï¼Œç¡®ä¿è¾“å…¥å…ƒç´ èƒŒæ™¯é€æ˜
                resetElementStyles(textElements, inputElements, sidebarElements, headerElements);
                
                // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å…ƒç´ é¢œè‰²
                textElements.forEach(el => {
                    el.style.color = '#e2e8f0';
                });
                
                // åœ¨æš—é»‘ä¸»é¢˜ä¸‹ï¼Œç‰¹åˆ«åŠ æ·±spanå…ƒç´ çš„æ–‡å­—é¢œè‰²
                const spanElements = document.querySelectorAll('span');
                spanElements.forEach(span => {
                    span.style.color = '#a0aec0';
                });
                
                // æ›´æ–°è¾“å…¥å…ƒç´ çš„é¢œè‰²å’Œè¾¹æ¡†ï¼Œä½†ä¿æŒèƒŒæ™¯é€æ˜
                inputElements.forEach(el => {
                    if (el.tagName === 'TEXTAREA') {
                        // æš—é»‘ä¸»é¢˜ä¸‹çš„è¾“å…¥åŒºtextareaæ–‡å­—é¢œè‰²æ”¹ä¸ºå¸¦10%é‡‘è‰²çš„è–„è·ç»¿
                        el.style.color = '#b8e6cf';
                    } else {
                        el.style.color = '#e2e8f0';
                    }
                    el.style.borderColor = '#4a5568';
                });
                
                // æ›´æ–°è®°å½•çº¸çš„è¡Œçº¿æ¡é¢œè‰²ä¸ºæµ…ç°
                const gridLines = document.querySelectorAll('.grid-line');
                gridLines.forEach(line => {
                    line.style.setProperty('--grid-line-color', '#718096'); // æµ…ç°è‰²
                    line.style.borderBottomColor = '#718096'; // æµ…ç°è‰²
                });
                
                // æ›´æ–°è®°å½•çº¸çš„ç«–çº¿æ¡é¢œè‰²ä¸ºæµ…ç°
                const columns = document.querySelectorAll('.column');
                columns.forEach(col => {
                    col.style.setProperty('--column-border-color', '#718096'); // æµ…ç°è‰²
                });
                
                // æ›´æ–°ä¾§è¾¹æ 
                sidebarElements.forEach(el => {
                    el.style.backgroundColor = '#2d3748';
                });
                
                // æ›´æ–°å¤´éƒ¨ - æš—é»‘ä¸»é¢˜ä¸“ç”¨èƒŒæ™¯
                headerElements.forEach(el => {
                    el.style.background = 'linear-gradient(135deg, #4a5568, #2d3748)';
                    el.style.color = '#ffffff';
                });
                
                // æ›´æ–°ç¬”è®°æœ¬åˆ—è¡¨h3æ ‡é¢˜ - æ·»åŠ é»‘è‰²é®ç½©
                const notebookListHeaders = document.querySelectorAll('.notebook-list h3');
                notebookListHeaders.forEach(h3 => {
                    h3.style.background = 'rgba(0, 0, 0, 0.3)';
                    h3.style.padding = '10px 15px';
                    h3.style.borderRadius = 'var(--radius-small)';
                });
                
                // æ›´æ–°æ‰€æœ‰è®°å½•çº¸èƒŒæ™¯ - æš—é»‘ä¸»é¢˜ä¸“ç”¨ï¼ˆç›´æ¥è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¸ä½¿ç”¨è¦†ç›–å±‚ï¼‰
                const papers = document.querySelectorAll('.paper');
                papers.forEach(paper => {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¦†ç›–å±‚
                    const existingOverlay = paper.querySelector('.theme-overlay');
                    if (existingOverlay) {
                        paper.removeChild(existingOverlay);
                    }
                    
                    // ç›´æ¥è®¾ç½®è®°å½•çº¸çš„èƒŒæ™¯è‰²ï¼Œç¡®ä¿çº¿æ¡å’Œå†…å®¹æ¸…æ™°å¯è§
                    paper.style.backgroundColor = '#2d3748'; // æš—é»‘ä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²
                    
                    // ç¡®ä¿è®°å½•çº¸å†…å®¹å…ƒç´ æ¸…æ™°å¯è§
                    const contentElements = paper.querySelectorAll('.cell-input, .paper-content, .editable-content, .paper-header, .paper-title, button');
                    contentElements.forEach(el => {
                        // å¦‚æœæ˜¯textareaå…ƒç´ ï¼Œä¿æŒä¹‹å‰è®¾ç½®çš„ç‰¹æ®Šé¢œè‰²(#b8e6cf)
                        if (el.tagName !== 'TEXTAREA' && (el.classList.contains('cell-input') || el.classList.contains('paper-content') || el.classList.contains('editable-content'))) {
                            el.style.color = '#e2e8f0'; // æµ…è‰²æ–‡å­—ç¡®ä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸Šçš„å¯è¯»æ€§
                        }
                    });
                });
            } else if (theme === 'pastel') {
                // æŸ”å’Œä¸»é¢˜
                root.style.setProperty('--primary-color', '#ff9e9e');
                root.style.setProperty('--secondary-color', '#ffd9c0');
                root.style.setProperty('--text-color', '#6b7280');
                root.style.setProperty('--bg-color', '#ffffff');
                document.body.style.backgroundColor = '#ffffff';
                document.body.style.color = '#6b7280';
                
                // é‡ç½®å…ƒç´ æ ·å¼
                resetElementStyles(textElements, inputElements, sidebarElements, headerElements);
                
                // æ›´æ–°å¤´éƒ¨ - æŸ”å’Œä¸»é¢˜ä¸“ç”¨èƒŒæ™¯
                headerElements.forEach(el => {
                    el.style.background = 'linear-gradient(135deg, #ff9e9e, #ffd9c0)';
                    el.style.color = '#6b7280';
                });
                
                // æ›´æ–°ç¬”è®°æœ¬åˆ—è¡¨h3æ ‡é¢˜ - æŸ”å’Œä¸»é¢˜ä¸“ç”¨
                const notebookListHeaders = document.querySelectorAll('.notebook-list h3');
                notebookListHeaders.forEach(h3 => {
                    // ä½¿ç”¨æŸ”å’Œçš„æµ…ç²‰è‰²èƒŒæ™¯ï¼Œä¸æŸ”å’Œä¸»é¢˜åè°ƒ
                    h3.style.background = '#ffedec';
                    h3.style.padding = '10px 15px';
                    h3.style.borderRadius = 'var(--radius-small)';
                    h3.style.color = '#6b7280'; // æ·±ç°è‰²æ–‡å­—ï¼Œç¡®ä¿å¯è¯»æ€§
                });
                
                // åº”ç”¨åˆ°æœ¬è®°å½•çº¸å’Œåº”ç”¨åˆ°å…¨éƒ¨æŒ‰é’®çš„æ ·å¼å·²åœ¨updateUIElementsStyleså‡½æ•°ä¸­ç»Ÿä¸€å¤„ç†
                
                // æ›´æ–°æ‰€æœ‰è®°å½•çº¸èƒŒæ™¯ - æŸ”å’Œä¸»é¢˜ä¸“ç”¨ï¼ˆç›´æ¥è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¸ä½¿ç”¨è¦†ç›–å±‚ï¼‰
                const papers = document.querySelectorAll('.paper');
                papers.forEach(paper => {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¦†ç›–å±‚
                    const existingOverlay = paper.querySelector('.theme-overlay');
                    if (existingOverlay) {
                        paper.removeChild(existingOverlay);
                    }
                    
                    // ç›´æ¥è®¾ç½®è®°å½•çº¸çš„èƒŒæ™¯è‰²ï¼Œç¡®ä¿çº¿æ¡å’Œå†…å®¹æ¸…æ™°å¯è§
                    paper.style.backgroundColor = '#fff7e6'; // æŸ”å’Œä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²
                    
                    // ç¡®ä¿è®°å½•çº¸å†…å®¹å…ƒç´ æ¸…æ™°å¯è§
                    const contentElements = paper.querySelectorAll('.cell-input, .paper-content, .editable-content, .paper-header, .paper-title, button');
                    contentElements.forEach(el => {
                        if (el.classList.contains('cell-input') || el.classList.contains('paper-content') || el.classList.contains('editable-content')) {
                            el.style.color = '#6b7280'; // æ·±è‰²æ–‡å­—ç¡®ä¿åœ¨æµ…è‰²èƒŒæ™¯ä¸Šçš„å¯è¯»æ€§
                        }
                    });
                });
            } else if (theme === 'vibrant') {
                // é²œè‰³ä¸»é¢˜ - ä¿®å¤ä¸ºçœŸæ­£é²œè‰³çš„é…è‰²æ–¹æ¡ˆ
                root.style.setProperty('--primary-color', '#ff4d4d'); // é²œè‰³çº¢è‰²ä½œä¸ºä¸»è‰²è°ƒ
                root.style.setProperty('--secondary-color', '#4d79ff'); // é²œè‰³è“è‰²ä½œä¸ºè¾…åŠ©è‰²
                root.style.setProperty('--text-color', '#333333'); // æ·±è‰²æ–‡å­—ç¡®ä¿å¯è¯»æ€§
                root.style.setProperty('--bg-color', '#ffffff'); // ç™½è‰²èƒŒæ™¯
                document.body.style.backgroundColor = '#ffffff';
                document.body.style.color = '#333333';
                
                // é‡ç½®å…ƒç´ æ ·å¼ï¼Œç¡®ä¿è¾“å…¥å…ƒç´ èƒŒæ™¯é€æ˜
                resetElementStyles(textElements, inputElements, sidebarElements, headerElements);
                
                // æ›´æ–°æ‰€æœ‰æ–‡æœ¬å…ƒç´ é¢œè‰²ä¸ºæ·±è‰²ï¼Œç¡®ä¿å¯è¯»æ€§
                textElements.forEach(el => {
                    el.style.color = '#333333';
                });
                
                // æ›´æ–°è¾“å…¥å…ƒç´ çš„è¾¹æ¡†é¢œè‰²ï¼Œä½†ä¿æŒèƒŒæ™¯é€æ˜
                inputElements.forEach(el => {
                    el.style.borderColor = '#ff4d4d'; // ä½¿ç”¨é²œè‰³çº¢è‰²ä½œä¸ºè¾¹æ¡†
                });
                
                // æ›´æ–°ä¾§è¾¹æ  - ä½¿ç”¨æµ…ç°è‰²èƒŒæ™¯
                sidebarElements.forEach(el => {
                    el.style.backgroundColor = '#f9f9f9';
                });
                
                // æ›´æ–°å¤´éƒ¨ - é²œè‰³ä¸»é¢˜ä¸“ç”¨èƒŒæ™¯
                headerElements.forEach(el => {
                    el.style.background = 'linear-gradient(135deg, #ff4d4d, #4d79ff)';
                    el.style.color = '#ffffff'; // å¤´éƒ¨æ–‡å­—ä¿æŒç™½è‰²ä»¥é…åˆæ¸å˜è‰²
                });
                
                // æ›´æ–°ç¬”è®°æœ¬åˆ—è¡¨h3æ ‡é¢˜ - é²œè‰³ä¸»é¢˜ä¸“ç”¨
                const notebookListHeaders = document.querySelectorAll('.notebook-list h3');
                notebookListHeaders.forEach(h3 => {
                    // ä½¿ç”¨é²œè‰³çš„æµ…è“è‰²èƒŒæ™¯ï¼Œä¸é²œè‰³ä¸»é¢˜åè°ƒ
                    h3.style.background = '#e6f3ff';
                    h3.style.padding = '10px 15px';
                    h3.style.borderRadius = 'var(--radius-small)';
                    h3.style.color = '#333333'; // æ·±ç°è‰²æ–‡å­—ï¼Œç¡®ä¿å¯è¯»æ€§
                });
                
                // åº”ç”¨åˆ°æœ¬è®°å½•çº¸å’Œåº”ç”¨åˆ°å…¨éƒ¨æŒ‰é’®çš„æ ·å¼å·²åœ¨updateUIElementsStyleså‡½æ•°ä¸­ç»Ÿä¸€å¤„ç†
                
                // æ›´æ–°æ‰€æœ‰è®°å½•çº¸èƒŒæ™¯ - é²œè‰³ä¸»é¢˜ä¸“ç”¨ï¼ˆç›´æ¥è®¾ç½®èƒŒæ™¯è‰²ï¼Œä¸ä½¿ç”¨è¦†ç›–å±‚ï¼‰
                const papers = document.querySelectorAll('.paper');
                papers.forEach(paper => {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„è¦†ç›–å±‚
                    const existingOverlay = paper.querySelector('.theme-overlay');
                    if (existingOverlay) {
                        paper.removeChild(existingOverlay);
                    }
                    
                    // ç›´æ¥è®¾ç½®è®°å½•çº¸çš„èƒŒæ™¯è‰²ï¼Œç¡®ä¿çº¿æ¡å’Œå†…å®¹æ¸…æ™°å¯è§
                    paper.style.backgroundColor = '#90caf9'; // é²œè‰³ä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²ï¼ˆé²œè‰³äº®è“è‰²ï¼Œé¿å…ä½¿ç”¨é»„è‰²ï¼‰
                    
                    // ç›´æ¥è®¾ç½®è®°å½•çº¸çš„è¡Œçº¿æ¡é¢œè‰²ä¸ºçº¯ç™½è‰²ï¼ˆé²œè‰³ä¸»é¢˜ä¸“ç”¨ï¼‰
                    const gridLines = paper.querySelectorAll('.grid-line');
                    gridLines.forEach(line => {
                        line.style.setProperty('--grid-line-color', '#FFFFFF'); // çº¯ç™½è‰²
                        line.style.borderBottomColor = '#FFFFFF'; // çº¯ç™½è‰²
                    });
                    
                    // ç›´æ¥è®¾ç½®è®°å½•çº¸çš„ç«–çº¿æ¡é¢œè‰²ä¸ºçº¯ç™½è‰²ï¼ˆé²œè‰³ä¸»é¢˜ä¸“ç”¨ï¼‰
                    const columns = paper.querySelectorAll('.column');
                    columns.forEach(col => {
                        col.style.setProperty('--column-border-color', '#FFFFFF'); // çº¯ç™½è‰²
                    });
                    
                    // ç¡®ä¿è®°å½•çº¸å†…å®¹å…ƒç´ æ¸…æ™°å¯è§
                    const contentElements = paper.querySelectorAll('.cell-input, .paper-content, .editable-content, .paper-header, .paper-title, button');
                    contentElements.forEach(el => {
                        if (el.classList.contains('cell-input') || el.classList.contains('paper-content') || el.classList.contains('editable-content')) {
                            el.style.color = '#333333'; // æ·±è‰²æ–‡å­—ç¡®ä¿åœ¨æµ…è‰²èƒŒæ™¯ä¸Šçš„å¯è¯»æ€§
                        }
                    });
                });
            } else {
                // é»˜è®¤ä¸»é¢˜
                root.style.removeProperty('--primary-color');
                root.style.removeProperty('--secondary-color');
                root.style.removeProperty('--text-color');
                root.style.removeProperty('--bg-color');
                document.body.style.backgroundColor = '';
                document.body.style.color = '';
                
                // é‡ç½®å…ƒç´ æ ·å¼
                resetElementStyles(textElements, inputElements, sidebarElements, headerElements);
                
                // æ›´æ–°å¤´éƒ¨ - é»˜è®¤ä¸»é¢˜ä¸“ç”¨èƒŒæ™¯
                headerElements.forEach(el => {
                    el.style.background = 'linear-gradient(135deg, #f3f4f6, #e5e7eb)';
                    el.style.color = '#333333';
                });
                
                // æ›´æ–°ç¬”è®°æœ¬åˆ—è¡¨h3æ ‡é¢˜ - é»˜è®¤ä¸»é¢˜ä¸“ç”¨
                const notebookListHeaders = document.querySelectorAll('.notebook-list h3');
                notebookListHeaders.forEach(h3 => {
                    // è®¾ç½®ä¸ºç™½è‰²èƒŒæ™¯
                    h3.style.background = '#ffffff';
                    h3.style.padding = '10px 15px';
                    h3.style.borderRadius = 'var(--radius-small)';
                    h3.style.color = '#333333'; // æ·±ç°è‰²æ–‡å­—ï¼Œç¡®ä¿å¯è¯»æ€§
                });
                
                // åœ¨é»˜è®¤ä¸»é¢˜ä¸‹ï¼Œæ¢å¤ç”¨æˆ·è‡ªå®šä¹‰çš„è®°å½•çº¸èƒŒæ™¯
                const papers = document.querySelectorAll('.paper');
                papers.forEach(paper => {
                    // ç§»é™¤ä¸»é¢˜è¦†ç›–å±‚
                    const existingOverlay = paper.querySelector('.theme-overlay');
                    if (existingOverlay) {
                        paper.removeChild(existingOverlay);
                    }
                    
                    // è·å–paperId
                    const paperId = paper.dataset.paperId;
                    if (paperId) {
                        // è·å–è®°å½•çº¸çš„è®¾ç½®
                        const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
                        // å¦‚æœæœ‰è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰²ï¼Œåº”ç”¨å®ƒï¼›å¦åˆ™ç§»é™¤å†…è”æ ·å¼ï¼Œä½¿ç”¨CSSé»˜è®¤å€¼
                        if (settings.backgroundColor) {
                            paper.style.backgroundColor = settings.backgroundColor;
                        } else {
                            paper.style.removeProperty('background-color');
                        }
                    }
                });
            }
            
            // æ›´æ–°æ§åˆ¶æ æŒ‰é’®å’Œå…¶ä»–UIå…ƒç´ çš„æ ·å¼
            updateUIElementsStyles();
        }
        
        // é‡ç½®å…ƒç´ æ ·å¼
        function resetElementStyles(textElements, inputElements, sidebarElements, headerElements) {
            // é‡ç½®æ–‡æœ¬å…ƒç´ 
            textElements.forEach(el => {
                el.style.removeProperty('color');
            });
            
            // é‡ç½®è¾“å…¥å…ƒç´ 
            inputElements.forEach(el => {
                el.style.removeProperty('background-color');
                el.style.removeProperty('color');
                el.style.removeProperty('border-color');
            });
            
            // é‡ç½®ä¾§è¾¹æ 
            sidebarElements.forEach(el => {
                el.style.removeProperty('background-color');
            });
            
            // é‡ç½®å¤´éƒ¨
            headerElements.forEach(el => {
                el.style.removeProperty('background-color');
                el.style.removeProperty('background');
                el.style.removeProperty('color');
            });
            
            // é‡ç½®è®°å½•çº¸çš„è¡Œçº¿æ¡æ ·å¼
            const gridLines = document.querySelectorAll('.grid-line');
            gridLines.forEach(line => {
                line.style.removeProperty('--grid-line-color');
                line.style.removeProperty('border-bottom-color');
            });
            
            // é‡ç½®è®°å½•çº¸çš„ç«–çº¿æ¡æ ·å¼
            const columns = document.querySelectorAll('.column');
            columns.forEach(col => {
                col.style.removeProperty('--column-border-color');
            });
        }
        
        // åº”ç”¨è¡Œçº¿æ¡æ ·å¼åˆ°æŒ‡å®šè®°å½•çº¸
        function applyLineStyleToPaper(paperData, lineStyle) {
            if (!paperData || !lineStyle) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) return;
            
            // è®¾ç½®data-line-styleå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-line-style', lineStyle);
            
            // è·å–æ‰€æœ‰ç½‘æ ¼è¡Œ
            const gridLines = paperElement.querySelectorAll('.grid-line');
            
            // åº”ç”¨è¡Œçº¿æ¡æ ·å¼
            gridLines.forEach(line => {
                line.style.borderBottomStyle = lineStyle;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.lineStyle = lineStyle;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
        }
        
        // åº”ç”¨è¡Œçº¿æ¡æ ·å¼åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyLineStyleToAllPapers(lineStyle) {
            if (!lineStyle) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyLineStyleToPaper(paper, lineStyle);
            });
        }
        
        // åº”ç”¨ç«–çº¿æ¡æ ·å¼åˆ°æŒ‡å®šè®°å½•çº¸
        function applyColumnStyleToPaper(paperData, columnStyle) {
            if (!paperData || !columnStyle) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) return;
            
            // è®¾ç½®data-column-styleå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-column-style', columnStyle);
            
            // è·å–æ‰€æœ‰åˆ—
            const columns = paperElement.querySelectorAll('.column');
            
            // åº”ç”¨ç«–çº¿æ¡æ ·å¼
            columns.forEach(col => {
                col.style.borderRightStyle = columnStyle;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.columnStyle = columnStyle;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
        }
        
        // åº”ç”¨ç«–çº¿æ¡æ ·å¼åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyColumnStyleToAllPapers(columnStyle) {
            if (!columnStyle) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyColumnStyleToPaper(paper, columnStyle);
            });
        }
        
        // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°æŒ‡å®šè®°å½•çº¸
        function applyLineColorToPaper(paperData, lineColor) {
            if (!paperData || !lineColor) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) return;
            
            // è®¾ç½®data-line-colorå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-line-color', lineColor);
            
            // è·å–æ‰€æœ‰ç½‘æ ¼è¡Œå’Œåˆ—
            const gridLines = paperElement.querySelectorAll('.grid-line');
            const columns = paperElement.querySelectorAll('.column');
            
            // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°è¡Œ
            gridLines.forEach(line => {
                line.style.borderBottomColor = lineColor;
            });
            
            // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°åˆ—
            columns.forEach(col => {
                col.style.borderRightColor = lineColor;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.lineColor = lineColor;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
        }
        
        // åº”ç”¨çº¿æ¡é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyLineColorToAllPapers(lineColor) {
            if (!lineColor) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyLineColorToPaper(paper, lineColor);
            });
        }
        
        // åº”ç”¨èƒŒæ™¯é¢œè‰²åˆ°æŒ‡å®šè®°å½•çº¸
        function applyBgColorToPaper(paperData, bgColor) {
            if (!paperData || !bgColor) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) return;
            
            // åº”ç”¨èƒŒæ™¯é¢œè‰²
            paperElement.style.backgroundColor = bgColor;
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.backgroundColor = bgColor;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
            
            // åŒæ—¶æ›´æ–°notebooksæ•°æ®ç»“æ„ä¸­çš„èƒŒæ™¯é¢œè‰²
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (currentNotebook) {
                const paper = currentNotebook.papers.find(p => p.id === paperId);
                if (paper) {
                    if (!paper.style) {
                        paper.style = {};
                    }
                    paper.style.backgroundColor = bgColor;
                    currentNotebook.updatedAt = new Date().toISOString();
                    debouncedSaveToLocalStorage();
                }
            }
        }
        
        // åº”ç”¨èƒŒæ™¯é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyBgColorToAllPapers(bgColor) {
            if (!bgColor) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyBgColorToPaper(paper, bgColor);
            });
        }
        
        // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°æŒ‡å®šè®°å½•çº¸
        function applyTextColorToPaper(paperData, textColor) {
            if (!paperData || !textColor) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) return;
            
            // è®¾ç½®data-text-colorå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-text-color', textColor);
            
            // è·å–æ‰€æœ‰å•å…ƒæ ¼è¾“å…¥æ¡†å’Œå†…å®¹åŒºåŸŸ
            const inputElements = paperElement.querySelectorAll('.cell-input');
            const contentAreas = paperElement.querySelectorAll('.paper-content, .editable-content');
            
            // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°è¾“å…¥æ¡†
            inputElements.forEach(input => {
                input.style.color = textColor;
            });
            
            // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°å…¶ä»–å†…å®¹åŒºåŸŸ
            contentAreas.forEach(area => {
                area.style.color = textColor;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.textColor = textColor;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
            console.log('Saved textColor to localStorage:', textColor);
        }
        
        // åº”ç”¨æ–‡å­—é¢œè‰²åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyTextColorToAllPapers(textColor) {
            if (!textColor) return;
            
            // ä¿å­˜å½“å‰çš„çº¿æ¡æ ·å¼è®¾ç½®ï¼Œé˜²æ­¢åœ¨é‡æ–°æ¸²æŸ“æ—¶è¢«å…¨å±€åº”ç”¨
            const tempLineStyle = currentStyle.lineStyle;
            const tempColumnBorderStyle = currentStyle.columnBorderStyle;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyTextColorToPaper(paper, textColor);
            });
            
            // æ¢å¤åŸå§‹çš„çº¿æ¡æ ·å¼è®¾ç½®
            currentStyle.lineStyle = tempLineStyle;
            currentStyle.columnBorderStyle = tempColumnBorderStyle;
        }
        
        // åº”ç”¨å­—ä½“åˆ°æŒ‡å®šè®°å½•çº¸
        function applyFontToPaper(paperData, font) {
            if (!paperData || !font) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                // æ²¡æœ‰æœ‰æ•ˆçš„paperDataï¼Œæç¤ºç”¨æˆ·
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) {
                // æ‰¾ä¸åˆ°è®°å½•çº¸å…ƒç´ ï¼Œæç¤ºç”¨æˆ·
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // è®¾ç½®data-fontå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-font', font);
            
            // è·å–æ‰€æœ‰å•å…ƒæ ¼è¾“å…¥æ¡†å’Œå†…å®¹åŒºåŸŸ
            const inputElements = paperElement.querySelectorAll('.cell-input');
            const contentAreas = paperElement.querySelectorAll('.paper-content, .editable-content');
            
            // åº”ç”¨å­—ä½“åˆ°è¾“å…¥æ¡†
            inputElements.forEach(input => {
                input.style.fontFamily = font;
            });
            
            // åº”ç”¨å­—ä½“åˆ°å…¶ä»–å†…å®¹åŒºåŸŸ
            contentAreas.forEach(area => {
                area.style.fontFamily = font;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.font = font;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
        }
        
        // åº”ç”¨å­—ä½“åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyFontToAllPapers(font) {
            if (!font) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyFontToPaper(paper, font);
            });
        }
        
        // åº”ç”¨å­—å·åˆ°æŒ‡å®šè®°å½•çº¸
        function applyFontSizeToPaper(paperData, fontSize) {
            if (!paperData || !fontSize) return;
            
            // ç¡®å®špaperId - æ£€æŸ¥ä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡è¿˜æ˜¯DOMå…ƒç´ 
            let paperId;
            if (paperData.id) {
                // å¦‚æœä¼ å…¥çš„æ˜¯æ•°æ®å¯¹è±¡
                paperId = paperData.id;
            } else if (paperData.dataset && paperData.dataset.paperId) {
                // å¦‚æœä¼ å…¥çš„æ˜¯DOMå…ƒç´ ï¼Œä»data-paper-idå±æ€§è·å–
                paperId = paperData.dataset.paperId;
            } else {
                // æ²¡æœ‰æœ‰æ•ˆçš„paperDataï¼Œæç¤ºç”¨æˆ·
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„DOMå…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) {
                // æ‰¾ä¸åˆ°è®°å½•çº¸å…ƒç´ ï¼Œæç¤ºç”¨æˆ·
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // è®¾ç½®data-font-sizeå±æ€§ï¼Œä¾›é‡æ–°æ¸²æŸ“æ—¶ä½¿ç”¨
            paperElement.setAttribute('data-font-size', fontSize);
            
            // è·å–æ‰€æœ‰å•å…ƒæ ¼è¾“å…¥æ¡†å’Œå†…å®¹åŒºåŸŸ
            const inputElements = paperElement.querySelectorAll('.cell-input');
            const contentAreas = paperElement.querySelectorAll('.paper-content, .editable-content');
            
            // åº”ç”¨å­—å·åˆ°è¾“å…¥æ¡†
            inputElements.forEach(input => {
                input.style.fontSize = fontSize;
            });
            
            // åº”ç”¨å­—å·åˆ°å…¶ä»–å†…å®¹åŒºåŸŸ
            contentAreas.forEach(area => {
                area.style.fontSize = fontSize;
            });
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
            settings.fontSize = fontSize;
            localStorage.setItem('paperSettings_' + paperId, JSON.stringify(settings));
        }
        
        // åº”ç”¨å­—å·åˆ°æ‰€æœ‰è®°å½•çº¸
        function applyFontSizeToAllPapers(fontSize) {
            if (!fontSize) return;
            
            // è·å–æ‰€æœ‰è®°å½•çº¸
            const allPapers = document.querySelectorAll('.paper');
            
            allPapers.forEach(paper => {
                applyFontSizeToPaper(paper, fontSize);
            });
        }
        
        // æ›´æ–°UIå…ƒç´ çš„æ ·å¼
        function updateUIElementsStyles() {
            const theme = getCurrentTheme();
            const buttons = document.querySelectorAll('.btn');
            const modals = document.querySelectorAll('.modal');
            const recycleBins = document.querySelectorAll('.recycle-bin');
            const mobileRecycleModals = document.querySelectorAll('.mobile-recycle-modal');
            const bgImageOptions = document.querySelectorAll('.bg-image-option');
            const fontOptions = document.querySelectorAll('.font-option');
            
            // å¤„ç†èƒŒæ™¯é€‰é¡¹çš„æ ·å¼
            bgImageOptions.forEach(option => {
                if (theme === 'dark') {
                    // æš—é»‘ä¸»é¢˜ä¸‹ï¼Œä½¿ç”¨è¾ƒæµ…çš„ç°è‰²æ–‡å­—ï¼Œç¡®ä¿æ¸…æ™°å¯è§ä½†ä¸è¿‡äºæ˜¾çœ¼
                    option.style.color = '#a0aec0';
                    // å¯¹äºé€‰ä¸­çŠ¶æ€çš„é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨æ›´äº®çš„é¢œè‰²
                    if (option.classList.contains('selected')) {
                        option.style.color = '#e2e8f0';
                    }
                } else {
                    // å…¶ä»–ä¸»é¢˜ï¼Œç§»é™¤å†…è”æ ·å¼
                    option.style.removeProperty('color');
                }
            });
            
            // å¤„ç†å­—ä½“é€‰é¡¹çš„æ ·å¼
            fontOptions.forEach(option => {
                if (theme === 'dark') {
                    // æš—é»‘ä¸»é¢˜ä¸‹ï¼Œä½¿ç”¨è¾ƒæµ…çš„ç°è‰²æ–‡å­—ï¼Œç¡®ä¿æ¸…æ™°å¯è§ä½†ä¸è¿‡äºæ˜¾çœ¼
                    option.style.color = '#a0aec0';
                    // å¯¹äºé€‰ä¸­çŠ¶æ€çš„é€‰é¡¹ï¼Œå¯ä»¥ä½¿ç”¨æ›´äº®çš„é¢œè‰²
                    if (option.classList.contains('selected')) {
                        option.style.color = '#e2e8f0';
                    }
                }
            });

            // ç»Ÿä¸€å¤„ç†æ‰€æœ‰æŒ‰é’®çš„æ ·å¼ï¼ŒåŒ…æ‹¬æ§åˆ¶æ å’Œä¾§è¾¹æ çš„èœå•æŒ‰é’®
            buttons.forEach(btn => {
                // å…ˆé‡ç½®æ‰€æœ‰æ ·å¼
                btn.style.removeProperty('background-color');
                btn.style.removeProperty('background');
                btn.style.removeProperty('color');
                btn.style.removeProperty('border');
                btn.style.removeProperty('border-color');
                
                // ç‰¹æ®Šå¤„ç†"åº”ç”¨åˆ°æœ¬è®°å½•çº¸"å’Œ"åº”ç”¨åˆ°å…¨éƒ¨"æŒ‰é’®
                const isApplyButton = btn.id.includes('apply-text-color') || 
                                     btn.id.includes('apply-font') || 
                                     btn.id.includes('apply-font-size') || 
                                     btn.id.includes('apply-to') ||
                                     btn.id.includes('apply-bg-color') ||
                                     btn.id.includes('apply-line-style') ||
                                     btn.id.includes('apply-column-style') ||
                                     btn.id.includes('apply-line-color');
                
                // æ ¹æ®ä¸»é¢˜è®¾ç½®æ ·å¼
                if (isApplyButton) {
                    // å¯¹é½è®¾ç½®æŒ‰é’®çš„æ ·å¼ - ç»Ÿä¸€ä¸‰ä¸ªä¸»é¢˜ä¸‹çš„æ ·å¼
                    if (theme === 'dark') {
                        // æš—é»‘ä¸»é¢˜ä¸‹çš„ç‰¹æ®Šæ ·å¼
                        btn.style.backgroundColor = '#4a5568';
                        btn.style.background = '#4a5568';
                        btn.style.color = '#e2e8f0';
                        btn.style.border = 'none';
                    } else if (theme === 'vibrant') {
                        // é²œè‰³ä¸»é¢˜ä¸‹çš„ç‰¹æ®Šæ ·å¼
                        btn.style.backgroundColor = '#6666cc';
                        btn.style.background = '#6666cc';
                        btn.style.color = '#ffffff';
                        btn.style.border = 'none';
                    } else if (theme === 'pastel') {
                        // æŸ”å’Œä¸»é¢˜ä¸‹çš„ç‰¹æ®Šæ ·å¼
                        btn.style.backgroundColor = '#ffc2c2';
                        btn.style.background = '#ffc2c2';
                        btn.style.color = '#6b7280';
                        btn.style.border = 'none';
                    }
                } else if (theme === 'dark') {
                    // æš—é»‘ä¸»é¢˜ - ä¿æŒåŸæœ‰çš„ç°è‰²ç³»
                    if (btn.classList.contains('btn-primary')) {
                        btn.style.backgroundColor = '#4a5568';
                        btn.style.background = '#4a5568'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                    } else if (btn.classList.contains('btn-secondary') || btn.classList.contains('btn-tertiary')) {
                        btn.style.backgroundColor = '#2d3748';
                        btn.style.background = '#2d3748'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                        // ä¸ºå–æ¶ˆæŒ‰é’®æ·»åŠ ç°è‰²å¤–æ¡†
                        btn.style.border = '1px solid #4a5568';
                        btn.style.borderColor = '#4a5568';
                    }
                    btn.style.color = '#e2e8f0';
                } else if (theme === 'vibrant') {
                    // é²œè‰³ä¸»é¢˜ - ä½¿ç”¨é²œè‰³çš„é¢œè‰²æ–¹æ¡ˆ
                    if (btn.classList.contains('btn-primary')) {
                        btn.style.backgroundColor = '#ff4d4d'; // é²œè‰³çº¢è‰²ä½œä¸ºä¸»æŒ‰é’®èƒŒæ™¯
                        btn.style.background = '#ff4d4d'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                    } else if (btn.classList.contains('btn-secondary')) {
                        btn.style.backgroundColor = '#4d79ff'; // é²œè‰³è“è‰²ä½œä¸ºæ¬¡è¦æŒ‰é’®èƒŒæ™¯
                        btn.style.background = '#4d79ff'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                    } else if (btn.classList.contains('btn-tertiary')) {
                        btn.style.backgroundColor = '#ffd166'; // é²œè‰³é»„è‰²ä½œä¸ºç¬¬ä¸‰çº§æŒ‰é’®èƒŒæ™¯
                        btn.style.background = '#ffd166'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                        btn.style.color = '#333333'; // æ·±è‰²æ–‡å­—ç¡®ä¿å¯è¯»æ€§
                    } else {
                        btn.style.color = '#ffffff'; // å…¶ä»–æŒ‰é’®ä½¿ç”¨ç™½è‰²æ–‡å­—
                    }
                } else if (theme === 'pastel') {
                    if (btn.classList.contains('btn-primary')) {
                        btn.style.backgroundColor = '#ff9e9e';
                        btn.style.background = '#ff9e9e'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                    } else if (btn.classList.contains('btn-secondary')) {
                        btn.style.backgroundColor = '#ffd9c0';
                        btn.style.background = '#ffd9c0'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                    } else if (btn.classList.contains('btn-tertiary')) {
                        btn.style.backgroundColor = '#fff1d0'; // æŸ”å’Œé»„è‰²ä½œä¸ºç¬¬ä¸‰çº§æŒ‰é’®èƒŒæ™¯
                        btn.style.background = '#fff1d0'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                        btn.style.color = '#6b7280'; // ç°è‰²æ–‡å­—ç¡®ä¿å¯è¯»æ€§
                    } else {
                        btn.style.color = '#6b7280'; // å…¶ä»–æŒ‰é’®ä½¿ç”¨ç°è‰²æ–‡å­—
                    }
                } else {
                    // é»˜è®¤ä¸»é¢˜ï¼Œç§»é™¤æ‰€æœ‰å†…è”æ ·å¼ï¼ŒåŒ…æ‹¬backgroundå±æ€§
                    btn.style.removeProperty('background-color');
                    btn.style.removeProperty('background'); // ç§»é™¤èƒŒæ™¯å±æ€§ï¼Œç¡®ä¿æ¢å¤é»˜è®¤æ ·å¼
                    btn.style.removeProperty('color');
                }
            });
            
            modals.forEach(modal => {
                if (theme === 'dark') {
                    modal.querySelector('.modal-content').style.backgroundColor = '#2d3748';
                    modal.querySelector('.modal-content').style.color = '#e2e8f0';
                    
                    // å¤„ç†æ¨¡æ€æ¡†å¤´éƒ¨
                    const modalHeader = modal.querySelector('.modal-header');
                    if (modalHeader) {
                        modalHeader.style.backgroundColor = '#2d3748';
                        modalHeader.style.color = '#e2e8f0';
                    }
                    
                    // å¤„ç†è®¾ç½®æ ‡ç­¾æŒ‰é’®
                    const tabBtns = modal.querySelectorAll('.tab-btn');
                    tabBtns.forEach(btn => {
                        btn.style.color = '#e2e8f0';
                    });
                    
                    // å¤„ç†æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®åŒºåŸŸ
                    const modalActions = modal.querySelector('.modal-actions');
                    if (modalActions) {
                        modalActions.style.backgroundColor = '#2d3748';
                    }
                } else if (theme === 'vibrant') {
                    modal.querySelector('.modal-content').style.backgroundColor = '#ffffff';
                    modal.querySelector('.modal-content').style.color = '#333333';
                    
                    // å¤„ç†æ¨¡æ€æ¡†å¤´éƒ¨
                    const modalHeader = modal.querySelector('.modal-header');
                    if (modalHeader) {
                        modalHeader.style.backgroundColor = '#ffffff';
                        modalHeader.style.color = '#333333';
                    }
                    
                    // å¤„ç†è®¾ç½®æ ‡ç­¾æŒ‰é’®
                    const tabBtns = modal.querySelectorAll('.tab-btn');
                    tabBtns.forEach(btn => {
                        btn.style.color = '#333333';
                    })
                    
                    // é‡ç½®æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®åŒºåŸŸæ ·å¼
                    const modalActions = modal.querySelector('.modal-actions');
                    if (modalActions) {
                        modalActions.style.removeProperty('background-color');
                    };
                } else if (theme === 'pastel') {
                    modal.querySelector('.modal-content').style.backgroundColor = '#ffffff';
                    modal.querySelector('.modal-content').style.color = '#6b7280';
                    
                    // å¤„ç†æ¨¡æ€æ¡†å¤´éƒ¨
                    const modalHeader = modal.querySelector('.modal-header');
                    if (modalHeader) {
                        modalHeader.style.backgroundColor = '#ffffff';
                        modalHeader.style.color = '#6b7280';
                    }
                    
                    // å¤„ç†è®¾ç½®æ ‡ç­¾æŒ‰é’®
                    const tabBtns = modal.querySelectorAll('.tab-btn');
                    tabBtns.forEach(btn => {
                        btn.style.color = '#6b7280';
                    })
                    
                    // é‡ç½®æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®åŒºåŸŸæ ·å¼
                    const modalActions = modal.querySelector('.modal-actions');
                    if (modalActions) {
                        modalActions.style.removeProperty('background-color');
                    };
                } else {
                    // é»˜è®¤ä¸»é¢˜ï¼Œç§»é™¤å†…è”æ ·å¼
                    modal.querySelector('.modal-content').style.removeProperty('background-color');
                    modal.querySelector('.modal-content').style.removeProperty('color');
                    
                    // å¤„ç†æ¨¡æ€æ¡†å¤´éƒ¨
                    const modalHeader = modal.querySelector('.modal-header');
                    if (modalHeader) {
                        modalHeader.style.removeProperty('background-color');
                        modalHeader.style.removeProperty('color');
                    }
                    
                    // å¤„ç†è®¾ç½®æ ‡ç­¾æŒ‰é’®
                    const tabBtns = modal.querySelectorAll('.tab-btn');
                    tabBtns.forEach(btn => {
                        btn.style.removeProperty('color');
                    })
                    
                    // é‡ç½®æ¨¡æ€æ¡†åº•éƒ¨æŒ‰é’®åŒºåŸŸæ ·å¼
                    const modalActions = modal.querySelector('.modal-actions');
                    if (modalActions) {
                        modalActions.style.removeProperty('background-color');
                    };
                }
            });

            // å¤„ç†å›æ”¶ç«™æ ·å¼
            recycleBins.forEach(recycleBin => {
                if (theme === 'dark') {
                    // æš—é»‘ä¸»é¢˜ä¸‹çš„å›æ”¶ç«™æ ·å¼
                    recycleBin.style.backgroundColor = '#2d3748';
                    recycleBin.style.color = '#e2e8f0';
                    
                    // å¤„ç†å›æ”¶ç«™å¤´éƒ¨
                    const recycleHeader = recycleBin.querySelector('.recycle-header');
                    if (recycleHeader) {
                        recycleHeader.style.borderBottomColor = '#4a5568';
                        const headerTitle = recycleHeader.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.color = '#e2e8f0';
                        }
                    }
                    
                    // å¤„ç†å›æ”¶ç«™å†…å®¹é¡¹
                    const recycleItems = recycleBin.querySelectorAll('.recycle-item');
                    recycleItems.forEach(item => {
                        item.style.backgroundColor = '#1a202c';
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.color = '#e2e8f0';
                        if (metaEl) metaEl.style.color = '#a0aec0';
                        if (dateEl) dateEl.style.color = '#718096';
                    });
                    
                    // å¤„ç†è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - æš—é»‘ä¸»é¢˜
                    const paperTags = recycleBin.querySelectorAll('.recycle-item-type.paper');
                    paperTags.forEach(tag => {
                        tag.style.backgroundColor = '#4a5568';
                        tag.style.color = '#e2e8f0';
                        tag.style.border = '1px solid #4a5568';
                    });
                    
                    const notebookTags = recycleBin.querySelectorAll('.recycle-item-type.notebook');
                    notebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#4a5568';
                        tag.style.color = '#e2e8f0';
                        tag.style.border = '1px solid #4a5568';
                    });
                    
                    // å¤„ç†åº•éƒ¨è¾¹æ¡†
                    const recycleFooter = recycleBin.querySelector('.recycle-footer');
                    if (recycleFooter) {
                        recycleFooter.style.borderTopColor = '#4a5568';
                    }
                    
                    // å¤„ç†è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = recycleBin.querySelectorAll('.filter-btn');
                    filterBtns.forEach(btn => {
                        if (btn.classList.contains('active')) {
                            btn.style.backgroundColor = '#4a5568';
                            btn.style.color = '#e2e8f0';
                        } else {
                            btn.style.backgroundColor = '#1a202c';
                            btn.style.color = '#a0aec0';
                        }
                    });
                } else if (theme === 'vibrant') {
                    // é²œè‰³ä¸»é¢˜ä¸‹çš„å›æ”¶ç«™æ ·å¼
                    recycleBin.style.removeProperty('background-color');
                    recycleBin.style.removeProperty('color');
                    
                    // å¤„ç†å›æ”¶ç«™å¤´éƒ¨
                    const recycleHeader = recycleBin.querySelector('.recycle-header');
                    if (recycleHeader) {
                        recycleHeader.style.removeProperty('border-bottom-color');
                        const headerTitle = recycleHeader.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å›æ”¶ç«™å†…å®¹é¡¹
                    const recycleItems = recycleBin.querySelectorAll('.recycle-item');
                    recycleItems.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - é²œè‰³ä¸»é¢˜
                    const paperTags = recycleBin.querySelectorAll('.recycle-item-type.paper');
                    paperTags.forEach(tag => {
                        tag.style.backgroundColor = '#ff6b6b'; // é²œè‰³çº¢è‰²
                        tag.style.color = '#ffffff';
                        tag.style.border = '1px solid #ff6b6b';
                    });
                    
                    const notebookTags = recycleBin.querySelectorAll('.recycle-item-type.notebook');
                    notebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#4d79ff'; // é²œè‰³è“è‰²
                        tag.style.color = '#ffffff';
                        tag.style.border = '1px solid #4d79ff';
                    });
                    
                    // å¤„ç†åº•éƒ¨è¾¹æ¡†
                    const recycleFooter = recycleBin.querySelector('.recycle-footer');
                    if (recycleFooter) {
                        recycleFooter.style.removeProperty('border-top-color');
                    }
                    
                    // å¤„ç†è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = recycleBin.querySelectorAll('.filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                } else if (theme === 'pastel') {
                    // æŸ”å’Œä¸»é¢˜ä¸‹çš„å›æ”¶ç«™æ ·å¼
                    recycleBin.style.removeProperty('background-color');
                    recycleBin.style.removeProperty('color');
                    
                    // å¤„ç†å›æ”¶ç«™å¤´éƒ¨
                    const recycleHeader = recycleBin.querySelector('.recycle-header');
                    if (recycleHeader) {
                        recycleHeader.style.removeProperty('border-bottom-color');
                        const headerTitle = recycleHeader.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å›æ”¶ç«™å†…å®¹é¡¹
                    const recycleItems = recycleBin.querySelectorAll('.recycle-item');
                    recycleItems.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - æŸ”å’Œä¸»é¢˜
                    const paperTags = recycleBin.querySelectorAll('.recycle-item-type.paper');
                    paperTags.forEach(tag => {
                        tag.style.backgroundColor = '#b9e0ff'; // æŸ”å’Œè“è‰²
                        tag.style.color = '#4b5563';
                        tag.style.border = '1px solid #b9e0ff';
                    });
                    
                    const notebookTags = recycleBin.querySelectorAll('.recycle-item-type.notebook');
                    notebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#ffd6b9'; // æŸ”å’Œæ©™è‰²
                        tag.style.color = '#4b5563';
                        tag.style.border = '1px solid #ffd6b9';
                    });
                    
                    // å¤„ç†åº•éƒ¨è¾¹æ¡†
                    const recycleFooter = recycleBin.querySelector('.recycle-footer');
                    if (recycleFooter) {
                        recycleFooter.style.removeProperty('border-top-color');
                    }
                    
                    // å¤„ç†è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = recycleBin.querySelectorAll('.filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                } else {
                    // å…¶ä»–ä¸»é¢˜ï¼Œç§»é™¤å†…è”æ ·å¼
                    recycleBin.style.removeProperty('background-color');
                    recycleBin.style.removeProperty('color');
                    
                    // å¤„ç†å›æ”¶ç«™å¤´éƒ¨
                    const recycleHeader = recycleBin.querySelector('.recycle-header');
                    if (recycleHeader) {
                        recycleHeader.style.removeProperty('border-bottom-color');
                        const headerTitle = recycleHeader.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å›æ”¶ç«™å†…å®¹é¡¹
                    const recycleItems = recycleBin.querySelectorAll('.recycle-item');
                    recycleItems.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†åº•éƒ¨è¾¹æ¡†
                    const recycleFooter = recycleBin.querySelector('.recycle-footer');
                    if (recycleFooter) {
                        recycleFooter.style.removeProperty('border-top-color');
                    }
                    
                    // å¤„ç†è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = recycleBin.querySelectorAll('.filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                }
            });

            // å¤„ç†ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—æ ·å¼
            mobileRecycleModals.forEach(modal => {
                if (theme === 'dark') {
                    // æš—é»‘ä¸»é¢˜ä¸‹çš„ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—æ ·å¼
                    const content = modal.querySelector('.mobile-recycle-content');
                    if (content) {
                        content.style.backgroundColor = '#2d3748';
                        content.style.color = '#e2e8f0';
                    }
                    
                    // å¤„ç†å¼¹çª—å¤´éƒ¨
                    const header = modal.querySelector('.mobile-recycle-header');
                    if (header) {
                        const headerTitle = header.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.color = '#e2e8f0';
                        }
                        
                        const closeBtn = header.querySelector('.mobile-recycle-close');
                        if (closeBtn) {
                            closeBtn.style.color = '#e2e8f0';
                        }
                    }
                    
                    // å¤„ç†å¼¹çª—å†…å®¹é¡¹
                    const items = modal.querySelectorAll('#mobile-recycle-items .recycle-item');
                    items.forEach(item => {
                        item.style.backgroundColor = '#1a202c';
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.color = '#e2e8f0';
                        if (metaEl) metaEl.style.color = '#a0aec0';
                        if (dateEl) dateEl.style.color = '#718096';
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - æš—é»‘ä¸»é¢˜
                    const mobilePaperTags = modal.querySelectorAll('.recycle-item-type.paper');
                    mobilePaperTags.forEach(tag => {
                        tag.style.backgroundColor = '#4a5568';
                        tag.style.color = '#e2e8f0';
                        tag.style.border = '1px solid #4a5568';
                    });
                    
                    const mobileNotebookTags = modal.querySelectorAll('.recycle-item-type.notebook');
                    mobileNotebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#4a5568';
                        tag.style.color = '#e2e8f0';
                        tag.style.border = '1px solid #4a5568';
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = modal.querySelectorAll('#mobile-recycle-filter .filter-btn');
                    filterBtns.forEach(btn => {
                        if (btn.classList.contains('active')) {
                            btn.style.backgroundColor = '#4a5568';
                            btn.style.color = '#e2e8f0';
                        } else {
                            btn.style.backgroundColor = '#1a202c';
                            btn.style.color = '#a0aec0';
                        }
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯æ¸…ç©ºå›æ”¶ç«™æŒ‰é’®
                    const emptyRecycleBtn = modal.querySelector('#mobile-empty-recycle-btn');
                    if (emptyRecycleBtn) {
                        emptyRecycleBtn.style.backgroundColor = '#742a2a'; // æš—é»‘ä¸»é¢˜ä¸‹çš„æš—çº¢è‰²
                        emptyRecycleBtn.style.background = '#742a2a'; // è¦†ç›–ä»»ä½•å¯èƒ½çš„æ¸å˜èƒŒæ™¯
                        emptyRecycleBtn.style.color = '#e2e8f0'; // æµ…è‰²æ–‡å­—ç¡®ä¿å¯è¯»æ€§
                    }
                } else if (theme === 'vibrant') {
                    // é²œè‰³ä¸»é¢˜ä¸‹çš„ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—æ ·å¼
                    const content = modal.querySelector('.mobile-recycle-content');
                    if (content) {
                        content.style.removeProperty('background-color');
                        content.style.removeProperty('color');
                    }
                    
                    // å¤„ç†å¼¹çª—å¤´éƒ¨
                    const header = modal.querySelector('.mobile-recycle-header');
                    if (header) {
                        const headerTitle = header.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                        
                        const closeBtn = header.querySelector('.mobile-recycle-close');
                        if (closeBtn) {
                            closeBtn.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å¼¹çª—å†…å®¹é¡¹
                    const items = modal.querySelectorAll('#mobile-recycle-items .recycle-item');
                    items.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - é²œè‰³ä¸»é¢˜
                    const mobilePaperTags = modal.querySelectorAll('.recycle-item-type.paper');
                    mobilePaperTags.forEach(tag => {
                        tag.style.backgroundColor = '#ff6b6b'; // é²œè‰³çº¢è‰²
                        tag.style.color = '#ffffff';
                        tag.style.border = '1px solid #ff6b6b';
                    });
                    
                    const mobileNotebookTags = modal.querySelectorAll('.recycle-item-type.notebook');
                    mobileNotebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#4d79ff'; // é²œè‰³è“è‰²
                        tag.style.color = '#ffffff';
                        tag.style.border = '1px solid #4d79ff';
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = modal.querySelectorAll('#mobile-recycle-filter .filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯æ¸…ç©ºå›æ”¶ç«™æŒ‰é’®
                    const emptyRecycleBtn = modal.querySelector('#mobile-empty-recycle-btn');
                    if (emptyRecycleBtn) {
                        emptyRecycleBtn.style.removeProperty('background-color');
                        emptyRecycleBtn.style.removeProperty('background');
                        emptyRecycleBtn.style.removeProperty('color');
                    }
                } else if (theme === 'pastel') {
                    // æŸ”å’Œä¸»é¢˜ä¸‹çš„ç§»åŠ¨ç«¯å›æ”¶ç«™å¼¹çª—æ ·å¼
                    const content = modal.querySelector('.mobile-recycle-content');
                    if (content) {
                        content.style.removeProperty('background-color');
                        content.style.removeProperty('color');
                    }
                    
                    // å¤„ç†å¼¹çª—å¤´éƒ¨
                    const header = modal.querySelector('.mobile-recycle-header');
                    if (header) {
                        const headerTitle = header.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                        
                        const closeBtn = header.querySelector('.mobile-recycle-close');
                        if (closeBtn) {
                            closeBtn.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å¼¹çª—å†…å®¹é¡¹
                    const items = modal.querySelectorAll('#mobile-recycle-items .recycle-item');
                    items.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è®°å½•çº¸/è®°å½•æœ¬æ ‡ç­¾æ ·å¼ - æŸ”å’Œä¸»é¢˜
                    const mobilePaperTags = modal.querySelectorAll('.recycle-item-type.paper');
                    mobilePaperTags.forEach(tag => {
                        tag.style.backgroundColor = '#b9e0ff'; // æŸ”å’Œè“è‰²
                        tag.style.color = '#4b5563';
                        tag.style.border = '1px solid #b9e0ff';
                    });
                    
                    const mobileNotebookTags = modal.querySelectorAll('.recycle-item-type.notebook');
                    mobileNotebookTags.forEach(tag => {
                        tag.style.backgroundColor = '#ffd6b9'; // æŸ”å’Œæ©™è‰²
                        tag.style.color = '#4b5563';
                        tag.style.border = '1px solid #ffd6b9';
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = modal.querySelectorAll('#mobile-recycle-filter .filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯æ¸…ç©ºå›æ”¶ç«™æŒ‰é’®
                    const emptyRecycleBtn = modal.querySelector('#mobile-empty-recycle-btn');
                    if (emptyRecycleBtn) {
                        emptyRecycleBtn.style.removeProperty('background-color');
                        emptyRecycleBtn.style.removeProperty('background');
                        emptyRecycleBtn.style.removeProperty('color');
                    }
                } else {
                    // å…¶ä»–ä¸»é¢˜ï¼Œç§»é™¤å†…è”æ ·å¼
                    const content = modal.querySelector('.mobile-recycle-content');
                    if (content) {
                        content.style.removeProperty('background-color');
                        content.style.removeProperty('color');
                    }
                    
                    // å¤„ç†å¼¹çª—å¤´éƒ¨
                    const header = modal.querySelector('.mobile-recycle-header');
                    if (header) {
                        const headerTitle = header.querySelector('h3');
                        if (headerTitle) {
                            headerTitle.style.removeProperty('color');
                        }
                        
                        const closeBtn = header.querySelector('.mobile-recycle-close');
                        if (closeBtn) {
                            closeBtn.style.removeProperty('color');
                        }
                    }
                    
                    // å¤„ç†å¼¹çª—å†…å®¹é¡¹
                    const items = modal.querySelectorAll('#mobile-recycle-items .recycle-item');
                    items.forEach(item => {
                        item.style.removeProperty('background-color');
                        const titleEl = item.querySelector('.recycle-item-title');
                        const metaEl = item.querySelector('.recycle-item-meta');
                        const dateEl = item.querySelector('.recycle-item-date');
                        
                        if (titleEl) titleEl.style.removeProperty('color');
                        if (metaEl) metaEl.style.removeProperty('color');
                        if (dateEl) dateEl.style.removeProperty('color');
                    });
                    
                    // å¤„ç†ç§»åŠ¨ç«¯è¿‡æ»¤å™¨æŒ‰é’®
                    const filterBtns = modal.querySelectorAll('#mobile-recycle-filter .filter-btn');
                    filterBtns.forEach(btn => {
                        btn.style.removeProperty('background-color');
                        btn.style.removeProperty('color');
                    });
                }
            });
        }

        // é˜²æŠ–å‡½æ•°ï¼Œç”¨äºä¼˜åŒ–é¢‘ç¹è°ƒç”¨çš„æ“ä½œ
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // åˆ›å»ºé˜²æŠ–ç‰ˆçš„ä¿å­˜å‡½æ•°
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocalStorage() {
            try {
                // ä»…ä¿å­˜æ•°æ®åˆ°localStorageä½œä¸ºä¸»å­˜å‚¨
                localStorage.setItem('threeGridNotebooks', JSON.stringify(notebooks));
                console.log('æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                showToast('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        

        
        // é˜²æŠ–ç‰ˆæœ¬çš„ä¿å­˜å‡½æ•°
        const debouncedSaveToLocalStorage = debounce(function() {
            try {
                // é˜²æŠ–ç‰ˆæœ¬åªä¿å­˜åˆ°localStorageï¼Œä¸è§¦å‘å¯¼å‡º
                localStorage.setItem('threeGridNotebooks', JSON.stringify(notebooks));
            } catch (error) {
                console.error('é˜²æŠ–ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }, 300); // 300æ¯«ç§’çš„å»¶è¿Ÿ
        
        // å¯¼å‡ºæ•°æ®åˆ°ç”¨æˆ·é€‰æ‹©çš„è·¯å¾„
        function exportDataToSelectedPath() {
            try {
                // åˆ›å»ºåŒ…å«æ‰€æœ‰æ•°æ®çš„å¯¼å‡ºå¯¹è±¡
                const exportData = {
                    notebooks: notebooks,
                    recycleBinData: recycleBinData,
                    currentStyle: currentStyle,
                    exportTime: new Date().toISOString()
                };
                
                // å°†æ•°æ®è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // è®¾ç½®æ–‡ä»¶å
                const fileName = `ä¸‰æ ¼è®°å½•æœ¬æ•°æ®_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
                a.download = fileName;
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showToast(`æ•°æ®å·²å¯¼å‡ºåˆ°: ${fileName}`);
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                showToast('æ•°æ®å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // åˆ›å»ºæ–°è®°å½•çº¸
        function createNewPaper(title) {
            // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•æœ¬
            if (notebooks.length === 0) {
                showToast('è¯·å…ˆåˆ›å»ºä¸€ä¸ªè®°å½•æœ¬');
                return;
            }
            
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;

            // æ£€æµ‹è®¾å¤‡ç±»å‹ï¼ŒPCç«¯é»˜è®¤15è¡Œï¼Œç§»åŠ¨ç«¯é»˜è®¤9è¡Œ
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            const defaultRows = isMobile ? 9 : 15;

            // è·å–å½“å‰ä¸»é¢˜ï¼Œç¡®ä¿ä¸»é¢˜ä¼˜å…ˆ
            const currentTheme = getCurrentTheme();
            let themeBackgroundColor = '#ffffff'; // é»˜è®¤ç™½è‰²èƒŒæ™¯
            
            // æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®ç›¸åº”çš„èƒŒæ™¯è‰²
            if (currentTheme === 'dark') {
                themeBackgroundColor = '#2d3748'; // æš—é»‘ä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²
            } else if (currentTheme === 'pastel') {
                themeBackgroundColor = '#fff7e6'; // æŸ”å’Œä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²
            } else if (currentTheme === 'vibrant') {
                themeBackgroundColor = '#90caf9'; // é²œè‰³ä¸»é¢˜çš„è®°å½•çº¸èƒŒæ™¯è‰²
            }

            const newPaper = {
                id: Date.now().toString(),
                title: title || `è®°å½•çº¸ ${currentNotebook.papers.length + 1}`,
                date: new Date().toLocaleDateString('zh-CN'),
                data: Array(3).fill().map(() => Array(defaultRows).fill('')),
                style: { 
                    ...currentStyle, 
                    textAlignment: 'center', 
                    backgroundColor: themeBackgroundColor, 
                    backgroundImage: null, 
                    customBackgroundImage: null, // ä¸»é¢˜ä¼˜å…ˆï¼Œä½¿ç”¨å½“å‰ä¸»é¢˜çš„èƒŒæ™¯è‰²
                    lineHeights: {} // å­˜å‚¨è¡Œé«˜ä¿¡æ¯ï¼Œæ ¼å¼ï¼š{ rowIndex: height }
                }
            };

            currentNotebook.papers.unshift(newPaper);
            currentNotebook.updatedAt = new Date().toISOString(); // æ›´æ–°ä¿®æ”¹æ—¶é—´
            
            // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œå‡å°‘é¢‘ç¹è¯»å†™localStorage
            debouncedSaveToLocalStorage();
            
            // å¢é‡æ¸²æŸ“ï¼šåªæ·»åŠ æ–°è®°å½•çº¸åˆ°DOMï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
            const newPaperElement = createPaperElement(newPaper);
            const firstPaperElement = papersContainer.firstChild;
            if (firstPaperElement) {
                papersContainer.insertBefore(newPaperElement, firstPaperElement);
            } else {
                papersContainer.appendChild(newPaperElement);
            }
            
            // è®¾ç½®ä¸ºå½“å‰é€‰ä¸­çš„è®°å½•çº¸
            currentPaperId = newPaper.id;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.paper').forEach(p => {
                p.classList.remove('selected');
            });
            newPaperElement.classList.add('selected');
            
            // æ›´æ–°è®°å½•æœ¬åˆ—è¡¨æ˜¾ç¤ºçš„çº¸å¼ æ•°é‡
            updateNotebookPaperCount(currentNotebookId);
        }
        
        // æ›´æ–°è®°å½•æœ¬æ˜¾ç¤ºçš„çº¸å¼ æ•°é‡
        function updateNotebookPaperCount(notebookId) {
            const notebookItem = document.querySelector(`.notebook-item[data-notebook-id="${notebookId}"]`);
            if (notebookItem) {
                const countDiv = notebookItem.querySelector('div[style*="fontSize: 0.85rem"]');
                if (countDiv) {
                    const currentNotebook = notebooks.find(n => n.id === notebookId);
                    if (currentNotebook) {
                        countDiv.textContent = `${currentNotebook.papers.length} å¼ è®°å½•çº¸`;
                    }
                }
            }
        }
        
        // åˆ›å»ºå››æ ¼è®°å½•çº¸
        function createFourColumnPaper(title) {
            // æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•æœ¬
            if (notebooks.length === 0) {
                showToast('è¯·å…ˆåˆ›å»ºä¸€ä¸ªè®°å½•æœ¬');
                return;
            }
            
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;

            // æ£€æµ‹è®¾å¤‡ç±»å‹ï¼ŒPCç«¯é»˜è®¤15è¡Œï¼Œç§»åŠ¨ç«¯é»˜è®¤9è¡Œ
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            const defaultRows = isMobile ? 9 : 15;

            const newPaper = {
                id: Date.now().toString(),
                title: title || `å››æ ¼è®°å½• ${currentNotebook.papers.length + 1}`,
                date: new Date().toLocaleDateString('zh-CN'),
                data: Array(4).fill().map(() => Array(defaultRows).fill('')),
                style: { ...currentStyle, textAlignment: 'center', backgroundColor: '#ffffff', backgroundImage: null, customBackgroundImage: null }, // å¼ºåˆ¶è®¾ç½®å±…ä¸­å¯¹é½ã€ç™½è‰²èƒŒæ™¯å’Œæ— èƒŒæ™¯å›¾ç‰‡
                isFourColumn: true // æ ‡è®°ä¸ºå››åˆ—è®°å½•çº¸ï¼Œä»¥ä¾¿åœ¨æ¸²æŸ“æ—¶è¯†åˆ«
            };

            currentNotebook.papers.unshift(newPaper);
            currentNotebook.updatedAt = new Date().toISOString(); // æ›´æ–°ä¿®æ”¹æ—¶é—´
            
            // ä½¿ç”¨é˜²æŠ–ä¿å­˜ï¼Œå‡å°‘é¢‘ç¹è¯»å†™localStorage
            debouncedSaveToLocalStorage();
            
            // å¢é‡æ¸²æŸ“ï¼šåªæ·»åŠ æ–°è®°å½•çº¸åˆ°DOMï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
            const newPaperElement = createPaperElement(newPaper);
            const firstPaperElement = papersContainer.firstChild;
            if (firstPaperElement) {
                papersContainer.insertBefore(newPaperElement, firstPaperElement);
            } else {
                papersContainer.appendChild(newPaperElement);
            }
            
            // è®¾ç½®ä¸ºå½“å‰é€‰ä¸­çš„è®°å½•çº¸
            currentPaperId = newPaper.id;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.paper').forEach(p => {
                p.classList.remove('selected');
            });
            newPaperElement.classList.add('selected');
            
            // æ›´æ–°è®°å½•æœ¬åˆ—è¡¨æ˜¾ç¤ºçš„çº¸å¼ æ•°é‡
            updateNotebookPaperCount(currentNotebookId);
        }

        // åˆ›å»ºæ–°è®°å½•æœ¬
        function createNewNotebook(title) {
            const newNotebook = {
                id: Date.now().toString(),
                title: title || `è®°å½•æœ¬ ${notebooks.length + 1}`,
                papers: [],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            notebooks.push(newNotebook);
            saveToLocalStorage();
            renderNotebooksList();
            // å§‹ç»ˆåˆ‡æ¢åˆ°æ–°åˆ›å»ºçš„è®°å½•æœ¬
            switchToNotebook(newNotebook.id);
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šè®°å½•æœ¬ - ä¼˜åŒ–ç‰ˆ
        function switchToNotebook(notebookId) {
            // é˜²æ­¢é‡å¤åˆ‡æ¢åˆ°åŒä¸€ä¸ªè®°å½•æœ¬
            if (currentNotebookId === notebookId) return;
            
            currentNotebookId = notebookId;
            
            // ä½¿ç”¨é˜²æŠ–æ¥å»¶è¿Ÿæ¸²æŸ“ï¼Œé¿å…é¢‘ç¹åˆ‡æ¢æ—¶çš„å¤šæ¬¡æ¸²æŸ“
            debouncedRenderPapers();
            
            // åªæ›´æ–°è®°å½•æœ¬åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€ï¼Œä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªåˆ—è¡¨
            updateNotebooksSelection();
        }
        
        // åªæ›´æ–°è®°å½•æœ¬åˆ—è¡¨çš„é€‰ä¸­çŠ¶æ€
        function updateNotebooksSelection() {
            document.querySelectorAll('.notebook-item').forEach(item => {
                const id = item.getAttribute('data-notebook-id');
                if (id === currentNotebookId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // é˜²æŠ–ç‰ˆçš„renderPapers
        const debouncedRenderPapers = debounce(renderPapers, 50);

        // æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸ - ä¼˜åŒ–ç‰ˆ
        function renderPapers() {
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;

            // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µæ¥å‡å°‘DOMé‡æ’æ¬¡æ•°
            const fragment = document.createDocumentFragment();

            // æ¸…ç©ºå®¹å™¨
            papersContainer.innerHTML = '';

            if (currentNotebook.papers.length === 0) {
                papersContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰è®°å½•çº¸ï¼Œç‚¹å‡»"æ–°å»ºè®°å½•çº¸"å¼€å§‹è®°å½•å§ï¼</p>';
                return;
            }

            // æ³¨æ„ï¼šhandleCellInputå‡½æ•°å·²ç»åœ¨å¤–éƒ¨å®šä¹‰ï¼Œè¿™é‡Œä¸å†é‡æ–°å®šä¹‰

            // æ‰¹é‡æ¸²æŸ“è®°å½•çº¸
            currentNotebook.papers.forEach(paper => {
                const paperElement = createPaperElement(paper, currentNotebook);
                fragment.appendChild(paperElement);
            });

            // ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOM
            papersContainer.appendChild(fragment);

            // äº‹ä»¶ç›‘å¬å™¨å·²ç»åœ¨DOMContentLoadedä¸­æ·»åŠ ï¼Œè¿™é‡Œä¸å†é‡å¤æ·»åŠ 
            
            // è®°å½•çº¸æ¸²æŸ“å®Œæˆåï¼Œå†æ¬¡åº”ç”¨ä¸»é¢˜ï¼Œç¡®ä¿ä¸»é¢˜èƒŒæ™¯è‰²åœ¨åˆ·æ–°åä¹Ÿèƒ½æ­£ç¡®æ˜¾ç¤º
            applyThemeToUI();
        }

        // åˆ›å»ºå•ä¸ªè®°å½•çº¸å…ƒç´ 
        function createPaperElement(paper, currentNotebook) {
            const paperElement = document.createElement('div');
            paperElement.className = 'paper';
            paperElement.setAttribute('data-paper-id', paper.id);
            
            // åº”ç”¨æ ·å¼è®¾ç½®
            if (paper.style) {
                // åº”ç”¨èƒŒæ™¯é¢œè‰²
                if (paper.style.backgroundColor) {
                    paperElement.style.backgroundColor = paper.style.backgroundColor;
                } else {
                    paperElement.style.backgroundColor = 'transparent'; // é»˜è®¤æ— èƒŒæ™¯
                }
                
                // ç§»é™¤ä¹‹å‰çš„èƒŒæ™¯å›¾ç‰‡ç±»
                paperElement.classList.remove('bg-image-lined', 'bg-image-grid', 'bg-image-dot', 'bg-image-custom');
                paperElement.style.backgroundImage = '';
                
                // åº”ç”¨èƒŒæ™¯å›¾ç‰‡
                if (paper.style.customBackgroundImage) {
                    // è‡ªå®šä¹‰èƒŒæ™¯å›¾ç‰‡
                    paperElement.classList.add('bg-image-custom');
                    paperElement.style.backgroundImage = `url(${paper.style.customBackgroundImage})`;
                } else if (paper.style.backgroundImage) {
                    // é¢„è®¾èƒŒæ™¯å›¾ç‰‡ç±»å‹
                    const bgImageMap = {
                        'lined': 'bg-image-lined',
                        'grid': 'bg-image-grid',
                        'dot': 'bg-image-dot',
                        'speaker': 'bg-image-speaker'
                    };
                    const bgClass = bgImageMap[paper.style.backgroundImage];
                    if (bgClass) {
                        paperElement.classList.add(bgClass);
                    }
                }
                
                // ä»æœ¬åœ°å­˜å‚¨æ¢å¤æ–‡å­—é¢œè‰²å’Œå­—ä½“è®¾ç½®
                const paperId = paper.id;
                const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
                if (settings.textColor) {
                    paperElement.setAttribute('data-text-color', settings.textColor);
                }
                if (settings.fontFamily) {
                    paperElement.setAttribute('data-font-family', settings.fontFamily);
                }
            } else {
                paperElement.style.backgroundColor = 'transparent'; // é»˜è®¤æ— èƒŒæ™¯
            }
            
            // é€‰ä¸­æ ·å¼
            if (paper.id === currentPaperId) {
                paperElement.classList.add('selected');
            }

            // è®°å½•çº¸å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'paper-header';
            
            // æ‰“å°æŒ‰é’®
            const printBtn = document.createElement('button');
            printBtn.className = 'print-btn';
            printBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>';
            printBtn.title = 'å¯¼å‡ºä¸ºå›¾ç‰‡';
            printBtn.dataset.paperId = paper.id;
            header.appendChild(printBtn);
            
            // å¯ç¼–è¾‘æ ‡é¢˜
            const titleElement = createTitleElement(paper);
            header.appendChild(titleElement);
            
            // æ—¥æœŸ
            const dateElement = document.createElement('div');
            dateElement.className = 'paper-date';
            dateElement.textContent = paper.date;
            header.appendChild(dateElement);
            
            // åˆ é™¤æŒ‰é’®
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = 'Ã—';
            deleteBtn.title = 'åˆ é™¤è®°å½•çº¸';
            header.appendChild(deleteBtn);
            
            paperElement.appendChild(header);

            // æ¸²æŸ“æ ‡ç­¾
            if (paper.tags && paper.tags.length > 0) {
                const tagsContainer = document.createElement('div');
                tagsContainer.className = 'paper-tags';
                paper.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.className = 'tag';
                    tagSpan.textContent = tag;
                    tagSpan.dataset.tag = tag;
                    tagsContainer.appendChild(tagSpan);
                });
                paperElement.appendChild(tagsContainer);
            }

            // ç½‘æ ¼å®¹å™¨
            const gridContainer = document.createElement('div');
            gridContainer.className = paper.isFourColumn ? 'grid-container four-column' : 'grid-container';

            // åˆ›å»ºç½‘æ ¼å†…å®¹
            createGridContent(gridContainer, paper);

            paperElement.appendChild(gridContainer);

            // åˆ›å»ºåŠ å·æŒ‰é’®ï¼ˆå³ä¸‹è§’æ·»åŠ è¡Œæ•°æŒ‰é’®ï¼‰
            const addRowBtn = document.createElement('button');
            addRowBtn.className = 'add-row-btn';
            addRowBtn.innerHTML = '+';
            addRowBtn.title = 'å¢åŠ ä¸€è¡Œ';
            addRowBtn.dataset.paperId = paper.id;
            addRowBtn.style.cssText = `
                position: absolute;
                bottom: 10px;
                right: 10px;
                width: 32px;
                height: 32px;
                border: none;
                border-radius: 50%;
                background-color: var(--success-color);
                color: white;
                font-size: 18px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
                transition: all 0.2s ease;
            `;
            addRowBtn.onmouseover = function() {
                this.style.transform = 'scale(1.1)';
                this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
            };
            addRowBtn.onmouseout = function() {
                this.style.transform = 'scale(1)';
                this.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.15)';
            };
            addRowBtn.onclick = function() {
                const paperId = this.dataset.paperId;
                addRowToPaper(paperId);
            };
            paperElement.appendChild(addRowBtn);

            return paperElement;
        }

        // åˆ›å»ºå¯ç¼–è¾‘æ ‡é¢˜å…ƒç´ 
        function createTitleElement(paper) {
            const titleElement = document.createElement('div');
            titleElement.className = 'paper-title';
            titleElement.textContent = paper.title;
            titleElement.setAttribute('contenteditable', 'false');
            titleElement.dataset.paperId = paper.id;
            
            // åŒå‡»æ ‡é¢˜å¯ç¼–è¾‘ - å°†äº‹ä»¶å¤„ç†ç§»è‡³å¤–éƒ¨å§”æ‰˜
            titleElement.setAttribute('data-editable', 'true');
            
            return titleElement;
        }

        // ä¸ºè®°å½•çº¸å¢åŠ ä¸€è¡Œçš„å‡½æ•°
        function addRowToPaper(paperId) {
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;
            
            const paper = currentNotebook.papers.find(p => p.id === paperId);
            if (!paper) return;
            
            // ç¡®å®šè®°å½•çº¸çš„åˆ—æ•°
            const columnCount = paper.isFourColumn ? 4 : 3;
            
            // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
            if (!paper.data) paper.data = Array(columnCount).fill().map(() => []);
            
            // ä¸ºæ¯ä¸€åˆ—å¢åŠ ä¸€ä¸ªç©ºå€¼ï¼ˆå³ä¸€è¡Œï¼‰
            for (let colIndex = 0; colIndex < columnCount; colIndex++) {
                if (!paper.data[colIndex]) paper.data[colIndex] = [];
                paper.data[colIndex].push(''); // æ·»åŠ ç©ºå­—ç¬¦ä¸²ä½œä¸ºæ–°è¡Œçš„å†…å®¹
            }
            
            // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
            currentNotebook.updatedAt = new Date().toISOString();
            debouncedSaveToLocalStorage();
            
            // åªæ›´æ–°å½“å‰è®°å½•çº¸ï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
            const paperElement = document.querySelector(`.paper[data-paper-id="${paper.id}"]`);
            if (paperElement) {
                const gridContainer = paperElement.querySelector('.grid-container');
                if (gridContainer) {
                    // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºç½‘æ ¼å†…å®¹
                    gridContainer.innerHTML = '';
                    createGridContent(gridContainer, paper);
                }
                
                // é‡æ–°åº”ç”¨ä¸»é¢˜æ ·å¼ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°çš„ä¸»é¢˜è®¾ç½®
                applyThemeToUI();
            }
        }

        // åˆ›å»ºç½‘æ ¼å†…å®¹
        function createGridContent(gridContainer, paper) {
            // ç¡®å®šè®°å½•çº¸çš„åˆ—æ•°
            const columnCount = paper.isFourColumn ? 4 : 3;
            
            // åº”ç”¨æ ·å¼
            let borderStyle = currentStyle.lineStyle || 'dashed';
            // è€ƒè™‘å½“å‰ä¸»é¢˜è®¾ç½®çº¿æ¡é¢œè‰²
                const currentTheme = getCurrentTheme();
                let borderColor;
                if (currentTheme === 'dark') {
                    borderColor = '#718096'; // æš—é»‘ä¸»é¢˜çš„çº¿æ¡é¢œè‰²
                } else if (currentTheme === 'vibrant') {
                    borderColor = '#FFFFFF'; // é²œè‰³ä¸»é¢˜çš„çº¿æ¡é¢œè‰²ï¼Œè®¾ç½®ä¸ºçº¯ç™½è‰²
                } else {
                    borderColor = currentStyle.lineColor || '#000000'; // å…¶ä»–ä¸»é¢˜çš„çº¿æ¡é¢œè‰²ï¼Œé»˜è®¤é»‘è‰²
                }
            
            // ä¸ºæ¯ä¸€åˆ—åˆ›å»ºè¡Œ
            for (let colIndex = 0; colIndex < columnCount; colIndex++) {
                const column = document.createElement('div');
                column.className = 'column';
                
                // åº”ç”¨åˆ—æ ·å¼
                let columnBorderStyle = currentStyle.columnBorderStyle || 'solid';
                column.style.setProperty('--column-border-style', columnBorderStyle);
                column.style.setProperty('--column-border-color', borderColor);

                // è·å–å½“å‰åˆ—çš„å®é™…è¡Œæ•°
                // æ£€æµ‹è®¾å¤‡ç±»å‹ï¼Œç¡®ä¿ç§»åŠ¨è®¾å¤‡ä¸Šé»˜è®¤æ˜¾ç¤º9è¡Œï¼ŒPCç«¯é»˜è®¤æ˜¾ç¤º15è¡Œ
                const isMobile = window.matchMedia('(max-width: 768px)').matches;
                const defaultRows = isMobile ? 9 : 15;
                const rowCount = paper.data[colIndex]?.length || defaultRows;
                
                // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæ¥å‡å°‘DOMæ“ä½œ
                const columnFragment = document.createDocumentFragment();
                
                for (let rowIndex = 0; rowIndex < rowCount; rowIndex++) {
                    const gridLine = document.createElement('div');
                    gridLine.className = 'grid-line';
                    
                    // è®¾ç½®çº¿æ¡æ ·å¼
                    if (borderStyle === 'double') {
                        gridLine.classList.add('double-line');
                    } else {
                        gridLine.style.borderBottom = `1px ${borderStyle} ${borderColor}`;
                    }
                    
                    gridLine.style.setProperty('--grid-line-color', borderColor);

                    const cellValue = paper.data[colIndex][rowIndex] || '';
                    
                    // æ¸²æŸ“å•å…ƒæ ¼å†…å®¹
                    if (cellValue.startsWith('<img')) {
                        gridLine.innerHTML = cellValue;
                    } else {
                        // ä½¿ç”¨textareaæ›¿ä»£inputä»¥æ”¯æŒè‡ªåŠ¨æ¢è¡Œ
                        const input = document.createElement('textarea');
                        input.value = cellValue;
                        // å¯ç”¨è‡ªåŠ¨æ¢è¡ŒåŠŸèƒ½
                        input.style.whiteSpace = 'pre-wrap';
                        input.style.wordWrap = 'break-word';
                        input.style.overflowWrap = 'break-word';
                        input.style.resize = 'none'; // ç¦ç”¨æ‰‹åŠ¨è°ƒæ•´å¤§å°
                        input.style.overflow = 'hidden'; // éšè—æ»šåŠ¨æ¡
                        
                        // ä¸è®¾ç½®åˆå§‹é«˜åº¦ï¼Œå®Œå…¨ä½¿ç”¨CSSé»˜è®¤å€¼ï¼Œç¡®ä¿æœªæ¢è¡Œæ—¶ä¿æŒåŸæœ‰é—´è·
                        
                        // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨ï¼Œå®ç°åŒæ­¥è¡Œé«˜åŠŸèƒ½
                        input.addEventListener('input', function() {
                            try {
                                // è·å–çˆ¶å…ƒç´ grid-line
                                const gridLine = this.parentElement;
                                
                                if (!gridLine) return;
                                
                                // è·å–å½“å‰è¡Œçš„ç´¢å¼•
                                const rowIndex = parseInt(this.getAttribute('data-row'));
                                
                                // å…ˆé‡ç½®æ‰€æœ‰å†…è”æ ·å¼ï¼Œå›åˆ°CSSé»˜è®¤çŠ¶æ€
                                this.style.height = '';
                                gridLine.style.height = '';
                                gridLine.style.minHeight = '';
                                
                                // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†è‡ªåŠ¨æ¢è¡Œ
                                // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å…ƒç´ æ¥æµ‹é‡å•è¡Œæ–‡æœ¬çš„é«˜åº¦
                                const tempSpan = document.createElement('span');
                                tempSpan.style.visibility = 'hidden';
                                tempSpan.style.position = 'absolute';
                                tempSpan.style.whiteSpace = 'nowrap';
                                tempSpan.style.fontSize = getComputedStyle(this).fontSize;
                                tempSpan.style.fontFamily = getComputedStyle(this).fontFamily;
                                tempSpan.style.lineHeight = getComputedStyle(this).lineHeight;
                                tempSpan.textContent = this.value || '\u00A0'; // ä½¿ç”¨ä¸é—´æ–­ç©ºæ ¼ç¡®ä¿å…ƒç´ æœ‰å°ºå¯¸
                                document.body.appendChild(tempSpan);
                                
                                const singleLineWidth = tempSpan.offsetWidth;
                                document.body.removeChild(tempSpan);
                                
                                // è·å–è¾“å…¥æ¡†çš„å¯è§å®½åº¦ï¼ˆå‡å»å†…è¾¹è·ï¼‰
                                const inputComputedStyle = getComputedStyle(this);
                                const paddingLeft = parseFloat(inputComputedStyle.paddingLeft) || 0;
                                const paddingRight = parseFloat(inputComputedStyle.paddingRight) || 0;
                                const visibleWidth = this.clientWidth - paddingLeft - paddingRight;
                                
                                // è·å–å½“å‰çº¸å¼ å…ƒç´ 
                                const paperElement = this.closest('.paper');
                                
                                // æŸ¥æ‰¾åŒä¸€è¡Œçš„æ‰€æœ‰grid-lineå…ƒç´ 
                                const sameRowGridLines = [];
                                if (paperElement && !isNaN(rowIndex)) {
                                    // è·å–æ‰€æœ‰åˆ—
                                    const columns = paperElement.querySelectorAll('.column');
                                    columns.forEach(column => {
                                        // åœ¨æ¯ä¸€åˆ—ä¸­æŸ¥æ‰¾å¯¹åº”è¡Œç´¢å¼•çš„grid-line
                                        const gridLines = column.querySelectorAll('.grid-line');
                                        if (gridLines[rowIndex]) {
                                            sameRowGridLines.push(gridLines[rowIndex]);
                                        }
                                    });
                                }
                                
                                // æ£€æŸ¥æ˜¯å¦å‘ç”Ÿäº†è‡ªåŠ¨æ¢è¡Œ
                                if (singleLineWidth > visibleWidth) {
                                    // å½“å†…å®¹æ¢è¡Œæ—¶ï¼ŒåŠ¨æ€è°ƒæ•´é«˜åº¦ä»¥æ˜¾ç¤ºæ‰€æœ‰å†…å®¹
                                    this.style.height = 'auto';
                                    const targetHeight = this.scrollHeight;
                                    this.style.height = targetHeight + 'px';
                                    gridLine.style.height = 'auto';
                                    gridLine.style.minHeight = targetHeight + 'px';
                                    
                                    // åŒæ­¥è°ƒæ•´åŒä¸€è¡Œçš„å…¶ä»–åˆ—
                                    sameRowGridLines.forEach(line => {
                                        if (line !== gridLine) {
                                            const otherInput = line.querySelector('.cell-input');
                                            if (otherInput) {
                                                // å…ˆé‡ç½®å…¶ä»–è¾“å…¥æ¡†çš„é«˜åº¦
                                                otherInput.style.height = '';
                                                
                                                // ç¡®ä¿å…¶ä»–è¾“å…¥æ¡†ä¹Ÿæœ‰è¶³å¤Ÿçš„é«˜åº¦
                                                if (otherInput.scrollHeight < targetHeight) {
                                                    otherInput.style.height = targetHeight + 'px';
                                                    line.style.height = 'auto';
                                                    line.style.minHeight = targetHeight + 'px';
                                                }
                                            }
                                        }
                                    });
                                    
                                    // ä¿å­˜è¡Œé«˜ä¿¡æ¯åˆ°paperå¯¹è±¡
                                    if (paper && paper.style) {
                                        paper.style.lineHeights = paper.style.lineHeights || {};
                                        paper.style.lineHeights[rowIndex] = targetHeight;
                                        // è§¦å‘é˜²æŠ–ä¿å­˜
                                        debouncedSaveToLocalStorage();
                                    }
                                } else {
                                    // å½“å†…å®¹æœªæ¢è¡Œæ—¶ï¼Œæ£€æŸ¥åŒä¸€è¡Œæ˜¯å¦æœ‰å…¶ä»–åˆ—éœ€è¦ä¿æŒé«˜åº¦
                                    let maxHeightInRow = 0;
                                    sameRowGridLines.forEach(line => {
                                        const input = line.querySelector('.cell-input');
                                        if (input) {
                                            // é‡ç½®é«˜åº¦ä»¥è·å–å®é™…å†…å®¹é«˜åº¦
                                            input.style.height = '';
                                            const currentHeight = input.scrollHeight;
                                            maxHeightInRow = Math.max(maxHeightInRow, currentHeight);
                                        }
                                    });
                                    
                                    // å¦‚æœåŒä¸€è¡Œæœ‰å…¶ä»–åˆ—éœ€è¦æ›´é«˜çš„é«˜åº¦ï¼Œä¿æŒè¯¥é«˜åº¦
                                    if (maxHeightInRow > this.scrollHeight) {
                                        this.style.height = maxHeightInRow + 'px';
                                        gridLine.style.height = 'auto';
                                        gridLine.style.minHeight = maxHeightInRow + 'px';
                                        
                                        // ä¿å­˜è¡Œé«˜ä¿¡æ¯åˆ°paperå¯¹è±¡
                                        if (paper && paper.style) {
                                            paper.style.lineHeights = paper.style.lineHeights || {};
                                            paper.style.lineHeights[rowIndex] = maxHeightInRow;
                                            // è§¦å‘é˜²æŠ–ä¿å­˜
                                            debouncedSaveToLocalStorage();
                                        }
                                    } else if (paper && paper.style && paper.style.lineHeights && paper.style.lineHeights[rowIndex]) {
                                        // å¦‚æœå½“å‰è¡Œæ²¡æœ‰å†…å®¹æ¢è¡Œï¼Œä½†ä¹‹å‰ä¿å­˜äº†è¡Œé«˜ï¼Œæ¸…é™¤ä¿å­˜çš„è¡Œé«˜
                                        delete paper.style.lineHeights[rowIndex];
                                        // è§¦å‘é˜²æŠ–ä¿å­˜
                                        debouncedSaveToLocalStorage();
                                    }
                                }
                            } catch (error) {
                                // å¿½ç•¥é”™è¯¯ï¼Œç¡®ä¿åº”ç”¨æ­£å¸¸è¿è¡Œ
                                console.log('è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦æ—¶å‡ºé”™:', error);
                            }
                        });
                        
                        // åˆå§‹åŒ–æ—¶ä¸è‡ªåŠ¨è°ƒæ•´é«˜åº¦ï¼Œä¿æŒåŸå§‹æ ·å¼
                        // æ ¹æ®å•å…ƒæ ¼ä½ç½®è®¾ç½®æç¤ºæ–‡å­—
                        let placeholderText = '';
                        // åªåœ¨ç¤ºä¾‹è®°å½•çº¸ä¸­æ˜¾ç¤ºå ä½ç¬¦æ–‡å­—
                        if (paper.title === 'ç¤ºä¾‹è®°å½•çº¸') {
                            if (colIndex === 0 && rowIndex === 1) placeholderText = 'è¿™é‡Œå¯ä»¥è®°å½•ä½ çš„çµæ„Ÿã€åˆ›æ„å’Œæƒ³æ³•';
                            if (colIndex === 1 && rowIndex === 1) placeholderText = 'è¿™é‡Œå¯ä»¥è®°å½•å¾…åŠäº‹é¡¹ã€è®¡åˆ’å’Œç›®æ ‡';
                            if (colIndex === 2 && rowIndex === 1) placeholderText = 'è¿™é‡Œå¯ä»¥è®°å½•åæ€ã€æ€»ç»“å’Œæ”¶è·';
                            if (colIndex === 0 && rowIndex === 3) placeholderText = 'ğŸ’¡ ç‚¹å‡»å³ä¸‹è§’\"+\"æŒ‰é’®å¯ä»¥æ·»åŠ æ›´å¤šå†…å®¹';
                            if (colIndex === 1 && rowIndex === 3) placeholderText = 'âœ… å®Œæˆçš„ä»»åŠ¡å¯ä»¥æ ‡è®°å‡ºæ¥';
                            if (colIndex === 2 && rowIndex === 3) placeholderText = 'ğŸ“š éšæ—¶å›é¡¾å’Œå®Œå–„ä½ çš„æ€è€ƒ';
                        }
                        input.placeholder = placeholderText;
                        input.setAttribute('data-col', colIndex);
                        input.setAttribute('data-row', rowIndex);
                        input.classList.add('cell-input');

                        // åº”ç”¨æ–‡æœ¬å¯¹é½è®¾ç½®
                        const alignment = paper.style && paper.style.textAlignment ? paper.style.textAlignment : currentStyle.textAlignment;
                        input.style.textAlign = alignment;
                        
                        // åº”ç”¨ä¿å­˜çš„è¡Œé«˜ä¿¡æ¯
                        if (paper && paper.style && paper.style.lineHeights && paper.style.lineHeights[rowIndex]) {
                            const savedHeight = paper.style.lineHeights[rowIndex];
                            input.style.height = savedHeight + 'px';
                            gridLine.style.height = 'auto';
                            gridLine.style.minHeight = savedHeight + 'px';
                        }
                        
                        // åº”ç”¨æ–‡å­—é¢œè‰²è®¾ç½®
                        const paperElement = input.closest('.paper');
                        if (paperElement) {
                            const textColor = paperElement.getAttribute('data-text-color');
                            if (textColor) {
                                input.style.color = textColor;
                            }
                            
                            // åº”ç”¨å­—ä½“è®¾ç½®
                            const paperId = paperElement.getAttribute('data-paper-id');
                            const settings = JSON.parse(localStorage.getItem('paperSettings_' + paperId) || '{}');
                            if (settings.fontFamily) {
                                input.style.fontFamily = settings.fontFamily;
                            }
                            
                            // åº”ç”¨å­—å·è®¾ç½®
                            if (settings.fontSize) {
                                input.style.fontSize = settings.fontSize;
                            }
                        }
                        
                        // ç¬¬ä¸€è¡Œç‰¹æ®Šæ ·å¼
                        if (rowIndex === 0 && paper.data[colIndex][0]) {
                            input.style.fontWeight = 'bold';
                        }

                        gridLine.appendChild(input);
                    }
                    
                    columnFragment.appendChild(gridLine);
                }

                column.appendChild(columnFragment);
                gridContainer.appendChild(column);
            }
        }

        // äº‹ä»¶å§”æ‰˜ - å¤„ç†è®°å½•çº¸ç‚¹å‡»
        function handlePaperClick(e) {
            const paperElement = e.target.closest('.paper');
            if (!paperElement) return;
            
            // é¿å…ç‚¹å‡»åˆ é™¤æŒ‰é’®æˆ–åŠ å·æŒ‰é’®æ—¶è§¦å‘é€‰æ‹©
            if (e.target.classList.contains('delete-btn') || e.target.classList.contains('add-row-btn')) {
                return;
            }
            
            // å¤„ç†æ ‡ç­¾ç‚¹å‡»
            if (e.target.classList.contains('tag')) {
                const tag = e.target.dataset.tag;
                if (tag) {
                    searchByTag(tag);
                }
                return;
            }
            
            // å¤„ç†æ ‡é¢˜åŒå‡»ç¼–è¾‘
            if (e.type === 'dblclick' && e.target.classList.contains('paper-title')) {
                // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°documentçº§åˆ«ï¼Œé¿å…å…¨å±€åŒå‡»äº‹ä»¶çš„å¹²æ‰°
                e.stopPropagation();
                
                e.target.setAttribute('contenteditable', 'true');
                e.target.focus();
                
                // é€‰ä¸­æ‰€æœ‰æ–‡æœ¬
                const range = document.createRange();
                range.selectNodeContents(e.target);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                return;
            }
            
            // å¤„ç†æ ‡é¢˜ä¿å­˜
            if (e.type === 'blur' && e.target.classList.contains('paper-title')) {
                saveTitle(e.target);
                return;
            }
            
            // å¤„ç†é”®ç›˜äº‹ä»¶
            if (e.type === 'keydown' && e.target.classList.contains('paper-title')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTitle(e.target);
                } else if (e.key === 'Escape') {
                    const paperId = e.target.dataset.paperId;
                    const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
                    const paper = currentNotebook.papers.find(p => p.id === paperId);
                    if (paper) {
                        e.target.textContent = paper.title;
                    }
                    e.target.setAttribute('contenteditable', 'false');
                }
                return;
            }
            
            // æ™®é€šç‚¹å‡»äº‹ä»¶ - è®¾ç½®å½“å‰è®°å½•çº¸
            const paperId = paperElement.getAttribute('data-paper-id');
            currentPaperId = paperId;
            
            // æ›´æ–°è®°å½•çº¸é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.paper').forEach(p => {
                p.classList.remove('selected');
            });
            paperElement.classList.add('selected');
        }

        // äº‹ä»¶å§”æ‰˜ - å¤„ç†å®¹å™¨å†…è¾“å…¥
        function handleContainerInput(e) {
            if (e.target.classList.contains('cell-input')) {
                // ä½¿ç”¨é˜²æŠ–å¤„ç†å•å…ƒæ ¼è¾“å…¥
                handleCellInput(e.target);
            }
        }

        // ä¿å­˜æ ‡é¢˜å‡½æ•°
        function saveTitle(titleElement) {
            const newTitle = titleElement.textContent.trim() || 'æ–°è®°å½•çº¸';
            const paperId = titleElement.dataset.paperId;
            
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;
            
            const paper = currentNotebook.papers.find(p => p.id === paperId);
            if (!paper) return;
            
            if (newTitle !== paper.title) {
                paper.title = newTitle;
                // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
                currentNotebook.updatedAt = new Date().toISOString();
                debouncedSaveToLocalStorage();
            }
            titleElement.setAttribute('contenteditable', 'false');
        }

        // å•å…ƒæ ¼è¾“å…¥é˜²æŠ–å¤„ç†
        function handleCellInput(inputElement) {
            const col = parseInt(inputElement.getAttribute('data-col'));
            const row = parseInt(inputElement.getAttribute('data-row'));
            const paperElement = inputElement.closest('.paper');
            const paperId = paperElement.getAttribute('data-paper-id');
            
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return;
            
            const paper = currentNotebook.papers.find(p => p.id === paperId);
            if (!paper) return;
            
            // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
            if (!paper.data) paper.data = [[], [], []];
            if (!paper.data[col]) paper.data[col] = [];
            
            paper.data[col][row] = inputElement.value;
            
            // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
            currentNotebook.updatedAt = new Date().toISOString();
            debouncedSaveToLocalStorage();
        }

        // é˜²æŠ–ç‰ˆçš„å•å…ƒæ ¼è¾“å…¥å¤„ç†
        const debouncedCellInputHandler = debounce(handleCellInput, 100);

        // ä¸ºæ‰€æœ‰å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨æ·»åŠ äº‹ä»¶å§”æ‰˜
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬æ ‡é¢˜åŒå‡»äº‹ä»¶
            papersContainer.addEventListener('dblclick', handlePaperClick);
            // ç›‘å¬æ ‡é¢˜å¤±å»ç„¦ç‚¹äº‹ä»¶
            papersContainer.addEventListener('blur', handlePaperClick, true);
            // ç›‘å¬æ ‡é¢˜é”®ç›˜äº‹ä»¶
            papersContainer.addEventListener('keydown', handlePaperClick, true);
            // ç›‘å¬å•å…ƒæ ¼è¾“å…¥äº‹ä»¶
            papersContainer.addEventListener('input', function(e) {
                if (e.target.classList.contains('cell-input')) {
                    debouncedCellInputHandler(e.target);
                }
            });
            // ç›‘å¬è®°å½•çº¸ç‚¹å‡»äº‹ä»¶ - æ”¯æŒç§»åŠ¨ç«¯é€‰ä¸­
            papersContainer.addEventListener('click', handlePaperClick);
            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            papersContainer.addEventListener('touchstart', function(e) {
                // å¯¹äºè§¦æ‘¸è®¾å¤‡ï¼Œç¡®ä¿ç‚¹å‡»è¾“å…¥åŒºæˆ–è®°å½•çº¸å¤–æ¡†æ—¶é€‰ä¸­è®°å½•çº¸
                const target = e.target;
                const paperElement = target.closest('.paper');
                if (paperElement) {
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                    e.stopPropagation();
                    // å¯¹äºè¾“å…¥æ¡†å’Œè®°å½•çº¸å¤–æ¡†ï¼Œå»¶è¿Ÿè§¦å‘ç‚¹å‡»äº‹ä»¶ä»¥ç¡®ä¿èšç„¦è¾“å…¥æ¡†
                    if (target.classList.contains('cell-input') || target.classList.contains('paper')) {
                        setTimeout(() => handlePaperClick(e), 50);
                    }
                }
            }, { passive: true });
        });

        // å›¾ç‰‡æ’å…¥åŠŸèƒ½
        // æ‰“å¼€å›¾ç‰‡æ’å…¥æ¨¡æ€æ¡†
        addImageBtn.addEventListener('click', function() {
            if (!currentPaperId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // é‡ç½®é€‰æ‹©
            imageColumnSelect.selectedIndex = 0;
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……è¡Œé€‰é¡¹
            imageRowSelect.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ç¬¬${i + 1}è¡Œ`;
                imageRowSelect.appendChild(option);
            }
            
            imageUrlInput.value = '';
            imageModal.style.display = 'flex';
        });

        // ç¡®è®¤æ’å…¥å›¾ç‰‡
            confirmImageBtn.addEventListener('click', function() {
                if (!currentPaperId) return;
                
                const paper = getCurrentPaper();
                if (!paper) return;
                
                const column = parseInt(imageColumnSelect.value);
                const row = parseInt(imageRowSelect.value);
                const imageUrl = imageUrlInput.value.trim();
                
                if (!imageUrl) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å›¾ç‰‡URL');
                    return;
                }
                
                // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                if (!paper.data) {
                    paper.data = [[], [], []];
                }
                
                // è®¾ç½®å›¾ç‰‡HTML
                paper.data[column][row] = `<img src="${imageUrl}" alt="è®°å½•å›¾ç‰‡" class="image-preview">`;
                
                // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
                const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
                if (currentNotebook) {
                    currentNotebook.updatedAt = new Date().toISOString();
                }
                
                debouncedSaveToLocalStorage();
                
                // åªæ›´æ–°å½“å‰è®°å½•çº¸ï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
                const paperElement = document.querySelector(`.paper[data-paper-id="${paper.id}"]`);
                if (paperElement) {
                    const gridContainer = paperElement.querySelector('.grid-container');
                    if (gridContainer) {
                        // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºç½‘æ ¼å†…å®¹
                        gridContainer.innerHTML = '';
                        createGridContent(gridContainer, paper);
                    }
                }
                
                imageModal.style.display = 'none';
            });

        // è·å–å½“å‰é€‰ä¸­çš„è®°å½•çº¸
        function getCurrentPaper() {
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook) return null;
            return currentNotebook.papers.find(p => p.id === currentPaperId);
        }

        // å¯Œæ–‡æœ¬ç¼–è¾‘åŠŸèƒ½
        // æ‰“å¼€å¯Œæ–‡æœ¬ç¼–è¾‘æ¨¡æ€æ¡†
        richTextEditBtn.addEventListener('click', function() {
            if (!currentPaperId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè®°å½•çº¸');
                return;
            }
            
            // é‡ç½®é€‰æ‹©
            richTextColumnSelect.selectedIndex = 0;
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……è¡Œé€‰é¡¹
            richTextRowSelect.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `ç¬¬${i + 1}è¡Œ`;
                richTextRowSelect.appendChild(option);
            }
            
            richTextContent.value = '';
            richTextModal.style.display = 'flex';
        });

        // å¯Œæ–‡æœ¬æ ¼å¼åŒ–å·¥å…·
        formatBoldBtn.addEventListener('click', function() {
            try {
                document.execCommand('bold', false, null);
            } catch (error) {
                // å¿½ç•¥å¼€å‘è€…å·¥å…·æ‰“å¼€æ—¶çš„é”™è¯¯
            }
            richTextContent.focus();
        });

        formatItalicBtn.addEventListener('click', function() {
            try {
                document.execCommand('italic', false, null);
            } catch (error) {
                // å¿½ç•¥å¼€å‘è€…å·¥å…·æ‰“å¼€æ—¶çš„é”™è¯¯
            }
            richTextContent.focus();
        });

        formatUnderlineBtn.addEventListener('click', function() {
            try {
                document.execCommand('underline', false, null);
            } catch (error) {
                // å¿½ç•¥å¼€å‘è€…å·¥å…·æ‰“å¼€æ—¶çš„é”™è¯¯
            }
            richTextContent.focus();
        });

        formatColorSelect.addEventListener('change', function() {
            try {
                document.execCommand('foreColor', false, this.value);
            } catch (error) {
                // å¿½ç•¥å¼€å‘è€…å·¥å…·æ‰“å¼€æ—¶çš„é”™è¯¯
            }
            richTextContent.focus();
        });

        // ç¡®è®¤åº”ç”¨å¯Œæ–‡æœ¬å†…å®¹
            confirmRichTextBtn.addEventListener('click', function() {
                if (!currentPaperId) return;
                
                const paper = getCurrentPaper();
                if (!paper) return;
                
                const column = parseInt(richTextColumnSelect.value);
                const row = parseInt(richTextRowSelect.value);
                const richText = richTextContent.innerHTML;
                
                // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                if (!paper.data) {
                    paper.data = [[], [], []];
                }
                
                // ä¿å­˜å¯Œæ–‡æœ¬å†…å®¹
                paper.data[column][row] = richText;
                
                // æ›´æ–°è®°å½•æœ¬çš„ä¿®æ”¹æ—¶é—´
                const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
                if (currentNotebook) {
                    currentNotebook.updatedAt = new Date().toISOString();
                }
                
                debouncedSaveToLocalStorage();
                
                // åªæ›´æ–°å½“å‰è®°å½•çº¸ï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
                const paperElement = document.querySelector(`.paper[data-paper-id="${paper.id}"]`);
                if (paperElement) {
                    const gridContainer = paperElement.querySelector('.grid-container');
                    if (gridContainer) {
                        // æ¸…ç©ºå¹¶é‡æ–°åˆ›å»ºç½‘æ ¼å†…å®¹
                        gridContainer.innerHTML = '';
                        createGridContent(gridContainer, paper);
                    }
                }
                
                richTextModal.style.display = 'none';
            });

        // åˆ é™¤è®°å½•çº¸åŠŸèƒ½ - ä½¿ç”¨ç»Ÿä¸€çš„åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
            deletePaperBtn.addEventListener('click', function() {
                if (!currentPaperId) return;
                
                showDeleteConfirmModal(
                    'ç¡®è®¤åˆ é™¤è®°å½•çº¸',
                    'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®°å½•çº¸å—ï¼Ÿæ­¤æ“ä½œå°†æ— æ³•æ’¤é”€ã€‚',
                    function() {
                        const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
                        if (currentNotebook) {
                            // ä¿å­˜è¢«åˆ é™¤çš„è®°å½•çº¸IDä»¥ä¾¿ä»DOMä¸­ç§»é™¤
                            const deletedPaperId = currentPaperId;
                            
                            currentNotebook.papers = currentNotebook.papers.filter(p => p.id !== currentPaperId);
                            currentNotebook.updatedAt = new Date().toISOString(); // æ›´æ–°ä¿®æ”¹æ—¶é—´
                            currentPaperId = null;
                            debouncedSaveToLocalStorage();
                            
                            // åªä»DOMä¸­ç§»é™¤è¢«åˆ é™¤çš„è®°å½•çº¸ï¼Œä¸é‡æ–°æ¸²æŸ“æ‰€æœ‰è®°å½•çº¸
                            const deletedPaperElement = document.querySelector(`.paper[data-paper-id="${deletedPaperId}"]`);
                            if (deletedPaperElement) {
                                deletedPaperElement.remove();
                            }
                            
                            // å¦‚æœæ²¡æœ‰è®°å½•çº¸äº†ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€æç¤º
                            if (currentNotebook.papers.length === 0) {
                                papersContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰è®°å½•çº¸ï¼Œç‚¹å‡»"æ–°å»ºè®°å½•çº¸"å¼€å§‹è®°å½•å§ï¼</p>';
                            }
                            
                            // æ›´æ–°è®°å½•æœ¬åˆ—è¡¨æ˜¾ç¤ºçš„çº¸å¼ æ•°é‡
                            updateNotebookPaperCount(currentNotebookId);
                        }
                    }
                );
                
                paperMenuModal.style.display = 'none';
            });

        // æ¨¡æ€æ¡†å…³é—­äº‹ä»¶
        cancelSyncBtn.addEventListener('click', function() { 
            syncModal.style.display = 'none'; 
            // æ¢å¤åŸå§‹z-indexå€¼ï¼Œé¿å…å½±å“å…¶ä»–åŠŸèƒ½
            syncModal.style.zIndex = '1000'; 
        });
        cancelTemplateBtn.addEventListener('click', function() { templateModal.style.display = 'none'; });
        closePaperMenuBtn.addEventListener('click', function() { paperMenuModal.style.display = 'none'; });
        cancelImageBtn.addEventListener('click', function() { imageModal.style.display = 'none'; });
        cancelRichTextBtn.addEventListener('click', function() { richTextModal.style.display = 'none'; });
        cancelTagsBtn.addEventListener('click', function() { tagsModal.style.display = 'none'; });

        // åˆ›å»ºéšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´ ç”¨äºæ•°æ®å¯¼å…¥
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.json';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);

        // æœ¬åœ°å¤‡ä»½åŠŸèƒ½ - å¯¼å‡ºæ‰€æœ‰æ•°æ®
        function createLocalBackup() {
            if (!notebooks || notebooks.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                return;
            }

            // å‡†å¤‡å¯¼å‡ºæ‰€æœ‰æ•°æ®
            const allData = {
                version: '1.0',
                exportTime: new Date().toISOString(),
                data: {
                    threeGridNotebooks: notebooks,
                    recycleBinData: recycleBinData || [],
                    currentStyle: currentStyle || {},
                    threeGridTheme: localStorage.getItem('threeGridTheme') || 'default',
                    skipOrientationPrompt: localStorage.getItem('skipOrientationPrompt') === 'true'
                }
            };

            // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ä¸‰æ ¼è®°å½•æœ¬_å®Œæ•´å¤‡ä»½_${new Date().toISOString().replace(/[:.]/g, '-').split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('æœ¬åœ°å¤‡ä»½åˆ›å»ºæˆåŠŸï¼');
        }

        // ä»å¤‡ä»½æ¢å¤åŠŸèƒ½
        function handleImportData() {
            const file = fileInput.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (fileExtension !== 'json') {
                alert('è¯·é€‰æ‹©æ­£ç¡®çš„JSONæ ¼å¼å¤‡ä»½æ–‡ä»¶');
                return;
            }

            // è¯»å–æ–‡ä»¶å†…å®¹
            const reader = new FileReader();
            reader.onload = function(event) {
                processImportData(event.target.result);
            };
            
            reader.onerror = function() {
                alert('æ–‡ä»¶è¯»å–å¤±è´¥');
            };
            
            reader.readAsText(file);
        }
        
        // å¤„ç†å¯¼å…¥æ•°æ®çš„æ ¸å¿ƒå‡½æ•°
        function processImportData(dataStr) {
            try {
                // è§£æJSONæ•°æ®
                const importData = JSON.parse(dataStr);
                
                // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼ - æ”¯æŒå®Œæ•´ç‰ˆå’Œç´§å‡‘ç‰ˆ
                let standardData;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯ç´§å‡‘ç‰ˆæ ¼å¼ï¼ˆäºŒç»´ç åˆ†äº«ä½¿ç”¨ï¼‰
                if (importData.v && importData.d) {
                    // è½¬æ¢ç´§å‡‘ç‰ˆåˆ°æ ‡å‡†ç‰ˆ
                    standardData = {
                        version: importData.v,
                        data: {
                            threeGridNotebooks: importData.d.n ? importData.d.n.map(compactNotebook => ({
                                id: compactNotebook.i,
                                title: compactNotebook.t,
                                color: compactNotebook.c,
                                coverIndex: compactNotebook.co,
                                createTime: new Date().toISOString(), // ä¸ºç´§å‡‘ç‰ˆæ•°æ®æ·»åŠ åˆ›å»ºæ—¶é—´
                                updateTime: new Date().toISOString(), // ä¸ºç´§å‡‘ç‰ˆæ•°æ®æ·»åŠ æ›´æ–°æ—¶é—´
                                pages: compactNotebook.p ? compactNotebook.p.map(compactPage => ({
                                    id: compactPage.i,
                                    title: compactPage.t,
                                    content: compactPage.c,
                                    createTime: new Date().toISOString(),
                                    updateTime: new Date().toISOString(),
                                    tags: [] // ç´§å‡‘ç‰ˆä¸åŒ…å«tags
                                })) : []
                            })) : [],
                            threeGridTheme: importData.d.th || 'default'
                        }
                    };
                } else if (importData.version && importData.data) {
                    // æ ‡å‡†ç‰ˆæ ¼å¼ï¼ˆä¼ ç»Ÿå¤‡ä»½æ–‡ä»¶ï¼‰
                    standardData = importData;
                } else {
                    alert('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                    return;
                }

                // æ˜¾ç¤ºå¯¼å…¥é€‰é¡¹
                const mergeOption = confirm('æ•°æ®å¯¼å…¥é€‰é¡¹ï¼š\n\n[ç¡®å®š] - åˆå¹¶æ•°æ®ï¼ˆå°†ä¿ç•™ç°æœ‰æ•°æ®å¹¶æ·»åŠ æ–°æ•°æ®ï¼‰\n\n[å–æ¶ˆ] - æ›¿æ¢æ•°æ®ï¼ˆå°†å®Œå…¨è¦†ç›–ç°æœ‰æ•°æ®ï¼‰\n\nå¯¼å…¥å‰å»ºè®®å…ˆå¤‡ä»½å½“å‰æ•°æ®ï¼');
                
                if (mergeOption) {
                    // åˆå¹¶æ•°æ®
                    mergeImportedData(standardData.data);
                } else {
                    // æ›¿æ¢æ•°æ®
                    replaceImportedData(standardData.data);
                }

                // é‡æ–°åŠ è½½åº”ç”¨æ•°æ®
                location.reload();
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
            } catch (error) {
                // å°è¯•å¤„ç†Base64ç¼–ç çš„æ•°æ®ï¼ˆäºŒç»´ç æ‰«æç»“æœï¼‰
                try {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯base64ç¼–ç çš„URLæ ¼å¼
                    if (dataStr.startsWith('data:text/plain;charset=utf-8;base64,')) {
                        const base64Data = dataStr.replace('data:text/plain;charset=utf-8;base64,', '');
                        const decodedData = decodeURIComponent(escape(atob(base64Data)));
                        processImportData(decodedData);
                    } else {
                        // ç›´æ¥å°è¯•Base64è§£ç 
                        const decodedData = decodeURIComponent(escape(atob(dataStr)));
                        processImportData(decodedData);
                    }
                } catch (innerError) {
                    alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æ•°æ®æŸå');
                    console.error('Import error:', error);
                    console.error('Base64 decode error:', innerError);
                }
            }
        }
        
        // åˆå¹¶å¯¼å…¥çš„æ•°æ®
        function mergeImportedData(importData) {
            if (importData.threeGridNotebooks) {
                // ä¸ºæ¯ä¸ªå¯¼å…¥çš„ç¬”è®°æœ¬ç”Ÿæˆæ–°çš„IDï¼Œé¿å…å†²çª
                const importedNotebooks = importData.threeGridNotebooks.map(notebook => {
                    const newNotebook = {...notebook};
                    newNotebook.id = generateNotebookId();
                    
                    // å¤„ç†è®°å½•çº¸æ•°æ® - æ”¯æŒpaperså’Œpagesä¸¤ç§å±æ€§å
                    if (newNotebook.papers) {
                        newNotebook.papers = newNotebook.papers.map(paper => {
                            const newPaper = {...paper};
                            newPaper.id = generatePaperId();
                            return newPaper;
                        });
                    } else if (newNotebook.pages) {
                        // å…¼å®¹ä¼˜åŒ–åçš„åˆ†äº«æ•°æ®ç»“æ„
                        newNotebook.pages = newNotebook.pages.map(page => {
                            const newPage = {...page};
                            newPage.id = generatePaperId();
                            return newPage;
                        });
                    }
                    
                    return newNotebook;
                });
                
                // åˆå¹¶ç¬”è®°æœ¬
                notebooks = [...notebooks, ...importedNotebooks];
                saveToLocalStorage();
            }
            
            // å…¶ä»–æ•°æ®å¯ä»¥é€‰æ‹©æ€§åˆå¹¶æˆ–æç¤ºç”¨æˆ·
            if (importData.recycleBinData && importData.recycleBinData.length > 0) {
                if (confirm('æ˜¯å¦åˆå¹¶å›æ”¶ç«™æ•°æ®ï¼Ÿ')) {
                    recycleBinData = [...recycleBinData, ...importData.recycleBinData];
                    saveRecycleBinToLocalStorage();
                }
            }
        }
        
        // æ›¿æ¢å¯¼å…¥çš„æ•°æ®
        function replaceImportedData(importData) {
            if (importData.threeGridNotebooks) {
                notebooks = importData.threeGridNotebooks;
                saveToLocalStorage();
            }
            
            if (importData.recycleBinData) {
                recycleBinData = importData.recycleBinData;
                saveRecycleBinToLocalStorage();
            }
            
            if (importData.currentStyle) {
                currentStyle = importData.currentStyle;
                saveStyleToLocalStorage();
            }
            
            if (importData.threeGridTheme !== undefined) {
                localStorage.setItem('threeGridTheme', importData.threeGridTheme);
            }
            
            if (importData.skipOrientationPrompt !== undefined) {
                localStorage.setItem('skipOrientationPrompt', importData.skipOrientationPrompt ? 'true' : 'false');
            }
        }

        // ä¸ºæ–‡ä»¶è¾“å…¥å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        fileInput.addEventListener('change', handleImportData);

        // è·å–æœ¬åœ°å¤‡ä»½ä¸æ¢å¤æŒ‰é’®å¹¶æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        const localBackupBtn = document.getElementById('local-backup-btn');
        const localRestoreBtn = document.getElementById('local-restore-btn');
        
        if (localBackupBtn) {
            localBackupBtn.addEventListener('click', function() {
                createLocalBackup();
            });
        }
        
        if (localRestoreBtn) {
            localRestoreBtn.addEventListener('click', function() {
                fileInput.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
                fileInput.click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©å¯¹è¯æ¡†
            });
        }
        
        // äºŒç»´ç åŠŸèƒ½ - ç”Ÿæˆä¸æ‰«æ
        const generateQrBtn = document.getElementById('generate-qr-btn');
        const scanQrBtn = document.getElementById('scan-qr-btn');
        const qrModal = document.getElementById('qr-modal');
        const scanModal = document.getElementById('scan-modal');
        const cancelQrBtn = document.getElementById('cancel-qr-btn');
        const refreshQrBtn = document.getElementById('refresh-qr-btn');
        const cancelScanBtn = document.getElementById('cancel-scan-btn');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrExpireCountdown = document.getElementById('qr-expire-countdown');
        const scannerContainer = document.getElementById('scanner-container');
        const scanningIndicator = document.getElementById('scanning-indicator');
        
        let qrCountdownTimer = null;
        let currentQrCode = null;
        
        // ç”Ÿæˆåˆ†äº«äºŒç»´ç 
        function generateShareQrCode() {
            // äºŒç»´ç ç”ŸæˆåŠŸèƒ½å·²ç¦ç”¨
            showToast('äºŒç»´ç ç”ŸæˆåŠŸèƒ½å·²ç¦ç”¨');
        }
        
        // å¼€å§‹äºŒç»´ç å€’è®¡æ—¶
        function startQrCountdown() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }

        // æ£€æµ‹æ˜¯å¦ä¸ºPCç«¯è®¾å¤‡
        function detectIsPC() {
            // ä¼˜å…ˆä½¿ç”¨isMobileå‡½æ•°çš„åå‘åˆ¤æ–­ï¼Œè¿™æ˜¯æ›´å¯é çš„ç§»åŠ¨è®¾å¤‡æ£€æµ‹
            return !isMobile();
        }
        
        // å½“ç”¨æˆ·å°è¯•ä½¿ç”¨æ‰«æåŠŸèƒ½æ—¶æ˜¾ç¤ºå‹å¥½æç¤º
        function showScanFallbackMessage() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // æœ¬åœ°å¤‡é€‰æ–¹æ¡ˆï¼šå»ºè®®ç”¨æˆ·ä¸‹è½½jsQRåº“æ–‡ä»¶åˆ°æœ¬åœ° - å·²ç¦ç”¨äºŒç»´ç åŠŸèƒ½ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        window.showLocalFallbackInstructions = function() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
            showToast('äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨');
        };
        
        // æ‰«æäºŒç»´ç åŠŸèƒ½
        function scanQrCode() {
            // äºŒç»´ç æ‰«æåŠŸèƒ½å·²ç¦ç”¨
            showToast('äºŒç»´ç æ‰«æåŠŸèƒ½å·²ç¦ç”¨');
        }
        
        // æ˜¾ç¤ºPCç«¯æ‘„åƒå¤´æƒé™ç¡®è®¤å¯¹è¯æ¡†
        function showPcCameraPermissionDialog() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // ç»§ç»­æ‰«ææµç¨‹
        function proceedWithScanning() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // å¯åŠ¨æ‰«æå™¨
        function startScanner() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // æ‰«æè¿‡ç¨‹
        function startScanningProcess(video, stream) {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // å¤„ç†æ‰«æç»“æœ
        function handleScanResult(result) {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // å…³é—­æ‰«ææ¨¡æ€æ¡†
        function closeScanModal() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥é€‰é¡¹
        function showManualInputOption() {
            // åˆ›å»ºæ‰‹åŠ¨è¾“å…¥æ¨¡æ€æ¡†
            const manualInputModal = document.createElement('div');
            manualInputModal.style.position = 'fixed';
            manualInputModal.style.top = '0';
            manualInputModal.style.left = '0';
            manualInputModal.style.width = '100%';
            manualInputModal.style.height = '100%';
            manualInputModal.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            manualInputModal.style.display = 'flex';
            manualInputModal.style.alignItems = 'center';
            manualInputModal.style.justifyContent = 'center';
            manualInputModal.style.zIndex = '1000';
            manualInputModal.style.padding = '20px';
            
            // åˆ›å»ºå¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.borderRadius = '12px';
            dialog.style.padding = '24px';
            dialog.style.width = '100%';
            dialog.style.maxWidth = '400px';
            dialog.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
            
            // æ·»åŠ æ ‡é¢˜
            const title = document.createElement('h3');
            title.textContent = 'æ‰‹åŠ¨è¾“å…¥æ•°æ®';
            title.style.color = '#333';
            title.style.margin = '0 0 16px 0';
            title.style.fontSize = '18px';
            
            // æ·»åŠ è¯´æ˜æ–‡å­—
            const description = document.createElement('p');
            description.innerHTML = 'ç”±äºç½‘ç»œåŸå› ï¼ŒäºŒç»´ç æ‰«æåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ã€‚æ‚¨å¯ä»¥å°è¯•ä»¥ä¸‹æ“ä½œï¼š<br><br>1. æ‰‹åŠ¨è¾“å…¥äºŒç»´ç ä¸­çš„å†…å®¹ï¼ˆé€šå¸¸æ˜¯ä¸€ä¸²Base64ç¼–ç çš„æ–‡æœ¬ï¼‰<br>2. å°†äºŒç»´ç å›¾ç‰‡ä¿å­˜åˆ°è®¾å¤‡ï¼Œé€šè¿‡å…¶ä»–äºŒç»´ç æ‰«æåº”ç”¨è·å–å†…å®¹åå†è¾“å…¥<br><br>æç¤ºï¼šBase64ç¼–ç çš„æ–‡æœ¬é€šå¸¸åŒ…å«å­—æ¯ã€æ•°å­—å’Œ+/=ç­‰ç‰¹æ®Šå­—ç¬¦ã€‚';
            description.style.color = '#666';
            description.style.margin = '0 0 20px 0';
            description.style.fontSize = '14px';
            description.style.lineHeight = '1.5';
            description.style.whiteSpace = 'pre-line';
            
            // æ·»åŠ æ–‡æœ¬è¾“å…¥æ¡†
            const textarea = document.createElement('textarea');
            textarea.placeholder = 'è¯·è¾“å…¥äºŒç»´ç ä¸­çš„å†…å®¹...';
            textarea.style.width = '100%';
            textarea.style.height = '120px';
            textarea.style.padding = '12px';
            textarea.style.border = '1px solid #ddd';
            textarea.style.borderRadius = '6px';
            textarea.style.fontSize = '14px';
            textarea.style.resize = 'vertical';
            textarea.style.boxSizing = 'border-box';
            
            // æ·»åŠ æŒ‰é’®å®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'flex-end';
            buttonContainer.style.marginTop = '16px';
            buttonContainer.style.gap = '12px';
            
            // æ·»åŠ å–æ¶ˆæŒ‰é’®
            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'å–æ¶ˆ';
            cancelButton.style.padding = '8px 20px';
            cancelButton.style.backgroundColor = '#f5f5f5';
            cancelButton.style.color = '#666';
            cancelButton.style.border = 'none';
            cancelButton.style.borderRadius = '6px';
            cancelButton.style.cursor = 'pointer';
            cancelButton.style.fontSize = '14px';
            cancelButton.onclick = () => {
                document.body.removeChild(manualInputModal);
            };
            
            // æ·»åŠ ç¡®è®¤æŒ‰é’®
            const confirmButton = document.createElement('button');
            confirmButton.textContent = 'ç¡®è®¤';
            confirmButton.style.padding = '8px 20px';
            confirmButton.style.backgroundColor = '#009688';
            confirmButton.style.color = 'white';
            confirmButton.style.border = 'none';
            confirmButton.style.borderRadius = '6px';
            confirmButton.style.cursor = 'pointer';
            confirmButton.style.fontSize = '14px';
            confirmButton.onclick = () => {
                const inputText = textarea.value.trim();
                if (inputText) {
                    try {
                        // ä½¿ç”¨ç°æœ‰çš„processImportDataå‡½æ•°å¤„ç†è¾“å…¥çš„æ•°æ®
                        processImportData(inputText);
                        document.body.removeChild(manualInputModal);
                    } catch (error) {
                        console.error('å¤„ç†æ‰‹åŠ¨è¾“å…¥æ•°æ®å¤±è´¥:', error);
                        alert('è¾“å…¥çš„æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®è®¤è¾“å…¥çš„æ˜¯æœ‰æ•ˆçš„ä¸‰æ ¼è®°å½•æœ¬æ•°æ®ã€‚');
                    }
                } else {
                    alert('è¯·è¾“å…¥å†…å®¹åå†ç¡®è®¤ã€‚');
                }
            };
            
            // ç»„è£…å¯¹è¯æ¡†
            buttonContainer.appendChild(cancelButton);
            buttonContainer.appendChild(confirmButton);
            
            dialog.appendChild(title);
            dialog.appendChild(description);
            dialog.appendChild(textarea);
            dialog.appendChild(buttonContainer);
            
            manualInputModal.appendChild(dialog);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(manualInputModal);
        }
        
        // è§£ç äºŒç»´ç æ•°æ®æ¼”ç¤ºåŠŸèƒ½ - ç”¨äºå¼€å‘æµ‹è¯•å’Œæ¨¡æ‹Ÿæ‰«ææ•ˆæœ
        function decodeQrCodeDemo() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
            showToast('äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨');
        }
        
        // å…³é—­äºŒç»´ç æ¨¡æ€æ¡†
        function closeQrModal() {
            // äºŒç»´ç åŠŸèƒ½å·²ç¦ç”¨ï¼Œæ­¤å‡½æ•°ä¸å†éœ€è¦
        }
        
        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ - å·²ç¦ç”¨äºŒç»´ç åŠŸèƒ½ï¼Œç§»é™¤ç›¸å…³äº‹ä»¶ç›‘å¬
        // if (generateQrBtn) {
        //     generateQrBtn.addEventListener('click', generateShareQrCode);
        // }
        // 
        // if (scanQrBtn) {
        //     scanQrBtn.addEventListener('click', scanQrCode);
        // }
        // 
        // if (cancelQrBtn) {
        //     cancelQrBtn.addEventListener('click', closeQrModal);
        // }
        // 
        // if (cancelScanBtn) {
        //     cancelScanBtn.addEventListener('click', closeScanModal);
        // }
        // 
        // if (refreshQrBtn) {
        //     refreshQrBtn.addEventListener('click', generateShareQrCode);
        // }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­ - å·²ç¦ç”¨äºŒç»´ç åŠŸèƒ½ï¼Œç§»é™¤ç›¸å…³äº‹ä»¶ç›‘å¬
        // window.addEventListener('click', function(event) {
        //     if (event.target === qrModal) {
        //         closeQrModal();
        //     }
        // });

        // ä½¿searchByTagå‡½æ•°å¯ä»HTMLä¸­è®¿é—®
        window.searchByTag = searchByTag;

        // æ¸²æŸ“è®°å½•æœ¬åˆ—è¡¨ - ä¼˜åŒ–ç‰ˆ
        function renderNotebooksList() {
            // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µå‡å°‘DOMé‡æ’æ¬¡æ•°
            const fragment = document.createDocumentFragment();

            notebooks.forEach(notebook => {
                const notebookItem = document.createElement('div');
                notebookItem.className = `notebook-item ${notebook.id === currentNotebookId ? 'active' : ''}`;
                notebookItem.setAttribute('data-notebook-id', notebook.id);
                
                // åˆ›å»ºè®°å½•æœ¬æ ‡é¢˜
                const titleDiv = document.createElement('div');
                titleDiv.style.fontWeight = 'bold';
                titleDiv.textContent = notebook.title;
                
                // åˆ›å»ºè®°å½•çº¸æ•°é‡æ˜¾ç¤º
                const countDiv = document.createElement('div');
                countDiv.style.fontSize = '0.85rem';
                countDiv.style.color = '#666';
                countDiv.style.marginRight = '25px'; // å¾€å·¦ç§»åŠ¨ä¸€ç‚¹ï¼Œä¸ºåˆ é™¤å›¾æ ‡ç•™å‡ºç©ºé—´
                countDiv.textContent = `${notebook.papers.length} å¼ è®°å½•çº¸`;
                
                // åˆ›å»ºåˆ é™¤å›¾æ ‡æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'notebook-delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'åˆ é™¤è®°å½•æœ¬';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è®°å½•æœ¬åˆ‡æ¢
                    const currentNotebook = notebook;
                    
                    showDeleteConfirmModal(
                        'ç¡®è®¤åˆ é™¤è®°å½•æœ¬',
                        'ç¡®å®šè¦å°†è¿™ä¸ªè®°å½•æœ¬ç§»è‡³å›æ”¶ç«™å—ï¼Ÿ',
                        function() {
                            // ä»è®°å½•æœ¬åˆ—è¡¨ä¸­ç§»é™¤
                            const notebookIndex = notebooks.findIndex(n => n.id === currentNotebook.id);
                            const deletedNotebook = notebooks.splice(notebookIndex, 1)[0];
                              
                            // æ·»åŠ åˆ°å›æ”¶ç«™
                            const recycleItem = {
                                id: Date.now().toString(),
                                type: 'notebook', // æ ‡è®°ä¸ºè®°å½•æœ¬ç±»å‹
                                notebook: deletedNotebook,
                                deletedAt: new Date().toLocaleString('zh-CN')
                            };
                            recycleBinData.push(recycleItem);
                              
                            // ä¿å­˜æ•°æ®
                            saveToLocalStorage();
                            saveRecycleBinToLocalStorage();
                              
                            // æ›´æ–°UI
                            renderNotebooksList();
                            updateRecycleBinUI();
                              
                            if (notebooks.length > 0) {
                                switchToNotebook(notebooks[0].id);
                            } else {
                                papersContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰è®°å½•æœ¬ï¼Œç‚¹å‡»"æ–°å»ºè®°å½•æœ¬"å¼€å§‹åˆ›å»ºå§ï¼</p>';
                                currentNotebookId = null;
                            }
                        }
                    );
                });
                
                // ç»„ç»‡å¸ƒå±€
                const rightSection = document.createElement('div');
                rightSection.style.display = 'flex';
                rightSection.style.alignItems = 'center';
                rightSection.appendChild(countDiv);
                rightSection.appendChild(deleteBtn);
                
                notebookItem.appendChild(titleDiv);
                notebookItem.appendChild(rightSection);

                // ä¸å†ä¸ºæ¯ä¸ªå…ƒç´ å•ç‹¬æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                fragment.appendChild(notebookItem);
            });

            // æ¸…ç©ºå®¹å™¨å¹¶ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰å…ƒç´ 
            notebooksContainer.innerHTML = '';
            notebooksContainer.appendChild(fragment);
        }

        // äº‹ä»¶å§”æ‰˜ - å¤„ç†è®°å½•æœ¬ç‚¹å‡»
        function handleNotebookClick(e) {
            const notebookItem = e.target.closest('.notebook-item');
            if (!notebookItem || e.target.classList.contains('notebook-delete-btn')) return;
            
            const notebookId = notebookItem.getAttribute('data-notebook-id');
            switchToNotebook(notebookId);
        }

        // äº‹ä»¶å§”æ‰˜ - å¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
        function handleNotebookDelete(e) {
            if (!e.target.classList.contains('notebook-delete-btn')) return;
            
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è®°å½•æœ¬åˆ‡æ¢
            const notebookId = e.target.closest('[data-notebook-id]').getAttribute('data-notebook-id');
            const currentNotebook = notebooks.find(n => n.id === notebookId);
            
            if (currentNotebook) {
                showDeleteConfirmModal(
                    'ç¡®è®¤åˆ é™¤è®°å½•æœ¬',
                    'ç¡®å®šè¦å°†è¿™ä¸ªè®°å½•æœ¬ç§»è‡³å›æ”¶ç«™å—ï¼Ÿ',
                    function() {
                        // ä»è®°å½•æœ¬åˆ—è¡¨ä¸­ç§»é™¤
                        const notebookIndex = notebooks.findIndex(n => n.id === currentNotebook.id);
                        const deletedNotebook = notebooks.splice(notebookIndex, 1)[0];
                           
                        // æ·»åŠ åˆ°å›æ”¶ç«™
                        const recycleItem = {
                            id: Date.now().toString(),
                            type: 'notebook', // æ ‡è®°ä¸ºè®°å½•æœ¬ç±»å‹
                            notebook: deletedNotebook,
                            deletedAt: new Date().toLocaleString('zh-CN')
                        };
                        recycleBinData.push(recycleItem);
                           
                        // ä¿å­˜æ•°æ®
                        saveToLocalStorage();
                        saveRecycleBinToLocalStorage();
                           
                        // æ›´æ–°UI
                        renderNotebooksList();
                        updateRecycleBinUI();
                           
                        if (notebooks.length > 0) {
                            switchToNotebook(notebooks[0].id);
                        } else {
                            papersContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">è¿˜æ²¡æœ‰è®°å½•æœ¬ï¼Œç‚¹å‡»"æ–°å»ºè®°å½•æœ¬"å¼€å§‹åˆ›å»ºå§ï¼</p>';
                            currentNotebookId = null;
                        }
                    }
                );
            }
        }

        // ä¸ºæ‰€æœ‰å·²å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨æ·»åŠ äº‹ä»¶å§”æ‰˜
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬è®°å½•æœ¬å®¹å™¨çš„ç‚¹å‡»äº‹ä»¶
            notebooksContainer.addEventListener('click', handleNotebookClick);
            // ç›‘å¬åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            notebooksContainer.addEventListener('click', handleNotebookDelete);
            
            // ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–äºŒç»´ç æ‰«æåŠŸèƒ½
            optimizeForMobileScanning();
        });
        
        // ä¸ºç§»åŠ¨è®¾å¤‡ä¼˜åŒ–æ‰«æåŠŸèƒ½
        function optimizeForMobileScanning() {
            // æ£€æµ‹æ˜¯å¦æ˜¯ç§»åŠ¨è®¾å¤‡
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // ä¸ºç§»åŠ¨è®¾å¤‡æ·»åŠ æ‰«æç›¸å…³çš„CSSæ ·å¼
                const mobileScanStyle = document.createElement('style');
                mobileScanStyle.textContent = `
                    /* ä¼˜åŒ–æ‰«ææ¨¡æ€æ¡†åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šçš„æ˜¾ç¤º */
                    #scan-modal {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.9);
                        z-index: 1000;
                        display: none;
                    }
                    
                    #scanner-container {
                        position: relative;
                        width: 100%;
                        height: 100%;
                        display: flex;
                        flex-direction: column;
                        justify-content: center;
                        align-items: center;
                    }
                    
                    #scan-video {
                        max-width: 100%;
                        max-height: 80vh;
                        object-fit: contain;
                    }
                    
                    #scan-overlay {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                    }
                    
                    /* é€‚é…æ¨ªå±å’Œç«–å±æ¨¡å¼ */
                    @media (orientation: landscape) {
                        #scan-frame {
                            width: 250px;
                            height: 250px;
                        }
                        
                        #scan-tip {
                            font-size: 14px;
                            padding: 0 15px;
                        }
                    }
                    
                    @media (orientation: portrait) {
                        #scan-frame {
                            width: 80vw;
                            max-width: 300px;
                            height: 80vw;
                            max-height: 300px;
                        }
                        
                        #scan-tip {
                            font-size: 16px;
                            padding: 0 20px;
                        }
                    }
                `;
                document.head.appendChild(mobileScanStyle);
                
                // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–ï¼Œä¼˜åŒ–æ‰«æä½“éªŒ
                window.addEventListener('orientationchange', function() {
                    // å¦‚æœæ‰«ææ¨¡æ€æ¡†æ­£åœ¨æ˜¾ç¤ºï¼Œé‡æ–°è°ƒæ•´å°ºå¯¸
                    if (scanModal && scanModal.style.display === 'flex') {
                        setTimeout(() => {
                            // è¿™é‡Œå¯ä»¥æ·»åŠ è°ƒæ•´æ‰«æåŒºåŸŸå¤§å°çš„é€»è¾‘
                        }, 300);
                    }
                });
            }
        }

        // å¯¼å‡ºè®°å½•
        function exportRecords() {
            const currentNotebook = notebooks.find(n => n.id === currentNotebookId);
            if (!currentNotebook || currentNotebook.papers.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è®°å½•');
                return;
            }

            let exportContent = `=== ${currentNotebook.title} ===\n`;
            exportContent += `å¯¼å‡ºæ—¶é—´: ${new Date().toLocaleString('zh-CN')}\n\n`;

            currentNotebook.papers.forEach((paper, paperIndex) => {
                exportContent += `--- ${paper.title} (${paper.date}) ---
`;
                
                // æ‰¾å‡ºæ¯ä¸€åˆ—çš„æœ€å¤§å†…å®¹è¡Œæ•°
                const maxRows = Math.max(...paper.data.map(col => 
                    col.filter(row => row.trim() !== '').length
                ));
                
                // é€è¡Œå¯¼å‡ºä¸‰åˆ—å†…å®¹
                for (let i = 0; i < maxRows; i++) {
                    const rowContent = paper.data.map(col => col[i] || '').join('\t');
                    exportContent += rowContent + '\n';
                }
                
                exportContent += '\n';
            });

            // åˆ›å»ºBlobå¹¶ä¸‹è½½
            const blob = new Blob([exportContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentNotebook.title}_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // äº‹ä»¶ç›‘å¬
        newPaperBtn.addEventListener('click', function() {
            paperTitle.value = '';
            newPaperModal.querySelector('h3').textContent = 'æ–°å»ºè®°å½•çº¸';
            newPaperModal.style.display = 'flex';
        });
        
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ ‡å¿—æ¥åŒºåˆ†å½“å‰æ˜¯åˆ›å»ºå“ªç§è®°å½•çº¸
        let isCreatingFourColumnPaper = false;

        newNotebookBtn.addEventListener('click', function() {
            notebookTitle.value = '';
            newNotebookModal.style.display = 'flex';
        });

        cancelPaperBtn.addEventListener('click', function() {
            newPaperModal.style.display = 'none';
        });

        confirmPaperBtn.addEventListener('click', function() {
            const title = paperTitle.value.trim();
            if (!title) {
                showToast('è¯·è¾“å…¥è®°å½•çº¸æ ‡é¢˜');
                paperTitle.focus();
                return;
            }
            
            if (isCreatingFourColumnPaper) {
                createFourColumnPaper(title);
                isCreatingFourColumnPaper = false;
            } else {
                createNewPaper(title);
            }
            newPaperModal.style.display = 'none';
        });
        
        cancelPaperBtn.addEventListener('click', function() {
            isCreatingFourColumnPaper = false;
            newPaperModal.style.display = 'none';
        });

        cancelNotebookBtn.addEventListener('click', function() {
            newNotebookModal.style.display = 'none';
        });

        confirmNotebookBtn.addEventListener('click', function() {
            const title = notebookTitle.value.trim();
            if (!title) {
                showToast('è¯·è¾“å…¥è®°å½•æœ¬æ ‡é¢˜');
                notebookTitle.focus();
                return;
            }
            createNewNotebook(title);
            newNotebookModal.style.display = 'none';
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            if (event.target === newPaperModal) {
                newPaperModal.style.display = 'none';
            }
            if (event.target === newNotebookModal) {
                newNotebookModal.style.display = 'none';
            }
        });
        
        // å››æ ¼è®°å½•æŒ‰é’®äº‹ä»¶ç›‘å¬
        const sidebarFourColumnBtn = document.getElementById('sidebar-four-column-btn');
        if (sidebarFourColumnBtn) {
            sidebarFourColumnBtn.addEventListener('click', function() {
                paperTitle.value = '';
                newPaperModal.querySelector('h3').textContent = 'æ–°å»ºå››æ ¼è®°å½•';
                isCreatingFourColumnPaper = true;
                newPaperModal.style.display = 'flex';
            });
        }
        
        const fourColumnBtn = document.getElementById('four-column-btn');
        if (fourColumnBtn) {
            fourColumnBtn.addEventListener('click', function() {
                paperTitle.value = '';
                newPaperModal.querySelector('h3').textContent = 'æ–°å»ºå››æ ¼è®°å½•';
                isCreatingFourColumnPaper = true;
                newPaperModal.style.display = 'flex';
            });
        }

        // æ‰“å°æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
        papersContainer.addEventListener('click', function(e) {
            if (e.target.closest('.print-btn')) {
                const printBtn = e.target.closest('.print-btn');
                const paperId = printBtn.dataset.paperId;
                exportPaperAsImage(paperId);
            }
        });

        // å¯¼å‡ºè®°å½•çº¸ä¸ºå›¾ç‰‡
        function exportPaperAsImage(paperId) {
            // ç¡®ä¿å…¨å±€çŠ¶æ€å˜é‡å·²åˆå§‹åŒ–
            if (window.exportCount === undefined) {
                window.exportCount = 0;
            }
            
            // æ·»åŠ å¯¼å‡ºçŠ¶æ€æ ‡è®°ï¼Œé˜²æ­¢è¿ç»­ç‚¹å‡»
            if (window.isExporting) {
                showToast('æ­£åœ¨å¤„ç†ä¸Šä¸€æ¬¡å¯¼å‡ºï¼Œè¯·ç¨å€™...');
                return;
            }
            window.isExporting = true;
            
            // å¢åŠ å¯¼å‡ºè®¡æ•°
            window.exportCount++;
            
            // æ¯ä¸‰æ¬¡å¯¼å‡ºåæç¤ºç”¨æˆ·ç­‰å¾…ç‰‡åˆ»ï¼Œä»¥é¿å…æµè§ˆå™¨é™åˆ¶
            if (window.exportCount % 3 === 0) {
                showToast('å·²è¿ç»­å¯¼å‡ºå¤šå¼ å›¾ç‰‡ï¼Œä¸ºç¡®ä¿åŠŸèƒ½æ­£å¸¸ï¼Œè¯·ç¨ç­‰2ç§’...');
            }
            
            // ç«‹å³æ˜¾ç¤ºé«˜å¯¹æ¯”åº¦çš„åŠ è½½æç¤º
            const loadingToast = document.createElement('div');
            loadingToast.className = 'export-loading-toast';
            loadingToast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: #ff3e3e;
                color: white;
                padding: 20px 30px;
                border-radius: 8px;
                font-size: 18px;
                font-weight: bold;
                z-index: 9999;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                text-align: center;
                transition: opacity 0.3s ease;
            `;
            loadingToast.textContent = 'æ­£åœ¨å‡†å¤‡å¯¼å‡º...';
            document.body.appendChild(loadingToast);

            // ç«‹å³æ£€æŸ¥å¹¶é€€å‡ºå…¨å±æ¨¡å¼
            const wasFullscreen = document.fullscreenElement !== null;
            if (wasFullscreen && typeof window.exitFullscreen === 'function') {
                window.exitFullscreen();
                // æ˜¾ç¤ºæç¤ºï¼Œå‘ŠçŸ¥ç”¨æˆ·æ­£åœ¨é€€å‡ºå…¨å±ä»¥å‡†å¤‡ä¸‹è½½
                showToast('æ­£åœ¨é€€å‡ºå…¨å±ä»¥å‡†å¤‡ä¸‹è½½...');
            }

            // æŸ¥æ‰¾å¯¹åº”çš„è®°å½•çº¸å…ƒç´ 
            const paperElement = document.querySelector(`.paper[data-paper-id="${paperId}"]`);
            if (!paperElement) {
                alert('æœªæ‰¾åˆ°è®°å½•çº¸å…ƒç´ ');
                window.isExporting = false;
                loadingToast.remove();
                return;
            }

            // è·å–è®°å½•çº¸æ ‡é¢˜ä½œä¸ºæ–‡ä»¶å
            const titleElement = paperElement.querySelector('.paper-title');
            const fileName = titleElement ? titleElement.textContent.trim() : 'è®°å½•çº¸';

            // æ˜¾ç¤ºåŠ è½½æç¤º
            showToast('æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ï¼Œè¯·ç¨å€™...');

            // éšè—æ‰“å°å›¾æ ‡å’Œåˆ é™¤å›¾æ ‡
            const printBtn = paperElement.querySelector('.print-btn');
            const deleteBtn = paperElement.querySelector('.delete-btn');
            const originalPrintBtnStyle = printBtn ? printBtn.style.display : '';
            const originalDeleteBtnStyle = deleteBtn ? deleteBtn.style.display : '';
            
            if (printBtn) printBtn.style.display = 'none';
            if (deleteBtn) deleteBtn.style.display = 'none';
            
            // ä¸´æ—¶å°†ä¼ªå…ƒç´ ç«–çº¿è½¬æ¢ä¸ºå®é™…DOMå…ƒç´ ï¼Œä»¥ç¡®ä¿å¯¼å‡ºå›¾ç‰‡æ—¶ç«–çº¿ä½ç½®æ­£ç¡®
            const tempVerticalLines = [];
            const columns = paperElement.querySelectorAll('.column:not(:last-child)');
            columns.forEach(column => {
                const verticalLine = document.createElement('div');
                verticalLine.className = 'temp-vertical-line';
                
                // è·å–åˆ—è¾¹æ¡†æ ·å¼å’Œé¢œè‰²
                const columnBorderStyle = column.style.getPropertyValue('--column-border-style') || 'solid';
                const columnBorderColor = column.style.getPropertyValue('--column-border-color') || '#a0d4e6';
                
                // è®¾ç½®ç«–çº¿æ ·å¼
                verticalLine.style.cssText = `
                    position: absolute;
                    top: 0;
                    right: -20px;
                    height: 100%;
                    width: 1px;
                    background-color: ${columnBorderColor};
                    z-index: 5;
                `;
                
                // æ ¹æ®è¾¹æ¡†æ ·å¼è°ƒæ•´
                if (columnBorderStyle === 'dashed') {
                    verticalLine.style.backgroundImage = `repeating-linear-gradient(
                        to bottom,
                        transparent 0px,
                        transparent 19px,
                        ${columnBorderColor} 19px,
                        ${columnBorderColor} 20px
                    )`;
                    verticalLine.style.backgroundColor = 'transparent';
                } else if (columnBorderStyle === 'dotted') {
                    verticalLine.style.backgroundImage = `repeating-linear-gradient(
                        to bottom,
                        transparent 0px,
                        transparent 5px,
                        ${columnBorderColor} 5px,
                        ${columnBorderColor} 6px
                    )`;
                    verticalLine.style.backgroundColor = 'transparent';
                }
                
                // æ·»åŠ åˆ°çˆ¶å…ƒç´ ä¸­
                column.parentNode.appendChild(verticalLine);
                tempVerticalLines.push(verticalLine);
            });

            // ä¿å­˜æ‰€æœ‰éœ€è¦æ¸…ç†çš„èµ„æºå¼•ç”¨
            const resourcesToClean = {
                tempElements: [],
                urls: []
            };
            
            // ç¡®ä¿èµ„æºæ¸…ç†çš„å‡½æ•°
            function cleanupResources() {
                // æ¢å¤æ‰“å°å›¾æ ‡å’Œåˆ é™¤å›¾æ ‡æ˜¾ç¤º
                if (printBtn) printBtn.style.display = originalPrintBtnStyle;
                if (deleteBtn) deleteBtn.style.display = originalDeleteBtnStyle;
                
                // ç§»é™¤ä¸´æ—¶æ·»åŠ çš„ç«–çº¿å…ƒç´ 
                tempVerticalLines.forEach(line => {
                    if (line && line.parentNode) line.parentNode.removeChild(line);
                });
                
                // ç§»é™¤æ‰€æœ‰ä¸´æ—¶åˆ›å»ºçš„å…ƒç´ 
                resourcesToClean.tempElements.forEach(element => {
                    if (element && element.parentNode) {
                        try {
                            element.parentNode.removeChild(element);
                        } catch (e) {
                            console.warn('ç§»é™¤å…ƒç´ å¤±è´¥:', e);
                        }
                    }
                });
                
                // é‡Šæ”¾æ‰€æœ‰åˆ›å»ºçš„URLå¯¹è±¡
                resourcesToClean.urls.forEach(url => {
                    try {
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.warn('é‡Šæ”¾URLå¯¹è±¡å¤±è´¥:', e);
                    }
                });
                
                // æ¸…ç©ºèµ„æºåˆ—è¡¨
                resourcesToClean.tempElements = [];
                resourcesToClean.urls = [];
                
                // ç§»é™¤åŠ è½½æç¤º
                if (loadingToast && loadingToast.parentNode) {
                    loadingToast.style.opacity = '0';
                    setTimeout(() => {
                        if (loadingToast.parentNode) {
                            loadingToast.parentNode.removeChild(loadingToast);
                        }
                    }, 300);
                }
                
                // é‡ç½®å¯¼å‡ºçŠ¶æ€æ ‡è®°
                window.isExporting = false;
                
                // æ¯äº”æ¬¡å¯¼å‡ºåé‡ç½®è®¡æ•°ï¼Œå¸®åŠ©é˜²æ­¢é•¿æ—¶é—´ç´¯ç§¯çš„é—®é¢˜
                if (window.exportCount >= 5) {
                    window.exportCount = 0;
                }
            }

            // ä½¿ç”¨html2canvaså°†è®°å½•çº¸è½¬æ¢ä¸ºå›¾ç‰‡
            if (typeof html2canvas === 'undefined') {
                console.error('âŒ html2canvasåº“ä¸å¯ç”¨ï¼Œæ— æ³•ç”Ÿæˆå›¾ç‰‡');
                alert('å¾ˆæŠ±æ­‰ï¼Œå›¾ç‰‡ç”ŸæˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚');
                cleanupResources();
                return;
            }
            
            // æ›´æ–°åŠ è½½æç¤º
            loadingToast.textContent = 'æ­£åœ¨ç”Ÿæˆå›¾ç‰‡...';
            
            html2canvas(paperElement, {
                scale: 2, // æé«˜å›¾ç‰‡è´¨é‡
                useCORS: true, // å…è®¸è·¨åŸŸå›¾ç‰‡
                logging: false,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                // æ›´å¥å£®çš„ä¸‹è½½è§¦å‘æœºåˆ¶
                function triggerDownload() {
                    // è·å–å›¾ç‰‡æ•°æ®
                    let dataUrl;
                    try {
                        // å°è¯•è·å–å›¾ç‰‡æ•°æ®ï¼Œå¦‚æœæ•°æ®è¿‡å¤§åˆ™é™çº§å¤„ç†
                        dataUrl = canvas.toDataURL('image/png');
                        
                        // æ£€æŸ¥æ•°æ®URLå¤§å°ï¼Œå¦‚æœè¿‡å¤§å¯èƒ½åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå‡ºé—®é¢˜
                        if (dataUrl.length > 5 * 1024 * 1024) { // 5MB
                            // é™çº§å¤„ç†ï¼šé™ä½å›¾ç‰‡è´¨é‡
                            dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        }
                    } catch (e) {
                        console.error('è·å–å›¾ç‰‡æ•°æ®å¤±è´¥:', e);
                        showToast('å›¾ç‰‡ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                        cleanupResources();
                        return;
                    }
                    
                    const downloadFileName = `${fileName || 'æœªå‘½åè®°å½•çº¸'}.png`;
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                    const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    
                    // æ˜¾ç¤ºå‡†å¤‡ä¸‹è½½çš„æç¤º
                    showToast('å‡†å¤‡ä¸‹è½½å›¾ç‰‡...');
                    
                    // æ›´æ–°åŠ è½½æç¤º
                    loadingToast.textContent = 'æ­£åœ¨å‡†å¤‡ä¸‹è½½...';
                    
                    // ä¸ºç§»åŠ¨è®¾å¤‡æä¾›æ›´å¥å£®çš„ä¸‹è½½å¤„ç†
                    setTimeout(() => {
                        if (isMobile) {
                            // ç§»åŠ¨è®¾å¤‡ä¸Šçš„ç‰¹æ®Šå¤„ç†
                            try {
                                // é’ˆå¯¹iOSå’ŒAndroidçš„ä¸åŒå¤„ç†
                                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                                
                                if (isIOS) {
                                    // iOSè®¾å¤‡ä¸Šçš„å¤„ç†
                                    // åˆ›å»ºä¸€ä¸ªæ–°çš„canvasç”¨äºåœ¨iOSä¸Šæ˜¾ç¤º
                                    const tempCanvas = document.createElement('canvas');
                                    tempCanvas.width = canvas.width;
                                    tempCanvas.height = canvas.height;
                                    tempCanvas.style.cssText = `
                                        position: fixed;
                                        top: 0;
                                        left: 0;
                                        width: 100vw;
                                        height: 100vh;
                                        object-fit: contain;
                                        background: white;
                                        z-index: 9998;
                                        cursor: pointer;
                                    `;
                                    tempCanvas.getContext('2d').drawImage(canvas, 0, 0);
                                    tempCanvas.onclick = function() {
                                        if (this.parentNode) {
                                            this.parentNode.removeChild(this);
                                        }
                                    };
                                    
                                    // åˆ›å»ºæç¤ºæ–‡å­—
                                    const iOSHint = document.createElement('div');
                                    iOSHint.style.cssText = `
                                        position: fixed;
                                        bottom: 20px;
                                        left: 50%;
                                        transform: translateX(-50%);
                                        background: rgba(0,0,0,0.7);
                                        color: white;
                                        padding: 10px 15px;
                                        border-radius: 5px;
                                        font-size: 14px;
                                        z-index: 9999;
                                    `;
                                    iOSHint.textContent = 'ç‚¹å‡»å›¾ç‰‡å¯å…³é—­ï¼Œä½¿ç”¨ç³»ç»Ÿä¿å­˜åŠŸèƒ½ä¿å­˜å›¾ç‰‡';
                                    
                                    // æ·»åŠ åˆ°èµ„æºæ¸…ç†åˆ—è¡¨
                                    resourcesToClean.tempElements.push(tempCanvas);
                                    resourcesToClean.tempElements.push(iOSHint);
                                    
                                    document.body.appendChild(tempCanvas);
                                    document.body.appendChild(iOSHint);
                                    
                                    // 3ç§’åéšè—æç¤º
                                    setTimeout(() => {
                                        iOSHint.style.opacity = '0';
                                        setTimeout(() => {
                                            if (iOSHint.parentNode) {
                                                iOSHint.parentNode.removeChild(iOSHint);
                                            }
                                        }, 300);
                                    }, 3000);
                                    
                                    // 10ç§’åè‡ªåŠ¨ç§»é™¤canvasï¼Œé¿å…é•¿æ—¶é—´å ç”¨å±å¹•
                                    setTimeout(() => {
                                        if (tempCanvas.parentNode) {
                                            tempCanvas.parentNode.removeChild(tempCanvas);
                                        }
                                    }, 10000);
                                } else {
                                    // Androidè®¾å¤‡ä¸Šçš„å¤„ç†
                                    try {
                                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                                        const link = document.createElement('a');
                                        link.download = downloadFileName;
                                        
                                        // ä½¿ç”¨Blobå’ŒcreateObjectURLæ¥å¤„ç†å¤§å›¾ç‰‡
                                        // å°†dataURLè½¬æ¢ä¸ºBlob
                                        const byteString = atob(dataUrl.split(',')[1]);
                                        const mimeString = dataUrl.split(',')[0].split(':')[1].split(';')[0];
                                        const ab = new ArrayBuffer(byteString.length);
                                        const ia = new Uint8Array(ab);
                                        
                                        for (let i = 0; i < byteString.length; i++) {
                                            ia[i] = byteString.charCodeAt(i);
                                        }
                                        
                                        const blob = new Blob([ab], {type: mimeString});
                                        const url = URL.createObjectURL(blob);
                                        
                                        // æ·»åŠ åˆ°èµ„æºæ¸…ç†åˆ—è¡¨
                                        resourcesToClean.urls.push(url);
                                        resourcesToClean.tempElements.push(link);
                                        
                                        link.href = url;
                                        
                                        // ç§»åŠ¨è®¾å¤‡ä¸Šå¯èƒ½éœ€è¦é¢å¤–çš„å¤„ç†
                                        link.style.display = 'none';
                                        document.body.appendChild(link);
                                        
                                        // è§¦å‘ç‚¹å‡»äº‹ä»¶
                                        link.click();
                                        
                                        // ç§»é™¤é“¾æ¥å…ƒç´ å’Œæ¸…ç†URLå¯¹è±¡
                                        setTimeout(() => {
                                            if (link.parentNode) {
                                                link.parentNode.removeChild(link);
                                            }
                                            try {
                                                URL.revokeObjectURL(url);
                                            } catch (e) {
                                                console.warn('é‡Šæ”¾URLå¯¹è±¡å¤±è´¥:', e);
                                            }
                                        }, 100);
                                    } catch (e) {
                                        console.log('å¤‡ç”¨ä¸‹è½½æ–¹å¼:', e);
                                        // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨åŸæœ‰çš„dataURLæ–¹å¼
                                        const link = document.createElement('a');
                                        link.download = downloadFileName;
                                        link.href = dataUrl;
                                        
                                        // æ·»åŠ åˆ°èµ„æºæ¸…ç†åˆ—è¡¨
                                        resourcesToClean.tempElements.push(link);
                                        
                                        document.body.appendChild(link);
                                        link.click();
                                        setTimeout(() => {
                                            if (link.parentNode) {
                                                link.parentNode.removeChild(link);
                                            }
                                        }, 100);
                                    }
                                }
                            } catch (e) {
                                console.log('å¤‡ç”¨ä¸‹è½½æ–¹å¼:', e);
                                // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥æ‰“å¼€å›¾ç‰‡åœ¨æ–°çª—å£
                                try {
                                    const newWindow = window.open(dataUrl, '_blank');
                                    if (!newWindow) {
                                        showToast('æ— æ³•æ‰“å¼€å›¾ç‰‡ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®');
                                    }
                                } catch (e) {
                                    console.error('æ‰“å¼€æ–°çª—å£å¤±è´¥:', e);
                                    showToast('å›¾ç‰‡å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                                }
                            }
                        } else {
                                // æ¡Œé¢è®¾å¤‡ä¸Šçš„æ ‡å‡†å¤„ç†
                                try {
                                    const link = document.createElement('a');
                                    link.download = downloadFileName;
                                    link.href = dataUrl;
                                    
                                    // æ·»åŠ åˆ°èµ„æºæ¸…ç†åˆ—è¡¨
                                    resourcesToClean.tempElements.push(link);
                                    
                                    document.body.appendChild(link);
                                    link.click();
                                    
                                    // ç§»é™¤é“¾æ¥å…ƒç´ 
                                    setTimeout(() => {
                                        if (link.parentNode) {
                                            link.parentNode.removeChild(link);
                                        }
                                    }, 100);
                                } catch (e) {
                                    console.error('æ¡Œé¢ä¸‹è½½å¤„ç†å¤±è´¥:', e);
                                    showToast('å›¾ç‰‡å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                                }
                            }
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        setTimeout(() => {
                            showToast('å›¾ç‰‡å¯¼å‡ºæˆåŠŸï¼è¯·æ£€æŸ¥ä¸‹è½½æ–‡ä»¶å¤¹');
                        }, 800);
                        
                        // æ¸…ç†èµ„æº
                        setTimeout(() => {
                            try {
                                cleanupResources();
                            } catch (e) {
                                console.error('èµ„æºæ¸…ç†å¤±è´¥:', e);
                                // å³ä½¿æ¸…ç†å¤±è´¥ä¹Ÿè¦ç¡®ä¿å¯¼å‡ºçŠ¶æ€è¢«é‡ç½®
                                window.isExporting = false;
                            }
                        }, 1000);
                        
                        // å¦‚æœä¹‹å‰æ˜¯å…¨å±æ¨¡å¼ï¼Œæä¾›ç”¨æˆ·é€‰é¡¹æ¢å¤å…¨å±
                        if (wasFullscreen && typeof document.requestFullscreen === 'function') {
                            // å…¨å±æ¨¡å¼éœ€è¦ç”¨æˆ·æ˜ç¡®äº¤äº’æ‰èƒ½æ¢å¤ï¼Œæ·»åŠ æç¤ºè®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»æ¢å¤
                            setTimeout(() => {
                                // åˆ›å»ºä¸€ä¸ªæç¤ºæŒ‰é’®è®©ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ¢å¤å…¨å±
                                const fullscreenHint = document.createElement('div');
                                fullscreenHint.className = 'fullscreen-hint';
                                fullscreenHint.style.cssText = `
                                    position: fixed;
                                    bottom: 20px;
                                    right: 20px;
                                    background: rgba(0,0,0,0.7);
                                    color: white;
                                    padding: 10px 15px;
                                    border-radius: 20px;
                                    font-size: 14px;
                                    z-index: 9999;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                `;
                                fullscreenHint.textContent = 'æ¢å¤å…¨å±æ¨¡å¼';
                                fullscreenHint.onclick = function() {
                                    try {
                                        document.requestFullscreen();
                                        this.parentNode.removeChild(this);
                                    } catch (e) {
                                        console.warn('æ¢å¤å…¨å±å¤±è´¥:', e);
                                        showToast('æ— æ³•æ¢å¤å…¨å±ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»å…¨å±æŒ‰é’®');
                                    }
                                };
                                
                                // æ·»åŠ åˆ°èµ„æºæ¸…ç†åˆ—è¡¨
                                resourcesToClean.tempElements.push(fullscreenHint);
                                document.body.appendChild(fullscreenHint);
                                
                                // 10ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
                                setTimeout(() => {
                                    if (fullscreenHint.parentNode) {
                                        fullscreenHint.style.opacity = '0';
                                        setTimeout(() => {
                                            if (fullscreenHint.parentNode) {
                                                fullscreenHint.parentNode.removeChild(fullscreenHint);
                                            }
                                        }, 300);
                                    }
                                }, 10000);
                            }, 3000);
                        }
                    }, 500);
                }
                
                // ç›´æ¥è§¦å‘ä¸‹è½½ï¼Œå› ä¸ºå…¨å±å·²ç»åœ¨å‡½æ•°å¼€å§‹æ—¶é€€å‡º
                triggerDownload();
            }).catch(error => {
                console.error('å¯¼å‡ºå›¾ç‰‡å¤±è´¥:', error);
                showToast('å¯¼å‡ºå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                cleanupResources();
            });
        }

        // è®¾ç½®æ’åºåŠŸèƒ½
        function setupSortToggle() {
            const sortBtn = document.getElementById('sort-toggle-btn');
            const sortOptions = [
                { sortBy: 'createdAt', sortOrder: 'desc', text: 'æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼ˆæœ€æ–°åœ¨å‰ï¼‰' },
                { sortBy: 'title', sortOrder: 'asc', text: 'æŒ‰åç§°A-Zæ’åº' },
                { sortBy: 'title', sortOrder: 'desc', text: 'æŒ‰åç§°Z-Aæ’åº' },
                { sortBy: 'updatedAt', sortOrder: 'desc', text: 'æŒ‰ä¿®æ”¹æ—¶é—´æ’åºï¼ˆæœ€æ–°ä¿®æ”¹åœ¨å‰ï¼‰' }
            ];
            let currentSortIndex = 0;
            
            // åˆ›å»ºæ’åºé€‰é¡¹èœå•
            let sortMenu = null;
            
            function toggleSortMenu() {
                if (sortMenu) {
                    // å¦‚æœèœå•å·²å­˜åœ¨ï¼Œåˆ™ç§»é™¤å®ƒ
                    document.body.removeChild(sortMenu);
                    sortMenu = null;
                    return;
                }
                
                // åˆ›å»ºèœå•å…ƒç´ 
                sortMenu = document.createElement('div');
                sortMenu.className = 'sort-menu';
                sortMenu.style.position = 'absolute';
                sortMenu.style.top = `${sortBtn.getBoundingClientRect().bottom + window.pageYOffset}px`;
                sortMenu.style.left = `${sortBtn.getBoundingClientRect().left + window.pageXOffset}px`;
                sortMenu.style.background = 'white';
                sortMenu.style.border = '1px solid var(--border-medium)';
                sortMenu.style.borderRadius = 'var(--radius-small)';
                sortMenu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                sortMenu.style.zIndex = '1000';
                sortMenu.style.minWidth = '150px';
                
                // æ·»åŠ æ’åºé€‰é¡¹
                sortOptions.forEach((option, index) => {
                    const optionItem = document.createElement('div');
                    optionItem.className = 'sort-option';
                    optionItem.style.padding = '8px 16px';
                    optionItem.style.cursor = 'pointer';
                    optionItem.style.fontSize = '0.9rem';
                    optionItem.style.borderBottom = index < sortOptions.length - 1 ? '1px solid var(--border-light)' : 'none';
                    optionItem.style.transition = 'background-color 0.1s';
                    
                    if (index === currentSortIndex) {
                        optionItem.style.background = 'var(--bg-light)';
                        optionItem.style.fontWeight = 'bold';
                    }
                    
                    optionItem.textContent = option.text;
                    
                    optionItem.addEventListener('mouseenter', function() {
                        this.style.background = 'var(--bg-light)';
                    });
                    
                    optionItem.addEventListener('mouseleave', function() {
                        if (index !== currentSortIndex) {
                            this.style.background = 'white';
                        }
                    });
                    
                    optionItem.addEventListener('click', function() {
                        currentSortIndex = index;
                        sortNotebooks(option.sortBy, option.sortOrder);
                        document.body.removeChild(sortMenu);
                        sortMenu = null;
                    });
                    
                    sortMenu.appendChild(optionItem);
                });
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(sortMenu);
                
                // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
                function closeMenu(event) {
                    if (sortMenu && !sortBtn.contains(event.target) && !sortMenu.contains(event.target)) {
                        document.body.removeChild(sortMenu);
                        sortMenu = null;
                        document.removeEventListener('click', closeMenu);
                    }
                }
                
                setTimeout(() => {
                    document.addEventListener('click', closeMenu);
                }, 0);
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
            sortBtn.addEventListener('click', toggleSortMenu);
        }
        
        // è®¾ç½®è§†å›¾åˆ‡æ¢åŠŸèƒ½
        function setupViewToggle() {
            const toggleBtn = document.getElementById('view-toggle-btn');
            const notebookList = document.getElementById('notebook-list');
            const viewText = toggleBtn.querySelector('span');
            const viewIcon = toggleBtn.querySelector('svg');
            
            // åˆå§‹åŒ–æ˜¾ç¤ºæ¨¡å¼
            let isListView = true;
            
            // åˆ‡æ¢è§†å›¾çš„å‡½æ•°
            function toggleView() {
                isListView = !isListView;
                
                if (isListView) {
                    // åˆ‡æ¢åˆ°åˆ—è¡¨è§†å›¾
                    notebookList.classList.remove('icon-view');
                    notebookList.classList.remove('tile-view');
                    notebookList.classList.add('list-view');
                    viewText.textContent = 'åˆ—è¡¨è§†å›¾';
                    // æ›´æ–°å›¾æ ‡ - æ›¿æ¢ä¸ºæ–°çš„åˆ—è¡¨è§†å›¾å›¾æ ‡
                    viewIcon.innerHTML = '<line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line>';
                } else {
                    // åˆ‡æ¢åˆ°å¹³é“ºè§†å›¾
                    notebookList.classList.remove('list-view');
                    notebookList.classList.remove('icon-view');
                    notebookList.classList.add('tile-view');
                    viewText.textContent = 'å¹³é“ºè§†å›¾';
                    // æ›´æ–°å›¾æ ‡
                    viewIcon.innerHTML = '<rect x="3" y="3" width="9" height="9"></rect><rect x="15" y="3" width="9" height="9"></rect><rect x="3" y="15" width="9" height="9"></rect><rect x="15" y="15" width="9" height="9"></rect>';
                }
            }
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
            toggleBtn.addEventListener('click', toggleView);
        }
        
        // åˆå§‹åŒ–è§†å›¾åˆ‡æ¢åŠŸèƒ½
        setupViewToggle();
        
        // åˆå§‹åŒ–æ’åºåŠŸèƒ½
        setupSortToggle();
        
        // åˆå§‹åŒ–åº”ç”¨
        initApp();
        
        // ä¸ºèƒŒæ™¯å›¾ç‰‡ç›¸å…³åŠŸèƒ½æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // ç›‘å¬æ–‡ä»¶ä¸Šä¼ å˜åŒ–
            const bgImageUpload = document.getElementById('background-image-upload');
            const bgImagePreview = document.getElementById('background-image-preview');
            const previewImage = document.getElementById('preview-image');
            const removeBgImageBtn = document.getElementById('remove-background-image');
            const bgImageOptions = document.querySelectorAll('.bg-image-option');
            
            if (bgImageUpload) {
                bgImageUpload.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            // æ›´æ–°é¢„è§ˆ
                            if (bgImagePreview) {
                                bgImagePreview.style.display = 'block';
                            }
                            if (previewImage) {
                                previewImage.src = event.target.result;
                            }
                            
                            if (removeBgImageBtn) {
                                removeBgImageBtn.style.display = 'block';
                            }
                            
                            // é‡ç½®èƒŒæ™¯å›¾ç‰‡é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                            bgImageOptions.forEach(option => {
                                option.classList.remove('active');
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // ç›‘å¬ç§»é™¤èƒŒæ™¯å›¾ç‰‡æŒ‰é’®ç‚¹å‡»
            if (removeBgImageBtn) {
                removeBgImageBtn.addEventListener('click', function() {
                    if (bgImagePreview) {
                        bgImagePreview.src = '';
                        bgImagePreview.style.display = 'none';
                    }
                    removeBgImageBtn.style.display = 'none';
                    
                    if (bgImageUpload) {
                        bgImageUpload.value = '';
                    }
                    
                    // é€‰ä¸­æ— èƒŒæ™¯é€‰é¡¹
                const noBgOption = document.querySelector('.bg-image-option[data-image="none"]');
                if (noBgOption) {
                    bgImageOptions.forEach(option => {
                        option.classList.remove('active');
                    });
                    noBgOption.classList.add('active');
                }
                });
            }
            
            // ç›‘å¬èƒŒæ™¯å›¾ç‰‡é€‰é¡¹ç‚¹å‡»
            bgImageOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // æ›´æ–°é€‰ä¸­çŠ¶æ€
                    bgImageOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // éšè—é¢„è§ˆå’Œç§»é™¤æŒ‰é’®
                    if (bgImagePreview) {
                        bgImagePreview.style.display = 'none';
                    }
                    if (removeBgImageBtn) {
                        removeBgImageBtn.style.display = 'none';
                    }
                    if (bgImageUpload) {
                        bgImageUpload.value = '';
                    }
                });
            });
        });
        
        // æ˜¾ç¤ºç®€å•æç¤ºçš„å‡½æ•°
        window.showToast = function(message) {
            // åˆ›å»ºtoastè®¡æ•°å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!window.toastCounter) {
                window.toastCounter = 0;
            }
            window.toastCounter++;
            
            // åˆ›å»ºæ–°çš„toastå…ƒç´ ï¼Œä½¿ç”¨å”¯ä¸€ID
            const toast = document.createElement('div');
            toast.id = `style-toast-${window.toastCounter}`;
            toast.textContent = message;
            
            // è·å–å½“å‰å·²å­˜åœ¨çš„toastæ•°é‡ï¼Œç”¨äºè®¡ç®—å‚ç›´ä½ç½®
            const existingToasts = document.querySelectorAll('[id^="style-toast-"]');
            const verticalOffset = existingToasts.length * 45; // æ¯ä¸ªtoasté—´è·45px
            
            toast.style.cssText = `
                position: fixed;
                bottom: calc(20% + ${verticalOffset}px);
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 1rem;
                z-index: 1002;
                pointer-events: none;
                opacity: 1;
                transition: opacity 0.3s ease, bottom 0.3s ease;
            `;
            
            document.body.appendChild(toast);
            
            // 2ç§’åæ·¡å‡ºå¹¶ç§»é™¤toast
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    toast.style.opacity = '0';
                    
                    // æ·¡å‡ºåŠ¨ç”»åé‡æ–°è®¡ç®—å…¶ä»–toastä½ç½®
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                        
                        // æ›´æ–°å‰©ä½™toastçš„ä½ç½®
                        const remainingToasts = document.querySelectorAll('[id^="style-toast-"]');
                        remainingToasts.forEach((t, index) => {
                            t.style.bottom = `calc(20% + ${index * 45}px)`;
                        });
                    }, 300);
                }
            }, 2000);
        };
    </script>
</body>
</html>